<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Sarrat González, Juan R González">
<meta name="dcterms.date" content="2025-10-01">

<title>Chapter 9: Data Splitting and Resampling - The Foundation of Model Validation – Tidyverse &amp; Machine Learning Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-90ee96a17764a76d4fcf3f331faa145e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidyverse &amp; Machine Learning Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-1-tidyverse" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 1: Tidyverse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-1-tidyverse">    
        <li>
    <a class="dropdown-item" href="./01-introduction.html">
 <span class="dropdown-text">Ch 1: Introduction to Tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-data-import.html">
 <span class="dropdown-text">Ch 2: Data Import with readr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-data-wrangling.html">
 <span class="dropdown-text">Ch 3: Data Wrangling with dplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-data-tidying.html">
 <span class="dropdown-text">Ch 4: Data Tidying with tidyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-visualization.html">
 <span class="dropdown-text">Ch 5: Visualization with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-functional-programming.html">
 <span class="dropdown-text">Ch 6: Functional Programming with purrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-strings-dates.html">
 <span class="dropdown-text">Ch 7: Strings and Dates</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-1.html">
 <span class="dropdown-text">Block 1 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-2-tidymodels" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 2: Tidymodels</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-2-tidymodels">    
        <li>
    <a class="dropdown-item" href="./08-tidymodels-intro.html">
 <span class="dropdown-text">Ch 8: Introduction to Tidymodels</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-data-splitting.html">
 <span class="dropdown-text">Ch 9: Data Splitting &amp; Resampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-feature-engineering.html">
 <span class="dropdown-text">Ch 10: Feature Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-model-specification.html">
 <span class="dropdown-text">Ch 11: Model Specification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-workflows-evaluation.html">
 <span class="dropdown-text">Ch 12: Workflows &amp; Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-hyperparameter-tuning.html">
 <span class="dropdown-text">Ch 13: Hyperparameter Tuning</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-2.html">
 <span class="dropdown-text">Block 2 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-3-machine-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 3: Machine Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-3-machine-learning">    
        <li>
    <a class="dropdown-item" href="./14-classification.html">
 <span class="dropdown-text">Ch 14: Classification Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-regression.html">
 <span class="dropdown-text">Ch 15: Regression Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-ensemble-methods.html">
 <span class="dropdown-text">Ch 16: Ensemble Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./17-unsupervised-learning.html">
 <span class="dropdown-text">Ch 17: Unsupervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./18-model-deployment.html">
 <span class="dropdown-text">Ch 18: Model Deployment</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-3.html">
 <span class="dropdown-text">Block 3 Assessment</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#why-data-splitting-matters" id="toc-why-data-splitting-matters" class="nav-link" data-scroll-target="#why-data-splitting-matters">Why Data Splitting Matters</a>
  <ul class="collapse">
  <li><a href="#the-fundamental-problem-overfitting" id="toc-the-fundamental-problem-overfitting" class="nav-link" data-scroll-target="#the-fundamental-problem-overfitting">The Fundamental Problem: Overfitting</a></li>
  </ul></li>
  <li><a href="#the-traintest-split" id="toc-the-traintest-split" class="nav-link" data-scroll-target="#the-traintest-split">The Train/Test Split</a>
  <ul class="collapse">
  <li><a href="#basic-splitting-with-rsample" id="toc-basic-splitting-with-rsample" class="nav-link" data-scroll-target="#basic-splitting-with-rsample">Basic Splitting with rsample</a></li>
  <li><a href="#stratified-sampling" id="toc-stratified-sampling" class="nav-link" data-scroll-target="#stratified-sampling">Stratified Sampling</a></li>
  <li><a href="#multi-level-splits-trainvalidationtest" id="toc-multi-level-splits-trainvalidationtest" class="nav-link" data-scroll-target="#multi-level-splits-trainvalidationtest">Multi-level Splits: Train/Validation/Test</a></li>
  </ul></li>
  <li><a href="#cross-validation-making-the-most-of-your-data" id="toc-cross-validation-making-the-most-of-your-data" class="nav-link" data-scroll-target="#cross-validation-making-the-most-of-your-data">Cross-Validation: Making the Most of Your Data</a>
  <ul class="collapse">
  <li><a href="#k-fold-cross-validation" id="toc-k-fold-cross-validation" class="nav-link" data-scroll-target="#k-fold-cross-validation">K-Fold Cross-Validation</a></li>
  <li><a href="#repeated-cross-validation" id="toc-repeated-cross-validation" class="nav-link" data-scroll-target="#repeated-cross-validation">Repeated Cross-Validation</a></li>
  <li><a href="#leave-one-out-cross-validation-loocv" id="toc-leave-one-out-cross-validation-loocv" class="nav-link" data-scroll-target="#leave-one-out-cross-validation-loocv">Leave-One-Out Cross-Validation (LOOCV)</a></li>
  </ul></li>
  <li><a href="#bootstrap-methods" id="toc-bootstrap-methods" class="nav-link" data-scroll-target="#bootstrap-methods">Bootstrap Methods</a>
  <ul class="collapse">
  <li><a href="#understanding-bootstrap" id="toc-understanding-bootstrap" class="nav-link" data-scroll-target="#understanding-bootstrap">Understanding Bootstrap</a></li>
  <li><a href="#out-of-bag-oob-error-estimation" id="toc-out-of-bag-oob-error-estimation" class="nav-link" data-scroll-target="#out-of-bag-oob-error-estimation">Out-of-Bag (OOB) Error Estimation</a></li>
  </ul></li>
  <li><a href="#time-series-splitting" id="toc-time-series-splitting" class="nav-link" data-scroll-target="#time-series-splitting">Time Series Splitting</a>
  <ul class="collapse">
  <li><a href="#time-series-cross-validation" id="toc-time-series-cross-validation" class="nav-link" data-scroll-target="#time-series-cross-validation">Time Series Cross-Validation</a></li>
  <li><a href="#rolling-origin-evaluation" id="toc-rolling-origin-evaluation" class="nav-link" data-scroll-target="#rolling-origin-evaluation">Rolling Origin Evaluation</a></li>
  </ul></li>
  <li><a href="#nested-resampling" id="toc-nested-resampling" class="nav-link" data-scroll-target="#nested-resampling">Nested Resampling</a></li>
  <li><a href="#validation-sets-in-practice" id="toc-validation-sets-in-practice" class="nav-link" data-scroll-target="#validation-sets-in-practice">Validation Sets in Practice</a></li>
  <li><a href="#choosing-the-right-resampling-strategy" id="toc-choosing-the-right-resampling-strategy" class="nav-link" data-scroll-target="#choosing-the-right-resampling-strategy">Choosing the Right Resampling Strategy</a></li>
  <li><a href="#common-pitfalls-and-best-practices" id="toc-common-pitfalls-and-best-practices" class="nav-link" data-scroll-target="#common-pitfalls-and-best-practices">Common Pitfalls and Best Practices</a>
  <ul class="collapse">
  <li><a href="#pitfall-1-data-leakage" id="toc-pitfall-1-data-leakage" class="nav-link" data-scroll-target="#pitfall-1-data-leakage">Pitfall 1: Data Leakage</a></li>
  <li><a href="#pitfall-2-multiple-testing-on-test-set" id="toc-pitfall-2-multiple-testing-on-test-set" class="nav-link" data-scroll-target="#pitfall-2-multiple-testing-on-test-set">Pitfall 2: Multiple Testing on Test Set</a></li>
  <li><a href="#pitfall-3-improper-stratification" id="toc-pitfall-3-improper-stratification" class="nav-link" data-scroll-target="#pitfall-3-improper-stratification">Pitfall 3: Improper Stratification</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-implement-custom-resampling" id="toc-exercise-1-implement-custom-resampling" class="nav-link" data-scroll-target="#exercise-1-implement-custom-resampling">Exercise 1: Implement Custom Resampling</a></li>
  <li><a href="#exercise-2-compare-resampling-strategies" id="toc-exercise-2-compare-resampling-strategies" class="nav-link" data-scroll-target="#exercise-2-compare-resampling-strategies">Exercise 2: Compare Resampling Strategies</a></li>
  <li><a href="#exercise-3-time-series-validation" id="toc-exercise-3-time-series-validation" class="nav-link" data-scroll-target="#exercise-3-time-series-validation">Exercise 3: Time Series Validation</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next?</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 9: Data Splitting and Resampling - The Foundation of Model Validation</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Sarrat González, Juan R González </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this chapter, you will master:</p>
<ul>
<li>The critical importance of proper data splitting</li>
<li>Train/test/validation splits and when to use them</li>
<li>Stratified sampling for balanced splits</li>
<li>Cross-validation techniques and theory</li>
<li>Bootstrap methods for uncertainty estimation</li>
<li>Time series splitting strategies</li>
<li>Nested resampling for unbiased evaluation</li>
<li>Best practices and common pitfalls</li>
</ul>
</section>
<section id="why-data-splitting-matters" class="level2">
<h2 class="anchored" data-anchor-id="why-data-splitting-matters">Why Data Splitting Matters</h2>
<p>Imagine you’re studying for an exam. If you only practice with questions you’ve already seen and memorized the answers to, you might think you understand the material perfectly. But when you face new questions on the actual exam, you realize you’ve only memorized specific answers rather than understanding the concepts. This is exactly what happens in machine learning when we don’t properly split our data.</p>
<section id="the-fundamental-problem-overfitting" class="level3">
<h3 class="anchored" data-anchor-id="the-fundamental-problem-overfitting">The Fundamental Problem: Overfitting</h3>
<p>When we train a model on data and evaluate it on the same data, we get an overly optimistic estimate of performance. The model has essentially “memorized” the training data, including its noise and peculiarities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching packages -------------------------------------- tidymodels 1.4.1 --</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>v broom        1.0.10     v recipes      1.3.1 
v dials        1.4.2      v rsample      1.3.1 
v dplyr        1.1.4      v tailor       0.1.0 
v ggplot2      4.0.0      v tidyr        1.3.1 
v infer        1.0.9      v tune         2.0.0 
v modeldata    1.5.1      v workflows    1.3.0 
v parsnip      1.3.3      v workflowsets 1.1.1 
v purrr        1.1.0      v yardstick    1.3.2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ----------------------------------------- tidymodels_conflicts() --
x purrr::discard() masks scales::discard()
x dplyr::filter()  masks stats::filter()
x dplyr::lag()     masks stats::lag()
x recipes::step()  masks stats::step()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v forcats   1.0.0     v stringr   1.5.2
v lubridate 1.9.4     v tibble    3.3.0
v readr     2.1.5     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x readr::col_factor() masks scales::col_factor()
x purrr::discard()    masks scales::discard()
x dplyr::filter()     masks stats::filter()
x stringr::fixed()    masks recipes::fixed()
x dplyr::lag()        masks stats::lag()
x readr::spec()       masks yardstick::spec()
i Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'vip'

The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate overfitting with a simple example</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>simple_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> n),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> <span class="dv">2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="dv">5</span>,  <span class="co"># True relationship</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="dv">3</span>)  <span class="co"># Add noise</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit increasingly complex models</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear =</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> simple_data),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">poly5 =</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">5</span>), <span class="at">data =</span> simple_data),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">poly15 =</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">15</span>), <span class="at">data =</span> simple_data)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate training error (biased!)</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>training_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">residuals</span>(.)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate new test data</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>),</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> <span class="dv">2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="dv">5</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">3</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate test error (unbiased)</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>test_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="sc">~</span> {</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(., <span class="at">newdata =</span> test_data)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>y <span class="sc">-</span> predictions)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare errors</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>error_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Linear"</span>, <span class="st">"Polynomial (5)"</span>, <span class="st">"Polynomial (15)"</span>),</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Training RMSE</span><span class="st">`</span> <span class="ot">=</span> training_errors,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Test RMSE</span><span class="st">`</span> <span class="ot">=</span> test_errors,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Overfit Amount</span><span class="st">`</span> <span class="ot">=</span> test_errors <span class="sc">-</span> training_errors</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(error_comparison, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">Training RMSE</th>
<th style="text-align: right;">Test RMSE</th>
<th style="text-align: right;">Overfit Amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Linear</td>
<td style="text-align: right;">2.72</td>
<td style="text-align: right;">3.12</td>
<td style="text-align: right;">0.40</td>
</tr>
<tr class="even">
<td style="text-align: left;">Polynomial (5)</td>
<td style="text-align: right;">2.68</td>
<td style="text-align: right;">3.19</td>
<td style="text-align: right;">0.51</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Polynomial (15)</td>
<td style="text-align: right;">2.46</td>
<td style="text-align: right;">3.22</td>
<td style="text-align: right;">0.76</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the fits</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> simple_data <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">linear =</span> <span class="fu">predict</span>(models<span class="sc">$</span>linear),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">poly5 =</span> <span class="fu">predict</span>(models<span class="sc">$</span>poly5),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">poly15 =</span> <span class="fu">predict</span>(models<span class="sc">$</span>poly15)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> linear, <span class="at">color =</span> <span class="st">"Linear"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> poly5, <span class="at">color =</span> <span class="st">"Poly(5)"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> poly15, <span class="at">color =</span> <span class="st">"Poly(15)"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Linear"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Poly(5)"</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">"Poly(15)"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Complexity and Overfitting"</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Complex models fit training data better but may generalize worse"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"X"</span>, <span class="at">y =</span> <span class="st">"Y"</span>, <span class="at">color =</span> <span class="st">"Model"</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Notice how the complex polynomial model (degree 15) has lower training error but higher test error - classic overfitting! This is why we need proper data splitting strategies.</p>
</section>
</section>
<section id="the-traintest-split" class="level2">
<h2 class="anchored" data-anchor-id="the-traintest-split">The Train/Test Split</h2>
<p>The simplest approach is to split data into training and testing sets. The training set is used to fit the model, and the test set provides an unbiased estimate of performance on new data.</p>
<section id="basic-splitting-with-rsample" class="level3">
<h3 class="anchored" data-anchor-id="basic-splitting-with-rsample">Basic Splitting with rsample</h3>
<p>The <code>rsample</code> package provides powerful tools for data splitting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the Ames housing data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic 75/25 split</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the datasets</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the sizes</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>split_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Original"</span>, <span class="st">"Training"</span>, <span class="st">"Testing"</span>),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of Rows</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(ames), <span class="fu">nrow</span>(ames_train), <span class="fu">nrow</span>(ames_test)),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percentage =</span> <span class="fu">c</span>(<span class="dv">100</span>, </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">nrow</span>(ames_train) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">nrow</span>(ames_test) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(split_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Dataset</th>
<th style="text-align: right;">Number of Rows</th>
<th style="text-align: right;">Percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Original</td>
<td style="text-align: right;">2930</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: left;">Training</td>
<td style="text-align: right;">2197</td>
<td style="text-align: right;">75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Testing</td>
<td style="text-align: right;">733</td>
<td style="text-align: right;">25</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The split object contains indices</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ames_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Training/Testing/Total&gt;
&lt;2197/733/2930&gt;</code></pre>
</div>
</div>
<p>The <code>initial_split()</code> function doesn’t just randomly split the data - it’s designed with several important features: - Reproducible with set.seed() - Maintains data structure - Can do stratified sampling - Preserves data types</p>
</section>
<section id="stratified-sampling" class="level3">
<h3 class="anchored" data-anchor-id="stratified-sampling">Stratified Sampling</h3>
<p>When you have imbalanced classes or want to ensure representative splits, use stratified sampling:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification example with imbalanced classes</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>imbalanced_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature1 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature2 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Common"</span>, <span class="dv">900</span>), <span class="fu">rep</span>(<span class="st">"Rare"</span>, <span class="dv">100</span>)))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Regular split (might not preserve class balance)</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>regular_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(imbalanced_data, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>regular_train <span class="ot">&lt;-</span> <span class="fu">training</span>(regular_split)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified split (preserves class balance)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>stratified_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(imbalanced_data, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> class)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>stratified_train <span class="ot">&lt;-</span> <span class="fu">training</span>(stratified_split)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare class distributions</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>distribution_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  imbalanced_data <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Original"</span>),</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  regular_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Regular Split"</span>),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  stratified_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Stratified Split"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Dataset) <span class="sc">%&gt;%</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Percentage =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(distribution_comparison, <span class="fu">aes</span>(<span class="at">x =</span> Dataset, <span class="at">y =</span> Percentage, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Common"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Rare"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Class Distribution: Regular vs Stratified Splitting"</span>,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stratified sampling preserves class proportions"</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage (%)"</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">90</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Stratified sampling is crucial for: - Classification with imbalanced classes - Regression with skewed target distributions - Ensuring all groups are represented in both sets</p>
</section>
<section id="multi-level-splits-trainvalidationtest" class="level3">
<h3 class="anchored" data-anchor-id="multi-level-splits-trainvalidationtest">Multi-level Splits: Train/Validation/Test</h3>
<p>Sometimes we need three sets: - <strong>Training</strong>: For model fitting - <strong>Validation</strong>: For hyperparameter tuning - <strong>Test</strong>: For final, unbiased evaluation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial split</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>initial_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>train_val <span class="ot">&lt;-</span> <span class="fu">training</span>(initial_split)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">testing</span>(initial_split)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Split training into train/validation</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>train_val_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(train_val, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">training</span>(train_val_split)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>validation <span class="ot">&lt;-</span> <span class="fu">testing</span>(train_val_split)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of three-way split</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>three_way_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Validation"</span>, <span class="st">"Test"</span>, <span class="st">"Total"</span>),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">Rows =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(train), <span class="fu">nrow</span>(validation), <span class="fu">nrow</span>(test), <span class="fu">nrow</span>(ames)),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Percentage of Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(train) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(validation) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(test) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(three_way_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Dataset</th>
<th style="text-align: right;">Rows</th>
<th style="text-align: right;">Percentage of Total</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Training</td>
<td style="text-align: right;">1758</td>
<td style="text-align: right;">60</td>
</tr>
<tr class="even">
<td style="text-align: left;">Validation</td>
<td style="text-align: right;">586</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Test</td>
<td style="text-align: right;">586</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">Total</td>
<td style="text-align: right;">2930</td>
<td style="text-align: right;">100</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: Use initial_validation_split (tidymodels 1.1.0+)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates all three splits at once</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># val_split &lt;- initial_validation_split(ames, prop = c(0.6, 0.2))</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This would give: 60% train, 20% validation, 20% test</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="cross-validation-making-the-most-of-your-data" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation-making-the-most-of-your-data">Cross-Validation: Making the Most of Your Data</h2>
<p>While train/test splits are simple, they have limitations: - Only use part of the data for training - Results can vary based on the specific split - May not be reliable for small datasets</p>
<p>Cross-validation addresses these issues by using multiple splits.</p>
<section id="k-fold-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="k-fold-cross-validation">K-Fold Cross-Validation</h3>
<p>K-fold CV divides data into k equal parts (folds), trains on k-1 folds, and tests on the remaining fold. This process repeats k times.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 5-fold cross-validation</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ames_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ames_cv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation 
# A tibble: 5 x 2
  splits             id   
  &lt;list&gt;             &lt;chr&gt;
1 &lt;split [1757/440]&gt; Fold1
2 &lt;split [1757/440]&gt; Fold2
3 &lt;split [1758/439]&gt; Fold3
4 &lt;split [1758/439]&gt; Fold4
5 &lt;split [1758/439]&gt; Fold5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the structure</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>first_fold <span class="ot">&lt;-</span> ames_cv<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">analysis</span>(first_fold) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()  <span class="co"># Training data for this fold</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1757</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assessment</span>(first_fold) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()  <span class="co"># Test data for this fold</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 440</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize how data is split across folds</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>fold_assignments <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(fold) {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  assessment_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(ames_cv<span class="sc">$</span>splits[[fold]]<span class="sc">$</span>in_id <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  ames_train <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">row_id =</span> <span class="fu">row_number</span>(),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">fold =</span> fold,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">in_assessment =</span> row_id <span class="sc">%in%</span> assessment_rows</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(row_id <span class="sc">&lt;=</span> <span class="dv">100</span>)  <span class="co"># Show first 100 rows for visualization</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fold_assignments, <span class="fu">aes</span>(<span class="at">x =</span> row_id, <span class="at">y =</span> <span class="fu">factor</span>(fold), <span class="at">fill =</span> in_assessment)) <span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">height =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"coral"</span>),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Testing"</span>)) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"5-Fold Cross-Validation Data Assignment"</span>,</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each row is used for testing exactly once"</span>,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observation ID"</span>, <span class="at">y =</span> <span class="st">"Fold"</span>, <span class="at">fill =</span> <span class="st">"Role"</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The mathematics of cross-validation: - Each observation is used for testing exactly once - Each observation is used for training k-1 times - We get k performance estimates - Final estimate is the average across folds - Standard error provides uncertainty estimate</p>
</section>
<section id="repeated-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="repeated-cross-validation">Repeated Cross-Validation</h3>
<p>For more stable estimates, we can repeat the CV process with different random splits:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeated 5-fold CV (3 repeats = 15 total resamples)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ames_repeated_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">3</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ames_repeated_cv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  5-fold cross-validation repeated 3 times 
# A tibble: 15 x 3
   splits             id      id2  
   &lt;list&gt;             &lt;chr&gt;   &lt;chr&gt;
 1 &lt;split [1757/440]&gt; Repeat1 Fold1
 2 &lt;split [1757/440]&gt; Repeat1 Fold2
 3 &lt;split [1758/439]&gt; Repeat1 Fold3
 4 &lt;split [1758/439]&gt; Repeat1 Fold4
 5 &lt;split [1758/439]&gt; Repeat1 Fold5
 6 &lt;split [1757/440]&gt; Repeat2 Fold1
 7 &lt;split [1757/440]&gt; Repeat2 Fold2
 8 &lt;split [1758/439]&gt; Repeat2 Fold3
 9 &lt;split [1758/439]&gt; Repeat2 Fold4
10 &lt;split [1758/439]&gt; Repeat2 Fold5
11 &lt;split [1757/440]&gt; Repeat3 Fold1
12 &lt;split [1757/440]&gt; Repeat3 Fold2
13 &lt;split [1758/439]&gt; Repeat3 Fold3
14 &lt;split [1758/439]&gt; Repeat3 Fold4
15 &lt;split [1758/439]&gt; Repeat3 Fold5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variability: single vs repeated CV</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a simple model to demonstrate</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>simple_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond, <span class="at">data =</span> ames_train)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Single CV</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>single_cv_results <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(<span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeated CV</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>repeated_cv_results <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(ames_repeated_cv) <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  single_cv_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Single 5-fold CV"</span>),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  repeated_cv_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Repeated 5-fold CV (3x)"</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(comparison, <span class="fu">aes</span>(<span class="at">x =</span> Method, <span class="at">y =</span> mean, <span class="at">fill =</span> Method)) <span class="sc">+</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Single vs Repeated Cross-Validation"</span>,</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Repeated CV has smaller standard errors (more stable estimates)"</span>,</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="leave-one-out-cross-validation-loocv" class="level3">
<h3 class="anchored" data-anchor-id="leave-one-out-cross-validation-loocv">Leave-One-Out Cross-Validation (LOOCV)</h3>
<p>LOOCV is a special case where k = n (number of observations):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a small dataset for LOOCV demonstration</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>small_data <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">50</span>)  <span class="co"># LOOCV is computationally expensive</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create LOOCV splits</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>loocv_splits <span class="ot">&lt;-</span> <span class="fu">loo_cv</span>(small_data)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>loocv_splits</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Leave-one-out cross-validation 
# A tibble: 50 x 2
   splits         id        
   &lt;list&gt;         &lt;chr&gt;     
 1 &lt;split [49/1]&gt; Resample1 
 2 &lt;split [49/1]&gt; Resample2 
 3 &lt;split [49/1]&gt; Resample3 
 4 &lt;split [49/1]&gt; Resample4 
 5 &lt;split [49/1]&gt; Resample5 
 6 &lt;split [49/1]&gt; Resample6 
 7 &lt;split [49/1]&gt; Resample7 
 8 &lt;split [49/1]&gt; Resample8 
 9 &lt;split [49/1]&gt; Resample9 
10 &lt;split [49/1]&gt; Resample10
# i 40 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare computational cost</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>cv_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"5-fold CV"</span>, <span class="st">"10-fold CV"</span>, <span class="st">"LOOCV"</span>),</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of Models</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fu">nrow</span>(small_data)),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Training Set Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">*</span> <span class="dv">4</span><span class="sc">/</span><span class="dv">5</span>),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">*</span> <span class="dv">9</span><span class="sc">/</span><span class="dv">10</span>),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(small_data) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Test Set Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">/</span> <span class="dv">5</span>),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">/</span> <span class="dv">10</span>),</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cv_comparison)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: right;">Number of Models</th>
<th style="text-align: right;">Training Set Size</th>
<th style="text-align: right;">Test Set Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">5-fold CV</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">10-fold CV</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LOOCV</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>LOOCV characteristics: - <strong>Pros</strong>: Uses maximum data for training, deterministic (no randomness) - <strong>Cons</strong>: Computationally expensive, high variance, can overfit to the dataset</p>
</section>
</section>
<section id="bootstrap-methods" class="level2">
<h2 class="anchored" data-anchor-id="bootstrap-methods">Bootstrap Methods</h2>
<p>Bootstrap resampling draws samples WITH replacement from the original data. This creates datasets of the same size but with some observations repeated and others omitted.</p>
<section id="understanding-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="understanding-bootstrap">Understanding Bootstrap</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bootstrap samples</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ames_boot <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(ames_train, <span class="at">times =</span> <span class="dv">25</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ames_boot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 25 x 2
   splits             id         
   &lt;list&gt;             &lt;chr&gt;      
 1 &lt;split [2197/804]&gt; Bootstrap01
 2 &lt;split [2197/819]&gt; Bootstrap02
 3 &lt;split [2197/822]&gt; Bootstrap03
 4 &lt;split [2197/798]&gt; Bootstrap04
 5 &lt;split [2197/814]&gt; Bootstrap05
 6 &lt;split [2197/812]&gt; Bootstrap06
 7 &lt;split [2197/794]&gt; Bootstrap07
 8 &lt;split [2197/825]&gt; Bootstrap08
 9 &lt;split [2197/819]&gt; Bootstrap09
10 &lt;split [2197/806]&gt; Bootstrap10
# i 15 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine one bootstrap sample</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>first_boot <span class="ot">&lt;-</span> ames_boot<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># In bootstrap, some observations appear multiple times</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>boot_sample <span class="ot">&lt;-</span> <span class="fu">analysis</span>(first_boot)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>original_ids <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ames_train)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>sampled_ids <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">rownames</span>(boot_sample))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Count frequency of observations</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>id_frequency <span class="ot">&lt;-</span> <span class="fu">table</span>(sampled_ids)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>freq_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Times Sampled</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">max</span>(id_frequency),</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Count =</span> <span class="fu">c</span>(</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span>(original_ids <span class="sc">%in%</span> sampled_ids)),  <span class="co"># Not sampled (0 times)</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(id_frequency), <span class="cf">function</span>(x) <span class="fu">sum</span>(id_frequency <span class="sc">==</span> x))</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percentage =</span> Count <span class="sc">/</span> <span class="fu">nrow</span>(ames_train) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(freq_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Times Sampled</th>
<th style="text-align: right;">Count</th>
<th style="text-align: right;">Percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2197</td>
<td style="text-align: right;">100</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize bootstrap sampling</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>sample_viz <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">original_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap_sample =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(bootstrap_sample) <span class="sc">%&gt;%</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">bootstrap_sample =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="dv">0</span>))</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sample_viz, <span class="fu">aes</span>(<span class="at">x =</span> bootstrap_sample, <span class="at">y =</span> n)) <span class="sc">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Bootstrap Sampling Example (n=20)"</span>,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Some observations appear multiple times, others not at all"</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Original Observation ID"</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Times Selected"</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The mathematics of bootstrap: - Probability of being selected at least once: <span class="math inline">\(1 - (1 - 1/n)^n \approx 0.632\)</span> as <span class="math inline">\(n \to \infty\)</span> - About 37% of observations are not selected (out-of-bag) - Provides estimates of sampling distribution - Useful for confidence intervals and bias estimation</p>
</section>
<section id="out-of-bag-oob-error-estimation" class="level3">
<h3 class="anchored" data-anchor-id="out-of-bag-oob-error-estimation">Out-of-Bag (OOB) Error Estimation</h3>
<p>Bootstrap’s unique property is that ~37% of data is not sampled, providing a natural test set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate OOB predictions for each bootstrap sample</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>oob_analysis <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>, <span class="cf">function</span>(i) {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  boot_split <span class="ot">&lt;-</span> ames_boot<span class="sc">$</span>splits[[i]]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observations in this bootstrap sample</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  in_bag <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">rownames</span>(<span class="fu">analysis</span>(boot_split)))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OOB observations</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  all_ids <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ames_train)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  oob_ids <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_ids, <span class="fu">unique</span>(in_bag))</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap =</span> i,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_unique_in_bag =</span> <span class="fu">length</span>(<span class="fu">unique</span>(in_bag)),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oob =</span> <span class="fu">length</span>(oob_ids),</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_oob =</span> <span class="fu">length</span>(oob_ids) <span class="sc">/</span> <span class="fu">length</span>(all_ids) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>oob_summary <span class="ot">&lt;-</span> oob_analysis <span class="sc">%&gt;%</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_pct_oob =</span> <span class="fu">mean</span>(pct_oob),</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_pct_oob =</span> <span class="fu">sd</span>(pct_oob),</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">theoretical_oob =</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">exp</span>(<span class="dv">1</span>)) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># ~36.8%</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(oob_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">mean_pct_oob</th>
<th style="text-align: right;">sd_pct_oob</th>
<th style="text-align: right;">theoretical_oob</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">63.2</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize OOB percentages</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(oob_analysis, <span class="fu">aes</span>(<span class="at">x =</span> pct_oob)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> oob_summary<span class="sc">$</span>theoretical_oob, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Out-of-Bag Percentage Across Bootstrap Samples"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red line shows theoretical value (~36.8%)"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"OOB Percentage"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="time-series-splitting" class="level2">
<h2 class="anchored" data-anchor-id="time-series-splitting">Time Series Splitting</h2>
<p>Time series data requires special handling because: - Observations are not independent - Future cannot be used to predict past - Temporal patterns must be preserved</p>
<section id="time-series-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="time-series-cross-validation">Time Series Cross-Validation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time series data</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">&lt;-</span> <span class="dv">365</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ts_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">by =</span> <span class="st">"day"</span>, <span class="at">length.out =</span> n_days),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="at">length.out =</span> n_days),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">20</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span>n_days) <span class="sc">/</span> <span class="dv">7</span>),  <span class="co"># Weekly pattern</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(n_days, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> noise</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series split - expanding window</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>ts_initial <span class="ot">&lt;-</span> <span class="dv">180</span>  <span class="co"># Initial training size</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>ts_assess <span class="ot">&lt;-</span> <span class="dv">30</span>    <span class="co"># Assessment size</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>ts_splits <span class="ot">&lt;-</span> <span class="fu">sliding_period</span>(</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  ts_data,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  date,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">period =</span> <span class="st">"month"</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">lookback =</span> <span class="dv">5</span>,  <span class="co"># Use 6 months of data</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess_stop =</span> <span class="dv">1</span>  <span class="co"># Assess on next month</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize time series CV</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>split_viz <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">5</span>, <span class="fu">length</span>(ts_splits<span class="sc">$</span>splits)), <span class="cf">function</span>(i) {</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  split <span class="ot">&lt;-</span> ts_splits<span class="sc">$</span>splits[[i]]</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> <span class="fu">analysis</span>(split) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">role =</span> <span class="st">"Training"</span>, <span class="at">split_id =</span> i)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> <span class="fu">assessment</span>(split) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">role =</span> <span class="st">"Testing"</span>, <span class="at">split_id =</span> i)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(train_data, test_data)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(split_viz, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> split_id, <span class="at">color =</span> role)) <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Testing"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Time Series Cross-Validation"</span>,</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Training window slides forward, always predicting future"</span>,</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Split"</span>, <span class="at">color =</span> <span class="st">"Role"</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Time series splitting strategies: - <strong>Expanding window</strong>: Training set grows over time - <strong>Sliding window</strong>: Fixed-size training window - <strong>Skip periods</strong>: Gap between training and testing</p>
</section>
<section id="rolling-origin-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="rolling-origin-evaluation">Rolling Origin Evaluation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling origin (expanding window)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>rolling_splits <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  ts_data,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial =</span> <span class="dv">180</span>,    <span class="co"># Start with 180 days</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess =</span> <span class="dv">30</span>,      <span class="co"># Assess next 30 days</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip =</span> <span class="dv">30</span>,        <span class="co"># Skip 30 days between splits</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cumulative =</span> <span class="cn">TRUE</span> <span class="co"># Expanding window</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate how training size grows</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>rolling_summary <span class="ot">&lt;-</span> rolling_splits <span class="sc">%&gt;%</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_size =</span> <span class="fu">map_int</span>(splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">analysis</span>(.))),</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_size =</span> <span class="fu">map_int</span>(splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">assessment</span>(.)))</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, train_size, test_size) <span class="sc">%&gt;%</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">split =</span> <span class="fu">row_number</span>())</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rolling_summary, <span class="fu">aes</span>(<span class="at">x =</span> split)) <span class="sc">+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> train_size, <span class="at">color =</span> <span class="st">"Training"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> test_size, <span class="at">color =</span> <span class="st">"Testing"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Testing"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Rolling Origin: Expanding Window"</span>,</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Training set grows while test set remains constant"</span>,</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Split Number"</span>, <span class="at">y =</span> <span class="st">"Number of Observations"</span>,</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Dataset"</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="nested-resampling" class="level2">
<h2 class="anchored" data-anchor-id="nested-resampling">Nested Resampling</h2>
<p>When we need to tune hyperparameters AND get an unbiased performance estimate, we use nested resampling: - <strong>Outer loop</strong>: For performance estimation - <strong>Inner loop</strong>: For hyperparameter tuning</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create nested resampling</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer: 5-fold CV for performance estimation</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Inner: 5-fold CV for hyperparameter tuning</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer resampling</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>outer_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># For each outer fold, create inner resampling</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>nested_cv <span class="ot">&lt;-</span> <span class="fu">map</span>(outer_cv<span class="sc">$</span>splits, <span class="cf">function</span>(outer_split) {</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training data for this outer fold</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  outer_train <span class="ot">&lt;-</span> <span class="fu">analysis</span>(outer_split)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create inner CV on the outer training data</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  inner_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(outer_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">outer_split =</span> outer_split,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">inner_cv =</span> inner_cv</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize nested structure</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>nested_viz <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Fold</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Training Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">map_int</span>(outer_cv<span class="sc">$</span>splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">analysis</span>(.))),</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Test Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">map_int</span>(outer_cv<span class="sc">$</span>splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">assessment</span>(.))),</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Inner Folds</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>,</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Total Models per Outer Fold</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Total Models Overall</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">25</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(nested_viz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 18%">
<col style="width: 14%">
<col style="width: 11%">
<col style="width: 25%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Outer Fold</th>
<th style="text-align: right;">Outer Training Size</th>
<th style="text-align: right;">Outer Test Size</th>
<th style="text-align: right;">Inner Folds</th>
<th style="text-align: right;">Total Models per Outer Fold</th>
<th style="text-align: right;">Total Models Overall</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1757</td>
<td style="text-align: right;">440</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1757</td>
<td style="text-align: right;">440</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1758</td>
<td style="text-align: right;">439</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1758</td>
<td style="text-align: right;">439</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1758</td>
<td style="text-align: right;">439</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">25</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conceptual diagram</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="st">Nested Resampling Structure:</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="st">============================</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="st">Full Training Data</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="st">  |</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">  ├── Outer Fold 1</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="st">  │   ├── Outer Training (80%)</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 1: Train (64%) + Val (16%)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 2: Train (64%) + Val (16%)</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 3: Train (64%) + Val (16%)</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 4: Train (64%) + Val (16%)</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   └── Inner Fold 5: Train (64%) + Val (16%)</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="st">  │   └── Outer Test (20%) - Never seen during tuning</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="st">  │</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="st">  ├── Outer Fold 2</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="st">  │   └── [Same structure]</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="st">  ...</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Nested Resampling Structure:
============================
Full Training Data
  |
  &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Outer Fold 1
  &lt;U+2502&gt;   &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Outer Training (80%)
  &lt;U+2502&gt;   &lt;U+2502&gt;   &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Inner Fold 1: Train (64%) + Val (16%)
  &lt;U+2502&gt;   &lt;U+2502&gt;   &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Inner Fold 2: Train (64%) + Val (16%)
  &lt;U+2502&gt;   &lt;U+2502&gt;   &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Inner Fold 3: Train (64%) + Val (16%)
  &lt;U+2502&gt;   &lt;U+2502&gt;   &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Inner Fold 4: Train (64%) + Val (16%)
  &lt;U+2502&gt;   &lt;U+2502&gt;   &lt;U+2514&gt;&lt;U+2500&gt;&lt;U+2500&gt; Inner Fold 5: Train (64%) + Val (16%)
  &lt;U+2502&gt;   &lt;U+2514&gt;&lt;U+2500&gt;&lt;U+2500&gt; Outer Test (20%) - Never seen during tuning
  &lt;U+2502&gt;
  &lt;U+251C&gt;&lt;U+2500&gt;&lt;U+2500&gt; Outer Fold 2
  &lt;U+2502&gt;   &lt;U+2514&gt;&lt;U+2500&gt;&lt;U+2500&gt; [Same structure]
  ...</code></pre>
</div>
</div>
<p>Nested resampling is crucial for: - Unbiased performance estimation when tuning - Comparing different modeling strategies - Understanding generalization performance</p>
</section>
<section id="validation-sets-in-practice" class="level2">
<h2 class="anchored" data-anchor-id="validation-sets-in-practice">Validation Sets in Practice</h2>
<p>Sometimes we want a single validation set for quick iterations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a validation set</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>val_split <span class="ot">&lt;-</span> <span class="fu">initial_validation_split</span>(ames, <span class="at">prop =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.2</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all three sets</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">&lt;-</span> <span class="fu">training</span>(val_split)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation</span>(val_split)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">&lt;-</span> <span class="fu">testing</span>(val_split)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Use validation set for model selection</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>models_to_compare <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">simple =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()),</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">moderate =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                   Neighborhood, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()),</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>                  Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> First_Flr_SF, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models and evaluate on validation set</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>validation_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(models_to_compare), <span class="cf">function</span>(model_name) {</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  recipe <span class="ot">&lt;-</span> models_to_compare[[model_name]]</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(recipe) <span class="sc">%&gt;%</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit on training</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> wf <span class="sc">%&gt;%</span> <span class="fu">fit</span>(train_set)</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on validation</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  val_pred <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(val_set) <span class="sc">%&gt;%</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(val_set)</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate metrics</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  val_pred <span class="sc">%&gt;%</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred) <span class="sc">%&gt;%</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> model_name)</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Select best model based on validation performance</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> validation_results <span class="sc">%&gt;%</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.estimate) <span class="sc">%&gt;%</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(model)</span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Best model based on validation set:"</span>, best_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Best model based on validation set: complex"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final evaluation on test set (only done once!)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="ot">&lt;-</span> models_to_compare[[best_model]]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(final_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train_set)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>test_pred <span class="ot">&lt;-</span> final_fit <span class="sc">%&gt;%</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test_set) <span class="sc">%&gt;%</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_set)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>final_performance <span class="ot">&lt;-</span> test_pred <span class="sc">%&gt;%</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(final_performance, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">.metric</th>
<th style="text-align: left;">.estimator</th>
<th style="text-align: right;">.estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">rmse</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">38837.693</td>
</tr>
<tr class="even">
<td style="text-align: left;">rsq</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">0.797</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mae</td>
<td style="text-align: left;">standard</td>
<td style="text-align: right;">24125.346</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="choosing-the-right-resampling-strategy" class="level2">
<h2 class="anchored" data-anchor-id="choosing-the-right-resampling-strategy">Choosing the Right Resampling Strategy</h2>
<p>Different strategies for different situations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision guide</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>strategy_guide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario =</span> <span class="fu">c</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large dataset (n &gt; 10,000)"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Medium dataset (1,000 &lt; n &lt; 10,000)"</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small dataset (n &lt; 1,000)"</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imbalanced classes"</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time series data"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Quick prototyping"</span>,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final evaluation"</span>,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hyperparameter tuning"</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model comparison"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uncertainty estimation"</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Recommended Strategy</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple train/test split or validation set"</span>,</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5 or 10-fold CV"</span>,</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Repeated CV or LOOCV"</span>,</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stratified CV"</span>,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time series CV or rolling origin"</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Validation set"</span>,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Held-out test set (touched only once)"</span>,</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nested CV"</span>,</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Repeated CV"</span>,</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bootstrap"</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">Reasoning =</span> <span class="fu">c</span>(</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sufficient data for reliable estimates"</span>,</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Balance between bias and variance"</span>,</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Maximize training data usage"</span>,</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Preserve class proportions"</span>,</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Respect temporal ordering"</span>,</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fast iteration and feedback"</span>,</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unbiased final assessment"</span>,</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Avoid overfitting to validation set"</span>,</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stable comparison metrics"</span>,</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Confidence intervals and distributions"</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(strategy_guide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 30%">
<col style="width: 35%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Scenario</th>
<th style="text-align: left;">Recommended Strategy</th>
<th style="text-align: left;">Reasoning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Large dataset (n &gt; 10,000)</td>
<td style="text-align: left;">Simple train/test split or validation set</td>
<td style="text-align: left;">Sufficient data for reliable estimates</td>
</tr>
<tr class="even">
<td style="text-align: left;">Medium dataset (1,000 &lt; n &lt; 10,000)</td>
<td style="text-align: left;">5 or 10-fold CV</td>
<td style="text-align: left;">Balance between bias and variance</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Small dataset (n &lt; 1,000)</td>
<td style="text-align: left;">Repeated CV or LOOCV</td>
<td style="text-align: left;">Maximize training data usage</td>
</tr>
<tr class="even">
<td style="text-align: left;">Imbalanced classes</td>
<td style="text-align: left;">Stratified CV</td>
<td style="text-align: left;">Preserve class proportions</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Time series data</td>
<td style="text-align: left;">Time series CV or rolling origin</td>
<td style="text-align: left;">Respect temporal ordering</td>
</tr>
<tr class="even">
<td style="text-align: left;">Quick prototyping</td>
<td style="text-align: left;">Validation set</td>
<td style="text-align: left;">Fast iteration and feedback</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Final evaluation</td>
<td style="text-align: left;">Held-out test set (touched only once)</td>
<td style="text-align: left;">Unbiased final assessment</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hyperparameter tuning</td>
<td style="text-align: left;">Nested CV</td>
<td style="text-align: left;">Avoid overfitting to validation set</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Model comparison</td>
<td style="text-align: left;">Repeated CV</td>
<td style="text-align: left;">Stable comparison metrics</td>
</tr>
<tr class="even">
<td style="text-align: left;">Uncertainty estimation</td>
<td style="text-align: left;">Bootstrap</td>
<td style="text-align: left;">Confidence intervals and distributions</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="common-pitfalls-and-best-practices" class="level2">
<h2 class="anchored" data-anchor-id="common-pitfalls-and-best-practices">Common Pitfalls and Best Practices</h2>
<section id="pitfall-1-data-leakage" class="level3">
<h3 class="anchored" data-anchor-id="pitfall-1-data-leakage">Pitfall 1: Data Leakage</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Preprocessing before splitting</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>wrong_data <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This uses information from ALL data including test!</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>],</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>wrong_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(wrong_data)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>wrong_train <span class="ot">&lt;-</span> <span class="fu">training</span>(wrong_split)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>wrong_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(wrong_split)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Preprocessing after splitting (using recipes)</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>right_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>right_train <span class="ot">&lt;-</span> <span class="fu">training</span>(right_split)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>right_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(right_split)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>right_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> right_train) <span class="sc">%&gt;%</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The recipe learns parameters only from training data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pitfall-2-multiple-testing-on-test-set" class="level3">
<h3 class="anchored" data-anchor-id="pitfall-2-multiple-testing-on-test-set">Pitfall 2: Multiple Testing on Test Set</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Using test set multiple times</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This is pseudocode - don't actually do this!</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># for (model in models) {</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   performance &lt;- evaluate(model, test_set)</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (performance &lt; best_performance) {</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     adjust_model(model)</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Testing again - overfitting to test set!</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Use validation set or CV for model selection</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Test set only for final evaluation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pitfall-3-improper-stratification" class="level3">
<h3 class="anchored" data-anchor-id="pitfall-3-improper-stratification">Pitfall 3: Improper Stratification</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with important subgroups</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>grouped_data <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">price_category =</span> <span class="fu">cut</span>(Sale_Price, </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">breaks =</span> <span class="fu">quantile</span>(Sale_Price, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.33</span>, <span class="fl">0.67</span>, <span class="dv">1</span>)),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"Medium"</span>, <span class="st">"High"</span>))</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Not stratifying on important variable</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>wrong_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(grouped_data)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>wrong_train <span class="ot">&lt;-</span> <span class="fu">training</span>(wrong_split)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Stratify to preserve distribution</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>right_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(grouped_data, <span class="at">strata =</span> price_category)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>right_train <span class="ot">&lt;-</span> <span class="fu">training</span>(right_split)</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare distributions</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  grouped_data <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"Original"</span>),</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  wrong_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"No Stratification"</span>),</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  right_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"With Stratification"</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Set) <span class="sc">%&gt;%</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Percentage =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(comparison, <span class="fu">aes</span>(<span class="at">x =</span> price_category, <span class="at">y =</span> Percentage, <span class="at">fill =</span> Set)) <span class="sc">+</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Stratification on Distribution"</span>,</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stratification preserves the original distribution"</span>,</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Price Category"</span>, <span class="at">y =</span> <span class="st">"Percentage"</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="exercise-1-implement-custom-resampling" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-implement-custom-resampling">Exercise 1: Implement Custom Resampling</h3>
<p>Create a custom resampling strategy for grouped data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Data with natural groups (e.g., different stores)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>store_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">store_id =</span> <span class="fu">rep</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">each =</span> <span class="dv">100</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>), <span class="at">length.out =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">10</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">190</span>, <span class="dv">10</span>), <span class="at">each =</span> <span class="dv">100</span>), <span class="at">sd =</span> <span class="dv">20</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom group-based CV: leave-one-store-out</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>group_splits <span class="ot">&lt;-</span> <span class="fu">group_vfold_cv</span>(store_data, <span class="at">group =</span> store_id)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine splits</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>split_summary <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(group_splits<span class="sc">$</span>splits), <span class="cf">function</span>(i) {</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  split <span class="ot">&lt;-</span> group_splits<span class="sc">$</span>splits[[i]]</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  train <span class="ot">&lt;-</span> <span class="fu">analysis</span>(split)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">assessment</span>(split)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">fold =</span> i,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_stores =</span> <span class="fu">n_distinct</span>(train<span class="sc">$</span>store_id),</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_stores =</span> <span class="fu">n_distinct</span>(test<span class="sc">$</span>store_id),</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_rows =</span> <span class="fu">nrow</span>(train),</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_rows =</span> <span class="fu">nrow</span>(test)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(split_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">fold</th>
<th style="text-align: right;">train_stores</th>
<th style="text-align: right;">test_stores</th>
<th style="text-align: right;">train_rows</th>
<th style="text-align: right;">test_rows</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">900</td>
<td style="text-align: right;">100</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="exercise-2-compare-resampling-strategies" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-compare-resampling-strategies">Exercise 2: Compare Resampling Strategies</h3>
<p>Evaluate different resampling methods on the same dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a subset of Ames data for speed</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>ames_subset <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Gr_Liv_Area, Overall_Cond, Year_Built, Lot_Area) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">500</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define resampling strategies</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">holdout =</span> <span class="fu">initial_split</span>(ames_subset, <span class="at">prop =</span> <span class="fl">0.75</span>),</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv5 =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv10 =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">10</span>),</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">repeated_cv =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">3</span>),</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="fu">bootstraps</span>(ames_subset, <span class="at">times =</span> <span class="dv">25</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple model for comparison</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>recipe_spec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_subset)</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate each strategy (except holdout which needs different handling)</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(strategy_name) {</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(recipe_spec) <span class="sc">%&gt;%</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(wf, strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize results</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Resampling Strategies"</span>,</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Error bars show standard error"</span>,</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Strategy"</span>, <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-time-series-validation" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-time-series-validation">Exercise 3: Time Series Validation</h3>
<p>Implement proper time series validation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate time series data with trend and seasonality</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>ts_exercise <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">day_of_week =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">1000</span>, <span class="dv">2000</span>, <span class="at">length.out =</span> <span class="fu">length</span>(date)),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">weekly =</span> <span class="dv">50</span> <span class="sc">*</span> (day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)),  <span class="co"># Weekend effect</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(date), <span class="dv">0</span>, <span class="dv">50</span>),</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time-based splits</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial training: 2 years, assess: 1 month, skip: 1 month</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>ts_splits <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  ts_exercise,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial =</span> <span class="dv">730</span>,  <span class="co"># 2 years</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess =</span> <span class="dv">30</span>,    <span class="co"># 1 month</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip =</span> <span class="dv">30</span>,      <span class="co"># Skip 1 month</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">cumulative =</span> <span class="cn">FALSE</span>  <span class="co"># Sliding window</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate a simple model</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>ts_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(sales <span class="sc">~</span> day_of_week <span class="sc">+</span> month <span class="sc">+</span> trend, <span class="at">data =</span> ts_exercise)</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>ts_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>ts_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ts_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ts_model)</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>ts_results <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  ts_workflow,</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  ts_splits,</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine performance over time</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>ts_metrics <span class="ot">&lt;-</span> ts_results <span class="sc">%&gt;%</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">split_num =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">n</span>()<span class="sc">/</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ts_metrics, <span class="fu">aes</span>(<span class="at">x =</span> split_num, <span class="at">y =</span> mean, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance Over Time"</span>,</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Time series cross-validation results"</span>,</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Split Number (Time →)"</span>, <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-data-splitting_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this comprehensive chapter, you’ve mastered:</p>
<p>✅ <strong>Fundamental concepts</strong> - Why proper data splitting is critical - The bias-variance tradeoff in evaluation - Training, validation, and test sets</p>
<p>✅ <strong>Splitting strategies</strong> - Simple holdout splits - Stratified sampling for balance - Multi-level splits for complex workflows</p>
<p>✅ <strong>Cross-validation techniques</strong> - K-fold and repeated CV - Leave-one-out CV - Time series CV</p>
<p>✅ <strong>Advanced methods</strong> - Bootstrap resampling - Nested resampling for tuning - Group-based splitting</p>
<p>✅ <strong>Best practices</strong> - Avoiding data leakage - Choosing appropriate strategies - Proper use of test sets</p>
<p>Key takeaways: - Never evaluate on training data - Choose resampling based on your data and goals - Stratify when you have imbalanced data - Respect temporal ordering in time series - Use nested CV for unbiased tuning - Touch the test set only once!</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>In <a href="./10-feature-engineering.html">Chapter 10</a>, we’ll explore feature engineering with recipes, learning how to transform raw data into model-ready features.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="https://rsample.tidymodels.org/">rsample Documentation</a></li>
<li><a href="https://stats.stackexchange.com/questions/65128/">Cross-Validation: The Right and Wrong Way</a></li>
<li><a href="https://www.tidymodels.org/learn/work/nested-resampling/">Nested Resampling Tutorial</a></li>
<li><a href="https://otexts.com/fpp3/tscv.html">Time Series Cross-Validation</a></li>
<li><a href="https://www.cambridge.org/core/books/bootstrap-methods-and-their-application/">Bootstrap Methods and Their Application</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all elements with class 'quarto-title-meta-heading' that contain "Author"
    const authorHeadings = document.querySelectorAll('.quarto-title-meta-heading');
    
    authorHeadings.forEach(function(heading) {
        if (heading.textContent.trim() === 'Author') {
            heading.textContent = 'Authors';
        }
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb52" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 9: Data Splitting and Resampling - The Foundation of Model Validation"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "David Sarrat González, Juan R González"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will master:</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The critical importance of proper data splitting</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Train/test/validation splits and when to use them</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stratified sampling for balanced splits</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cross-validation techniques and theory</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Bootstrap methods for uncertainty estimation</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Time series splitting strategies</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nested resampling for unbiased evaluation</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Best practices and common pitfalls</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Data Splitting Matters</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>Imagine you're studying for an exam. If you only practice with questions you've already seen and memorized the answers to, you might think you understand the material perfectly. But when you face new questions on the actual exam, you realize you've only memorized specific answers rather than understanding the concepts. This is exactly what happens in machine learning when we don't properly split our data.</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Fundamental Problem: Overfitting</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>When we train a model on data and evaluate it on the same data, we get an overly optimistic estimate of performance. The model has essentially "memorized" the training data, including its noise and peculiarities.</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate overfitting with a simple example</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>simple_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> n),</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> <span class="dv">2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="dv">5</span>,  <span class="co"># True relationship</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="at">sd =</span> <span class="dv">3</span>)  <span class="co"># Add noise</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit increasingly complex models</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear =</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> simple_data),</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">poly5 =</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">5</span>), <span class="at">data =</span> simple_data),</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">poly15 =</span> <span class="fu">lm</span>(y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">15</span>), <span class="at">data =</span> simple_data)</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate training error (biased!)</span></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>training_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="sc">~</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(<span class="fu">residuals</span>(.)<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate new test data</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>),</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> <span class="dv">2</span> <span class="sc">*</span> x <span class="sc">+</span> <span class="dv">5</span>,</span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">3</span>)</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate test error (unbiased)</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>test_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="sc">~</span> {</span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(., <span class="at">newdata =</span> test_data)</span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_data<span class="sc">$</span>y <span class="sc">-</span> predictions)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare errors</span></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>error_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Linear"</span>, <span class="st">"Polynomial (5)"</span>, <span class="st">"Polynomial (15)"</span>),</span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Training RMSE</span><span class="st">`</span> <span class="ot">=</span> training_errors,</span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Test RMSE</span><span class="st">`</span> <span class="ot">=</span> test_errors,</span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Overfit Amount</span><span class="st">`</span> <span class="ot">=</span> test_errors <span class="sc">-</span> training_errors</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(error_comparison, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the fits</span></span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> simple_data <span class="sc">%&gt;%</span></span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">linear =</span> <span class="fu">predict</span>(models<span class="sc">$</span>linear),</span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">poly5 =</span> <span class="fu">predict</span>(models<span class="sc">$</span>poly5),</span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">poly15 =</span> <span class="fu">predict</span>(models<span class="sc">$</span>poly15)</span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> linear, <span class="at">color =</span> <span class="st">"Linear"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> poly5, <span class="at">color =</span> <span class="st">"Poly(5)"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> poly15, <span class="at">color =</span> <span class="st">"Poly(15)"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Linear"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Poly(5)"</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">"Poly(15)"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Complexity and Overfitting"</span>,</span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Complex models fit training data better but may generalize worse"</span>,</span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"X"</span>, <span class="at">y =</span> <span class="st">"Y"</span>, <span class="at">color =</span> <span class="st">"Model"</span></span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a>Notice how the complex polynomial model (degree 15) has lower training error but higher test error - classic overfitting! This is why we need proper data splitting strategies.</span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Train/Test Split</span></span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a>The simplest approach is to split data into training and testing sets. The training set is used to fit the model, and the test set provides an unbiased estimate of performance on new data.</span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a><span class="fu">### Basic Splitting with rsample</span></span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>The <span class="in">`rsample`</span> package provides powerful tools for data splitting:</span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the Ames housing data</span></span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic 75/25 split</span></span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the datasets</span></span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the sizes</span></span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a>split_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Original"</span>, <span class="st">"Training"</span>, <span class="st">"Testing"</span>),</span>
<span id="cb52-135"><a href="#cb52-135" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of Rows</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(ames), <span class="fu">nrow</span>(ames_train), <span class="fu">nrow</span>(ames_test)),</span>
<span id="cb52-136"><a href="#cb52-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percentage =</span> <span class="fu">c</span>(<span class="dv">100</span>, </span>
<span id="cb52-137"><a href="#cb52-137" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">nrow</span>(ames_train) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb52-138"><a href="#cb52-138" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">nrow</span>(ames_test) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb52-139"><a href="#cb52-139" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-140"><a href="#cb52-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-141"><a href="#cb52-141" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(split_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb52-142"><a href="#cb52-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-143"><a href="#cb52-143" aria-hidden="true" tabindex="-1"></a><span class="co"># The split object contains indices</span></span>
<span id="cb52-144"><a href="#cb52-144" aria-hidden="true" tabindex="-1"></a>ames_split</span>
<span id="cb52-145"><a href="#cb52-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-146"><a href="#cb52-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-147"><a href="#cb52-147" aria-hidden="true" tabindex="-1"></a>The <span class="in">`initial_split()`</span> function doesn't just randomly split the data - it's designed with several important features:</span>
<span id="cb52-148"><a href="#cb52-148" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reproducible with set.seed()</span>
<span id="cb52-149"><a href="#cb52-149" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Maintains data structure</span>
<span id="cb52-150"><a href="#cb52-150" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Can do stratified sampling</span>
<span id="cb52-151"><a href="#cb52-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Preserves data types</span>
<span id="cb52-152"><a href="#cb52-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-153"><a href="#cb52-153" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stratified Sampling</span></span>
<span id="cb52-154"><a href="#cb52-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-155"><a href="#cb52-155" aria-hidden="true" tabindex="-1"></a>When you have imbalanced classes or want to ensure representative splits, use stratified sampling:</span>
<span id="cb52-156"><a href="#cb52-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-159"><a href="#cb52-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-160"><a href="#cb52-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification example with imbalanced classes</span></span>
<span id="cb52-161"><a href="#cb52-161" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb52-162"><a href="#cb52-162" aria-hidden="true" tabindex="-1"></a>imbalanced_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-163"><a href="#cb52-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature1 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb52-164"><a href="#cb52-164" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature2 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb52-165"><a href="#cb52-165" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Common"</span>, <span class="dv">900</span>), <span class="fu">rep</span>(<span class="st">"Rare"</span>, <span class="dv">100</span>)))</span>
<span id="cb52-166"><a href="#cb52-166" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-167"><a href="#cb52-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-168"><a href="#cb52-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Regular split (might not preserve class balance)</span></span>
<span id="cb52-169"><a href="#cb52-169" aria-hidden="true" tabindex="-1"></a>regular_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(imbalanced_data, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb52-170"><a href="#cb52-170" aria-hidden="true" tabindex="-1"></a>regular_train <span class="ot">&lt;-</span> <span class="fu">training</span>(regular_split)</span>
<span id="cb52-171"><a href="#cb52-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-172"><a href="#cb52-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified split (preserves class balance)</span></span>
<span id="cb52-173"><a href="#cb52-173" aria-hidden="true" tabindex="-1"></a>stratified_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(imbalanced_data, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> class)</span>
<span id="cb52-174"><a href="#cb52-174" aria-hidden="true" tabindex="-1"></a>stratified_train <span class="ot">&lt;-</span> <span class="fu">training</span>(stratified_split)</span>
<span id="cb52-175"><a href="#cb52-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-176"><a href="#cb52-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare class distributions</span></span>
<span id="cb52-177"><a href="#cb52-177" aria-hidden="true" tabindex="-1"></a>distribution_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb52-178"><a href="#cb52-178" aria-hidden="true" tabindex="-1"></a>  imbalanced_data <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Original"</span>),</span>
<span id="cb52-179"><a href="#cb52-179" aria-hidden="true" tabindex="-1"></a>  regular_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Regular Split"</span>),</span>
<span id="cb52-180"><a href="#cb52-180" aria-hidden="true" tabindex="-1"></a>  stratified_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Dataset =</span> <span class="st">"Stratified Split"</span>)</span>
<span id="cb52-181"><a href="#cb52-181" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-182"><a href="#cb52-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Dataset) <span class="sc">%&gt;%</span></span>
<span id="cb52-183"><a href="#cb52-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Percentage =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb52-184"><a href="#cb52-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-185"><a href="#cb52-185" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(distribution_comparison, <span class="fu">aes</span>(<span class="at">x =</span> Dataset, <span class="at">y =</span> Percentage, <span class="at">fill =</span> class)) <span class="sc">+</span></span>
<span id="cb52-186"><a href="#cb52-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb52-187"><a href="#cb52-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Common"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Rare"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb52-188"><a href="#cb52-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-189"><a href="#cb52-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Class Distribution: Regular vs Stratified Splitting"</span>,</span>
<span id="cb52-190"><a href="#cb52-190" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stratified sampling preserves class proportions"</span>,</span>
<span id="cb52-191"><a href="#cb52-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage (%)"</span></span>
<span id="cb52-192"><a href="#cb52-192" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-193"><a href="#cb52-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">90</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb52-194"><a href="#cb52-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-195"><a href="#cb52-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-196"><a href="#cb52-196" aria-hidden="true" tabindex="-1"></a>Stratified sampling is crucial for:</span>
<span id="cb52-197"><a href="#cb52-197" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Classification with imbalanced classes</span>
<span id="cb52-198"><a href="#cb52-198" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Regression with skewed target distributions</span>
<span id="cb52-199"><a href="#cb52-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Ensuring all groups are represented in both sets</span>
<span id="cb52-200"><a href="#cb52-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-201"><a href="#cb52-201" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multi-level Splits: Train/Validation/Test</span></span>
<span id="cb52-202"><a href="#cb52-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-203"><a href="#cb52-203" aria-hidden="true" tabindex="-1"></a>Sometimes we need three sets:</span>
<span id="cb52-204"><a href="#cb52-204" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Training**: For model fitting</span>
<span id="cb52-205"><a href="#cb52-205" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Validation**: For hyperparameter tuning</span>
<span id="cb52-206"><a href="#cb52-206" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Test**: For final, unbiased evaluation</span>
<span id="cb52-207"><a href="#cb52-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-210"><a href="#cb52-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-211"><a href="#cb52-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Create initial split</span></span>
<span id="cb52-212"><a href="#cb52-212" aria-hidden="true" tabindex="-1"></a>initial_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb52-213"><a href="#cb52-213" aria-hidden="true" tabindex="-1"></a>train_val <span class="ot">&lt;-</span> <span class="fu">training</span>(initial_split)</span>
<span id="cb52-214"><a href="#cb52-214" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">testing</span>(initial_split)</span>
<span id="cb52-215"><a href="#cb52-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-216"><a href="#cb52-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Split training into train/validation</span></span>
<span id="cb52-217"><a href="#cb52-217" aria-hidden="true" tabindex="-1"></a>train_val_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(train_val, <span class="at">prop =</span> <span class="fl">0.75</span>)</span>
<span id="cb52-218"><a href="#cb52-218" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">training</span>(train_val_split)</span>
<span id="cb52-219"><a href="#cb52-219" aria-hidden="true" tabindex="-1"></a>validation <span class="ot">&lt;-</span> <span class="fu">testing</span>(train_val_split)</span>
<span id="cb52-220"><a href="#cb52-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-221"><a href="#cb52-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of three-way split</span></span>
<span id="cb52-222"><a href="#cb52-222" aria-hidden="true" tabindex="-1"></a>three_way_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-223"><a href="#cb52-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Validation"</span>, <span class="st">"Test"</span>, <span class="st">"Total"</span>),</span>
<span id="cb52-224"><a href="#cb52-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">Rows =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(train), <span class="fu">nrow</span>(validation), <span class="fu">nrow</span>(test), <span class="fu">nrow</span>(ames)),</span>
<span id="cb52-225"><a href="#cb52-225" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Percentage of Total</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb52-226"><a href="#cb52-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(train) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb52-227"><a href="#cb52-227" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(validation) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb52-228"><a href="#cb52-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(test) <span class="sc">/</span> <span class="fu">nrow</span>(ames) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb52-229"><a href="#cb52-229" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb52-230"><a href="#cb52-230" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-231"><a href="#cb52-231" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-232"><a href="#cb52-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-233"><a href="#cb52-233" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(three_way_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb52-234"><a href="#cb52-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-235"><a href="#cb52-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative: Use initial_validation_split (tidymodels 1.1.0+)</span></span>
<span id="cb52-236"><a href="#cb52-236" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates all three splits at once</span></span>
<span id="cb52-237"><a href="#cb52-237" aria-hidden="true" tabindex="-1"></a><span class="co"># val_split &lt;- initial_validation_split(ames, prop = c(0.6, 0.2))</span></span>
<span id="cb52-238"><a href="#cb52-238" aria-hidden="true" tabindex="-1"></a><span class="co"># This would give: 60% train, 20% validation, 20% test</span></span>
<span id="cb52-239"><a href="#cb52-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-240"><a href="#cb52-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-241"><a href="#cb52-241" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross-Validation: Making the Most of Your Data</span></span>
<span id="cb52-242"><a href="#cb52-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-243"><a href="#cb52-243" aria-hidden="true" tabindex="-1"></a>While train/test splits are simple, they have limitations:</span>
<span id="cb52-244"><a href="#cb52-244" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Only use part of the data for training</span>
<span id="cb52-245"><a href="#cb52-245" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Results can vary based on the specific split</span>
<span id="cb52-246"><a href="#cb52-246" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>May not be reliable for small datasets</span>
<span id="cb52-247"><a href="#cb52-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-248"><a href="#cb52-248" aria-hidden="true" tabindex="-1"></a>Cross-validation addresses these issues by using multiple splits.</span>
<span id="cb52-249"><a href="#cb52-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-250"><a href="#cb52-250" aria-hidden="true" tabindex="-1"></a><span class="fu">### K-Fold Cross-Validation</span></span>
<span id="cb52-251"><a href="#cb52-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-252"><a href="#cb52-252" aria-hidden="true" tabindex="-1"></a>K-fold CV divides data into k equal parts (folds), trains on k-1 folds, and tests on the remaining fold. This process repeats k times.</span>
<span id="cb52-253"><a href="#cb52-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-256"><a href="#cb52-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-257"><a href="#cb52-257" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 5-fold cross-validation</span></span>
<span id="cb52-258"><a href="#cb52-258" aria-hidden="true" tabindex="-1"></a>ames_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb52-259"><a href="#cb52-259" aria-hidden="true" tabindex="-1"></a>ames_cv</span>
<span id="cb52-260"><a href="#cb52-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-261"><a href="#cb52-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the structure</span></span>
<span id="cb52-262"><a href="#cb52-262" aria-hidden="true" tabindex="-1"></a>first_fold <span class="ot">&lt;-</span> ames_cv<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span>
<span id="cb52-263"><a href="#cb52-263" aria-hidden="true" tabindex="-1"></a><span class="fu">analysis</span>(first_fold) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()  <span class="co"># Training data for this fold</span></span>
<span id="cb52-264"><a href="#cb52-264" aria-hidden="true" tabindex="-1"></a><span class="fu">assessment</span>(first_fold) <span class="sc">%&gt;%</span> <span class="fu">nrow</span>()  <span class="co"># Test data for this fold</span></span>
<span id="cb52-265"><a href="#cb52-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-266"><a href="#cb52-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize how data is split across folds</span></span>
<span id="cb52-267"><a href="#cb52-267" aria-hidden="true" tabindex="-1"></a>fold_assignments <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(fold) {</span>
<span id="cb52-268"><a href="#cb52-268" aria-hidden="true" tabindex="-1"></a>  assessment_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(ames_cv<span class="sc">$</span>splits[[fold]]<span class="sc">$</span>in_id <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb52-269"><a href="#cb52-269" aria-hidden="true" tabindex="-1"></a>  ames_train <span class="sc">%&gt;%</span></span>
<span id="cb52-270"><a href="#cb52-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb52-271"><a href="#cb52-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">row_id =</span> <span class="fu">row_number</span>(),</span>
<span id="cb52-272"><a href="#cb52-272" aria-hidden="true" tabindex="-1"></a>      <span class="at">fold =</span> fold,</span>
<span id="cb52-273"><a href="#cb52-273" aria-hidden="true" tabindex="-1"></a>      <span class="at">in_assessment =</span> row_id <span class="sc">%in%</span> assessment_rows</span>
<span id="cb52-274"><a href="#cb52-274" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-275"><a href="#cb52-275" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb52-276"><a href="#cb52-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(row_id <span class="sc">&lt;=</span> <span class="dv">100</span>)  <span class="co"># Show first 100 rows for visualization</span></span>
<span id="cb52-277"><a href="#cb52-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-278"><a href="#cb52-278" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fold_assignments, <span class="fu">aes</span>(<span class="at">x =</span> row_id, <span class="at">y =</span> <span class="fu">factor</span>(fold), <span class="at">fill =</span> in_assessment)) <span class="sc">+</span></span>
<span id="cb52-279"><a href="#cb52-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">height =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb52-280"><a href="#cb52-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"coral"</span>),</span>
<span id="cb52-281"><a href="#cb52-281" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Testing"</span>)) <span class="sc">+</span></span>
<span id="cb52-282"><a href="#cb52-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-283"><a href="#cb52-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"5-Fold Cross-Validation Data Assignment"</span>,</span>
<span id="cb52-284"><a href="#cb52-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each row is used for testing exactly once"</span>,</span>
<span id="cb52-285"><a href="#cb52-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Observation ID"</span>, <span class="at">y =</span> <span class="st">"Fold"</span>, <span class="at">fill =</span> <span class="st">"Role"</span></span>
<span id="cb52-286"><a href="#cb52-286" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-287"><a href="#cb52-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-288"><a href="#cb52-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-289"><a href="#cb52-289" aria-hidden="true" tabindex="-1"></a>The mathematics of cross-validation:</span>
<span id="cb52-290"><a href="#cb52-290" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each observation is used for testing exactly once</span>
<span id="cb52-291"><a href="#cb52-291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each observation is used for training k-1 times</span>
<span id="cb52-292"><a href="#cb52-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We get k performance estimates</span>
<span id="cb52-293"><a href="#cb52-293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Final estimate is the average across folds</span>
<span id="cb52-294"><a href="#cb52-294" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Standard error provides uncertainty estimate</span>
<span id="cb52-295"><a href="#cb52-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-296"><a href="#cb52-296" aria-hidden="true" tabindex="-1"></a><span class="fu">### Repeated Cross-Validation</span></span>
<span id="cb52-297"><a href="#cb52-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-298"><a href="#cb52-298" aria-hidden="true" tabindex="-1"></a>For more stable estimates, we can repeat the CV process with different random splits:</span>
<span id="cb52-299"><a href="#cb52-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-302"><a href="#cb52-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-303"><a href="#cb52-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeated 5-fold CV (3 repeats = 15 total resamples)</span></span>
<span id="cb52-304"><a href="#cb52-304" aria-hidden="true" tabindex="-1"></a>ames_repeated_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">3</span>)</span>
<span id="cb52-305"><a href="#cb52-305" aria-hidden="true" tabindex="-1"></a>ames_repeated_cv</span>
<span id="cb52-306"><a href="#cb52-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-307"><a href="#cb52-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variability: single vs repeated CV</span></span>
<span id="cb52-308"><a href="#cb52-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a simple model to demonstrate</span></span>
<span id="cb52-309"><a href="#cb52-309" aria-hidden="true" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-310"><a href="#cb52-310" aria-hidden="true" tabindex="-1"></a>simple_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond, <span class="at">data =</span> ames_train)</span>
<span id="cb52-311"><a href="#cb52-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-312"><a href="#cb52-312" aria-hidden="true" tabindex="-1"></a><span class="co"># Single CV</span></span>
<span id="cb52-313"><a href="#cb52-313" aria-hidden="true" tabindex="-1"></a>single_cv_results <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-314"><a href="#cb52-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb52-315"><a href="#cb52-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-316"><a href="#cb52-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(<span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-317"><a href="#cb52-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb52-318"><a href="#cb52-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-319"><a href="#cb52-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeated CV</span></span>
<span id="cb52-320"><a href="#cb52-320" aria-hidden="true" tabindex="-1"></a>repeated_cv_results <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-321"><a href="#cb52-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb52-322"><a href="#cb52-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-323"><a href="#cb52-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(ames_repeated_cv) <span class="sc">%&gt;%</span></span>
<span id="cb52-324"><a href="#cb52-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb52-325"><a href="#cb52-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-326"><a href="#cb52-326" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb52-327"><a href="#cb52-327" aria-hidden="true" tabindex="-1"></a>  single_cv_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Single 5-fold CV"</span>),</span>
<span id="cb52-328"><a href="#cb52-328" aria-hidden="true" tabindex="-1"></a>  repeated_cv_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Method =</span> <span class="st">"Repeated 5-fold CV (3x)"</span>)</span>
<span id="cb52-329"><a href="#cb52-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-330"><a href="#cb52-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-331"><a href="#cb52-331" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(comparison, <span class="fu">aes</span>(<span class="at">x =</span> Method, <span class="at">y =</span> mean, <span class="at">fill =</span> Method)) <span class="sc">+</span></span>
<span id="cb52-332"><a href="#cb52-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb52-333"><a href="#cb52-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb52-334"><a href="#cb52-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb52-335"><a href="#cb52-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-336"><a href="#cb52-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Single vs Repeated Cross-Validation"</span>,</span>
<span id="cb52-337"><a href="#cb52-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Repeated CV has smaller standard errors (more stable estimates)"</span>,</span>
<span id="cb52-338"><a href="#cb52-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb52-339"><a href="#cb52-339" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-340"><a href="#cb52-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-341"><a href="#cb52-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-342"><a href="#cb52-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-343"><a href="#cb52-343" aria-hidden="true" tabindex="-1"></a><span class="fu">### Leave-One-Out Cross-Validation (LOOCV)</span></span>
<span id="cb52-344"><a href="#cb52-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-345"><a href="#cb52-345" aria-hidden="true" tabindex="-1"></a>LOOCV is a special case where k = n (number of observations):</span>
<span id="cb52-346"><a href="#cb52-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-349"><a href="#cb52-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-350"><a href="#cb52-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a small dataset for LOOCV demonstration</span></span>
<span id="cb52-351"><a href="#cb52-351" aria-hidden="true" tabindex="-1"></a>small_data <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span> </span>
<span id="cb52-352"><a href="#cb52-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">50</span>)  <span class="co"># LOOCV is computationally expensive</span></span>
<span id="cb52-353"><a href="#cb52-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-354"><a href="#cb52-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Create LOOCV splits</span></span>
<span id="cb52-355"><a href="#cb52-355" aria-hidden="true" tabindex="-1"></a>loocv_splits <span class="ot">&lt;-</span> <span class="fu">loo_cv</span>(small_data)</span>
<span id="cb52-356"><a href="#cb52-356" aria-hidden="true" tabindex="-1"></a>loocv_splits</span>
<span id="cb52-357"><a href="#cb52-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-358"><a href="#cb52-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare computational cost</span></span>
<span id="cb52-359"><a href="#cb52-359" aria-hidden="true" tabindex="-1"></a>cv_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-360"><a href="#cb52-360" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"5-fold CV"</span>, <span class="st">"10-fold CV"</span>, <span class="st">"LOOCV"</span>),</span>
<span id="cb52-361"><a href="#cb52-361" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Number of Models</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="fu">nrow</span>(small_data)),</span>
<span id="cb52-362"><a href="#cb52-362" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Training Set Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb52-363"><a href="#cb52-363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">*</span> <span class="dv">4</span><span class="sc">/</span><span class="dv">5</span>),</span>
<span id="cb52-364"><a href="#cb52-364" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">*</span> <span class="dv">9</span><span class="sc">/</span><span class="dv">10</span>),</span>
<span id="cb52-365"><a href="#cb52-365" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(small_data) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb52-366"><a href="#cb52-366" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-367"><a href="#cb52-367" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Test Set Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb52-368"><a href="#cb52-368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">/</span> <span class="dv">5</span>),</span>
<span id="cb52-369"><a href="#cb52-369" aria-hidden="true" tabindex="-1"></a>    <span class="fu">floor</span>(<span class="fu">nrow</span>(small_data) <span class="sc">/</span> <span class="dv">10</span>),</span>
<span id="cb52-370"><a href="#cb52-370" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb52-371"><a href="#cb52-371" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-372"><a href="#cb52-372" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-373"><a href="#cb52-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-374"><a href="#cb52-374" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(cv_comparison)</span>
<span id="cb52-375"><a href="#cb52-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-376"><a href="#cb52-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-377"><a href="#cb52-377" aria-hidden="true" tabindex="-1"></a>LOOCV characteristics:</span>
<span id="cb52-378"><a href="#cb52-378" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Pros**: Uses maximum data for training, deterministic (no randomness)</span>
<span id="cb52-379"><a href="#cb52-379" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Cons**: Computationally expensive, high variance, can overfit to the dataset</span>
<span id="cb52-380"><a href="#cb52-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-381"><a href="#cb52-381" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bootstrap Methods</span></span>
<span id="cb52-382"><a href="#cb52-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-383"><a href="#cb52-383" aria-hidden="true" tabindex="-1"></a>Bootstrap resampling draws samples WITH replacement from the original data. This creates datasets of the same size but with some observations repeated and others omitted.</span>
<span id="cb52-384"><a href="#cb52-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-385"><a href="#cb52-385" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Bootstrap</span></span>
<span id="cb52-386"><a href="#cb52-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-389"><a href="#cb52-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-390"><a href="#cb52-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bootstrap samples</span></span>
<span id="cb52-391"><a href="#cb52-391" aria-hidden="true" tabindex="-1"></a>ames_boot <span class="ot">&lt;-</span> <span class="fu">bootstraps</span>(ames_train, <span class="at">times =</span> <span class="dv">25</span>)</span>
<span id="cb52-392"><a href="#cb52-392" aria-hidden="true" tabindex="-1"></a>ames_boot</span>
<span id="cb52-393"><a href="#cb52-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-394"><a href="#cb52-394" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine one bootstrap sample</span></span>
<span id="cb52-395"><a href="#cb52-395" aria-hidden="true" tabindex="-1"></a>first_boot <span class="ot">&lt;-</span> ames_boot<span class="sc">$</span>splits[[<span class="dv">1</span>]]</span>
<span id="cb52-396"><a href="#cb52-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-397"><a href="#cb52-397" aria-hidden="true" tabindex="-1"></a><span class="co"># In bootstrap, some observations appear multiple times</span></span>
<span id="cb52-398"><a href="#cb52-398" aria-hidden="true" tabindex="-1"></a>boot_sample <span class="ot">&lt;-</span> <span class="fu">analysis</span>(first_boot)</span>
<span id="cb52-399"><a href="#cb52-399" aria-hidden="true" tabindex="-1"></a>original_ids <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ames_train)</span>
<span id="cb52-400"><a href="#cb52-400" aria-hidden="true" tabindex="-1"></a>sampled_ids <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">rownames</span>(boot_sample))</span>
<span id="cb52-401"><a href="#cb52-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-402"><a href="#cb52-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Count frequency of observations</span></span>
<span id="cb52-403"><a href="#cb52-403" aria-hidden="true" tabindex="-1"></a>id_frequency <span class="ot">&lt;-</span> <span class="fu">table</span>(sampled_ids)</span>
<span id="cb52-404"><a href="#cb52-404" aria-hidden="true" tabindex="-1"></a>freq_summary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-405"><a href="#cb52-405" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Times Sampled</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span><span class="sc">:</span><span class="fu">max</span>(id_frequency),</span>
<span id="cb52-406"><a href="#cb52-406" aria-hidden="true" tabindex="-1"></a>  <span class="at">Count =</span> <span class="fu">c</span>(</span>
<span id="cb52-407"><a href="#cb52-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span>(original_ids <span class="sc">%in%</span> sampled_ids)),  <span class="co"># Not sampled (0 times)</span></span>
<span id="cb52-408"><a href="#cb52-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(id_frequency), <span class="cf">function</span>(x) <span class="fu">sum</span>(id_frequency <span class="sc">==</span> x))</span>
<span id="cb52-409"><a href="#cb52-409" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-410"><a href="#cb52-410" aria-hidden="true" tabindex="-1"></a>  <span class="at">Percentage =</span> Count <span class="sc">/</span> <span class="fu">nrow</span>(ames_train) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb52-411"><a href="#cb52-411" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-412"><a href="#cb52-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-413"><a href="#cb52-413" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(freq_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb52-414"><a href="#cb52-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-415"><a href="#cb52-415" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize bootstrap sampling</span></span>
<span id="cb52-416"><a href="#cb52-416" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb52-417"><a href="#cb52-417" aria-hidden="true" tabindex="-1"></a>sample_viz <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-418"><a href="#cb52-418" aria-hidden="true" tabindex="-1"></a>  <span class="at">original_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,</span>
<span id="cb52-419"><a href="#cb52-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap_sample =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">20</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-420"><a href="#cb52-420" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-421"><a href="#cb52-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(bootstrap_sample) <span class="sc">%&gt;%</span></span>
<span id="cb52-422"><a href="#cb52-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(<span class="at">bootstrap_sample =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="dv">0</span>))</span>
<span id="cb52-423"><a href="#cb52-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-424"><a href="#cb52-424" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sample_viz, <span class="fu">aes</span>(<span class="at">x =</span> bootstrap_sample, <span class="at">y =</span> n)) <span class="sc">+</span></span>
<span id="cb52-425"><a href="#cb52-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb52-426"><a href="#cb52-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb52-427"><a href="#cb52-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb52-428"><a href="#cb52-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-429"><a href="#cb52-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Bootstrap Sampling Example (n=20)"</span>,</span>
<span id="cb52-430"><a href="#cb52-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Some observations appear multiple times, others not at all"</span>,</span>
<span id="cb52-431"><a href="#cb52-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Original Observation ID"</span>,</span>
<span id="cb52-432"><a href="#cb52-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Times Selected"</span></span>
<span id="cb52-433"><a href="#cb52-433" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-434"><a href="#cb52-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-435"><a href="#cb52-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-436"><a href="#cb52-436" aria-hidden="true" tabindex="-1"></a>The mathematics of bootstrap:</span>
<span id="cb52-437"><a href="#cb52-437" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Probability of being selected at least once: $1 - (1 - 1/n)^n \approx 0.632$ as $n \to \infty$</span>
<span id="cb52-438"><a href="#cb52-438" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>About 37% of observations are not selected (out-of-bag)</span>
<span id="cb52-439"><a href="#cb52-439" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Provides estimates of sampling distribution</span>
<span id="cb52-440"><a href="#cb52-440" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Useful for confidence intervals and bias estimation</span>
<span id="cb52-441"><a href="#cb52-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-442"><a href="#cb52-442" aria-hidden="true" tabindex="-1"></a><span class="fu">### Out-of-Bag (OOB) Error Estimation</span></span>
<span id="cb52-443"><a href="#cb52-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-444"><a href="#cb52-444" aria-hidden="true" tabindex="-1"></a>Bootstrap's unique property is that ~37% of data is not sampled, providing a natural test set:</span>
<span id="cb52-445"><a href="#cb52-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-448"><a href="#cb52-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-449"><a href="#cb52-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate OOB predictions for each bootstrap sample</span></span>
<span id="cb52-450"><a href="#cb52-450" aria-hidden="true" tabindex="-1"></a>oob_analysis <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>, <span class="cf">function</span>(i) {</span>
<span id="cb52-451"><a href="#cb52-451" aria-hidden="true" tabindex="-1"></a>  boot_split <span class="ot">&lt;-</span> ames_boot<span class="sc">$</span>splits[[i]]</span>
<span id="cb52-452"><a href="#cb52-452" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-453"><a href="#cb52-453" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observations in this bootstrap sample</span></span>
<span id="cb52-454"><a href="#cb52-454" aria-hidden="true" tabindex="-1"></a>  in_bag <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">rownames</span>(<span class="fu">analysis</span>(boot_split)))</span>
<span id="cb52-455"><a href="#cb52-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-456"><a href="#cb52-456" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OOB observations</span></span>
<span id="cb52-457"><a href="#cb52-457" aria-hidden="true" tabindex="-1"></a>  all_ids <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ames_train)</span>
<span id="cb52-458"><a href="#cb52-458" aria-hidden="true" tabindex="-1"></a>  oob_ids <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_ids, <span class="fu">unique</span>(in_bag))</span>
<span id="cb52-459"><a href="#cb52-459" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-460"><a href="#cb52-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb52-461"><a href="#cb52-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">bootstrap =</span> i,</span>
<span id="cb52-462"><a href="#cb52-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_unique_in_bag =</span> <span class="fu">length</span>(<span class="fu">unique</span>(in_bag)),</span>
<span id="cb52-463"><a href="#cb52-463" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_oob =</span> <span class="fu">length</span>(oob_ids),</span>
<span id="cb52-464"><a href="#cb52-464" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_oob =</span> <span class="fu">length</span>(oob_ids) <span class="sc">/</span> <span class="fu">length</span>(all_ids) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb52-465"><a href="#cb52-465" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-466"><a href="#cb52-466" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-467"><a href="#cb52-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-468"><a href="#cb52-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb52-469"><a href="#cb52-469" aria-hidden="true" tabindex="-1"></a>oob_summary <span class="ot">&lt;-</span> oob_analysis <span class="sc">%&gt;%</span></span>
<span id="cb52-470"><a href="#cb52-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb52-471"><a href="#cb52-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_pct_oob =</span> <span class="fu">mean</span>(pct_oob),</span>
<span id="cb52-472"><a href="#cb52-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_pct_oob =</span> <span class="fu">sd</span>(pct_oob),</span>
<span id="cb52-473"><a href="#cb52-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">theoretical_oob =</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">exp</span>(<span class="dv">1</span>)) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># ~36.8%</span></span>
<span id="cb52-474"><a href="#cb52-474" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-475"><a href="#cb52-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-476"><a href="#cb52-476" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(oob_summary, <span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb52-477"><a href="#cb52-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-478"><a href="#cb52-478" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize OOB percentages</span></span>
<span id="cb52-479"><a href="#cb52-479" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(oob_analysis, <span class="fu">aes</span>(<span class="at">x =</span> pct_oob)) <span class="sc">+</span></span>
<span id="cb52-480"><a href="#cb52-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">15</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb52-481"><a href="#cb52-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> oob_summary<span class="sc">$</span>theoretical_oob, </span>
<span id="cb52-482"><a href="#cb52-482" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb52-483"><a href="#cb52-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-484"><a href="#cb52-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Out-of-Bag Percentage Across Bootstrap Samples"</span>,</span>
<span id="cb52-485"><a href="#cb52-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red line shows theoretical value (~36.8%)"</span>,</span>
<span id="cb52-486"><a href="#cb52-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"OOB Percentage"</span>,</span>
<span id="cb52-487"><a href="#cb52-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb52-488"><a href="#cb52-488" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-489"><a href="#cb52-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-490"><a href="#cb52-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-491"><a href="#cb52-491" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time Series Splitting</span></span>
<span id="cb52-492"><a href="#cb52-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-493"><a href="#cb52-493" aria-hidden="true" tabindex="-1"></a>Time series data requires special handling because:</span>
<span id="cb52-494"><a href="#cb52-494" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Observations are not independent</span>
<span id="cb52-495"><a href="#cb52-495" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Future cannot be used to predict past</span>
<span id="cb52-496"><a href="#cb52-496" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Temporal patterns must be preserved</span>
<span id="cb52-497"><a href="#cb52-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-498"><a href="#cb52-498" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Series Cross-Validation</span></span>
<span id="cb52-499"><a href="#cb52-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-502"><a href="#cb52-502" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-503"><a href="#cb52-503" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time series data</span></span>
<span id="cb52-504"><a href="#cb52-504" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb52-505"><a href="#cb52-505" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">&lt;-</span> <span class="dv">365</span></span>
<span id="cb52-506"><a href="#cb52-506" aria-hidden="true" tabindex="-1"></a>ts_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-507"><a href="#cb52-507" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>), <span class="at">by =</span> <span class="st">"day"</span>, <span class="at">length.out =</span> n_days),</span>
<span id="cb52-508"><a href="#cb52-508" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="at">length.out =</span> n_days),</span>
<span id="cb52-509"><a href="#cb52-509" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">20</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span>n_days) <span class="sc">/</span> <span class="dv">7</span>),  <span class="co"># Weekly pattern</span></span>
<span id="cb52-510"><a href="#cb52-510" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(n_days, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb52-511"><a href="#cb52-511" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> noise</span>
<span id="cb52-512"><a href="#cb52-512" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-513"><a href="#cb52-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-514"><a href="#cb52-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series split - expanding window</span></span>
<span id="cb52-515"><a href="#cb52-515" aria-hidden="true" tabindex="-1"></a>ts_initial <span class="ot">&lt;-</span> <span class="dv">180</span>  <span class="co"># Initial training size</span></span>
<span id="cb52-516"><a href="#cb52-516" aria-hidden="true" tabindex="-1"></a>ts_assess <span class="ot">&lt;-</span> <span class="dv">30</span>    <span class="co"># Assessment size</span></span>
<span id="cb52-517"><a href="#cb52-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-518"><a href="#cb52-518" aria-hidden="true" tabindex="-1"></a>ts_splits <span class="ot">&lt;-</span> <span class="fu">sliding_period</span>(</span>
<span id="cb52-519"><a href="#cb52-519" aria-hidden="true" tabindex="-1"></a>  ts_data,</span>
<span id="cb52-520"><a href="#cb52-520" aria-hidden="true" tabindex="-1"></a>  date,</span>
<span id="cb52-521"><a href="#cb52-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">period =</span> <span class="st">"month"</span>,</span>
<span id="cb52-522"><a href="#cb52-522" aria-hidden="true" tabindex="-1"></a>  <span class="at">lookback =</span> <span class="dv">5</span>,  <span class="co"># Use 6 months of data</span></span>
<span id="cb52-523"><a href="#cb52-523" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess_stop =</span> <span class="dv">1</span>  <span class="co"># Assess on next month</span></span>
<span id="cb52-524"><a href="#cb52-524" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-525"><a href="#cb52-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-526"><a href="#cb52-526" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize time series CV</span></span>
<span id="cb52-527"><a href="#cb52-527" aria-hidden="true" tabindex="-1"></a>split_viz <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">5</span>, <span class="fu">length</span>(ts_splits<span class="sc">$</span>splits)), <span class="cf">function</span>(i) {</span>
<span id="cb52-528"><a href="#cb52-528" aria-hidden="true" tabindex="-1"></a>  split <span class="ot">&lt;-</span> ts_splits<span class="sc">$</span>splits[[i]]</span>
<span id="cb52-529"><a href="#cb52-529" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> <span class="fu">analysis</span>(split) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">role =</span> <span class="st">"Training"</span>, <span class="at">split_id =</span> i)</span>
<span id="cb52-530"><a href="#cb52-530" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> <span class="fu">assessment</span>(split) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">role =</span> <span class="st">"Testing"</span>, <span class="at">split_id =</span> i)</span>
<span id="cb52-531"><a href="#cb52-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(train_data, test_data)</span>
<span id="cb52-532"><a href="#cb52-532" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-533"><a href="#cb52-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-534"><a href="#cb52-534" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(split_viz, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> split_id, <span class="at">color =</span> role)) <span class="sc">+</span></span>
<span id="cb52-535"><a href="#cb52-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-536"><a href="#cb52-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Testing"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb52-537"><a href="#cb52-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-538"><a href="#cb52-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Time Series Cross-Validation"</span>,</span>
<span id="cb52-539"><a href="#cb52-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Training window slides forward, always predicting future"</span>,</span>
<span id="cb52-540"><a href="#cb52-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Split"</span>, <span class="at">color =</span> <span class="st">"Role"</span></span>
<span id="cb52-541"><a href="#cb52-541" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-542"><a href="#cb52-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb52-543"><a href="#cb52-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-544"><a href="#cb52-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-545"><a href="#cb52-545" aria-hidden="true" tabindex="-1"></a>Time series splitting strategies:</span>
<span id="cb52-546"><a href="#cb52-546" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Expanding window**: Training set grows over time</span>
<span id="cb52-547"><a href="#cb52-547" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sliding window**: Fixed-size training window</span>
<span id="cb52-548"><a href="#cb52-548" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Skip periods**: Gap between training and testing</span>
<span id="cb52-549"><a href="#cb52-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-550"><a href="#cb52-550" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rolling Origin Evaluation</span></span>
<span id="cb52-551"><a href="#cb52-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-554"><a href="#cb52-554" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-555"><a href="#cb52-555" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling origin (expanding window)</span></span>
<span id="cb52-556"><a href="#cb52-556" aria-hidden="true" tabindex="-1"></a>rolling_splits <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(</span>
<span id="cb52-557"><a href="#cb52-557" aria-hidden="true" tabindex="-1"></a>  ts_data,</span>
<span id="cb52-558"><a href="#cb52-558" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial =</span> <span class="dv">180</span>,    <span class="co"># Start with 180 days</span></span>
<span id="cb52-559"><a href="#cb52-559" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess =</span> <span class="dv">30</span>,      <span class="co"># Assess next 30 days</span></span>
<span id="cb52-560"><a href="#cb52-560" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip =</span> <span class="dv">30</span>,        <span class="co"># Skip 30 days between splits</span></span>
<span id="cb52-561"><a href="#cb52-561" aria-hidden="true" tabindex="-1"></a>  <span class="at">cumulative =</span> <span class="cn">TRUE</span> <span class="co"># Expanding window</span></span>
<span id="cb52-562"><a href="#cb52-562" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-563"><a href="#cb52-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-564"><a href="#cb52-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate how training size grows</span></span>
<span id="cb52-565"><a href="#cb52-565" aria-hidden="true" tabindex="-1"></a>rolling_summary <span class="ot">&lt;-</span> rolling_splits <span class="sc">%&gt;%</span></span>
<span id="cb52-566"><a href="#cb52-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-567"><a href="#cb52-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_size =</span> <span class="fu">map_int</span>(splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">analysis</span>(.))),</span>
<span id="cb52-568"><a href="#cb52-568" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_size =</span> <span class="fu">map_int</span>(splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">assessment</span>(.)))</span>
<span id="cb52-569"><a href="#cb52-569" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-570"><a href="#cb52-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, train_size, test_size) <span class="sc">%&gt;%</span></span>
<span id="cb52-571"><a href="#cb52-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">split =</span> <span class="fu">row_number</span>())</span>
<span id="cb52-572"><a href="#cb52-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-573"><a href="#cb52-573" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rolling_summary, <span class="fu">aes</span>(<span class="at">x =</span> split)) <span class="sc">+</span></span>
<span id="cb52-574"><a href="#cb52-574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> train_size, <span class="at">color =</span> <span class="st">"Training"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-575"><a href="#cb52-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> test_size, <span class="at">color =</span> <span class="st">"Testing"</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-576"><a href="#cb52-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>, <span class="st">"Testing"</span> <span class="ot">=</span> <span class="st">"coral"</span>)) <span class="sc">+</span></span>
<span id="cb52-577"><a href="#cb52-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-578"><a href="#cb52-578" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Rolling Origin: Expanding Window"</span>,</span>
<span id="cb52-579"><a href="#cb52-579" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Training set grows while test set remains constant"</span>,</span>
<span id="cb52-580"><a href="#cb52-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Split Number"</span>, <span class="at">y =</span> <span class="st">"Number of Observations"</span>,</span>
<span id="cb52-581"><a href="#cb52-581" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Dataset"</span></span>
<span id="cb52-582"><a href="#cb52-582" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-583"><a href="#cb52-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-584"><a href="#cb52-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-585"><a href="#cb52-585" aria-hidden="true" tabindex="-1"></a><span class="fu">## Nested Resampling</span></span>
<span id="cb52-586"><a href="#cb52-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-587"><a href="#cb52-587" aria-hidden="true" tabindex="-1"></a>When we need to tune hyperparameters AND get an unbiased performance estimate, we use nested resampling:</span>
<span id="cb52-588"><a href="#cb52-588" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Outer loop**: For performance estimation</span>
<span id="cb52-589"><a href="#cb52-589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Inner loop**: For hyperparameter tuning</span>
<span id="cb52-590"><a href="#cb52-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-593"><a href="#cb52-593" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-594"><a href="#cb52-594" aria-hidden="true" tabindex="-1"></a><span class="co"># Create nested resampling</span></span>
<span id="cb52-595"><a href="#cb52-595" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer: 5-fold CV for performance estimation</span></span>
<span id="cb52-596"><a href="#cb52-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Inner: 5-fold CV for hyperparameter tuning</span></span>
<span id="cb52-597"><a href="#cb52-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-598"><a href="#cb52-598" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer resampling</span></span>
<span id="cb52-599"><a href="#cb52-599" aria-hidden="true" tabindex="-1"></a>outer_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb52-600"><a href="#cb52-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-601"><a href="#cb52-601" aria-hidden="true" tabindex="-1"></a><span class="co"># For each outer fold, create inner resampling</span></span>
<span id="cb52-602"><a href="#cb52-602" aria-hidden="true" tabindex="-1"></a>nested_cv <span class="ot">&lt;-</span> <span class="fu">map</span>(outer_cv<span class="sc">$</span>splits, <span class="cf">function</span>(outer_split) {</span>
<span id="cb52-603"><a href="#cb52-603" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Training data for this outer fold</span></span>
<span id="cb52-604"><a href="#cb52-604" aria-hidden="true" tabindex="-1"></a>  outer_train <span class="ot">&lt;-</span> <span class="fu">analysis</span>(outer_split)</span>
<span id="cb52-605"><a href="#cb52-605" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-606"><a href="#cb52-606" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create inner CV on the outer training data</span></span>
<span id="cb52-607"><a href="#cb52-607" aria-hidden="true" tabindex="-1"></a>  inner_cv <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(outer_train, <span class="at">v =</span> <span class="dv">5</span>)</span>
<span id="cb52-608"><a href="#cb52-608" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-609"><a href="#cb52-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb52-610"><a href="#cb52-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">outer_split =</span> outer_split,</span>
<span id="cb52-611"><a href="#cb52-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">inner_cv =</span> inner_cv</span>
<span id="cb52-612"><a href="#cb52-612" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-613"><a href="#cb52-613" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-614"><a href="#cb52-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-615"><a href="#cb52-615" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize nested structure</span></span>
<span id="cb52-616"><a href="#cb52-616" aria-hidden="true" tabindex="-1"></a>nested_viz <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-617"><a href="#cb52-617" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Fold</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb52-618"><a href="#cb52-618" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Training Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">map_int</span>(outer_cv<span class="sc">$</span>splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">analysis</span>(.))),</span>
<span id="cb52-619"><a href="#cb52-619" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Outer Test Size</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">map_int</span>(outer_cv<span class="sc">$</span>splits, <span class="sc">~</span> <span class="fu">nrow</span>(<span class="fu">assessment</span>(.))),</span>
<span id="cb52-620"><a href="#cb52-620" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Inner Folds</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>,</span>
<span id="cb52-621"><a href="#cb52-621" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Total Models per Outer Fold</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>,</span>
<span id="cb52-622"><a href="#cb52-622" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Total Models Overall</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">25</span></span>
<span id="cb52-623"><a href="#cb52-623" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-624"><a href="#cb52-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-625"><a href="#cb52-625" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(nested_viz)</span>
<span id="cb52-626"><a href="#cb52-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-627"><a href="#cb52-627" aria-hidden="true" tabindex="-1"></a><span class="co"># Conceptual diagram</span></span>
<span id="cb52-628"><a href="#cb52-628" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span></span>
<span id="cb52-629"><a href="#cb52-629" aria-hidden="true" tabindex="-1"></a><span class="st">Nested Resampling Structure:</span></span>
<span id="cb52-630"><a href="#cb52-630" aria-hidden="true" tabindex="-1"></a><span class="st">============================</span></span>
<span id="cb52-631"><a href="#cb52-631" aria-hidden="true" tabindex="-1"></a><span class="st">Full Training Data</span></span>
<span id="cb52-632"><a href="#cb52-632" aria-hidden="true" tabindex="-1"></a><span class="st">  |</span></span>
<span id="cb52-633"><a href="#cb52-633" aria-hidden="true" tabindex="-1"></a><span class="st">  ├── Outer Fold 1</span></span>
<span id="cb52-634"><a href="#cb52-634" aria-hidden="true" tabindex="-1"></a><span class="st">  │   ├── Outer Training (80%)</span></span>
<span id="cb52-635"><a href="#cb52-635" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 1: Train (64%) + Val (16%)</span></span>
<span id="cb52-636"><a href="#cb52-636" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 2: Train (64%) + Val (16%)</span></span>
<span id="cb52-637"><a href="#cb52-637" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 3: Train (64%) + Val (16%)</span></span>
<span id="cb52-638"><a href="#cb52-638" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   ├── Inner Fold 4: Train (64%) + Val (16%)</span></span>
<span id="cb52-639"><a href="#cb52-639" aria-hidden="true" tabindex="-1"></a><span class="st">  │   │   └── Inner Fold 5: Train (64%) + Val (16%)</span></span>
<span id="cb52-640"><a href="#cb52-640" aria-hidden="true" tabindex="-1"></a><span class="st">  │   └── Outer Test (20%) - Never seen during tuning</span></span>
<span id="cb52-641"><a href="#cb52-641" aria-hidden="true" tabindex="-1"></a><span class="st">  │</span></span>
<span id="cb52-642"><a href="#cb52-642" aria-hidden="true" tabindex="-1"></a><span class="st">  ├── Outer Fold 2</span></span>
<span id="cb52-643"><a href="#cb52-643" aria-hidden="true" tabindex="-1"></a><span class="st">  │   └── [Same structure]</span></span>
<span id="cb52-644"><a href="#cb52-644" aria-hidden="true" tabindex="-1"></a><span class="st">  ...</span></span>
<span id="cb52-645"><a href="#cb52-645" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb52-646"><a href="#cb52-646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-647"><a href="#cb52-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-648"><a href="#cb52-648" aria-hidden="true" tabindex="-1"></a>Nested resampling is crucial for:</span>
<span id="cb52-649"><a href="#cb52-649" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Unbiased performance estimation when tuning</span>
<span id="cb52-650"><a href="#cb52-650" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Comparing different modeling strategies</span>
<span id="cb52-651"><a href="#cb52-651" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understanding generalization performance</span>
<span id="cb52-652"><a href="#cb52-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-653"><a href="#cb52-653" aria-hidden="true" tabindex="-1"></a><span class="fu">## Validation Sets in Practice</span></span>
<span id="cb52-654"><a href="#cb52-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-655"><a href="#cb52-655" aria-hidden="true" tabindex="-1"></a>Sometimes we want a single validation set for quick iterations:</span>
<span id="cb52-656"><a href="#cb52-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-659"><a href="#cb52-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-660"><a href="#cb52-660" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a validation set</span></span>
<span id="cb52-661"><a href="#cb52-661" aria-hidden="true" tabindex="-1"></a>val_split <span class="ot">&lt;-</span> <span class="fu">initial_validation_split</span>(ames, <span class="at">prop =</span> <span class="fu">c</span>(<span class="fl">0.6</span>, <span class="fl">0.2</span>))</span>
<span id="cb52-662"><a href="#cb52-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-663"><a href="#cb52-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract all three sets</span></span>
<span id="cb52-664"><a href="#cb52-664" aria-hidden="true" tabindex="-1"></a>train_set <span class="ot">&lt;-</span> <span class="fu">training</span>(val_split)</span>
<span id="cb52-665"><a href="#cb52-665" aria-hidden="true" tabindex="-1"></a>val_set <span class="ot">&lt;-</span> <span class="fu">validation</span>(val_split)</span>
<span id="cb52-666"><a href="#cb52-666" aria-hidden="true" tabindex="-1"></a>test_set <span class="ot">&lt;-</span> <span class="fu">testing</span>(val_split)</span>
<span id="cb52-667"><a href="#cb52-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-668"><a href="#cb52-668" aria-hidden="true" tabindex="-1"></a><span class="co"># Use validation set for model selection</span></span>
<span id="cb52-669"><a href="#cb52-669" aria-hidden="true" tabindex="-1"></a>models_to_compare <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-670"><a href="#cb52-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">simple =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb52-671"><a href="#cb52-671" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()),</span>
<span id="cb52-672"><a href="#cb52-672" aria-hidden="true" tabindex="-1"></a>  <span class="at">moderate =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb52-673"><a href="#cb52-673" aria-hidden="true" tabindex="-1"></a>                   Neighborhood, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb52-674"><a href="#cb52-674" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()),</span>
<span id="cb52-675"><a href="#cb52-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb52-676"><a href="#cb52-676" aria-hidden="true" tabindex="-1"></a>                  Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> First_Flr_SF, <span class="at">data =</span> train_set) <span class="sc">%&gt;%</span></span>
<span id="cb52-677"><a href="#cb52-677" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb52-678"><a href="#cb52-678" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-679"><a href="#cb52-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-680"><a href="#cb52-680" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models and evaluate on validation set</span></span>
<span id="cb52-681"><a href="#cb52-681" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-682"><a href="#cb52-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-683"><a href="#cb52-683" aria-hidden="true" tabindex="-1"></a>validation_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(models_to_compare), <span class="cf">function</span>(model_name) {</span>
<span id="cb52-684"><a href="#cb52-684" aria-hidden="true" tabindex="-1"></a>  recipe <span class="ot">&lt;-</span> models_to_compare[[model_name]]</span>
<span id="cb52-685"><a href="#cb52-685" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-686"><a href="#cb52-686" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-687"><a href="#cb52-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-688"><a href="#cb52-688" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb52-689"><a href="#cb52-689" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-690"><a href="#cb52-690" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit on training</span></span>
<span id="cb52-691"><a href="#cb52-691" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> wf <span class="sc">%&gt;%</span> <span class="fu">fit</span>(train_set)</span>
<span id="cb52-692"><a href="#cb52-692" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-693"><a href="#cb52-693" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on validation</span></span>
<span id="cb52-694"><a href="#cb52-694" aria-hidden="true" tabindex="-1"></a>  val_pred <span class="ot">&lt;-</span> fit <span class="sc">%&gt;%</span></span>
<span id="cb52-695"><a href="#cb52-695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(val_set) <span class="sc">%&gt;%</span></span>
<span id="cb52-696"><a href="#cb52-696" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(val_set)</span>
<span id="cb52-697"><a href="#cb52-697" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-698"><a href="#cb52-698" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate metrics</span></span>
<span id="cb52-699"><a href="#cb52-699" aria-hidden="true" tabindex="-1"></a>  val_pred <span class="sc">%&gt;%</span></span>
<span id="cb52-700"><a href="#cb52-700" aria-hidden="true" tabindex="-1"></a>    <span class="fu">metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred) <span class="sc">%&gt;%</span></span>
<span id="cb52-701"><a href="#cb52-701" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> model_name)</span>
<span id="cb52-702"><a href="#cb52-702" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-703"><a href="#cb52-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-704"><a href="#cb52-704" aria-hidden="true" tabindex="-1"></a><span class="co"># Select best model based on validation performance</span></span>
<span id="cb52-705"><a href="#cb52-705" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> validation_results <span class="sc">%&gt;%</span></span>
<span id="cb52-706"><a href="#cb52-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-707"><a href="#cb52-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.estimate) <span class="sc">%&gt;%</span></span>
<span id="cb52-708"><a href="#cb52-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-709"><a href="#cb52-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(model)</span>
<span id="cb52-710"><a href="#cb52-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-711"><a href="#cb52-711" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Best model based on validation set:"</span>, best_model))</span>
<span id="cb52-712"><a href="#cb52-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-713"><a href="#cb52-713" aria-hidden="true" tabindex="-1"></a><span class="co"># Final evaluation on test set (only done once!)</span></span>
<span id="cb52-714"><a href="#cb52-714" aria-hidden="true" tabindex="-1"></a>final_recipe <span class="ot">&lt;-</span> models_to_compare[[best_model]]</span>
<span id="cb52-715"><a href="#cb52-715" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-716"><a href="#cb52-716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(final_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-717"><a href="#cb52-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-718"><a href="#cb52-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train_set)</span>
<span id="cb52-719"><a href="#cb52-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-720"><a href="#cb52-720" aria-hidden="true" tabindex="-1"></a>test_pred <span class="ot">&lt;-</span> final_fit <span class="sc">%&gt;%</span></span>
<span id="cb52-721"><a href="#cb52-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test_set) <span class="sc">%&gt;%</span></span>
<span id="cb52-722"><a href="#cb52-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_set)</span>
<span id="cb52-723"><a href="#cb52-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-724"><a href="#cb52-724" aria-hidden="true" tabindex="-1"></a>final_performance <span class="ot">&lt;-</span> test_pred <span class="sc">%&gt;%</span></span>
<span id="cb52-725"><a href="#cb52-725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb52-726"><a href="#cb52-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-727"><a href="#cb52-727" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(final_performance, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb52-728"><a href="#cb52-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-729"><a href="#cb52-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-730"><a href="#cb52-730" aria-hidden="true" tabindex="-1"></a><span class="fu">## Choosing the Right Resampling Strategy</span></span>
<span id="cb52-731"><a href="#cb52-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-732"><a href="#cb52-732" aria-hidden="true" tabindex="-1"></a>Different strategies for different situations:</span>
<span id="cb52-733"><a href="#cb52-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-736"><a href="#cb52-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-737"><a href="#cb52-737" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision guide</span></span>
<span id="cb52-738"><a href="#cb52-738" aria-hidden="true" tabindex="-1"></a>strategy_guide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-739"><a href="#cb52-739" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario =</span> <span class="fu">c</span>(</span>
<span id="cb52-740"><a href="#cb52-740" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large dataset (n &gt; 10,000)"</span>,</span>
<span id="cb52-741"><a href="#cb52-741" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Medium dataset (1,000 &lt; n &lt; 10,000)"</span>,</span>
<span id="cb52-742"><a href="#cb52-742" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small dataset (n &lt; 1,000)"</span>,</span>
<span id="cb52-743"><a href="#cb52-743" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imbalanced classes"</span>,</span>
<span id="cb52-744"><a href="#cb52-744" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time series data"</span>,</span>
<span id="cb52-745"><a href="#cb52-745" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Quick prototyping"</span>,</span>
<span id="cb52-746"><a href="#cb52-746" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Final evaluation"</span>,</span>
<span id="cb52-747"><a href="#cb52-747" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hyperparameter tuning"</span>,</span>
<span id="cb52-748"><a href="#cb52-748" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Model comparison"</span>,</span>
<span id="cb52-749"><a href="#cb52-749" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uncertainty estimation"</span></span>
<span id="cb52-750"><a href="#cb52-750" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-751"><a href="#cb52-751" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Recommended Strategy</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb52-752"><a href="#cb52-752" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple train/test split or validation set"</span>,</span>
<span id="cb52-753"><a href="#cb52-753" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5 or 10-fold CV"</span>,</span>
<span id="cb52-754"><a href="#cb52-754" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Repeated CV or LOOCV"</span>,</span>
<span id="cb52-755"><a href="#cb52-755" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stratified CV"</span>,</span>
<span id="cb52-756"><a href="#cb52-756" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time series CV or rolling origin"</span>,</span>
<span id="cb52-757"><a href="#cb52-757" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Validation set"</span>,</span>
<span id="cb52-758"><a href="#cb52-758" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Held-out test set (touched only once)"</span>,</span>
<span id="cb52-759"><a href="#cb52-759" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nested CV"</span>,</span>
<span id="cb52-760"><a href="#cb52-760" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Repeated CV"</span>,</span>
<span id="cb52-761"><a href="#cb52-761" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bootstrap"</span></span>
<span id="cb52-762"><a href="#cb52-762" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-763"><a href="#cb52-763" aria-hidden="true" tabindex="-1"></a>  <span class="at">Reasoning =</span> <span class="fu">c</span>(</span>
<span id="cb52-764"><a href="#cb52-764" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sufficient data for reliable estimates"</span>,</span>
<span id="cb52-765"><a href="#cb52-765" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Balance between bias and variance"</span>,</span>
<span id="cb52-766"><a href="#cb52-766" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Maximize training data usage"</span>,</span>
<span id="cb52-767"><a href="#cb52-767" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Preserve class proportions"</span>,</span>
<span id="cb52-768"><a href="#cb52-768" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Respect temporal ordering"</span>,</span>
<span id="cb52-769"><a href="#cb52-769" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fast iteration and feedback"</span>,</span>
<span id="cb52-770"><a href="#cb52-770" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unbiased final assessment"</span>,</span>
<span id="cb52-771"><a href="#cb52-771" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Avoid overfitting to validation set"</span>,</span>
<span id="cb52-772"><a href="#cb52-772" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stable comparison metrics"</span>,</span>
<span id="cb52-773"><a href="#cb52-773" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Confidence intervals and distributions"</span></span>
<span id="cb52-774"><a href="#cb52-774" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-775"><a href="#cb52-775" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-776"><a href="#cb52-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-777"><a href="#cb52-777" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(strategy_guide)</span>
<span id="cb52-778"><a href="#cb52-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-779"><a href="#cb52-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-780"><a href="#cb52-780" aria-hidden="true" tabindex="-1"></a><span class="fu">## Common Pitfalls and Best Practices</span></span>
<span id="cb52-781"><a href="#cb52-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-782"><a href="#cb52-782" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 1: Data Leakage</span></span>
<span id="cb52-783"><a href="#cb52-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-786"><a href="#cb52-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-787"><a href="#cb52-787" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Preprocessing before splitting</span></span>
<span id="cb52-788"><a href="#cb52-788" aria-hidden="true" tabindex="-1"></a>wrong_data <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb52-789"><a href="#cb52-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-790"><a href="#cb52-790" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This uses information from ALL data including test!</span></span>
<span id="cb52-791"><a href="#cb52-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>],</span>
<span id="cb52-792"><a href="#cb52-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price)</span>
<span id="cb52-793"><a href="#cb52-793" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-794"><a href="#cb52-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-795"><a href="#cb52-795" aria-hidden="true" tabindex="-1"></a>wrong_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(wrong_data)</span>
<span id="cb52-796"><a href="#cb52-796" aria-hidden="true" tabindex="-1"></a>wrong_train <span class="ot">&lt;-</span> <span class="fu">training</span>(wrong_split)</span>
<span id="cb52-797"><a href="#cb52-797" aria-hidden="true" tabindex="-1"></a>wrong_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(wrong_split)</span>
<span id="cb52-798"><a href="#cb52-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-799"><a href="#cb52-799" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Preprocessing after splitting (using recipes)</span></span>
<span id="cb52-800"><a href="#cb52-800" aria-hidden="true" tabindex="-1"></a>right_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames)</span>
<span id="cb52-801"><a href="#cb52-801" aria-hidden="true" tabindex="-1"></a>right_train <span class="ot">&lt;-</span> <span class="fu">training</span>(right_split)</span>
<span id="cb52-802"><a href="#cb52-802" aria-hidden="true" tabindex="-1"></a>right_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(right_split)</span>
<span id="cb52-803"><a href="#cb52-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-804"><a href="#cb52-804" aria-hidden="true" tabindex="-1"></a>right_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> right_train) <span class="sc">%&gt;%</span></span>
<span id="cb52-805"><a href="#cb52-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb52-806"><a href="#cb52-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb52-807"><a href="#cb52-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-808"><a href="#cb52-808" aria-hidden="true" tabindex="-1"></a><span class="co"># The recipe learns parameters only from training data</span></span>
<span id="cb52-809"><a href="#cb52-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-810"><a href="#cb52-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-811"><a href="#cb52-811" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 2: Multiple Testing on Test Set</span></span>
<span id="cb52-812"><a href="#cb52-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-815"><a href="#cb52-815" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-816"><a href="#cb52-816" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Using test set multiple times</span></span>
<span id="cb52-817"><a href="#cb52-817" aria-hidden="true" tabindex="-1"></a><span class="co"># This is pseudocode - don't actually do this!</span></span>
<span id="cb52-818"><a href="#cb52-818" aria-hidden="true" tabindex="-1"></a><span class="co"># for (model in models) {</span></span>
<span id="cb52-819"><a href="#cb52-819" aria-hidden="true" tabindex="-1"></a><span class="co">#   performance &lt;- evaluate(model, test_set)</span></span>
<span id="cb52-820"><a href="#cb52-820" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (performance &lt; best_performance) {</span></span>
<span id="cb52-821"><a href="#cb52-821" aria-hidden="true" tabindex="-1"></a><span class="co">#     adjust_model(model)</span></span>
<span id="cb52-822"><a href="#cb52-822" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Testing again - overfitting to test set!</span></span>
<span id="cb52-823"><a href="#cb52-823" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb52-824"><a href="#cb52-824" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb52-825"><a href="#cb52-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-826"><a href="#cb52-826" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Use validation set or CV for model selection</span></span>
<span id="cb52-827"><a href="#cb52-827" aria-hidden="true" tabindex="-1"></a><span class="co"># Test set only for final evaluation</span></span>
<span id="cb52-828"><a href="#cb52-828" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-829"><a href="#cb52-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-830"><a href="#cb52-830" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 3: Improper Stratification</span></span>
<span id="cb52-831"><a href="#cb52-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-834"><a href="#cb52-834" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-835"><a href="#cb52-835" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with important subgroups</span></span>
<span id="cb52-836"><a href="#cb52-836" aria-hidden="true" tabindex="-1"></a>grouped_data <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb52-837"><a href="#cb52-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-838"><a href="#cb52-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">price_category =</span> <span class="fu">cut</span>(Sale_Price, </span>
<span id="cb52-839"><a href="#cb52-839" aria-hidden="true" tabindex="-1"></a>                        <span class="at">breaks =</span> <span class="fu">quantile</span>(Sale_Price, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.33</span>, <span class="fl">0.67</span>, <span class="dv">1</span>)),</span>
<span id="cb52-840"><a href="#cb52-840" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"Medium"</span>, <span class="st">"High"</span>))</span>
<span id="cb52-841"><a href="#cb52-841" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-842"><a href="#cb52-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-843"><a href="#cb52-843" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Not stratifying on important variable</span></span>
<span id="cb52-844"><a href="#cb52-844" aria-hidden="true" tabindex="-1"></a>wrong_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(grouped_data)</span>
<span id="cb52-845"><a href="#cb52-845" aria-hidden="true" tabindex="-1"></a>wrong_train <span class="ot">&lt;-</span> <span class="fu">training</span>(wrong_split)</span>
<span id="cb52-846"><a href="#cb52-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-847"><a href="#cb52-847" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Stratify to preserve distribution</span></span>
<span id="cb52-848"><a href="#cb52-848" aria-hidden="true" tabindex="-1"></a>right_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(grouped_data, <span class="at">strata =</span> price_category)</span>
<span id="cb52-849"><a href="#cb52-849" aria-hidden="true" tabindex="-1"></a>right_train <span class="ot">&lt;-</span> <span class="fu">training</span>(right_split)</span>
<span id="cb52-850"><a href="#cb52-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-851"><a href="#cb52-851" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare distributions</span></span>
<span id="cb52-852"><a href="#cb52-852" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb52-853"><a href="#cb52-853" aria-hidden="true" tabindex="-1"></a>  grouped_data <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"Original"</span>),</span>
<span id="cb52-854"><a href="#cb52-854" aria-hidden="true" tabindex="-1"></a>  wrong_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"No Stratification"</span>),</span>
<span id="cb52-855"><a href="#cb52-855" aria-hidden="true" tabindex="-1"></a>  right_train <span class="sc">%&gt;%</span> <span class="fu">count</span>(price_category) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Set =</span> <span class="st">"With Stratification"</span>)</span>
<span id="cb52-856"><a href="#cb52-856" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-857"><a href="#cb52-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Set) <span class="sc">%&gt;%</span></span>
<span id="cb52-858"><a href="#cb52-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Percentage =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb52-859"><a href="#cb52-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-860"><a href="#cb52-860" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(comparison, <span class="fu">aes</span>(<span class="at">x =</span> price_category, <span class="at">y =</span> Percentage, <span class="at">fill =</span> Set)) <span class="sc">+</span></span>
<span id="cb52-861"><a href="#cb52-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb52-862"><a href="#cb52-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-863"><a href="#cb52-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Stratification on Distribution"</span>,</span>
<span id="cb52-864"><a href="#cb52-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Stratification preserves the original distribution"</span>,</span>
<span id="cb52-865"><a href="#cb52-865" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Price Category"</span>, <span class="at">y =</span> <span class="st">"Percentage"</span></span>
<span id="cb52-866"><a href="#cb52-866" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-867"><a href="#cb52-867" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-868"><a href="#cb52-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-869"><a href="#cb52-869" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb52-870"><a href="#cb52-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-871"><a href="#cb52-871" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Implement Custom Resampling</span></span>
<span id="cb52-872"><a href="#cb52-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-873"><a href="#cb52-873" aria-hidden="true" tabindex="-1"></a>Create a custom resampling strategy for grouped data:</span>
<span id="cb52-874"><a href="#cb52-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-877"><a href="#cb52-877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-878"><a href="#cb52-878" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-879"><a href="#cb52-879" aria-hidden="true" tabindex="-1"></a><span class="co"># Data with natural groups (e.g., different stores)</span></span>
<span id="cb52-880"><a href="#cb52-880" aria-hidden="true" tabindex="-1"></a>store_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-881"><a href="#cb52-881" aria-hidden="true" tabindex="-1"></a>  <span class="at">store_id =</span> <span class="fu">rep</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">each =</span> <span class="dv">100</span>),</span>
<span id="cb52-882"><a href="#cb52-882" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>), <span class="at">length.out =</span> <span class="dv">100</span>, <span class="at">by =</span> <span class="st">"day"</span>), <span class="dv">10</span>),</span>
<span id="cb52-883"><a href="#cb52-883" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="fu">rep</span>(<span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">190</span>, <span class="dv">10</span>), <span class="at">each =</span> <span class="dv">100</span>), <span class="at">sd =</span> <span class="dv">20</span>)</span>
<span id="cb52-884"><a href="#cb52-884" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-885"><a href="#cb52-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-886"><a href="#cb52-886" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom group-based CV: leave-one-store-out</span></span>
<span id="cb52-887"><a href="#cb52-887" aria-hidden="true" tabindex="-1"></a>group_splits <span class="ot">&lt;-</span> <span class="fu">group_vfold_cv</span>(store_data, <span class="at">group =</span> store_id)</span>
<span id="cb52-888"><a href="#cb52-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-889"><a href="#cb52-889" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine splits</span></span>
<span id="cb52-890"><a href="#cb52-890" aria-hidden="true" tabindex="-1"></a>split_summary <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(group_splits<span class="sc">$</span>splits), <span class="cf">function</span>(i) {</span>
<span id="cb52-891"><a href="#cb52-891" aria-hidden="true" tabindex="-1"></a>  split <span class="ot">&lt;-</span> group_splits<span class="sc">$</span>splits[[i]]</span>
<span id="cb52-892"><a href="#cb52-892" aria-hidden="true" tabindex="-1"></a>  train <span class="ot">&lt;-</span> <span class="fu">analysis</span>(split)</span>
<span id="cb52-893"><a href="#cb52-893" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">assessment</span>(split)</span>
<span id="cb52-894"><a href="#cb52-894" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-895"><a href="#cb52-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb52-896"><a href="#cb52-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">fold =</span> i,</span>
<span id="cb52-897"><a href="#cb52-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_stores =</span> <span class="fu">n_distinct</span>(train<span class="sc">$</span>store_id),</span>
<span id="cb52-898"><a href="#cb52-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_stores =</span> <span class="fu">n_distinct</span>(test<span class="sc">$</span>store_id),</span>
<span id="cb52-899"><a href="#cb52-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_rows =</span> <span class="fu">nrow</span>(train),</span>
<span id="cb52-900"><a href="#cb52-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_rows =</span> <span class="fu">nrow</span>(test)</span>
<span id="cb52-901"><a href="#cb52-901" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-902"><a href="#cb52-902" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-903"><a href="#cb52-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-904"><a href="#cb52-904" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(split_summary)</span>
<span id="cb52-905"><a href="#cb52-905" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-906"><a href="#cb52-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-907"><a href="#cb52-907" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Compare Resampling Strategies</span></span>
<span id="cb52-908"><a href="#cb52-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-909"><a href="#cb52-909" aria-hidden="true" tabindex="-1"></a>Evaluate different resampling methods on the same dataset:</span>
<span id="cb52-910"><a href="#cb52-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-913"><a href="#cb52-913" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-914"><a href="#cb52-914" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-915"><a href="#cb52-915" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a subset of Ames data for speed</span></span>
<span id="cb52-916"><a href="#cb52-916" aria-hidden="true" tabindex="-1"></a>ames_subset <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb52-917"><a href="#cb52-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Gr_Liv_Area, Overall_Cond, Year_Built, Lot_Area) <span class="sc">%&gt;%</span></span>
<span id="cb52-918"><a href="#cb52-918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">500</span>)</span>
<span id="cb52-919"><a href="#cb52-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-920"><a href="#cb52-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Define resampling strategies</span></span>
<span id="cb52-921"><a href="#cb52-921" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-922"><a href="#cb52-922" aria-hidden="true" tabindex="-1"></a>  <span class="at">holdout =</span> <span class="fu">initial_split</span>(ames_subset, <span class="at">prop =</span> <span class="fl">0.75</span>),</span>
<span id="cb52-923"><a href="#cb52-923" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv5 =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb52-924"><a href="#cb52-924" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv10 =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">10</span>),</span>
<span id="cb52-925"><a href="#cb52-925" aria-hidden="true" tabindex="-1"></a>  <span class="at">repeated_cv =</span> <span class="fu">vfold_cv</span>(ames_subset, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">repeats =</span> <span class="dv">3</span>),</span>
<span id="cb52-926"><a href="#cb52-926" aria-hidden="true" tabindex="-1"></a>  <span class="at">bootstrap =</span> <span class="fu">bootstraps</span>(ames_subset, <span class="at">times =</span> <span class="dv">25</span>)</span>
<span id="cb52-927"><a href="#cb52-927" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-928"><a href="#cb52-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-929"><a href="#cb52-929" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple model for comparison</span></span>
<span id="cb52-930"><a href="#cb52-930" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-931"><a href="#cb52-931" aria-hidden="true" tabindex="-1"></a>recipe_spec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_subset)</span>
<span id="cb52-932"><a href="#cb52-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-933"><a href="#cb52-933" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate each strategy (except holdout which needs different handling)</span></span>
<span id="cb52-934"><a href="#cb52-934" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(strategy_name) {</span>
<span id="cb52-935"><a href="#cb52-935" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-936"><a href="#cb52-936" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(recipe_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-937"><a href="#cb52-937" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb52-938"><a href="#cb52-938" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-939"><a href="#cb52-939" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(wf, strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb52-940"><a href="#cb52-940" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-941"><a href="#cb52-941" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb52-942"><a href="#cb52-942" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-943"><a href="#cb52-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-944"><a href="#cb52-944" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize results</span></span>
<span id="cb52-945"><a href="#cb52-945" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb52-946"><a href="#cb52-946" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb52-947"><a href="#cb52-947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb52-948"><a href="#cb52-948" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb52-949"><a href="#cb52-949" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-950"><a href="#cb52-950" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Resampling Strategies"</span>,</span>
<span id="cb52-951"><a href="#cb52-951" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Error bars show standard error"</span>,</span>
<span id="cb52-952"><a href="#cb52-952" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Strategy"</span>, <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb52-953"><a href="#cb52-953" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-954"><a href="#cb52-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-955"><a href="#cb52-955" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-956"><a href="#cb52-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-957"><a href="#cb52-957" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Time Series Validation</span></span>
<span id="cb52-958"><a href="#cb52-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-959"><a href="#cb52-959" aria-hidden="true" tabindex="-1"></a>Implement proper time series validation:</span>
<span id="cb52-960"><a href="#cb52-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-963"><a href="#cb52-963" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-964"><a href="#cb52-964" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-965"><a href="#cb52-965" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate time series data with trend and seasonality</span></span>
<span id="cb52-966"><a href="#cb52-966" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb52-967"><a href="#cb52-967" aria-hidden="true" tabindex="-1"></a>ts_exercise <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-968"><a href="#cb52-968" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb52-969"><a href="#cb52-969" aria-hidden="true" tabindex="-1"></a>  <span class="at">day_of_week =</span> lubridate<span class="sc">::</span><span class="fu">wday</span>(date),</span>
<span id="cb52-970"><a href="#cb52-970" aria-hidden="true" tabindex="-1"></a>  <span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date),</span>
<span id="cb52-971"><a href="#cb52-971" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">1000</span>, <span class="dv">2000</span>, <span class="at">length.out =</span> <span class="fu">length</span>(date)),</span>
<span id="cb52-972"><a href="#cb52-972" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb52-973"><a href="#cb52-973" aria-hidden="true" tabindex="-1"></a>  <span class="at">weekly =</span> <span class="dv">50</span> <span class="sc">*</span> (day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)),  <span class="co"># Weekend effect</span></span>
<span id="cb52-974"><a href="#cb52-974" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(date), <span class="dv">0</span>, <span class="dv">50</span>),</span>
<span id="cb52-975"><a href="#cb52-975" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb52-976"><a href="#cb52-976" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-977"><a href="#cb52-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-978"><a href="#cb52-978" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time-based splits</span></span>
<span id="cb52-979"><a href="#cb52-979" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial training: 2 years, assess: 1 month, skip: 1 month</span></span>
<span id="cb52-980"><a href="#cb52-980" aria-hidden="true" tabindex="-1"></a>ts_splits <span class="ot">&lt;-</span> <span class="fu">rolling_origin</span>(</span>
<span id="cb52-981"><a href="#cb52-981" aria-hidden="true" tabindex="-1"></a>  ts_exercise,</span>
<span id="cb52-982"><a href="#cb52-982" aria-hidden="true" tabindex="-1"></a>  <span class="at">initial =</span> <span class="dv">730</span>,  <span class="co"># 2 years</span></span>
<span id="cb52-983"><a href="#cb52-983" aria-hidden="true" tabindex="-1"></a>  <span class="at">assess =</span> <span class="dv">30</span>,    <span class="co"># 1 month</span></span>
<span id="cb52-984"><a href="#cb52-984" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip =</span> <span class="dv">30</span>,      <span class="co"># Skip 1 month</span></span>
<span id="cb52-985"><a href="#cb52-985" aria-hidden="true" tabindex="-1"></a>  <span class="at">cumulative =</span> <span class="cn">FALSE</span>  <span class="co"># Sliding window</span></span>
<span id="cb52-986"><a href="#cb52-986" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-987"><a href="#cb52-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-988"><a href="#cb52-988" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate a simple model</span></span>
<span id="cb52-989"><a href="#cb52-989" aria-hidden="true" tabindex="-1"></a>ts_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(sales <span class="sc">~</span> day_of_week <span class="sc">+</span> month <span class="sc">+</span> trend, <span class="at">data =</span> ts_exercise)</span>
<span id="cb52-990"><a href="#cb52-990" aria-hidden="true" tabindex="-1"></a>ts_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-991"><a href="#cb52-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-992"><a href="#cb52-992" aria-hidden="true" tabindex="-1"></a>ts_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-993"><a href="#cb52-993" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ts_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-994"><a href="#cb52-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ts_model)</span>
<span id="cb52-995"><a href="#cb52-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-996"><a href="#cb52-996" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb52-997"><a href="#cb52-997" aria-hidden="true" tabindex="-1"></a>ts_results <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb52-998"><a href="#cb52-998" aria-hidden="true" tabindex="-1"></a>  ts_workflow,</span>
<span id="cb52-999"><a href="#cb52-999" aria-hidden="true" tabindex="-1"></a>  ts_splits,</span>
<span id="cb52-1000"><a href="#cb52-1000" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb52-1001"><a href="#cb52-1001" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1002"><a href="#cb52-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1003"><a href="#cb52-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine performance over time</span></span>
<span id="cb52-1004"><a href="#cb52-1004" aria-hidden="true" tabindex="-1"></a>ts_metrics <span class="ot">&lt;-</span> ts_results <span class="sc">%&gt;%</span></span>
<span id="cb52-1005"><a href="#cb52-1005" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-1006"><a href="#cb52-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-1007"><a href="#cb52-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">split_num =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">n</span>()<span class="sc">/</span><span class="dv">3</span>), <span class="dv">3</span>)</span>
<span id="cb52-1008"><a href="#cb52-1008" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-1009"><a href="#cb52-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1010"><a href="#cb52-1010" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ts_metrics, <span class="fu">aes</span>(<span class="at">x =</span> split_num, <span class="at">y =</span> mean, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb52-1011"><a href="#cb52-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-1012"><a href="#cb52-1012" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-1013"><a href="#cb52-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb52-1014"><a href="#cb52-1014" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-1015"><a href="#cb52-1015" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Performance Over Time"</span>,</span>
<span id="cb52-1016"><a href="#cb52-1016" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Time series cross-validation results"</span>,</span>
<span id="cb52-1017"><a href="#cb52-1017" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Split Number (Time →)"</span>, <span class="at">y =</span> <span class="st">"Metric Value"</span></span>
<span id="cb52-1018"><a href="#cb52-1018" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-1019"><a href="#cb52-1019" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-1020"><a href="#cb52-1020" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1021"><a href="#cb52-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1022"><a href="#cb52-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb52-1023"><a href="#cb52-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1024"><a href="#cb52-1024" aria-hidden="true" tabindex="-1"></a>In this comprehensive chapter, you've mastered:</span>
<span id="cb52-1025"><a href="#cb52-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1026"><a href="#cb52-1026" aria-hidden="true" tabindex="-1"></a>✅ **Fundamental concepts**</span>
<span id="cb52-1027"><a href="#cb52-1027" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Why proper data splitting is critical</span>
<span id="cb52-1028"><a href="#cb52-1028" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>The bias-variance tradeoff in evaluation</span>
<span id="cb52-1029"><a href="#cb52-1029" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Training, validation, and test sets</span>
<span id="cb52-1030"><a href="#cb52-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1031"><a href="#cb52-1031" aria-hidden="true" tabindex="-1"></a>✅ **Splitting strategies**</span>
<span id="cb52-1032"><a href="#cb52-1032" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Simple holdout splits</span>
<span id="cb52-1033"><a href="#cb52-1033" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Stratified sampling for balance</span>
<span id="cb52-1034"><a href="#cb52-1034" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Multi-level splits for complex workflows</span>
<span id="cb52-1035"><a href="#cb52-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1036"><a href="#cb52-1036" aria-hidden="true" tabindex="-1"></a>✅ **Cross-validation techniques**</span>
<span id="cb52-1037"><a href="#cb52-1037" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>K-fold and repeated CV</span>
<span id="cb52-1038"><a href="#cb52-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Leave-one-out CV</span>
<span id="cb52-1039"><a href="#cb52-1039" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Time series CV</span>
<span id="cb52-1040"><a href="#cb52-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1041"><a href="#cb52-1041" aria-hidden="true" tabindex="-1"></a>✅ **Advanced methods**</span>
<span id="cb52-1042"><a href="#cb52-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Bootstrap resampling</span>
<span id="cb52-1043"><a href="#cb52-1043" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Nested resampling for tuning</span>
<span id="cb52-1044"><a href="#cb52-1044" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Group-based splitting</span>
<span id="cb52-1045"><a href="#cb52-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1046"><a href="#cb52-1046" aria-hidden="true" tabindex="-1"></a>✅ **Best practices**</span>
<span id="cb52-1047"><a href="#cb52-1047" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Avoiding data leakage</span>
<span id="cb52-1048"><a href="#cb52-1048" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Choosing appropriate strategies</span>
<span id="cb52-1049"><a href="#cb52-1049" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Proper use of test sets</span>
<span id="cb52-1050"><a href="#cb52-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1051"><a href="#cb52-1051" aria-hidden="true" tabindex="-1"></a>Key takeaways:</span>
<span id="cb52-1052"><a href="#cb52-1052" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Never evaluate on training data</span>
<span id="cb52-1053"><a href="#cb52-1053" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Choose resampling based on your data and goals</span>
<span id="cb52-1054"><a href="#cb52-1054" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stratify when you have imbalanced data</span>
<span id="cb52-1055"><a href="#cb52-1055" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Respect temporal ordering in time series</span>
<span id="cb52-1056"><a href="#cb52-1056" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use nested CV for unbiased tuning</span>
<span id="cb52-1057"><a href="#cb52-1057" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Touch the test set only once!</span>
<span id="cb52-1058"><a href="#cb52-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1059"><a href="#cb52-1059" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Next?</span></span>
<span id="cb52-1060"><a href="#cb52-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1061"><a href="#cb52-1061" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">Chapter 10</span><span class="co">](10-feature-engineering.Rmd)</span>, we'll explore feature engineering with recipes, learning how to transform raw data into model-ready features.</span>
<span id="cb52-1062"><a href="#cb52-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1063"><a href="#cb52-1063" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Resources</span></span>
<span id="cb52-1064"><a href="#cb52-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1065"><a href="#cb52-1065" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">rsample Documentation</span><span class="co">](https://rsample.tidymodels.org/)</span></span>
<span id="cb52-1066"><a href="#cb52-1066" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Cross-Validation: The Right and Wrong Way</span><span class="co">](https://stats.stackexchange.com/questions/65128/)</span></span>
<span id="cb52-1067"><a href="#cb52-1067" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Nested Resampling Tutorial</span><span class="co">](https://www.tidymodels.org/learn/work/nested-resampling/)</span></span>
<span id="cb52-1068"><a href="#cb52-1068" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Time Series Cross-Validation</span><span class="co">](https://otexts.com/fpp3/tscv.html)</span></span>
<span id="cb52-1069"><a href="#cb52-1069" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Bootstrap Methods and Their Application</span><span class="co">](https://www.cambridge.org/core/books/bootstrap-methods-and-their-application/)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>