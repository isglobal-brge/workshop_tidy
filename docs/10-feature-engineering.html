<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Sarrat González, Juan R González">
<meta name="dcterms.date" content="2025-10-06">

<title>Chapter 10: Feature Engineering with recipes - The Art and Science of Data Preparation – Tidyverse &amp; Machine Learning Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-90ee96a17764a76d4fcf3f331faa145e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidyverse &amp; Machine Learning Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-1-tidyverse" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 1: Tidyverse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-1-tidyverse">    
        <li>
    <a class="dropdown-item" href="./01-introduction.html">
 <span class="dropdown-text">Ch 1: Introduction to Tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-data-import.html">
 <span class="dropdown-text">Ch 2: Data Import with readr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-data-wrangling.html">
 <span class="dropdown-text">Ch 3: Data Wrangling with dplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-data-tidying.html">
 <span class="dropdown-text">Ch 4: Data Tidying with tidyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-visualization.html">
 <span class="dropdown-text">Ch 5: Visualization with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-functional-programming.html">
 <span class="dropdown-text">Ch 6: Functional Programming with purrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-strings-dates.html">
 <span class="dropdown-text">Ch 7: Strings and Dates</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-1.html">
 <span class="dropdown-text">Block 1 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-2-tidymodels" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 2: Tidymodels</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-2-tidymodels">    
        <li>
    <a class="dropdown-item" href="./08-tidymodels-intro.html">
 <span class="dropdown-text">Ch 8: Introduction to Tidymodels</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-data-splitting.html">
 <span class="dropdown-text">Ch 9: Data Splitting &amp; Resampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-feature-engineering.html">
 <span class="dropdown-text">Ch 10: Feature Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-model-specification.html">
 <span class="dropdown-text">Ch 11: Model Specification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-workflows-evaluation.html">
 <span class="dropdown-text">Ch 12: Workflows &amp; Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-hyperparameter-tuning.html">
 <span class="dropdown-text">Ch 13: Hyperparameter Tuning</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-2.html">
 <span class="dropdown-text">Block 2 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-3-machine-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 3: Machine Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-3-machine-learning">    
        <li>
    <a class="dropdown-item" href="./14-classification.html">
 <span class="dropdown-text">Ch 14: Classification Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-regression.html">
 <span class="dropdown-text">Ch 15: Regression Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-ensemble-methods.html">
 <span class="dropdown-text">Ch 16: Ensemble Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./17-unsupervised-learning.html">
 <span class="dropdown-text">Ch 17: Unsupervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./18-model-deployment.html">
 <span class="dropdown-text">Ch 18: Model Deployment</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-3.html">
 <span class="dropdown-text">Block 3 Assessment</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#what-is-feature-engineering" id="toc-what-is-feature-engineering" class="nav-link" data-scroll-target="#what-is-feature-engineering">What is Feature Engineering?</a>
  <ul class="collapse">
  <li><a href="#why-feature-engineering-matters" id="toc-why-feature-engineering-matters" class="nav-link" data-scroll-target="#why-feature-engineering-matters">Why Feature Engineering Matters</a></li>
  </ul></li>
  <li><a href="#the-recipes-package-philosophy" id="toc-the-recipes-package-philosophy" class="nav-link" data-scroll-target="#the-recipes-package-philosophy">The recipes Package Philosophy</a></li>
  <li><a href="#creating-your-first-recipe" id="toc-creating-your-first-recipe" class="nav-link" data-scroll-target="#creating-your-first-recipe">Creating Your First Recipe</a>
  <ul class="collapse">
  <li><a href="#adding-steps-to-the-recipe" id="toc-adding-steps-to-the-recipe" class="nav-link" data-scroll-target="#adding-steps-to-the-recipe">Adding Steps to the Recipe</a></li>
  <li><a href="#preparing-and-baking-the-recipe" id="toc-preparing-and-baking-the-recipe" class="nav-link" data-scroll-target="#preparing-and-baking-the-recipe">Preparing and Baking the Recipe</a></li>
  </ul></li>
  <li><a href="#numeric-transformations" id="toc-numeric-transformations" class="nav-link" data-scroll-target="#numeric-transformations">Numeric Transformations</a>
  <ul class="collapse">
  <li><a href="#scaling-and-normalization" id="toc-scaling-and-normalization" class="nav-link" data-scroll-target="#scaling-and-normalization">Scaling and Normalization</a></li>
  <li><a href="#transformations-for-skewed-data" id="toc-transformations-for-skewed-data" class="nav-link" data-scroll-target="#transformations-for-skewed-data">Transformations for Skewed Data</a></li>
  </ul></li>
  <li><a href="#handling-categorical-variables" id="toc-handling-categorical-variables" class="nav-link" data-scroll-target="#handling-categorical-variables">Handling Categorical Variables</a>
  <ul class="collapse">
  <li><a href="#dummy-variables-one-hot-encoding" id="toc-dummy-variables-one-hot-encoding" class="nav-link" data-scroll-target="#dummy-variables-one-hot-encoding">Dummy Variables (One-Hot Encoding)</a></li>
  <li><a href="#advanced-categorical-encoding" id="toc-advanced-categorical-encoding" class="nav-link" data-scroll-target="#advanced-categorical-encoding">Advanced Categorical Encoding</a></li>
  </ul></li>
  <li><a href="#creating-interaction-terms" id="toc-creating-interaction-terms" class="nav-link" data-scroll-target="#creating-interaction-terms">Creating Interaction Terms</a></li>
  <li><a href="#handling-missing-data" id="toc-handling-missing-data" class="nav-link" data-scroll-target="#handling-missing-data">Handling Missing Data</a>
  <ul class="collapse">
  <li><a href="#types-of-missingness" id="toc-types-of-missingness" class="nav-link" data-scroll-target="#types-of-missingness">Types of Missingness</a></li>
  </ul></li>
  <li><a href="#feature-selection-and-dimensionality-reduction" id="toc-feature-selection-and-dimensionality-reduction" class="nav-link" data-scroll-target="#feature-selection-and-dimensionality-reduction">Feature Selection and Dimensionality Reduction</a>
  <ul class="collapse">
  <li><a href="#filter-methods" id="toc-filter-methods" class="nav-link" data-scroll-target="#filter-methods">Filter Methods</a></li>
  <li><a href="#principal-component-analysis-pca" id="toc-principal-component-analysis-pca" class="nav-link" data-scroll-target="#principal-component-analysis-pca">Principal Component Analysis (PCA)</a></li>
  </ul></li>
  <li><a href="#time-based-features" id="toc-time-based-features" class="nav-link" data-scroll-target="#time-based-features">Time-Based Features</a></li>
  <li><a href="#text-features-brief-introduction" id="toc-text-features-brief-introduction" class="nav-link" data-scroll-target="#text-features-brief-introduction">Text Features (Brief Introduction)</a></li>
  <li><a href="#best-practices-and-common-pitfalls" id="toc-best-practices-and-common-pitfalls" class="nav-link" data-scroll-target="#best-practices-and-common-pitfalls">Best Practices and Common Pitfalls</a>
  <ul class="collapse">
  <li><a href="#best-practices" id="toc-best-practices" class="nav-link" data-scroll-target="#best-practices">Best Practices</a></li>
  <li><a href="#common-pitfalls-to-avoid" id="toc-common-pitfalls-to-avoid" class="nav-link" data-scroll-target="#common-pitfalls-to-avoid">Common Pitfalls to Avoid</a></li>
  </ul></li>
  <li><a href="#complete-example-putting-it-all-together" id="toc-complete-example-putting-it-all-together" class="nav-link" data-scroll-target="#complete-example-putting-it-all-together">Complete Example: Putting It All Together</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-engineer-features-for-house-prices" id="toc-exercise-1-engineer-features-for-house-prices" class="nav-link" data-scroll-target="#exercise-1-engineer-features-for-house-prices">Exercise 1: Engineer Features for House Prices</a></li>
  <li><a href="#exercise-2-handle-high-cardinality-categorical" id="toc-exercise-2-handle-high-cardinality-categorical" class="nav-link" data-scroll-target="#exercise-2-handle-high-cardinality-categorical">Exercise 2: Handle High-Cardinality Categorical</a></li>
  <li><a href="#exercise-3-time-series-feature-engineering" id="toc-exercise-3-time-series-feature-engineering" class="nav-link" data-scroll-target="#exercise-3-time-series-feature-engineering">Exercise 3: Time Series Feature Engineering</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next?</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 10: Feature Engineering with recipes - The Art and Science of Data Preparation</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Sarrat González, Juan R González </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 6, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this chapter, you will master:</p>
<ul>
<li>The philosophy and importance of feature engineering</li>
<li>Creating and applying recipes in tidymodels</li>
<li>Numeric transformations and scaling</li>
<li>Handling categorical variables</li>
<li>Creating interaction terms and polynomial features</li>
<li>Dealing with missing data systematically</li>
<li>Feature selection and dimensionality reduction</li>
<li>Time-based and text features</li>
<li>Best practices and common pitfalls</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Download R Script
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download the complete R code for this chapter: <a href="R_scripts/10-feature-engineering.R" class="btn btn-primary" download="10-feature-engineering.R">📥 Download 10-feature-engineering.R</a></p>
</div>
</div>
</section>
<section id="what-is-feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="what-is-feature-engineering">What is Feature Engineering?</h2>
<p>Feature engineering is the process of transforming raw data into features that better represent the underlying problem to predictive models. It’s often said that “data and features determine the upper limit of machine learning, while models and algorithms only approach this limit.”</p>
<section id="why-feature-engineering-matters" class="level3">
<h3 class="anchored" data-anchor-id="why-feature-engineering-matters">Why Feature Engineering Matters</h3>
<p>Think of feature engineering as translating your data into a language that your model can better understand. Even the most sophisticated algorithm will struggle with poorly prepared data, while a simple model can perform remarkably well with thoughtfully engineered features.</p>
<p>Consider these scenarios: - <strong>Raw timestamps</strong> → Extract hour of day, day of week, is_weekend, season - <strong>Text addresses</strong> → Extract zip code, city, distance from city center - <strong>Numerical ratios</strong> → Price per square foot instead of just price and area - <strong>Domain knowledge</strong> → Age of house at sale instead of just year built and sale year</p>
<p>Let’s see this in action:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example datasets</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple example to show feature engineering impact</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>simple_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">sale_date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2022-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperature =</span> <span class="dv">50</span> <span class="sc">+</span> <span class="dv">30</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(sale_date) <span class="sc">/</span> <span class="dv">365</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(sale_date), <span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> <span class="dv">1000</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(sale_date) <span class="sc">/</span> <span class="dv">365</span>) <span class="sc">+</span> </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>          <span class="dv">100</span> <span class="sc">*</span> (<span class="fu">wday</span>(sale_date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">+</span>  <span class="co"># Weekend boost</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rnorm</span>(<span class="fu">length</span>(sale_date), <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Without feature engineering - just using date as numeric</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>bad_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(sales <span class="sc">~</span> <span class="fu">as.numeric</span>(sale_date), <span class="at">data =</span> simple_data)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># With feature engineering</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>good_data <span class="ot">&lt;-</span> simple_data <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(sale_date),</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(sale_date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> <span class="fu">wday</span>(sale_date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(sale_date),</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">days_since_start =</span> <span class="fu">as.numeric</span>(sale_date <span class="sc">-</span> <span class="fu">min</span>(sale_date))</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>good_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(sales <span class="sc">~</span> month <span class="sc">+</span> is_weekend <span class="sc">+</span> temperature <span class="sc">+</span> days_since_start, </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> good_data)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare R-squared</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Without Feature Engineering"</span>, <span class="st">"With Feature Engineering"</span>),</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">R-squared</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">summary</span>(bad_model)<span class="sc">$</span>r.squared, <span class="fu">summary</span>(good_model)<span class="sc">$</span>r.squared)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">R-squared</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Without Feature Engineering</td>
<td style="text-align: right;">0.055</td>
</tr>
<tr class="even">
<td style="text-align: left;">With Feature Engineering</td>
<td style="text-align: right;">0.869</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Notice the dramatic improvement! The model with engineered features captures patterns that the raw date couldn’t represent.</p>
</section>
</section>
<section id="the-recipes-package-philosophy" class="level2">
<h2 class="anchored" data-anchor-id="the-recipes-package-philosophy">The recipes Package Philosophy</h2>
<p>The <code>recipes</code> package provides a domain-specific language for feature engineering. Think of it like writing a recipe for a meal:</p>
<ol type="1">
<li><strong>Ingredients</strong> (raw data): What you start with</li>
<li><strong>Instructions</strong> (steps): How to transform the ingredients</li>
<li><strong>Preparation</strong> (prep): Getting everything ready with your training data</li>
<li><strong>Baking</strong> (bake): Applying the recipe to new data</li>
</ol>
<p>This approach ensures: - <strong>Reproducibility</strong>: The same transformations applied consistently - <strong>Modularity</strong>: Easy to add, remove, or modify steps - <strong>Prevention of data leakage</strong>: Transformations learned only from training data</p>
</section>
<section id="creating-your-first-recipe" class="level2">
<h2 class="anchored" data-anchor-id="creating-your-first-recipe">Creating Your First Recipe</h2>
<p>Let’s start with a basic recipe and build complexity gradually:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the Ames housing data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sale_Price <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.8</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sale_Price <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(ames_train)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a basic recipe</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>basic_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Lot_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond, </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># View the recipe</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>basic_recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, the recipe is just a specification - it hasn’t done anything yet. It’s like having a recipe card but not having cooked the meal.</p>
<section id="adding-steps-to-the-recipe" class="level3">
<h3 class="anchored" data-anchor-id="adding-steps-to-the-recipe">Adding Steps to the Recipe</h3>
<p>Now let’s add transformation steps. Each step transforms the data in a specific way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced recipe with multiple steps</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>enhanced_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Lot_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                          Neighborhood <span class="sc">+</span> Gr_Liv_Area, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Log transform the outcome</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Create a new feature</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">House_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Built) <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Remove the original Year_Built</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Year_Built) <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Normalize numeric predictors</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Create dummy variables for categorical predictors</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>enhanced_recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each step is performed in order, and the output of one step becomes the input to the next. This is crucial to understand - order matters!</p>
</section>
<section id="preparing-and-baking-the-recipe" class="level3">
<h3 class="anchored" data-anchor-id="preparing-and-baking-the-recipe">Preparing and Baking the Recipe</h3>
<p>Now we need to “prepare” the recipe using the training data, then “bake” it to apply the transformations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the recipe (learn parameters from training data)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>prepped_recipe <span class="ot">&lt;-</span> <span class="fu">prep</span>(enhanced_recipe, <span class="at">training =</span> ames_train)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># See what was learned</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>prepped_recipe</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to training data</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>baked_train <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_recipe, <span class="at">new_data =</span> <span class="cn">NULL</span>)  <span class="co"># NULL means use training data</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,344
Columns: 41
$ Lot_Area                                             &lt;dbl&gt; -0.07145116, -0.1…
$ Gr_Liv_Area                                          &lt;dbl&gt; -0.88264922, -0.3…
$ Sale_Price                                           &lt;dbl&gt; 11.86358, 12.2496…
$ House_Age                                            &lt;dbl&gt; 0.10653670, -1.19…
$ Overall_Cond_Poor                                    &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Fair                                    &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Below_Average                           &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Average                                 &lt;dbl&gt; 1, 1, 1, 0, 1, 1,…
$ Overall_Cond_Above_Average                           &lt;dbl&gt; 0, 0, 0, 1, 0, 0,…
$ Overall_Cond_Good                                    &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Very_Good                               &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Excellent                               &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Overall_Cond_Very_Excellent                          &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_College_Creek                           &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Old_Town                                &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Edwards                                 &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Somerset                                &lt;dbl&gt; 0, 1, 1, 0, 0, 0,…
$ Neighborhood_Northridge_Heights                      &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Gilbert                                 &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Sawyer                                  &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Northwest_Ames                          &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Sawyer_West                             &lt;dbl&gt; 0, 0, 0, 0, 1, 0,…
$ Neighborhood_Mitchell                                &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Brookside                               &lt;dbl&gt; 0, 0, 0, 1, 0, 0,…
$ Neighborhood_Crawford                                &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Iowa_DOT_and_Rail_Road                  &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Timberland                              &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Northridge                              &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Stone_Brook                             &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_South_and_West_of_Iowa_State_University &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Clear_Creek                             &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Meadow_Village                          &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Briardale                               &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Bloomington_Heights                     &lt;dbl&gt; 0, 0, 0, 0, 0, 1,…
$ Neighborhood_Veenker                                 &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Northpark_Villa                         &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Blueste                                 &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Greens                                  &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Green_Hills                             &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Landmark                                &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…
$ Neighborhood_Hayden_Lake                             &lt;dbl&gt; 0, 0, 0, 0, 0, 0,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>baked_test <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_recipe, <span class="at">new_data =</span> ames_test)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that dimensions match (except for rows)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Test"</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Rows =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(baked_train), <span class="fu">nrow</span>(baked_test)),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Columns =</span> <span class="fu">c</span>(<span class="fu">ncol</span>(baked_train), <span class="fu">ncol</span>(baked_test))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Dataset</th>
<th style="text-align: right;">Rows</th>
<th style="text-align: right;">Columns</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Training</td>
<td style="text-align: right;">2344</td>
<td style="text-align: right;">41</td>
</tr>
<tr class="even">
<td style="text-align: left;">Test</td>
<td style="text-align: right;">586</td>
<td style="text-align: right;">41</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The key insight: <code>prep()</code> learns any necessary parameters (like mean and SD for normalization) from the training data, and <code>bake()</code> applies these learned transformations to any dataset.</p>
</section>
</section>
<section id="numeric-transformations" class="level2">
<h2 class="anchored" data-anchor-id="numeric-transformations">Numeric Transformations</h2>
<p>Numeric features often need transformation to work well with models. Let’s explore the most important transformations:</p>
<section id="scaling-and-normalization" class="level3">
<h3 class="anchored" data-anchor-id="scaling-and-normalization">Scaling and Normalization</h3>
<p>Different scaling methods serve different purposes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example data with different scales</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>scaling_demo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_A =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span> <span class="dv">15</span>),      <span class="co"># Normal, mean=100</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_B =</span> <span class="fu">rexp</span>(<span class="dv">1000</span>, <span class="at">rate =</span> <span class="fl">0.01</span>),               <span class="co"># Exponential, right-skewed</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_C =</span> <span class="fu">runif</span>(<span class="dv">1000</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),         <span class="co"># Uniform, 0-1 range</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_D =</span> <span class="fu">rlnorm</span>(<span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">10</span>, <span class="at">sdlog =</span> <span class="dv">2</span>)  <span class="co"># Log-normal, very large</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Different scaling recipes</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>scaling_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">original =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">normalized =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_range</span>(<span class="fu">all_predictors</span>(), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">robust =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_center</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>  <span class="co"># Center using median</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_scale</span>(<span class="fu">all_predictors</span>())       <span class="co"># Scale using standard deviation</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply each recipe</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>scaled_data <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(scaling_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  scaling_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">scaling_method =</span> name) <span class="sc">%&gt;%</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>scaling_method, </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"feature"</span>, </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the effects</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scaled_data, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> scaling_method)) <span class="sc">+</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(scaling_method <span class="sc">~</span> feature, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effects of Different Scaling Methods"</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each method has different properties and use cases"</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Scaled Value"</span>,</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<p>Key insights about scaling: - <strong>Normalization</strong> (z-score): Centers at 0, scales by standard deviation. Good for normally distributed features. - <strong>Range scaling</strong>: Forces values between min and max. Preserves shape but sensitive to outliers. - <strong>Robust scaling</strong>: Uses median and MAD, resistant to outliers.</p>
</section>
<section id="transformations-for-skewed-data" class="level3">
<h3 class="anchored" data-anchor-id="transformations-for-skewed-data">Transformations for Skewed Data</h3>
<p>Many real-world variables are skewed. Let’s handle them properly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create skewed data</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>skewed_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mild_skew =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="at">shape =</span> <span class="dv">2</span>, <span class="at">rate =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">moderate_skew =</span> <span class="fu">rlnorm</span>(<span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">0</span>, <span class="at">sdlog =</span> <span class="dv">1</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">severe_skew =</span> <span class="fu">rexp</span>(<span class="dv">1000</span>, <span class="at">rate =</span> <span class="fl">0.1</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Different transformation recipes</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>transform_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">original =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">log =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_log</span>(<span class="fu">all_predictors</span>(), <span class="at">offset =</span> <span class="dv">1</span>),  <span class="co"># offset prevents log(0)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">sqrt =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_sqrt</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">yeo_johnson =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_YeoJohnson</span>(<span class="fu">all_predictors</span>()),  <span class="co"># Automatic optimal transformation</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">box_cox =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_BoxCox</span>(<span class="fu">all_predictors</span>())  <span class="co"># Requires positive values</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply transformations and calculate skewness</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>skewness_comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(transform_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  transformed <span class="ot">&lt;-</span> transform_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>mild_skew),</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>moderate_skew),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">severe_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>severe_skew)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>skewness_comparison <span class="sc">%&gt;%</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>method, <span class="at">names_to =</span> <span class="st">"feature"</span>, <span class="at">values_to =</span> <span class="st">"skewness"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> <span class="fu">abs</span>(skewness), <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>feature) <span class="sc">+</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effectiveness of Different Transformations on Skewed Data"</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower absolute skewness is better (closer to normal distribution)"</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Transformation Method"</span>,</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Skewness"</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p>The Yeo-Johnson transformation is particularly useful because it: - Automatically finds the optimal transformation parameter - Handles both positive and negative values - Often achieves near-normal distributions</p>
</section>
</section>
<section id="handling-categorical-variables" class="level2">
<h2 class="anchored" data-anchor-id="handling-categorical-variables">Handling Categorical Variables</h2>
<p>Categorical variables require special treatment. The approach depends on the model type and the nature of the categories.</p>
<section id="dummy-variables-one-hot-encoding" class="level3">
<h3 class="anchored" data-anchor-id="dummy-variables-one-hot-encoding">Dummy Variables (One-Hot Encoding)</h3>
<p>This is the most common approach for linear models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example with different types of categorical variables</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>cat_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>)),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"M"</span>, <span class="st">"L"</span>, <span class="st">"XL"</span>, <span class="st">"M"</span>), </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"M"</span>, <span class="st">"L"</span>, <span class="st">"XL"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">quality =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>, <span class="st">"excellent"</span>, <span class="st">"good"</span>, <span class="st">"bad"</span>)),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">12</span>, <span class="dv">14</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic dummy encoding</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>dummy_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> cat_data) <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>dummy_result <span class="ot">&lt;-</span> dummy_recipe <span class="sc">%&gt;%</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>dummy_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  outcome color_green color_red size_1 size_2 size_3 quality_excellent
    &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;             &lt;dbl&gt;
1      10           0         1 -0.671    0.5 -0.224                 0
2      15           0         0 -0.224   -0.5  0.671                 0
3      20           1         0  0.224   -0.5 -0.671                 1
4      12           0         1  0.671    0.5  0.224                 0
5      14           0         0 -0.224   -0.5  0.671                 0
# ℹ 1 more variable: quality_good &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Notice how each category becomes its own binary column, except one category is dropped (reference level) to avoid perfect multicollinearity.</p>
</section>
<section id="advanced-categorical-encoding" class="level3">
<h3 class="anchored" data-anchor-id="advanced-categorical-encoding">Advanced Categorical Encoding</h3>
<p>For high-cardinality categorical variables (many unique values), simple dummy encoding can create too many features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create high-cardinality example</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>high_card_data <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Neighborhood, MS_SubClass) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Neighborhood_Freq =</span> <span class="fu">n</span>(),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> Neighborhood</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Different encoding strategies</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>encoding_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standard dummy encoding</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">dummy =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(Neighborhood),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Frequency encoding</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Neighborhood_Freq =</span> <span class="fu">n</span>(), <span class="at">.by =</span> Neighborhood) <span class="sc">%&gt;%</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(Neighborhood),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target encoding (mean of target for each category)</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">Neighborhood_Mean =</span> <span class="fu">mean</span>(Sale_Price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> Neighborhood</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(Neighborhood),</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lumping rare categories</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">lumped =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_other</span>(Neighborhood, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span>  <span class="co"># Combine rare levels</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(Neighborhood)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare number of features created</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>feature_counts <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(encoding_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>  n_features <span class="ot">&lt;-</span> encoding_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ncol</span>()</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_features =</span> n_features</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>feature_counts <span class="sc">%&gt;%</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> n_features, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> n_features), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Count with Different Encoding Methods"</span>,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"High-cardinality categorical variables can create many features"</span>,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Encoding Method"</span>,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of Features"</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Each method has trade-offs: - <strong>Dummy encoding</strong>: Simple but creates many features - <strong>Frequency encoding</strong>: Single feature but loses category identity - <strong>Target encoding</strong>: Powerful but risks overfitting - <strong>Lumping</strong>: Reduces features while preserving main categories</p>
</section>
</section>
<section id="creating-interaction-terms" class="level2">
<h2 class="anchored" data-anchor-id="creating-interaction-terms">Creating Interaction Terms</h2>
<p>Interactions capture relationships between features that aren’t additive:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data with interaction effect</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>interaction_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True relationship includes interaction</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="dv">10</span> <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>x2 <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>x1<span class="sc">*</span>x2 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Models with and without interaction</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>no_interaction_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">data =</span> interaction_data)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>with_interaction_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">data =</span> interaction_data) <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> x1<span class="sc">:</span>x2)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit both models</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>no_int_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(no_interaction_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(interaction_data)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>with_int_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(with_interaction_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(interaction_data)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction surface</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>),</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>grid_no_int <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">predict</span>(no_int_fit, grid)<span class="sc">$</span>.pred,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"Without Interaction"</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>grid_with_int <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">predict</span>(with_int_fit, grid)<span class="sc">$</span>.pred,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"With Interaction"</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the difference</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(grid_no_int, grid_with_int) <span class="sc">%&gt;%</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">fill =</span> prediction)) <span class="sc">+</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Including Interaction Terms"</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Interaction allows the effect of x1 to depend on x2"</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature 1"</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Feature 2"</span>,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Predicted</span><span class="sc">\n</span><span class="st">Value"</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare model performance</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Without Interaction"</span>, <span class="st">"With Interaction"</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((interaction_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">predict</span>(no_int_fit, interaction_data)<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((interaction_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">predict</span>(with_int_fit, interaction_data)<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Without Interaction</td>
<td style="text-align: right;">4.511</td>
</tr>
<tr class="even">
<td style="text-align: left;">With Interaction</td>
<td style="text-align: right;">2.018</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The interaction term allows the model to capture how the effect of one variable depends on another. This is crucial in many real-world scenarios: - Price elasticity depending on income level - Drug effectiveness depending on patient age - Marketing response depending on customer segment</p>
</section>
<section id="handling-missing-data" class="level2">
<h2 class="anchored" data-anchor-id="handling-missing-data">Handling Missing Data</h2>
<p>Missing data is ubiquitous in real-world datasets. The strategy depends on why data is missing:</p>
<section id="types-of-missingness" class="level3">
<h3 class="anchored" data-anchor-id="types-of-missingness">Types of Missingness</h3>
<ol type="1">
<li><strong>Missing Completely at Random (MCAR)</strong>: Missingness is independent of all variables</li>
<li><strong>Missing at Random (MAR)</strong>: Missingness depends on observed variables</li>
<li><strong>Missing Not at Random (MNAR)</strong>: Missingness depends on the missing value itself</li>
</ol>
<p>Let’s explore different imputation strategies:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with different missing patterns</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>missing_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="dv">2</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>x2 <span class="sc">+</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce different missing patterns</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>missing_data <span class="ot">&lt;-</span> missing_data <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MCAR: Random 20% missing</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1_mcar =</span> <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="fu">n</span>()) <span class="sc">&lt;</span> <span class="fl">0.2</span>, <span class="cn">NA</span>, x1),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MAR: Missing depends on x2</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2_mar =</span> <span class="fu">ifelse</span>(x2 <span class="sc">&lt;</span> <span class="fu">quantile</span>(x2, <span class="fl">0.2</span>), <span class="cn">NA</span>, x2),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MNAR: Large values more likely missing</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3_mnar =</span> <span class="fu">ifelse</span>(x3 <span class="sc">&gt;</span> <span class="fu">quantile</span>(x3, <span class="fl">0.8</span>) <span class="sc">&amp;</span> <span class="fu">runif</span>(<span class="fu">n</span>()) <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="cn">NA</span>, x3)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Different imputation strategies</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>imputation_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows with missing data</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">complete_case =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_naomit</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mean imputation</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_mean</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Median imputation (robust to outliers)</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">median_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_median</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K-nearest neighbors imputation</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">knn_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">5</span>),</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear imputation (using other variables)</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x1_mcar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x2_mar, x3_mnar)) <span class="sc">%&gt;%</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x2_mar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x1_mcar, x3_mnar)) <span class="sc">%&gt;%</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x3_mnar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x1_mcar, x2_mar))</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply imputation and evaluate</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>imputation_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(imputation_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  imputed <span class="ot">&lt;-</span> imputation_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate statistics</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_rows =</span> <span class="fu">nrow</span>(imputed),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x1_mcar <span class="sc">-</span> missing_data<span class="sc">$</span>x1[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x1_mcar)], </span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x2_mar <span class="sc">-</span> missing_data<span class="sc">$</span>x2[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x2_mar)], </span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x3_mnar <span class="sc">-</span> missing_data<span class="sc">$</span>x3[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x3_mnar)], </span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize imputation quality</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>imputation_results <span class="sc">%&gt;%</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"error"</span>), </span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>, </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"error"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> <span class="fu">abs</span>(error), <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Imputation Error by Method"</span>,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower is better - comparing imputed values to true values"</span>,</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Imputation Method"</span>,</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Mean Error"</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show data loss with complete case</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Complete Case"</span>, <span class="st">"Imputation Methods"</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Rows Retained</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    imputation_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(method <span class="sc">==</span> <span class="st">"complete_case"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n_rows),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Percentage</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    imputation_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(method <span class="sc">==</span> <span class="st">"complete_case"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n_rows) <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: right;">Rows Retained</th>
<th style="text-align: right;">Percentage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Complete Case</td>
<td style="text-align: right;">551</td>
<td style="text-align: right;">55.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Imputation Methods</td>
<td style="text-align: right;">1000</td>
<td style="text-align: right;">100.0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Key insights about imputation: - <strong>Complete case analysis</strong> loses a lot of data - <strong>Mean/median imputation</strong> is simple but ignores relationships - <strong>KNN imputation</strong> uses similar observations - <strong>Linear imputation</strong> preserves linear relationships - Choice depends on missing mechanism and data structure</p>
</section>
</section>
<section id="feature-selection-and-dimensionality-reduction" class="level2">
<h2 class="anchored" data-anchor-id="feature-selection-and-dimensionality-reduction">Feature Selection and Dimensionality Reduction</h2>
<p>Too many features can lead to overfitting and computational issues. Let’s explore methods to reduce dimensionality:</p>
<section id="filter-methods" class="level3">
<h3 class="anchored" data-anchor-id="filter-methods">Filter Methods</h3>
<p>Filter methods select features based on statistical tests:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with relevant and irrelevant features</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>feature_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relevant features</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_2 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Irrelevant features</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_2 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_4 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target depends only on relevant features</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="dv">2</span><span class="sc">*</span>relevant_1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>relevant_2 <span class="sc">-</span> relevant_3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlations with target</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>correlations <span class="ot">&lt;-</span> feature_data <span class="sc">%&gt;%</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target) <span class="sc">%&gt;%</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">cor</span>(., feature_data<span class="sc">$</span>target, <span class="at">use =</span> <span class="st">"complete.obs"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"feature"</span>, <span class="at">value =</span> <span class="st">"correlation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_correlation =</span> <span class="fu">abs</span>(correlation),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_type =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(feature, <span class="st">"relevant"</span>), <span class="st">"Relevant"</span>, <span class="st">"Noise"</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize correlations</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(correlations, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, abs_correlation), </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> abs_correlation, </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fill =</span> feature_type)) <span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Relevant"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"Noise"</span> <span class="ot">=</span> <span class="st">"gray50"</span>)) <span class="sc">+</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Selection Using Correlation Filter"</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red line shows potential threshold for feature selection"</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Correlation with Target"</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"True Feature Type"</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recipe with correlation filter</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>filtered_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> feature_data) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>) <span class="sc">%&gt;%</span>  <span class="co"># Remove highly correlated features</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(<span class="fu">all_predictors</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>(), </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">skip =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">threshold =</span> <span class="fl">0.1</span>)  <span class="co"># This would remove low correlation features</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Near-zero variance filter</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>nzv_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> feature_data) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>())  <span class="co"># Remove features with near-zero variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="principal-component-analysis-pca" class="level3">
<h3 class="anchored" data-anchor-id="principal-component-analysis-pca">Principal Component Analysis (PCA)</h3>
<p>PCA creates new features that are linear combinations of original features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create correlated features for PCA demonstration</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pca_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> x1 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),  <span class="co"># Correlated with x1</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),  <span class="co"># Correlated with x3</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x5 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> x1 <span class="sc">+</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA recipe</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> pca_data) <span class="sc">%&gt;%</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>  <span class="co"># Important: normalize before PCA</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_predictors</span>(), <span class="at">num_comp =</span> <span class="dv">3</span>)  <span class="co"># Keep 3 components</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare and examine</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>pca_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_recipe)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>pca_result <span class="ot">&lt;-</span> <span class="fu">bake</span>(pca_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract loadings</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>pca_loadings <span class="ot">&lt;-</span> <span class="fu">tidy</span>(pca_prep, <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co"># 2nd step is PCA</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(component <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">component =</span> <span class="fu">factor</span>(component, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize loadings</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pca_loadings, <span class="fu">aes</span>(<span class="at">x =</span> terms, <span class="at">y =</span> value, <span class="at">fill =</span> value <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>component) <span class="sc">+</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PCA Loadings"</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"How original features contribute to each principal component"</span>,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Original Feature"</span>,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Loading"</span>,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Sign"</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance explained</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pca_variance <span class="ot">&lt;-</span> pca_prep<span class="sc">$</span>steps[[<span class="dv">2</span>]]<span class="sc">$</span>res<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>variance_explained <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pca_variance)),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> pca_variance,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span> <span class="ot">=</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Cumulative Proportion</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scree plot</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(variance_explained <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>), </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> PC, <span class="at">y =</span> <span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(<span class="st">`</span><span class="at">Cumulative Proportion</span><span class="st">`</span>, <span class="dv">2</span>)), </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PCA Scree Plot"</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Shows variance explained by each component"</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Principal Component"</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proportion of Variance Explained"</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<p>PCA is powerful for: - Reducing dimensionality while preserving variance - Removing multicollinearity - Visualization (first 2-3 components) - Noise reduction</p>
</section>
</section>
<section id="time-based-features" class="level2">
<h2 class="anchored" data-anchor-id="time-based-features">Time-Based Features</h2>
<p>Time series data requires special feature engineering:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time series data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>time_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2022-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_value =</span> <span class="dv">1000</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">length.out =</span> <span class="fu">length</span>(date)),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">weekly =</span> <span class="dv">50</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">wday</span>(date) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(date), <span class="dv">0</span>, <span class="dv">30</span>),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> base_value <span class="sc">+</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-based feature engineering</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>time_features <span class="ot">&lt;-</span> time_data <span class="sc">%&gt;%</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic time components</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> <span class="fu">day</span>(date),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_of_year =</span> <span class="fu">week</span>(date),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(date),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cyclical encoding (preserves continuity)</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day <span class="sc">/</span> <span class="dv">31</span>),</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day <span class="sc">/</span> <span class="dv">31</span>),</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary indicators</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> <span class="fu">wday</span>(date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_start =</span> day <span class="sc">&lt;=</span> <span class="dv">7</span>,</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_end =</span> day <span class="sc">&gt;=</span> <span class="fu">day</span>(<span class="fu">ceiling_date</span>(date, <span class="st">"month"</span>) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">7</span>)),</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag features</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_1 =</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_7 =</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>),</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_30 =</span> <span class="fu">lag</span>(sales, <span class="dv">30</span>),</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling statistics</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_7 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_30 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">30</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_7 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">7</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize some engineered features</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="ot">&lt;-</span> time_features <span class="sc">%&gt;%</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales, month_sin, month_cos, is_weekend, sales_lag_7, sales_ma_30) <span class="sc">%&gt;%</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"feature"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature <span class="sc">!=</span> <span class="st">"sales"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature, <span class="at">correlation =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(correlation)))</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(feature_importance, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, <span class="fu">abs</span>(correlation)), </span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>                               <span class="at">y =</span> <span class="fu">abs</span>(correlation))) <span class="sc">+</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Importance of Time-Based Features"</span>,</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Correlation with sales"</span>,</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Correlation"</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show cyclical encoding</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cyclical_demo <span class="ot">&lt;-</span> time_features <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month, month_sin, month_cos) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(month)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(cyclical_demo, <span class="fu">aes</span>(<span class="at">x =</span> month_cos, <span class="at">y =</span> month_sin)) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(month)), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> month), <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Cyclical Encoding of Months"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Preserves continuity: December is close to January"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Cosine Component"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sine Component"</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="1344"></p>
</figure>
</div>
</div>
</div>
<p>Time features are crucial for: - Capturing seasonality and trends - Accounting for day-of-week effects - Incorporating historical information (lags) - Smoothing noisy signals (moving averages)</p>
</section>
<section id="text-features-brief-introduction" class="level2">
<h2 class="anchored" data-anchor-id="text-features-brief-introduction">Text Features (Brief Introduction)</h2>
<p>Text data requires specialized preprocessing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple text feature engineering example</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>text_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">review =</span> <span class="fu">c</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This product is absolutely amazing! Best purchase ever!"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible quality. Very disappointed. Would not recommend."</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Good value for money. Satisfied with the purchase."</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Excellent service and fast delivery. Five stars!"</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Product broke after one day. Complete waste of money."</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">rating =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Text feature recipe using textrecipes</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>text_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(rating <span class="sc">~</span> review, <span class="at">data =</span> text_data) <span class="sc">%&gt;%</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tokenize text</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(review) <span class="sc">%&gt;%</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove stop words</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_stopwords</span>(review) <span class="sc">%&gt;%</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n-grams</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ngram</span>(review, <span class="at">num_tokens =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to term frequency</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tf</span>(review, <span class="at">weight_scheme =</span> <span class="st">"binary"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optionally: TF-IDF weighting</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_tfidf(review) %&gt;%</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only most common terms</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenfilter</span>(review, <span class="at">max_tokens =</span> <span class="dv">20</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This is just a demonstration - real text processing needs more data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Text features can include: - Word counts and frequencies - N-grams (sequences of words) - TF-IDF weights - Sentiment scores - Word embeddings</p>
</section>
<section id="best-practices-and-common-pitfalls" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-and-common-pitfalls">Best Practices and Common Pitfalls</h2>
<section id="best-practices" class="level3">
<h3 class="anchored" data-anchor-id="best-practices">Best Practices</h3>
<ol type="1">
<li><strong>Always split before feature engineering</strong>
<ul>
<li>Prevents data leakage</li>
<li>Ensures fair evaluation</li>
</ul></li>
<li><strong>Order of operations matters</strong>
<ul>
<li>Impute missing values before normalization</li>
<li>Create interactions after dummy encoding</li>
<li>Normalize after all transformations</li>
</ul></li>
<li><strong>Keep it simple initially</strong>
<ul>
<li>Start with basic features</li>
<li>Add complexity gradually</li>
<li>Validate improvements</li>
</ul></li>
<li><strong>Document your choices</strong>
<ul>
<li>Why each transformation?</li>
<li>What domain knowledge informed decisions?</li>
</ul></li>
</ol>
</section>
<section id="common-pitfalls-to-avoid" class="level3">
<h3 class="anchored" data-anchor-id="common-pitfalls-to-avoid">Common Pitfalls to Avoid</h3>
<p>Let’s demonstrate some common mistakes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create split if not already done</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"ames_split"</span>)) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Normalizing before splitting</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># This leaks information from test set into training</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>wrong_approach <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]) <span class="sc">%&gt;%</span>  <span class="co"># Uses ALL data!</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>()</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Normalize within recipe</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>right_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area, <span class="at">data =</span> <span class="fu">training</span>(ames_split)) <span class="sc">%&gt;%</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(Gr_Liv_Area)  <span class="co"># Will use only training data statistics</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Creating too many features</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>overengineered_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_poly</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">degree =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Too many polynomial terms</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> <span class="fu">all_numeric_predictors</span>()<span class="sc">^</span><span class="dv">2</span>)  <span class="co"># All 2-way interactions</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Thoughtful feature engineering</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>thoughtful_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_poly</span>(Gr_Liv_Area, <span class="at">degree =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co"># Only where needed</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Overall_Cond)  <span class="co"># Specific, meaningful interaction</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="complete-example-putting-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="complete-example-putting-it-all-together">Complete Example: Putting It All Together</h2>
<p>Let’s create a comprehensive feature engineering pipeline:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use credit data for a complete example</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Status)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Comprehensive recipe</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>comprehensive_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Status <span class="sc">~</span> ., <span class="at">data =</span> credit_train) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Handle missing values</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Feature creation</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">debt_to_income =</span> Expenses <span class="sc">/</span> Income,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">savings_rate =</span> (Income <span class="sc">-</span> Expenses) <span class="sc">/</span> Income,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">has_records =</span> <span class="sc">!</span><span class="fu">is.na</span>(Records)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Handle skewness</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(Income, Amount) <span class="sc">%&gt;%</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Create dummy variables</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="sc">-</span>has_records) <span class="sc">%&gt;%</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Remove near-zero variance</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Normalize</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Remove highly correlated features</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8. PCA for dimensionality reduction (optional)</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_pca(all_numeric_predictors(), threshold = 0.95) %&gt;%</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 9. Balance classes (for classification)</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_smote</span>(Status)  <span class="co"># Synthetic minority oversampling</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the recipe</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>comprehensive_recipe</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare and check results</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>comprehensive_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(comprehensive_recipe)</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>comprehensive_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(comprehensive_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of transformations</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">Stage =</span> <span class="fu">c</span>(<span class="st">"Original"</span>, <span class="st">"After Engineering"</span>),</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N Features</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">ncol</span>(credit_train) <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">ncol</span>(comprehensive_baked) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N Observations</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(credit_train), <span class="fu">nrow</span>(comprehensive_baked)),</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Class Balance</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(credit_train<span class="sc">$</span>Status <span class="sc">==</span> <span class="st">"good"</span>) <span class="sc">/</span> <span class="fu">nrow</span>(credit_train),</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(comprehensive_baked<span class="sc">$</span>Status <span class="sc">==</span> <span class="st">"good"</span>) <span class="sc">/</span> <span class="fu">nrow</span>(comprehensive_baked)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Stage</th>
<th style="text-align: right;">N Features</th>
<th style="text-align: right;">N Observations</th>
<th style="text-align: right;">Class Balance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Original</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">3340</td>
<td style="text-align: right;">0.719</td>
</tr>
<tr class="even">
<td style="text-align: left;">After Engineering</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">4800</td>
<td style="text-align: right;">0.500</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a model with the engineered features</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(comprehensive_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(credit_train) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_test) <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(credit_test) <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth =</span> Status, <span class="at">estimate =</span> .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary         0.777</code></pre>
</div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="exercise-1-engineer-features-for-house-prices" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-engineer-features-for-house-prices">Exercise 1: Engineer Features for House Prices</h3>
<p>Create a comprehensive feature engineering pipeline for the Ames housing data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>exercise_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform outcome</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create meaningful features</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">House_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Built,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Remod_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Remod_Add,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Has_Garage =</span> <span class="sc">!</span><span class="fu">is.na</span>(Garage_Type),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Bathrooms =</span> Full_Bath <span class="sc">+</span> Half_Bath <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_SF =</span> Gr_Liv_Area <span class="sc">+</span> Total_Bsmt_SF,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Quality_x_Condition =</span> Overall_Cond <span class="sc">*</span> Overall_Cond</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove original year variables</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Year_Built, Year_Remod_Add, Mo_Sold, Year_Sold) <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle missing values</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rare categories</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform skewed variables (before creating dummies)</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(Lot_Area, Gr_Liv_Area, Total_SF) <span class="sc">%&gt;%</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Interactions (before creating dummies)</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Total_SF<span class="sc">:</span>Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create dummies</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove zero variance</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the recipe</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>exercise_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(exercise_recipe)</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>exercise_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(exercise_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Created"</span>, <span class="fu">ncol</span>(exercise_baked) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"features from"</span>, </span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"original features"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Created 103 features from 73 original features"</code></pre>
</div>
</div>
</section>
<section id="exercise-2-handle-high-cardinality-categorical" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-handle-high-cardinality-categorical">Exercise 2: Handle High-Cardinality Categorical</h3>
<p>Work with a high-cardinality categorical variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic high-cardinality data</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>high_card_ex <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="fu">sample</span>(<span class="fu">paste0</span>(<span class="st">"Cat_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make target depend somewhat on category</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> target <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(category)) <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Try different encoding strategies</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Frequency encoding</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">cat_freq =</span> <span class="fu">n</span>(), <span class="at">.by =</span> category) <span class="sc">%&gt;%</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(category),</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target encoding with smoothing</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_enc =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_mean =</span> <span class="fu">mean</span>(target),</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_count =</span> <span class="fu">n</span>(),</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> category</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Smooth with global mean for rare categories</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_smooth =</span> (cat_mean <span class="sc">*</span> cat_count <span class="sc">+</span> <span class="fu">mean</span>(target) <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">/</span> (cat_count <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(category, cat_mean, cat_count),</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Embedding-like (PCA on dummies)</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">embedding =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(category) <span class="sc">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">"category_"</span>), <span class="at">num_comp =</span> <span class="dv">10</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare approaches</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(name) {</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  prepped <span class="ot">&lt;-</span> <span class="fu">prep</span>(strategies[[name]])</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_features =</span> <span class="fu">ncol</span>(baked) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparison)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  method     n_features
  &lt;chr&gt;           &lt;dbl&gt;
1 frequency           3
2 target_enc          3
3 embedding          11</code></pre>
</div>
</div>
</section>
<section id="exercise-3-time-series-feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-time-series-feature-engineering">Exercise 3: Time Series Feature Engineering</h3>
<p>Create features for time series prediction:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate time series data</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ts_exercise <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend =</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="fu">n</span>() <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">seasonal =</span> <span class="dv">50</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">yday</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly =</span> <span class="dv">20</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">wday</span>(date) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales =</span> <span class="dv">1000</span> <span class="sc">+</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time features</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>ts_features <span class="ot">&lt;-</span> ts_exercise <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calendar features</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(date),</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(date),</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_month =</span> <span class="fu">day</span>(date),</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(date),</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cyclical encoding</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">dow_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day_of_week <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">dow_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day_of_week <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indicators</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_start =</span> day_of_month <span class="sc">&lt;=</span> <span class="dv">3</span>,</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_end =</span> day_of_month <span class="sc">&gt;=</span> <span class="dv">28</span>,</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag features</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_1 =</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_7 =</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>),</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_30 =</span> <span class="fu">lag</span>(sales, <span class="dv">30</span>),</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_365 =</span> <span class="fu">lag</span>(sales, <span class="dv">365</span>),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling statistics</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_7 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_30 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">30</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_7 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">7</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_30 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">30</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Differences</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_diff_1 =</span> sales <span class="sc">-</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_diff_7 =</span> sales <span class="sc">-</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate feature importance</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>feature_cors <span class="ot">&lt;-</span> ts_features <span class="sc">%&gt;%</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date, <span class="sc">-</span>trend, <span class="sc">-</span>seasonal, <span class="sc">-</span>weekly, <span class="sc">-</span>noise) <span class="sc">%&gt;%</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sales) <span class="sc">%&gt;%</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">cor</span>(., ts_features<span class="sc">$</span>sales)) <span class="sc">%&gt;%</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"feature"</span>, <span class="at">value =</span> <span class="st">"correlation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(correlation))) <span class="sc">%&gt;%</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>)</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(feature_cors, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, <span class="fu">abs</span>(correlation)), </span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> <span class="fu">abs</span>(correlation))) <span class="sc">+</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top Time Series Features"</span>,</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Absolute correlation with sales"</span>,</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"|Correlation|"</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="10-feature-engineering_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Feature engineering is both an art and a science. You’ve learned:</p>
<p>✅ <strong>Core concepts</strong>: Why feature engineering matters and how it works<br>
✅ <strong>Numeric transformations</strong>: Scaling, normalization, handling skewness<br>
✅ <strong>Categorical encoding</strong>: Dummies, target encoding, handling high cardinality<br>
✅ <strong>Interaction terms</strong>: Capturing non-additive relationships<br>
✅ <strong>Missing data strategies</strong>: Various imputation methods and when to use them<br>
✅ <strong>Dimensionality reduction</strong>: PCA and feature selection<br>
✅ <strong>Time features</strong>: Extracting temporal patterns<br>
✅ <strong>Best practices</strong>: Avoiding leakage, proper ordering, validation</p>
<p>Remember: - Feature engineering often has more impact than model selection - Domain knowledge is invaluable for creating meaningful features - Always validate that engineered features improve performance - Keep transformations in recipes for reproducibility - Start simple and add complexity gradually</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>In <a href="./11-model-specification.html">Chapter 11</a>, we’ll explore parsnip for unified model specification across different engines.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="http://www.feat.engineering/">Feature Engineering and Selection</a></li>
<li><a href="https://recipes.tidymodels.org/">Recipes Documentation</a></li>
<li><a href="https://www.oreilly.com/library/view/feature-engineering-for/9781491953235/">Feature Engineering for Machine Learning</a></li>
<li><a href="https://www.tmwr.org/recipes.html">Tidy Modeling with R - Recipes Chapter</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all elements with class 'quarto-title-meta-heading' that contain "Author"
    const authorHeadings = document.querySelectorAll('.quarto-title-meta-heading');
    
    authorHeadings.forEach(function(heading) {
        if (heading.textContent.trim() === 'Author') {
            heading.textContent = 'Authors';
        }
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 10: Feature Engineering with recipes - The Art and Science of Data Preparation"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "David Sarrat González, Juan R González"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will master:</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The philosophy and importance of feature engineering</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creating and applying recipes in tidymodels</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Numeric transformations and scaling</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handling categorical variables</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Creating interaction terms and polynomial features</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dealing with missing data systematically</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Feature selection and dimensionality reduction</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Time-based and text features</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Best practices and common pitfalls</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Download R Script</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>You can download the complete R code for this chapter:</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">📥 Download 10-feature-engineering.R</span><span class="co">](R_scripts/10-feature-engineering.R)</span>{.btn .btn-primary download="10-feature-engineering.R"}</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## What is Feature Engineering?</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>Feature engineering is the process of transforming raw data into features that better represent the underlying problem to predictive models. It's often said that "data and features determine the upper limit of machine learning, while models and algorithms only approach this limit."</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Feature Engineering Matters</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>Think of feature engineering as translating your data into a language that your model can better understand. Even the most sophisticated algorithm will struggle with poorly prepared data, while a simple model can perform remarkably well with thoughtfully engineered features.</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>Consider these scenarios:</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Raw timestamps** → Extract hour of day, day of week, is_weekend, season</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Text addresses** → Extract zip code, city, distance from city center</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Numerical ratios** → Price per square foot instead of just price and area</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Domain knowledge** → Age of house at sale instead of just year built and sale year</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>Let's see this in action:</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example datasets</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data)</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple example to show feature engineering impact</span></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>simple_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">sale_date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2022-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">temperature =</span> <span class="dv">50</span> <span class="sc">+</span> <span class="dv">30</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(sale_date) <span class="sc">/</span> <span class="dv">365</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(sale_date), <span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> <span class="dv">1000</span> <span class="sc">+</span> <span class="dv">200</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(sale_date) <span class="sc">/</span> <span class="dv">365</span>) <span class="sc">+</span> </span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>          <span class="dv">100</span> <span class="sc">*</span> (<span class="fu">wday</span>(sale_date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">+</span>  <span class="co"># Weekend boost</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rnorm</span>(<span class="fu">length</span>(sale_date), <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Without feature engineering - just using date as numeric</span></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>bad_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(sales <span class="sc">~</span> <span class="fu">as.numeric</span>(sale_date), <span class="at">data =</span> simple_data)</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a><span class="co"># With feature engineering</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>good_data <span class="ot">&lt;-</span> simple_data <span class="sc">%&gt;%</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(sale_date),</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(sale_date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> <span class="fu">wday</span>(sale_date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(sale_date),</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">days_since_start =</span> <span class="fu">as.numeric</span>(sale_date <span class="sc">-</span> <span class="fu">min</span>(sale_date))</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>good_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(sales <span class="sc">~</span> month <span class="sc">+</span> is_weekend <span class="sc">+</span> temperature <span class="sc">+</span> days_since_start, </span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> good_data)</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare R-squared</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Without Feature Engineering"</span>, <span class="st">"With Feature Engineering"</span>),</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">R-squared</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">summary</span>(bad_model)<span class="sc">$</span>r.squared, <span class="fu">summary</span>(good_model)<span class="sc">$</span>r.squared)</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>Notice the dramatic improvement! The model with engineered features captures patterns that the raw date couldn't represent.</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a><span class="fu">## The recipes Package Philosophy</span></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>The <span class="in">`recipes`</span> package provides a domain-specific language for feature engineering. Think of it like writing a recipe for a meal:</span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Ingredients** (raw data): What you start with</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Instructions** (steps): How to transform the ingredients</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Preparation** (prep): Getting everything ready with your training data</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Baking** (bake): Applying the recipe to new data</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>This approach ensures:</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reproducibility**: The same transformations applied consistently</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Modularity**: Easy to add, remove, or modify steps</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prevention of data leakage**: Transformations learned only from training data</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creating Your First Recipe</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>Let's start with a basic recipe and build complexity gradually:</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the Ames housing data</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sale_Price <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="fl">0.8</span>)</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sale_Price <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(ames_train)</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a basic recipe</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>basic_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Lot_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond, </span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="co"># View the recipe</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>basic_recipe</span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>At this point, the recipe is just a specification - it hasn't done anything yet. It's like having a recipe card but not having cooked the meal.</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding Steps to the Recipe</span></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>Now let's add transformation steps. Each step transforms the data in a specific way:</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced recipe with multiple steps</span></span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>enhanced_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Lot_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>                          Neighborhood <span class="sc">+</span> Gr_Liv_Area, </span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Log transform the outcome</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Create a new feature</span></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">House_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Built) <span class="sc">%&gt;%</span></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Remove the original Year_Built</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Year_Built) <span class="sc">%&gt;%</span></span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Normalize numeric predictors</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Create dummy variables for categorical predictors</span></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>enhanced_recipe</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>Each step is performed in order, and the output of one step becomes the input to the next. This is crucial to understand - order matters!</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a><span class="fu">### Preparing and Baking the Recipe</span></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>Now we need to "prepare" the recipe using the training data, then "bake" it to apply the transformations:</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the recipe (learn parameters from training data)</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>prepped_recipe <span class="ot">&lt;-</span> <span class="fu">prep</span>(enhanced_recipe, <span class="at">training =</span> ames_train)</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a><span class="co"># See what was learned</span></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>prepped_recipe</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to training data</span></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>baked_train <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_recipe, <span class="at">new_data =</span> <span class="cn">NULL</span>)  <span class="co"># NULL means use training data</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_train)</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test data</span></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>baked_test <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped_recipe, <span class="at">new_data =</span> ames_test)</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that dimensions match (except for rows)</span></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">Dataset =</span> <span class="fu">c</span>(<span class="st">"Training"</span>, <span class="st">"Test"</span>),</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">Rows =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(baked_train), <span class="fu">nrow</span>(baked_test)),</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">Columns =</span> <span class="fu">c</span>(<span class="fu">ncol</span>(baked_train), <span class="fu">ncol</span>(baked_test))</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>The key insight: <span class="in">`prep()`</span> learns any necessary parameters (like mean and SD for normalization) from the training data, and <span class="in">`bake()`</span> applies these learned transformations to any dataset.</span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a><span class="fu">## Numeric Transformations</span></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>Numeric features often need transformation to work well with models. Let's explore the most important transformations:</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scaling and Normalization</span></span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>Different scaling methods serve different purposes:</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example data with different scales</span></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a>scaling_demo <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_A =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span> <span class="dv">15</span>),      <span class="co"># Normal, mean=100</span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_B =</span> <span class="fu">rexp</span>(<span class="dv">1000</span>, <span class="at">rate =</span> <span class="fl">0.01</span>),               <span class="co"># Exponential, right-skewed</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_C =</span> <span class="fu">runif</span>(<span class="dv">1000</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),         <span class="co"># Uniform, 0-1 range</span></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature_D =</span> <span class="fu">rlnorm</span>(<span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">10</span>, <span class="at">sdlog =</span> <span class="dv">2</span>)  <span class="co"># Log-normal, very large</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Different scaling recipes</span></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>scaling_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">original =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo),</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">normalized =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_range</span>(<span class="fu">all_predictors</span>(), <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>),</span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">robust =</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> scaling_demo) <span class="sc">%&gt;%</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_center</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>  <span class="co"># Center using median</span></span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_scale</span>(<span class="fu">all_predictors</span>())       <span class="co"># Scale using standard deviation</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply each recipe</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>scaled_data <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(scaling_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>  scaling_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">scaling_method =</span> name) <span class="sc">%&gt;%</span></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>scaling_method, </span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"feature"</span>, </span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the effects</span></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scaled_data, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> scaling_method)) <span class="sc">+</span></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(scaling_method <span class="sc">~</span> feature, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effects of Different Scaling Methods"</span>,</span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each method has different properties and use cases"</span>,</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Scaled Value"</span>,</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>Key insights about scaling:</span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Normalization** (z-score): Centers at 0, scales by standard deviation. Good for normally distributed features.</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Range scaling**: Forces values between min and max. Preserves shape but sensitive to outliers.</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Robust scaling**: Uses median and MAD, resistant to outliers.</span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transformations for Skewed Data</span></span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>Many real-world variables are skewed. Let's handle them properly:</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a><span class="co"># Create skewed data</span></span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>skewed_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>  <span class="at">mild_skew =</span> <span class="fu">rgamma</span>(<span class="dv">1000</span>, <span class="at">shape =</span> <span class="dv">2</span>, <span class="at">rate =</span> <span class="fl">0.5</span>),</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>  <span class="at">moderate_skew =</span> <span class="fu">rlnorm</span>(<span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">0</span>, <span class="at">sdlog =</span> <span class="dv">1</span>),</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">severe_skew =</span> <span class="fu">rexp</span>(<span class="dv">1000</span>, <span class="at">rate =</span> <span class="fl">0.1</span>),</span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Different transformation recipes</span></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>transform_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a>  <span class="at">original =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data),</span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>  <span class="at">log =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_log</span>(<span class="fu">all_predictors</span>(), <span class="at">offset =</span> <span class="dv">1</span>),  <span class="co"># offset prevents log(0)</span></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a>  <span class="at">sqrt =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_sqrt</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a>  <span class="at">yeo_johnson =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_YeoJohnson</span>(<span class="fu">all_predictors</span>()),  <span class="co"># Automatic optimal transformation</span></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a>  <span class="at">box_cox =</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> skewed_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_BoxCox</span>(<span class="fu">all_predictors</span>())  <span class="co"># Requires positive values</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply transformations and calculate skewness</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a>skewness_comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(transform_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a>  transformed <span class="ot">&lt;-</span> transform_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">mild_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>mild_skew),</span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a>    <span class="at">moderate_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>moderate_skew),</span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">severe_skew =</span> moments<span class="sc">::</span><span class="fu">skewness</span>(transformed<span class="sc">$</span>severe_skew)</span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>skewness_comparison <span class="sc">%&gt;%</span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>method, <span class="at">names_to =</span> <span class="st">"feature"</span>, <span class="at">values_to =</span> <span class="st">"skewness"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> <span class="fu">abs</span>(skewness), <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>feature) <span class="sc">+</span></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effectiveness of Different Transformations on Skewed Data"</span>,</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower absolute skewness is better (closer to normal distribution)"</span>,</span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Transformation Method"</span>,</span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Skewness"</span></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a>The Yeo-Johnson transformation is particularly useful because it:</span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Automatically finds the optimal transformation parameter</span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handles both positive and negative values</span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Often achieves near-normal distributions</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a><span class="fu">## Handling Categorical Variables</span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>Categorical variables require special treatment. The approach depends on the model type and the nature of the categories.</span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dummy Variables (One-Hot Encoding)</span></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>This is the most common approach for linear models:</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Example with different types of categorical variables</span></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a>cat_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>)),</span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"M"</span>, <span class="st">"L"</span>, <span class="st">"XL"</span>, <span class="st">"M"</span>), </span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a>                <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"M"</span>, <span class="st">"L"</span>, <span class="st">"XL"</span>), <span class="at">ordered =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a>  <span class="at">quality =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="st">"good"</span>, <span class="st">"bad"</span>, <span class="st">"excellent"</span>, <span class="st">"good"</span>, <span class="st">"bad"</span>)),</span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a>  <span class="at">outcome =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">12</span>, <span class="dv">14</span>)</span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic dummy encoding</span></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a>dummy_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(outcome <span class="sc">~</span> ., <span class="at">data =</span> cat_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a>dummy_result <span class="ot">&lt;-</span> dummy_recipe <span class="sc">%&gt;%</span></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a>dummy_result</span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a>Notice how each category becomes its own binary column, except one category is dropped (reference level) to avoid perfect multicollinearity.</span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a><span class="fu">### Advanced Categorical Encoding</span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>For high-cardinality categorical variables (many unique values), simple dummy encoding can create too many features:</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Create high-cardinality example</span></span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>high_card_data <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Neighborhood, MS_SubClass) <span class="sc">%&gt;%</span></span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">Neighborhood_Freq =</span> <span class="fu">n</span>(),</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">.by =</span> Neighborhood</span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a><span class="co"># Different encoding strategies</span></span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>encoding_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standard dummy encoding</span></span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a>  <span class="at">dummy =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(Neighborhood),</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Frequency encoding</span></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">Neighborhood_Freq =</span> <span class="fu">n</span>(), <span class="at">.by =</span> Neighborhood) <span class="sc">%&gt;%</span></span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(Neighborhood),</span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target encoding (mean of target for each category)</span></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a>      <span class="at">Neighborhood_Mean =</span> <span class="fu">mean</span>(Sale_Price, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> Neighborhood</span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(Neighborhood),</span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lumping rare categories</span></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a>  <span class="at">lumped =</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Neighborhood, <span class="at">data =</span> high_card_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_other</span>(Neighborhood, <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span>  <span class="co"># Combine rare levels</span></span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(Neighborhood)</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare number of features created</span></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a>feature_counts <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(encoding_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>  n_features <span class="ot">&lt;-</span> encoding_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ncol</span>()</span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_features =</span> n_features</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a>feature_counts <span class="sc">%&gt;%</span></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> n_features, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> n_features), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Count with Different Encoding Methods"</span>,</span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"High-cardinality categorical variables can create many features"</span>,</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Encoding Method"</span>,</span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of Features"</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>Each method has trade-offs:</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dummy encoding**: Simple but creates many features</span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Frequency encoding**: Single feature but loses category identity</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Target encoding**: Powerful but risks overfitting</span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Lumping**: Reduces features while preserving main categories</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creating Interaction Terms</span></span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a>Interactions capture relationships between features that aren't additive:</span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate data with interaction effect</span></span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>interaction_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a>  <span class="co"># True relationship includes interaction</span></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="dv">10</span> <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>x2 <span class="sc">+</span> <span class="fl">0.5</span><span class="sc">*</span>x1<span class="sc">*</span>x2 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a><span class="co"># Models with and without interaction</span></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a>no_interaction_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">data =</span> interaction_data)</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a>with_interaction_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2, <span class="at">data =</span> interaction_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> x1<span class="sc">:</span>x2)</span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit both models</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a>no_int_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(no_interaction_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(interaction_data)</span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>with_int_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(with_interaction_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(interaction_data)</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction surface</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>),</span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> <span class="dv">50</span>)</span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a>grid_no_int <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">predict</span>(no_int_fit, grid)<span class="sc">$</span>.pred,</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"Without Interaction"</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>grid_with_int <span class="ot">&lt;-</span> grid <span class="sc">%&gt;%</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">predict</span>(with_int_fit, grid)<span class="sc">$</span>.pred,</span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">"With Interaction"</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the difference</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(grid_no_int, grid_with_int) <span class="sc">%&gt;%</span></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">fill =</span> prediction)) <span class="sc">+</span></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Including Interaction Terms"</span>,</span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Interaction allows the effect of x1 to depend on x2"</span>,</span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature 1"</span>,</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Feature 2"</span>,</span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Predicted</span><span class="sc">\n</span><span class="st">Value"</span></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare model performance</span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Without Interaction"</span>, <span class="st">"With Interaction"</span>),</span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((interaction_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">predict</span>(no_int_fit, interaction_data)<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((interaction_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">predict</span>(with_int_fit, interaction_data)<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a>The interaction term allows the model to capture how the effect of one variable depends on another. This is crucial in many real-world scenarios:</span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Price elasticity depending on income level</span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Drug effectiveness depending on patient age</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Marketing response depending on customer segment</span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a><span class="fu">## Handling Missing Data</span></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>Missing data is ubiquitous in real-world datasets. The strategy depends on why data is missing:</span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a><span class="fu">### Types of Missingness</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Missing Completely at Random (MCAR)**: Missingness is independent of all variables</span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Missing at Random (MAR)**: Missingness depends on observed variables</span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Missing Not at Random (MNAR)**: Missingness depends on the missing value itself</span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>Let's explore different imputation strategies:</span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with different missing patterns</span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>missing_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),</span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="dv">2</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>x2 <span class="sc">+</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce different missing patterns</span></span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>missing_data <span class="ot">&lt;-</span> missing_data <span class="sc">%&gt;%</span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MCAR: Random 20% missing</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1_mcar =</span> <span class="fu">ifelse</span>(<span class="fu">runif</span>(<span class="fu">n</span>()) <span class="sc">&lt;</span> <span class="fl">0.2</span>, <span class="cn">NA</span>, x1),</span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MAR: Missing depends on x2</span></span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2_mar =</span> <span class="fu">ifelse</span>(x2 <span class="sc">&lt;</span> <span class="fu">quantile</span>(x2, <span class="fl">0.2</span>), <span class="cn">NA</span>, x2),</span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MNAR: Large values more likely missing</span></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3_mnar =</span> <span class="fu">ifelse</span>(x3 <span class="sc">&gt;</span> <span class="fu">quantile</span>(x3, <span class="fl">0.8</span>) <span class="sc">&amp;</span> <span class="fu">runif</span>(<span class="fu">n</span>()) <span class="sc">&lt;</span> <span class="fl">0.5</span>, <span class="cn">NA</span>, x3)</span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a><span class="co"># Different imputation strategies</span></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>imputation_recipes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows with missing data</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>  <span class="at">complete_case =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_naomit</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Mean imputation</span></span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_mean</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Median imputation (robust to outliers)</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>  <span class="at">median_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_median</span>(<span class="fu">all_predictors</span>()),</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>  <span class="co"># K-nearest neighbors imputation</span></span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>  <span class="at">knn_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">5</span>),</span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear imputation (using other variables)</span></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear_imp =</span> <span class="fu">recipe</span>(y <span class="sc">~</span> x1_mcar <span class="sc">+</span> x2_mar <span class="sc">+</span> x3_mnar, <span class="at">data =</span> missing_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x1_mcar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x2_mar, x3_mnar)) <span class="sc">%&gt;%</span></span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x2_mar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x1_mcar, x3_mnar)) <span class="sc">%&gt;%</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_impute_linear</span>(x3_mnar, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(x1_mcar, x2_mar))</span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply imputation and evaluate</span></span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a>imputation_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(imputation_recipes), <span class="cf">function</span>(name) {</span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>  imputed <span class="ot">&lt;-</span> imputation_recipes[[name]] <span class="sc">%&gt;%</span></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate statistics</span></span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_rows =</span> <span class="fu">nrow</span>(imputed),</span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>    <span class="at">x1_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x1_mcar <span class="sc">-</span> missing_data<span class="sc">$</span>x1[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x1_mcar)], </span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">x2_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x2_mar <span class="sc">-</span> missing_data<span class="sc">$</span>x2[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x2_mar)], </span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">x3_mean_error =</span> <span class="fu">mean</span>(imputed<span class="sc">$</span>x3_mnar <span class="sc">-</span> missing_data<span class="sc">$</span>x3[<span class="sc">!</span><span class="fu">is.na</span>(imputed<span class="sc">$</span>x3_mnar)], </span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>                         <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize imputation quality</span></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>imputation_results <span class="sc">%&gt;%</span></span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"error"</span>), </span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>, </span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"error"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> <span class="fu">abs</span>(error), <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Imputation Error by Method"</span>,</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower is better - comparing imputed values to true values"</span>,</span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Imputation Method"</span>,</span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Mean Error"</span></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a><span class="co"># Show data loss with complete case</span></span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Complete Case"</span>, <span class="st">"Imputation Methods"</span>),</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Rows Retained</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>    imputation_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(method <span class="sc">==</span> <span class="st">"complete_case"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n_rows),</span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1000</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Percentage</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a>    imputation_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(method <span class="sc">==</span> <span class="st">"complete_case"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(n_rows) <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a>Key insights about imputation:</span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Complete case analysis** loses a lot of data</span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Mean/median imputation** is simple but ignores relationships</span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**KNN imputation** uses similar observations</span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Linear imputation** preserves linear relationships</span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Choice depends on missing mechanism and data structure</span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a><span class="fu">## Feature Selection and Dimensionality Reduction</span></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a>Too many features can lead to overfitting and computational issues. Let's explore methods to reduce dimensionality:</span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filter Methods</span></span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>Filter methods select features based on statistical tests:</span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with relevant and irrelevant features</span></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>feature_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relevant features</span></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_2 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">relevant_3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Irrelevant features</span></span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_2 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise_4 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target depends only on relevant features</span></span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="dv">2</span><span class="sc">*</span>relevant_1 <span class="sc">+</span> <span class="dv">3</span><span class="sc">*</span>relevant_2 <span class="sc">-</span> relevant_3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlations with target</span></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a>correlations <span class="ot">&lt;-</span> feature_data <span class="sc">%&gt;%</span></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target) <span class="sc">%&gt;%</span></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">cor</span>(., feature_data<span class="sc">$</span>target, <span class="at">use =</span> <span class="st">"complete.obs"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"feature"</span>, <span class="at">value =</span> <span class="st">"correlation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_correlation =</span> <span class="fu">abs</span>(correlation),</span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature_type =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(feature, <span class="st">"relevant"</span>), <span class="st">"Relevant"</span>, <span class="st">"Noise"</span>)</span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize correlations</span></span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(correlations, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, abs_correlation), </span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> abs_correlation, </span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fill =</span> feature_type)) <span class="sc">+</span></span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Relevant"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"Noise"</span> <span class="ot">=</span> <span class="st">"gray50"</span>)) <span class="sc">+</span></span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Feature Selection Using Correlation Filter"</span>,</span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red line shows potential threshold for feature selection"</span>,</span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Correlation with Target"</span>,</span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"True Feature Type"</span></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a><span class="co"># Recipe with correlation filter</span></span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a>filtered_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> feature_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>) <span class="sc">%&gt;%</span>  <span class="co"># Remove highly correlated features</span></span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(<span class="fu">all_predictors</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>(), </span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a>          <span class="at">skip =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a>          <span class="at">threshold =</span> <span class="fl">0.1</span>)  <span class="co"># This would remove low correlation features</span></span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Near-zero variance filter</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a>nzv_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> feature_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>())  <span class="co"># Remove features with near-zero variance</span></span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a><span class="fu">### Principal Component Analysis (PCA)</span></span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a>PCA creates new features that are linear combinations of original features:</span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a><span class="co"># Create correlated features for PCA demonstration</span></span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a>pca_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> x1 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),  <span class="co"># Correlated with x1</span></span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>  <span class="at">x3 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>  <span class="at">x4 =</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>),  <span class="co"># Correlated with x3</span></span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">x5 =</span> <span class="fu">rnorm</span>(<span class="dv">500</span>),</span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> x1 <span class="sc">+</span> x3 <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA recipe</span></span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a>pca_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(y <span class="sc">~</span> ., <span class="at">data =</span> pca_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span>  <span class="co"># Important: normalize before PCA</span></span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_predictors</span>(), <span class="at">num_comp =</span> <span class="dv">3</span>)  <span class="co"># Keep 3 components</span></span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare and examine</span></span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a>pca_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(pca_recipe)</span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a>pca_result <span class="ot">&lt;-</span> <span class="fu">bake</span>(pca_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract loadings</span></span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a>pca_loadings <span class="ot">&lt;-</span> <span class="fu">tidy</span>(pca_prep, <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co"># 2nd step is PCA</span></span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(component <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">component =</span> <span class="fu">factor</span>(component, <span class="at">levels =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize loadings</span></span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pca_loadings, <span class="fu">aes</span>(<span class="at">x =</span> terms, <span class="at">y =</span> value, <span class="at">fill =</span> value <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>component) <span class="sc">+</span></span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PCA Loadings"</span>,</span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"How original features contribute to each principal component"</span>,</span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Original Feature"</span>,</span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Loading"</span>,</span>
<span id="cb32-763"><a href="#cb32-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Sign"</span></span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance explained</span></span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a>pca_variance <span class="ot">&lt;-</span> pca_prep<span class="sc">$</span>steps[[<span class="dv">2</span>]]<span class="sc">$</span>res<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a>variance_explained <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pca_variance)),</span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> pca_variance,</span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span> <span class="ot">=</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Cumulative Proportion</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">cumsum</span>(<span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span>)</span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a><span class="co"># Scree plot</span></span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(variance_explained <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>), </span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> PC, <span class="at">y =</span> <span class="st">`</span><span class="at">Proportion Explained</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="dv">1</span>), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(<span class="st">`</span><span class="at">Cumulative Proportion</span><span class="st">`</span>, <span class="dv">2</span>)), </span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PCA Scree Plot"</span>,</span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Shows variance explained by each component"</span>,</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Principal Component"</span>,</span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Proportion of Variance Explained"</span></span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a>PCA is powerful for:</span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reducing dimensionality while preserving variance</span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Removing multicollinearity</span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Visualization (first 2-3 components)</span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Noise reduction</span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time-Based Features</span></span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a>Time series data requires special feature engineering:</span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time series data</span></span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a>time_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2020-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2022-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_value =</span> <span class="dv">1000</span>,</span>
<span id="cb32-812"><a href="#cb32-812" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">200</span>, <span class="at">length.out =</span> <span class="fu">length</span>(date)),</span>
<span id="cb32-813"><a href="#cb32-813" aria-hidden="true" tabindex="-1"></a>  <span class="at">seasonal =</span> <span class="dv">100</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">as.numeric</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">weekly =</span> <span class="dv">50</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">wday</span>(date) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(date), <span class="dv">0</span>, <span class="dv">30</span>),</span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a>  <span class="at">sales =</span> base_value <span class="sc">+</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-based feature engineering</span></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a>time_features <span class="ot">&lt;-</span> time_data <span class="sc">%&gt;%</span></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic time components</span></span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb32-824"><a href="#cb32-824" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb32-825"><a href="#cb32-825" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> <span class="fu">day</span>(date),</span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_of_year =</span> <span class="fu">week</span>(date),</span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(date),</span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cyclical encoding (preserves continuity)</span></span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day <span class="sc">/</span> <span class="dv">31</span>),</span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day <span class="sc">/</span> <span class="dv">31</span>),</span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary indicators</span></span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> <span class="fu">wday</span>(date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_start =</span> day <span class="sc">&lt;=</span> <span class="dv">7</span>,</span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_end =</span> day <span class="sc">&gt;=</span> <span class="fu">day</span>(<span class="fu">ceiling_date</span>(date, <span class="st">"month"</span>) <span class="sc">-</span> <span class="fu">days</span>(<span class="dv">7</span>)),</span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag features</span></span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_1 =</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_7 =</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>),</span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_30 =</span> <span class="fu">lag</span>(sales, <span class="dv">30</span>),</span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-847"><a href="#cb32-847" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling statistics</span></span>
<span id="cb32-848"><a href="#cb32-848" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_7 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_30 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">30</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_7 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">7</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>)</span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize some engineered features</span></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="ot">&lt;-</span> time_features <span class="sc">%&gt;%</span></span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales, month_sin, month_cos, is_weekend, sales_lag_7, sales_ma_30) <span class="sc">%&gt;%</span></span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"feature"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature <span class="sc">!=</span> <span class="st">"sales"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature, <span class="at">correlation =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(correlation)))</span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(feature_importance, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, <span class="fu">abs</span>(correlation)), </span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a>                               <span class="at">y =</span> <span class="fu">abs</span>(correlation))) <span class="sc">+</span></span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Importance of Time-Based Features"</span>,</span>
<span id="cb32-870"><a href="#cb32-870" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Correlation with sales"</span>,</span>
<span id="cb32-871"><a href="#cb32-871" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Absolute Correlation"</span></span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-874"><a href="#cb32-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-875"><a href="#cb32-875" aria-hidden="true" tabindex="-1"></a><span class="co"># Show cyclical encoding</span></span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a>cyclical_demo <span class="ot">&lt;-</span> time_features <span class="sc">%&gt;%</span></span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(month, month_sin, month_cos) <span class="sc">%&gt;%</span></span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(month)</span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(cyclical_demo, <span class="fu">aes</span>(<span class="at">x =</span> month_cos, <span class="at">y =</span> month_sin)) <span class="sc">+</span></span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(month)), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> month), <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Cyclical Encoding of Months"</span>,</span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Preserves continuity: December is close to January"</span>,</span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Cosine Component"</span>,</span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sine Component"</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a>Time features are crucial for:</span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Capturing seasonality and trends</span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Accounting for day-of-week effects</span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Incorporating historical information (lags)</span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Smoothing noisy signals (moving averages)</span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a><span class="fu">## Text Features (Brief Introduction)</span></span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a>Text data requires specialized preprocessing:</span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple text feature engineering example</span></span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a>text_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a>  <span class="at">review =</span> <span class="fu">c</span>(</span>
<span id="cb32-913"><a href="#cb32-913" aria-hidden="true" tabindex="-1"></a>    <span class="st">"This product is absolutely amazing! Best purchase ever!"</span>,</span>
<span id="cb32-914"><a href="#cb32-914" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Terrible quality. Very disappointed. Would not recommend."</span>,</span>
<span id="cb32-915"><a href="#cb32-915" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Good value for money. Satisfied with the purchase."</span>,</span>
<span id="cb32-916"><a href="#cb32-916" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Excellent service and fast delivery. Five stars!"</span>,</span>
<span id="cb32-917"><a href="#cb32-917" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Product broke after one day. Complete waste of money."</span></span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a>  <span class="at">rating =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a><span class="co"># Text feature recipe using textrecipes</span></span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a>text_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(rating <span class="sc">~</span> review, <span class="at">data =</span> text_data) <span class="sc">%&gt;%</span></span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tokenize text</span></span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(review) <span class="sc">%&gt;%</span></span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove stop words</span></span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_stopwords</span>(review) <span class="sc">%&gt;%</span></span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create n-grams</span></span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ngram</span>(review, <span class="at">num_tokens =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to term frequency</span></span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tf</span>(review, <span class="at">weight_scheme =</span> <span class="st">"binary"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optionally: TF-IDF weighting</span></span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_tfidf(review) %&gt;%</span></span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only most common terms</span></span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenfilter</span>(review, <span class="at">max_tokens =</span> <span class="dv">20</span>)</span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-937"><a href="#cb32-937" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This is just a demonstration - real text processing needs more data</span></span>
<span id="cb32-938"><a href="#cb32-938" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a>Text features can include:</span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Word counts and frequencies</span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>N-grams (sequences of words)</span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TF-IDF weights</span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sentiment scores</span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Word embeddings</span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Practices and Common Pitfalls</span></span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a><span class="fu">### Best Practices</span></span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Always split before feature engineering**</span>
<span id="cb32-952"><a href="#cb32-952" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Prevents data leakage</span>
<span id="cb32-953"><a href="#cb32-953" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Ensures fair evaluation</span>
<span id="cb32-954"><a href="#cb32-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-955"><a href="#cb32-955" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Order of operations matters**</span>
<span id="cb32-956"><a href="#cb32-956" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Impute missing values before normalization</span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Create interactions after dummy encoding</span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Normalize after all transformations</span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Keep it simple initially**</span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Start with basic features</span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Add complexity gradually</span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Validate improvements</span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Document your choices**</span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Why each transformation?</span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What domain knowledge informed decisions?</span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a><span class="fu">### Common Pitfalls to Avoid</span></span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a>Let's demonstrate some common mistakes:</span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a><span class="co"># Create split if not already done</span></span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"ames_split"</span>)) {</span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a>  ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb32-980"><a href="#cb32-980" aria-hidden="true" tabindex="-1"></a>  ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb32-981"><a href="#cb32-981" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Normalizing before splitting</span></span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a><span class="co"># This leaks information from test set into training</span></span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a>wrong_approach <span class="ot">&lt;-</span> ames <span class="sc">%&gt;%</span></span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]) <span class="sc">%&gt;%</span>  <span class="co"># Uses ALL data!</span></span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>()</span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Normalize within recipe</span></span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a>right_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area, <span class="at">data =</span> <span class="fu">training</span>(ames_split)) <span class="sc">%&gt;%</span></span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(Gr_Liv_Area)  <span class="co"># Will use only training data statistics</span></span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a><span class="co"># WRONG: Creating too many features</span></span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a>overengineered_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_poly</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">degree =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span>  <span class="co"># Too many polynomial terms</span></span>
<span id="cb32-997"><a href="#cb32-997" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> <span class="fu">all_numeric_predictors</span>()<span class="sc">^</span><span class="dv">2</span>)  <span class="co"># All 2-way interactions</span></span>
<span id="cb32-998"><a href="#cb32-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a><span class="co"># RIGHT: Thoughtful feature engineering</span></span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a>thoughtful_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_poly</span>(Gr_Liv_Area, <span class="at">degree =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span>  <span class="co"># Only where needed</span></span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Overall_Cond)  <span class="co"># Specific, meaningful interaction</span></span>
<span id="cb32-1004"><a href="#cb32-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1005"><a href="#cb32-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">## Complete Example: Putting It All Together</span></span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a>Let's create a comprehensive feature engineering pipeline:</span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1012"><a href="#cb32-1012" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># Use credit data for a complete example</span></span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Status)</span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a><span class="co"># Comprehensive recipe</span></span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a>comprehensive_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Status <span class="sc">~</span> ., <span class="at">data =</span> credit_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Handle missing values</span></span>
<span id="cb32-1021"><a href="#cb32-1021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1022"><a href="#cb32-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Feature creation</span></span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(</span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a>    <span class="at">debt_to_income =</span> Expenses <span class="sc">/</span> Income,</span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a>    <span class="at">savings_rate =</span> (Income <span class="sc">-</span> Expenses) <span class="sc">/</span> Income,</span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">has_records =</span> <span class="sc">!</span><span class="fu">is.na</span>(Records)</span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Handle skewness</span></span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(Income, Amount) <span class="sc">%&gt;%</span></span>
<span id="cb32-1033"><a href="#cb32-1033" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1034"><a href="#cb32-1034" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Create dummy variables</span></span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="sc">-</span>has_records) <span class="sc">%&gt;%</span></span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1037"><a href="#cb32-1037" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Remove near-zero variance</span></span>
<span id="cb32-1038"><a href="#cb32-1038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Normalize</span></span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Remove highly correlated features</span></span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8. PCA for dimensionality reduction (optional)</span></span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_pca(all_numeric_predictors(), threshold = 0.95) %&gt;%</span></span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 9. Balance classes (for classification)</span></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_smote</span>(Status)  <span class="co"># Synthetic minority oversampling</span></span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1052"><a href="#cb32-1052" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the recipe</span></span>
<span id="cb32-1053"><a href="#cb32-1053" aria-hidden="true" tabindex="-1"></a>comprehensive_recipe</span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare and check results</span></span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a>comprehensive_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(comprehensive_recipe)</span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a>comprehensive_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(comprehensive_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1059"><a href="#cb32-1059" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of transformations</span></span>
<span id="cb32-1060"><a href="#cb32-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a>  <span class="at">Stage =</span> <span class="fu">c</span>(<span class="st">"Original"</span>, <span class="st">"After Engineering"</span>),</span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N Features</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">ncol</span>(credit_train) <span class="sc">-</span> <span class="dv">1</span>, <span class="fu">ncol</span>(comprehensive_baked) <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N Observations</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">nrow</span>(credit_train), <span class="fu">nrow</span>(comprehensive_baked)),</span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Class Balance</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(credit_train<span class="sc">$</span>Status <span class="sc">==</span> <span class="st">"good"</span>) <span class="sc">/</span> <span class="fu">nrow</span>(credit_train),</span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(comprehensive_baked<span class="sc">$</span>Status <span class="sc">==</span> <span class="st">"good"</span>) <span class="sc">/</span> <span class="fu">nrow</span>(comprehensive_baked)</span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a model with the engineered features</span></span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a><span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(comprehensive_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec) <span class="sc">%&gt;%</span></span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(credit_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(credit_test) <span class="sc">%&gt;%</span></span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(credit_test) <span class="sc">%&gt;%</span></span>
<span id="cb32-1082"><a href="#cb32-1082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth =</span> Status, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb32-1083"><a href="#cb32-1083" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Engineer Features for House Prices</span></span>
<span id="cb32-1088"><a href="#cb32-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1089"><a href="#cb32-1089" aria-hidden="true" tabindex="-1"></a>Create a comprehensive feature engineering pipeline for the Ames housing data:</span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a>exercise_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform outcome</span></span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price) <span class="sc">%&gt;%</span></span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create meaningful features</span></span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(</span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a>    <span class="at">House_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Built,</span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">Remod_Age =</span> <span class="dv">2010</span> <span class="sc">-</span> Year_Remod_Add,</span>
<span id="cb32-1103"><a href="#cb32-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">Has_Garage =</span> <span class="sc">!</span><span class="fu">is.na</span>(Garage_Type),</span>
<span id="cb32-1104"><a href="#cb32-1104" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Bathrooms =</span> Full_Bath <span class="sc">+</span> Half_Bath <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_SF =</span> Gr_Liv_Area <span class="sc">+</span> Total_Bsmt_SF,</span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a>    <span class="at">Quality_x_Condition =</span> Overall_Cond <span class="sc">*</span> Overall_Cond</span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove original year variables</span></span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Year_Built, Year_Remod_Add, Mo_Sold, Year_Sold) <span class="sc">%&gt;%</span></span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle missing values</span></span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rare categories</span></span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform skewed variables (before creating dummies)</span></span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(Lot_Area, Gr_Liv_Area, Total_SF) <span class="sc">%&gt;%</span></span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Interactions (before creating dummies)</span></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Total_SF<span class="sc">:</span>Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create dummies</span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale</span></span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove zero variance</span></span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>())</span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1134"><a href="#cb32-1134" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the recipe</span></span>
<span id="cb32-1135"><a href="#cb32-1135" aria-hidden="true" tabindex="-1"></a>exercise_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(exercise_recipe)</span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a>exercise_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(exercise_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Created"</span>, <span class="fu">ncol</span>(exercise_baked) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"features from"</span>, </span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"original features"</span>))</span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Handle High-Cardinality Categorical</span></span>
<span id="cb32-1143"><a href="#cb32-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1144"><a href="#cb32-1144" aria-hidden="true" tabindex="-1"></a>Work with a high-cardinality categorical variable:</span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic high-cardinality data</span></span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a>high_card_ex <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="fu">sample</span>(<span class="fu">paste0</span>(<span class="st">"Cat_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>), <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>),</span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make target depend somewhat on category</span></span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> target <span class="sc">+</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(category)) <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a><span class="co"># Try different encoding strategies</span></span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Frequency encoding</span></span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(<span class="at">cat_freq =</span> <span class="fu">n</span>(), <span class="at">.by =</span> category) <span class="sc">%&gt;%</span></span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(category),</span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Target encoding with smoothing</span></span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_enc =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_mean =</span> <span class="fu">mean</span>(target),</span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_count =</span> <span class="fu">n</span>(),</span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a>      <span class="at">.by =</span> category</span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_mutate</span>(</span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Smooth with global mean for rare categories</span></span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a>      <span class="at">cat_smooth =</span> (cat_mean <span class="sc">*</span> cat_count <span class="sc">+</span> <span class="fu">mean</span>(target) <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">/</span> (cat_count <span class="sc">+</span> <span class="dv">10</span>)</span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_rm</span>(category, cat_mean, cat_count),</span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Embedding-like (PCA on dummies)</span></span>
<span id="cb32-1182"><a href="#cb32-1182" aria-hidden="true" tabindex="-1"></a>  <span class="at">embedding =</span> <span class="fu">recipe</span>(target <span class="sc">~</span> ., <span class="at">data =</span> high_card_ex) <span class="sc">%&gt;%</span></span>
<span id="cb32-1183"><a href="#cb32-1183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_dummy</span>(category) <span class="sc">%&gt;%</span></span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">step_pca</span>(<span class="fu">starts_with</span>(<span class="st">"category_"</span>), <span class="at">num_comp =</span> <span class="dv">10</span>)</span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1186"><a href="#cb32-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1187"><a href="#cb32-1187" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare approaches</span></span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a>comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(name) {</span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a>  prepped <span class="ot">&lt;-</span> <span class="fu">prep</span>(strategies[[name]])</span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a>  baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(prepped, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> name,</span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_features =</span> <span class="fu">ncol</span>(baked) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparison)</span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1201"><a href="#cb32-1201" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Time Series Feature Engineering</span></span>
<span id="cb32-1202"><a href="#cb32-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a>Create features for time series prediction:</span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate time series data</span></span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a>ts_exercise <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2021-01-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>)</span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend =</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="fu">n</span>() <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a>    <span class="at">seasonal =</span> <span class="dv">50</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">yday</span>(date) <span class="sc">/</span> <span class="dv">365</span>),</span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly =</span> <span class="dv">20</span> <span class="sc">*</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> <span class="fu">wday</span>(date) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales =</span> <span class="dv">1000</span> <span class="sc">+</span> trend <span class="sc">+</span> seasonal <span class="sc">+</span> weekly <span class="sc">+</span> noise</span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1221"><a href="#cb32-1221" aria-hidden="true" tabindex="-1"></a><span class="co"># Create time features</span></span>
<span id="cb32-1222"><a href="#cb32-1222" aria-hidden="true" tabindex="-1"></a>ts_features <span class="ot">&lt;-</span> ts_exercise <span class="sc">%&gt;%</span></span>
<span id="cb32-1223"><a href="#cb32-1223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-1224"><a href="#cb32-1224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calendar features</span></span>
<span id="cb32-1225"><a href="#cb32-1225" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb32-1226"><a href="#cb32-1226" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb32-1227"><a href="#cb32-1227" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> <span class="fu">week</span>(date),</span>
<span id="cb32-1228"><a href="#cb32-1228" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_week =</span> <span class="fu">wday</span>(date),</span>
<span id="cb32-1229"><a href="#cb32-1229" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_month =</span> <span class="fu">day</span>(date),</span>
<span id="cb32-1230"><a href="#cb32-1230" aria-hidden="true" tabindex="-1"></a>    <span class="at">day_of_year =</span> <span class="fu">yday</span>(date),</span>
<span id="cb32-1231"><a href="#cb32-1231" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">quarter</span>(date),</span>
<span id="cb32-1232"><a href="#cb32-1232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1233"><a href="#cb32-1233" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cyclical encoding</span></span>
<span id="cb32-1234"><a href="#cb32-1234" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb32-1235"><a href="#cb32-1235" aria-hidden="true" tabindex="-1"></a>    <span class="at">month_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> month <span class="sc">/</span> <span class="dv">12</span>),</span>
<span id="cb32-1236"><a href="#cb32-1236" aria-hidden="true" tabindex="-1"></a>    <span class="at">dow_sin =</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day_of_week <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb32-1237"><a href="#cb32-1237" aria-hidden="true" tabindex="-1"></a>    <span class="at">dow_cos =</span> <span class="fu">cos</span>(<span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">*</span> day_of_week <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb32-1238"><a href="#cb32-1238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1239"><a href="#cb32-1239" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Indicators</span></span>
<span id="cb32-1240"><a href="#cb32-1240" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_weekend =</span> day_of_week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>),</span>
<span id="cb32-1241"><a href="#cb32-1241" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_start =</span> day_of_month <span class="sc">&lt;=</span> <span class="dv">3</span>,</span>
<span id="cb32-1242"><a href="#cb32-1242" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_month_end =</span> day_of_month <span class="sc">&gt;=</span> <span class="dv">28</span>,</span>
<span id="cb32-1243"><a href="#cb32-1243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1244"><a href="#cb32-1244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag features</span></span>
<span id="cb32-1245"><a href="#cb32-1245" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_1 =</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb32-1246"><a href="#cb32-1246" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_7 =</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>),</span>
<span id="cb32-1247"><a href="#cb32-1247" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_30 =</span> <span class="fu">lag</span>(sales, <span class="dv">30</span>),</span>
<span id="cb32-1248"><a href="#cb32-1248" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_lag_365 =</span> <span class="fu">lag</span>(sales, <span class="dv">365</span>),</span>
<span id="cb32-1249"><a href="#cb32-1249" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1250"><a href="#cb32-1250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling statistics</span></span>
<span id="cb32-1251"><a href="#cb32-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_7 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-1252"><a href="#cb32-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_ma_30 =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sales, <span class="dv">30</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-1253"><a href="#cb32-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_7 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">7</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-1254"><a href="#cb32-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_std_30 =</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(sales, <span class="dv">30</span>, sd, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">align =</span> <span class="st">"right"</span>),</span>
<span id="cb32-1255"><a href="#cb32-1255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-1256"><a href="#cb32-1256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Differences</span></span>
<span id="cb32-1257"><a href="#cb32-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_diff_1 =</span> sales <span class="sc">-</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb32-1258"><a href="#cb32-1258" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_diff_7 =</span> sales <span class="sc">-</span> <span class="fu">lag</span>(sales, <span class="dv">7</span>)</span>
<span id="cb32-1259"><a href="#cb32-1259" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1260"><a href="#cb32-1260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb32-1261"><a href="#cb32-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1262"><a href="#cb32-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate feature importance</span></span>
<span id="cb32-1263"><a href="#cb32-1263" aria-hidden="true" tabindex="-1"></a>feature_cors <span class="ot">&lt;-</span> ts_features <span class="sc">%&gt;%</span></span>
<span id="cb32-1264"><a href="#cb32-1264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>date, <span class="sc">-</span>trend, <span class="sc">-</span>seasonal, <span class="sc">-</span>weekly, <span class="sc">-</span>noise) <span class="sc">%&gt;%</span></span>
<span id="cb32-1265"><a href="#cb32-1265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sales) <span class="sc">%&gt;%</span></span>
<span id="cb32-1266"><a href="#cb32-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="sc">~</span> <span class="fu">cor</span>(., ts_features<span class="sc">$</span>sales)) <span class="sc">%&gt;%</span></span>
<span id="cb32-1267"><a href="#cb32-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">enframe</span>(<span class="at">name =</span> <span class="st">"feature"</span>, <span class="at">value =</span> <span class="st">"correlation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-1268"><a href="#cb32-1268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(correlation))) <span class="sc">%&gt;%</span></span>
<span id="cb32-1269"><a href="#cb32-1269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">15</span>)</span>
<span id="cb32-1270"><a href="#cb32-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1271"><a href="#cb32-1271" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(feature_cors, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, <span class="fu">abs</span>(correlation)), </span>
<span id="cb32-1272"><a href="#cb32-1272" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> <span class="fu">abs</span>(correlation))) <span class="sc">+</span></span>
<span id="cb32-1273"><a href="#cb32-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb32-1274"><a href="#cb32-1274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-1275"><a href="#cb32-1275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-1276"><a href="#cb32-1276" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top Time Series Features"</span>,</span>
<span id="cb32-1277"><a href="#cb32-1277" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Absolute correlation with sales"</span>,</span>
<span id="cb32-1278"><a href="#cb32-1278" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Feature"</span>,</span>
<span id="cb32-1279"><a href="#cb32-1279" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"|Correlation|"</span></span>
<span id="cb32-1280"><a href="#cb32-1280" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1281"><a href="#cb32-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1282"><a href="#cb32-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1283"><a href="#cb32-1283" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb32-1284"><a href="#cb32-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1285"><a href="#cb32-1285" aria-hidden="true" tabindex="-1"></a>Feature engineering is both an art and a science. You've learned:</span>
<span id="cb32-1286"><a href="#cb32-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1287"><a href="#cb32-1287" aria-hidden="true" tabindex="-1"></a>✅ **Core concepts**: Why feature engineering matters and how it works  </span>
<span id="cb32-1288"><a href="#cb32-1288" aria-hidden="true" tabindex="-1"></a>✅ **Numeric transformations**: Scaling, normalization, handling skewness  </span>
<span id="cb32-1289"><a href="#cb32-1289" aria-hidden="true" tabindex="-1"></a>✅ **Categorical encoding**: Dummies, target encoding, handling high cardinality  </span>
<span id="cb32-1290"><a href="#cb32-1290" aria-hidden="true" tabindex="-1"></a>✅ **Interaction terms**: Capturing non-additive relationships  </span>
<span id="cb32-1291"><a href="#cb32-1291" aria-hidden="true" tabindex="-1"></a>✅ **Missing data strategies**: Various imputation methods and when to use them  </span>
<span id="cb32-1292"><a href="#cb32-1292" aria-hidden="true" tabindex="-1"></a>✅ **Dimensionality reduction**: PCA and feature selection  </span>
<span id="cb32-1293"><a href="#cb32-1293" aria-hidden="true" tabindex="-1"></a>✅ **Time features**: Extracting temporal patterns  </span>
<span id="cb32-1294"><a href="#cb32-1294" aria-hidden="true" tabindex="-1"></a>✅ **Best practices**: Avoiding leakage, proper ordering, validation  </span>
<span id="cb32-1295"><a href="#cb32-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1296"><a href="#cb32-1296" aria-hidden="true" tabindex="-1"></a>Remember:</span>
<span id="cb32-1297"><a href="#cb32-1297" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Feature engineering often has more impact than model selection</span>
<span id="cb32-1298"><a href="#cb32-1298" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Domain knowledge is invaluable for creating meaningful features</span>
<span id="cb32-1299"><a href="#cb32-1299" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Always validate that engineered features improve performance</span>
<span id="cb32-1300"><a href="#cb32-1300" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Keep transformations in recipes for reproducibility</span>
<span id="cb32-1301"><a href="#cb32-1301" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Start simple and add complexity gradually</span>
<span id="cb32-1302"><a href="#cb32-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1303"><a href="#cb32-1303" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Next?</span></span>
<span id="cb32-1304"><a href="#cb32-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1305"><a href="#cb32-1305" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">Chapter 11</span><span class="co">](11-model-specification.Rmd)</span>, we'll explore parsnip for unified model specification across different engines.</span>
<span id="cb32-1306"><a href="#cb32-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1307"><a href="#cb32-1307" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Resources</span></span>
<span id="cb32-1308"><a href="#cb32-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1309"><a href="#cb32-1309" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Feature Engineering and Selection</span><span class="co">](http://www.feat.engineering/)</span></span>
<span id="cb32-1310"><a href="#cb32-1310" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Recipes Documentation</span><span class="co">](https://recipes.tidymodels.org/)</span></span>
<span id="cb32-1311"><a href="#cb32-1311" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Feature Engineering for Machine Learning</span><span class="co">](https://www.oreilly.com/library/view/feature-engineering-for/9781491953235/)</span></span>
<span id="cb32-1312"><a href="#cb32-1312" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Tidy Modeling with R - Recipes Chapter</span><span class="co">](https://www.tmwr.org/recipes.html)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>