<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Sarrat González, Juan R González">
<meta name="dcterms.date" content="2025-10-06">

<title>Chapter 16: Ensemble Methods - The Power of Many – Tidyverse &amp; Machine Learning Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-90ee96a17764a76d4fcf3f331faa145e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidyverse &amp; Machine Learning Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-1-tidyverse" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 1: Tidyverse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-1-tidyverse">    
        <li>
    <a class="dropdown-item" href="./01-introduction.html">
 <span class="dropdown-text">Ch 1: Introduction to Tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-data-import.html">
 <span class="dropdown-text">Ch 2: Data Import with readr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-data-wrangling.html">
 <span class="dropdown-text">Ch 3: Data Wrangling with dplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-data-tidying.html">
 <span class="dropdown-text">Ch 4: Data Tidying with tidyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-visualization.html">
 <span class="dropdown-text">Ch 5: Visualization with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-functional-programming.html">
 <span class="dropdown-text">Ch 6: Functional Programming with purrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-strings-dates.html">
 <span class="dropdown-text">Ch 7: Strings and Dates</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-1.html">
 <span class="dropdown-text">Block 1 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-2-tidymodels" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 2: Tidymodels</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-2-tidymodels">    
        <li>
    <a class="dropdown-item" href="./08-tidymodels-intro.html">
 <span class="dropdown-text">Ch 8: Introduction to Tidymodels</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-data-splitting.html">
 <span class="dropdown-text">Ch 9: Data Splitting &amp; Resampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-feature-engineering.html">
 <span class="dropdown-text">Ch 10: Feature Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-model-specification.html">
 <span class="dropdown-text">Ch 11: Model Specification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-workflows-evaluation.html">
 <span class="dropdown-text">Ch 12: Workflows &amp; Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-hyperparameter-tuning.html">
 <span class="dropdown-text">Ch 13: Hyperparameter Tuning</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-2.html">
 <span class="dropdown-text">Block 2 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-3-machine-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 3: Machine Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-3-machine-learning">    
        <li>
    <a class="dropdown-item" href="./14-classification.html">
 <span class="dropdown-text">Ch 14: Classification Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-regression.html">
 <span class="dropdown-text">Ch 15: Regression Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-ensemble-methods.html">
 <span class="dropdown-text">Ch 16: Ensemble Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./17-unsupervised-learning.html">
 <span class="dropdown-text">Ch 17: Unsupervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./18-model-deployment.html">
 <span class="dropdown-text">Ch 18: Model Deployment</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-3.html">
 <span class="dropdown-text">Block 3 Assessment</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#the-wisdom-of-crowds-in-machine-learning" id="toc-the-wisdom-of-crowds-in-machine-learning" class="nav-link" data-scroll-target="#the-wisdom-of-crowds-in-machine-learning">The Wisdom of Crowds in Machine Learning</a></li>
  <li><a href="#why-ensembles-work-the-mathematical-foundation" id="toc-why-ensembles-work-the-mathematical-foundation" class="nav-link" data-scroll-target="#why-ensembles-work-the-mathematical-foundation">Why Ensembles Work: The Mathematical Foundation</a></li>
  <li><a href="#bagging-bootstrap-aggregating" id="toc-bagging-bootstrap-aggregating" class="nav-link" data-scroll-target="#bagging-bootstrap-aggregating">Bagging: Bootstrap Aggregating</a></li>
  <li><a href="#random-forests-bagging-with-a-twist" id="toc-random-forests-bagging-with-a-twist" class="nav-link" data-scroll-target="#random-forests-bagging-with-a-twist">Random Forests: Bagging with a Twist</a></li>
  <li><a href="#boosting-learning-from-mistakes" id="toc-boosting-learning-from-mistakes" class="nav-link" data-scroll-target="#boosting-learning-from-mistakes">Boosting: Learning from Mistakes</a>
  <ul class="collapse">
  <li><a href="#adaboost-the-original-boosting-algorithm" id="toc-adaboost-the-original-boosting-algorithm" class="nav-link" data-scroll-target="#adaboost-the-original-boosting-algorithm">AdaBoost: The Original Boosting Algorithm</a></li>
  <li><a href="#gradient-boosting-machines-gbm" id="toc-gradient-boosting-machines-gbm" class="nav-link" data-scroll-target="#gradient-boosting-machines-gbm">Gradient Boosting Machines (GBM)</a></li>
  </ul></li>
  <li><a href="#model-stacking-the-meta-learning-approach" id="toc-model-stacking-the-meta-learning-approach" class="nav-link" data-scroll-target="#model-stacking-the-meta-learning-approach">Model Stacking: The Meta-Learning Approach</a></li>
  <li><a href="#voting-ensembles" id="toc-voting-ensembles" class="nav-link" data-scroll-target="#voting-ensembles">Voting Ensembles</a></li>
  <li><a href="#diversity-in-ensembles" id="toc-diversity-in-ensembles" class="nav-link" data-scroll-target="#diversity-in-ensembles">Diversity in Ensembles</a></li>
  <li><a href="#advanced-ensemble-techniques" id="toc-advanced-ensemble-techniques" class="nav-link" data-scroll-target="#advanced-ensemble-techniques">Advanced Ensemble Techniques</a>
  <ul class="collapse">
  <li><a href="#dynamic-ensemble-selection" id="toc-dynamic-ensemble-selection" class="nav-link" data-scroll-target="#dynamic-ensemble-selection">Dynamic Ensemble Selection</a></li>
  <li><a href="#cascade-ensembles" id="toc-cascade-ensembles" class="nav-link" data-scroll-target="#cascade-ensembles">Cascade Ensembles</a></li>
  </ul></li>
  <li><a href="#best-practices-for-ensembles" id="toc-best-practices-for-ensembles" class="nav-link" data-scroll-target="#best-practices-for-ensembles">Best Practices for Ensembles</a>
  <ul class="collapse">
  <li><a href="#ensure-model-diversity" id="toc-ensure-model-diversity" class="nav-link" data-scroll-target="#ensure-model-diversity">1. Ensure Model Diversity</a></li>
  <li><a href="#choose-appropriate-ensemble-method" id="toc-choose-appropriate-ensemble-method" class="nav-link" data-scroll-target="#choose-appropriate-ensemble-method">2. Choose Appropriate Ensemble Method</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-build-a-custom-ensemble" id="toc-exercise-1-build-a-custom-ensemble" class="nav-link" data-scroll-target="#exercise-1-build-a-custom-ensemble">Exercise 1: Build a Custom Ensemble</a></li>
  <li><a href="#exercise-2-optimize-ensemble-weights" id="toc-exercise-2-optimize-ensemble-weights" class="nav-link" data-scroll-target="#exercise-2-optimize-ensemble-weights">Exercise 2: Optimize Ensemble Weights</a></li>
  <li><a href="#exercise-3-implement-boosting-from-scratch" id="toc-exercise-3-implement-boosting-from-scratch" class="nav-link" data-scroll-target="#exercise-3-implement-boosting-from-scratch">Exercise 3: Implement Boosting from Scratch</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next?</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 16: Ensemble Methods - The Power of Many</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Sarrat González, Juan R González </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 6, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this chapter, you will master:</p>
<ul>
<li>The theory behind ensemble methods</li>
<li>Bagging and random forests</li>
<li>Boosting algorithms (AdaBoost, GBM, XGBoost)</li>
<li>Stacking and blending models</li>
<li>Voting classifiers</li>
<li>Model diversity and ensemble selection</li>
<li>Practical implementation with tidymodels</li>
<li>When and why ensembles work</li>
</ul>
</section>
<section id="the-wisdom-of-crowds-in-machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="the-wisdom-of-crowds-in-machine-learning">The Wisdom of Crowds in Machine Learning</h2>
<p>Imagine you’re trying to guess the number of jellybeans in a jar. One person might overestimate, another might underestimate, but the average of many guesses often comes remarkably close to the truth. This is the fundamental principle behind ensemble methods: combining multiple models can produce predictions that are more accurate than any individual model.</p>
<p>The mathematics behind this are elegant. If we have multiple independent models with uncorrelated errors, combining them reduces the overall error. This is why ensemble methods consistently win machine learning competitions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching packages -------------------------------------- tidymodels 1.4.1 --</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>v broom        1.0.10     v recipes      1.3.1 
v dials        1.4.2      v rsample      1.3.1 
v dplyr        1.1.4      v tailor       0.1.0 
v ggplot2      4.0.0      v tidyr        1.3.1 
v infer        1.0.9      v tune         2.0.0 
v modeldata    1.5.1      v workflows    1.3.0 
v parsnip      1.3.3      v workflowsets 1.1.1 
v purrr        1.1.0      v yardstick    1.3.2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ----------------------------------------- tidymodels_conflicts() --
x purrr::discard() masks scales::discard()
x dplyr::filter()  masks stats::filter()
x dplyr::lag()     masks stats::lag()
x recipes::step()  masks stats::step()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v forcats   1.0.0     v stringr   1.5.2
v lubridate 1.9.4     v tibble    3.3.0
v readr     2.1.5     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x readr::col_factor() masks scales::col_factor()
x purrr::discard()    masks scales::discard()
x dplyr::filter()     masks stats::filter()
x stringr::fixed()    masks recipes::fixed()
x dplyr::lag()        masks stats::lag()
x readr::spec()       masks yardstick::spec()
i Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'vip'

The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stacks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'butcher':
  method                 from    
  as.character.dev_topic generics</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(baguette)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rules)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'rules'

The following object is masked from 'package:dials':

    max_rules</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'xgboost'

The following object is masked from 'package:dplyr':

    slice</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare data</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare a simpler dataset for visualization</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>ames_simple <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Gr_Liv_Area, Overall_Cond, Year_Built, Neighborhood) <span class="sc">%&gt;%</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="why-ensembles-work-the-mathematical-foundation" class="level2">
<h2 class="anchored" data-anchor-id="why-ensembles-work-the-mathematical-foundation">Why Ensembles Work: The Mathematical Foundation</h2>
<p>Let’s understand why combining models reduces error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the power of ensembles</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>n_models <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>n_points <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># True function</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> n_points)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>y_true <span class="ot">&lt;-</span> <span class="fu">sin</span>(x) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>y_observed <span class="ot">&lt;-</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(n_points, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple "weak" models (with random variations)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>weak_predictions <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models, <span class="cf">function</span>(i) {</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each model sees slightly different data (bootstrap)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  sample_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_points, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simple polynomial model with random degree</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  degree <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_observed[sample_idx] <span class="sc">~</span> <span class="fu">poly</span>(x[sample_idx], degree))</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on all points</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(model, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x))</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine predictions</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>ensemble_pred <span class="ot">&lt;-</span> <span class="fu">reduce</span>(weak_predictions, <span class="st">`</span><span class="at">+</span><span class="st">`</span>) <span class="sc">/</span> n_models</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate errors</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>individual_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(weak_predictions, <span class="sc">~</span> <span class="fu">mean</span>((. <span class="sc">-</span> y_true)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>ensemble_error <span class="ot">&lt;-</span> <span class="fu">mean</span>((ensemble_pred <span class="sc">-</span> y_true)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> y_true,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_observed =</span> y_observed,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">ensemble =</span> ensemble_pred</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(weak_predictions, <span class="at">.name_repair =</span> <span class="st">"minimal"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(<span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models))</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot individual models vs ensemble</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_observed), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_2), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_3), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Individual Weak Models"</span>,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each model overfits in different ways"</span>,</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_observed), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ensemble), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ensemble Prediction"</span>,</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Ensemble MSE:"</span>, <span class="fu">round</span>(ensemble_error, <span class="dv">3</span>), </span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"vs Avg Individual:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(individual_errors), <span class="dv">3</span>)),</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error reduction</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average individual model MSE:"</span>, <span class="fu">mean</span>(individual_errors), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average individual model MSE: 4.698849 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Ensemble MSE:"</span>, ensemble_error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ensemble MSE: 2.540965 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Error reduction:"</span>, <span class="fu">round</span>((<span class="dv">1</span> <span class="sc">-</span> ensemble_error<span class="sc">/</span><span class="fu">mean</span>(individual_errors)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error reduction: 45.9 %</code></pre>
</div>
</div>
<p>The key insight: errors cancel out when models make different mistakes!</p>
</section>
<section id="bagging-bootstrap-aggregating" class="level2">
<h2 class="anchored" data-anchor-id="bagging-bootstrap-aggregating">Bagging: Bootstrap Aggregating</h2>
<p>Bagging creates diverse models by training on different bootstrap samples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement bagging for decision trees</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>bagging_spec <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost_complexity =</span> <span class="dv">0</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">10</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">2</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">25</span>) <span class="sc">%&gt;%</span>  <span class="co"># 25 bootstrap samples</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple recipe</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>simple_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Street, Utilities, Condition_2, Roof_Matl, Heating, Pool_QC,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>          Misc_Feature, Pool_Area, Longitude, Latitude) <span class="sc">%&gt;%</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>bagging_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bagging_spec)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>bagging_fit <span class="ot">&lt;-</span> bagging_workflow <span class="sc">%&gt;%</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with single tree</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>single_tree_spec <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost_complexity =</span> <span class="dv">0</span>,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">10</span>,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">2</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>single_tree_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(single_tree_spec)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>single_tree_fit <span class="ot">&lt;-</span> single_tree_workflow <span class="sc">%&gt;%</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate both</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual =</span> ames_test<span class="sc">$</span>Sale_Price,</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">single_tree =</span> <span class="fu">predict</span>(single_tree_fit, ames_test)<span class="sc">$</span>.pred,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">bagging =</span> <span class="fu">predict</span>(bagging_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>comparison_metrics <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">single_tree_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> single_tree)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> bagging)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">improvement =</span> (single_tree_rmse <span class="sc">-</span> bagging_rmse) <span class="sc">/</span> single_tree_rmse <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(comparison_metrics, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">single_tree_rmse</th>
<th style="text-align: right;">bagging_rmse</th>
<th style="text-align: right;">improvement</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">35793.08</td>
<td style="text-align: right;">26948.51</td>
<td style="text-align: right;">24.71</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(single_tree, bagging), </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model"</span>, <span class="at">values_to =</span> <span class="st">"prediction"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> prediction)) <span class="sc">+</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Single Tree vs Bagged Trees"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Bagging reduces overfitting and improves predictions"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Bagging characteristics: - <strong>Reduces variance</strong> without increasing bias - <strong>Works best</strong> with high-variance, low-bias models (like deep trees) - <strong>Parallel training</strong> possible (each bootstrap independent) - <strong>Out-of-bag (OOB)</strong> error provides free validation</p>
</section>
<section id="random-forests-bagging-with-a-twist" class="level2">
<h2 class="anchored" data-anchor-id="random-forests-bagging-with-a-twist">Random Forests: Bagging with a Twist</h2>
<p>Random forests add feature randomness to bagging:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare different mtry values</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>rf_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry_prop =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.33</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1.0</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry_desc =</span> <span class="fu">c</span>(<span class="st">"10% features"</span>, <span class="st">"33% features (sqrt)"</span>, <span class="st">"50% features"</span>, </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"75% features"</span>, <span class="st">"100% features (bagging)"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">map</span>(mtry_prop, <span class="cf">function</span>(prop) {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rand_forest</span>(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">mtry =</span> <span class="fu">floor</span>(prop <span class="sc">*</span> (<span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_n =</span> <span class="dv">5</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit all models</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>rf_workflows <span class="ot">&lt;-</span> rf_comparison <span class="sc">%&gt;%</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">workflow =</span> <span class="fu">map</span>(model, <span class="cf">function</span>(m) {</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add_model</span>(m)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with cross-validation (simplified for speed)</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>rf_results <span class="ot">&lt;-</span> rf_workflows <span class="sc">%&gt;%</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_results =</span> <span class="fu">map</span>(workflow, <span class="sc">~</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>      .,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">3</span>),  <span class="co"># Reduced folds for speed</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract metrics</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>rf_metrics <span class="ot">&lt;-</span> rf_results <span class="sc">%&gt;%</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">map</span>(cv_results, collect_metrics)</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(metrics) <span class="sc">%&gt;%</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mtry_desc, .metric, mean, std_err)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize mtry effect</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>rf_metrics <span class="sc">%&gt;%</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry_desc, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Feature Randomness (mtry)"</span>,</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Moderate mtry often performs best"</span>,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Features Considered per Split"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"RMSE"</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature importance from best model</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>best_rf <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">500</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">5</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"permutation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>best_rf_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(best_rf) <span class="sc">%&gt;%</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract and plot importance</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>best_rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Random Forest Feature Importance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Random forest advantages: - <strong>Further reduces overfitting</strong> compared to bagging - <strong>Decorrelates trees</strong> through feature sampling - <strong>Provides feature importance</strong> naturally - <strong>Robust to hyperparameters</strong> (often works well out-of-box)</p>
</section>
<section id="boosting-learning-from-mistakes" class="level2">
<h2 class="anchored" data-anchor-id="boosting-learning-from-mistakes">Boosting: Learning from Mistakes</h2>
<p>Boosting sequentially builds models, each learning from previous errors:</p>
<section id="adaboost-the-original-boosting-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="adaboost-the-original-boosting-algorithm">AdaBoost: The Original Boosting Algorithm</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate boosting concept with simple example</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a difficult classification dataset</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>spiral_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="fu">runif</span>(<span class="dv">300</span>, <span class="dv">0</span>, <span class="dv">4</span> <span class="sc">*</span> pi),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">radius =</span> <span class="fu">runif</span>(<span class="dv">300</span>, <span class="fl">0.5</span>, <span class="dv">2</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> radius <span class="sc">*</span> <span class="fu">cos</span>(angle) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> radius <span class="sc">*</span> <span class="fu">sin</span>(angle) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(angle <span class="sc">%%</span> (<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">&lt;</span> pi, <span class="st">"A"</span>, <span class="st">"B"</span>))</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the problem</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(spiral_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> class)) <span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spiral Classification Problem"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Difficult for single linear boundary"</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Boosting builds sequential models</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Each focuses on misclassified points from previous models</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gradient-boosting-machines-gbm" class="level3">
<h3 class="anchored" data-anchor-id="gradient-boosting-machines-gbm">Gradient Boosting Machines (GBM)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost - state-of-the-art gradient boosting</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">10</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.01</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fl">0.8</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.1</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>xgb_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_spec)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> xgb_workflow <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare learning rates</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>learning_rates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>lr_comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(learning_rates, <span class="cf">function</span>(lr) {</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> lr</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(spec)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> wf <span class="sc">%&gt;%</span> <span class="fu">fit</span>(ames_train)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get training history (if available)</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>  train_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_train)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>  test_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_test)</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> lr,</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_train<span class="sc">$</span>Sale_Price <span class="sc">-</span> train_pred<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> test_pred<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize learning rate effect</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>lr_comparison <span class="sc">%&gt;%</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(train_rmse, test_rmse), </span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"set"</span>, <span class="at">values_to =</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(learn_rate), <span class="at">y =</span> rmse, <span class="at">fill =</span> set)) <span class="sc">+</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Learning Rate Effect in Gradient Boosting"</span>,</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower rates often generalize better but need more trees"</span>,</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Learning Rate"</span>,</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"RMSE"</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Boosting characteristics: - <strong>Sequential training</strong> (can’t parallelize easily) - <strong>Focuses on difficult cases</strong> progressively - <strong>Can overfit</strong> if not regularized properly - <strong>Often achieves</strong> best single-model performance</p>
</section>
</section>
<section id="model-stacking-the-meta-learning-approach" class="level2">
<h2 class="anchored" data-anchor-id="model-stacking-the-meta-learning-approach">Model Stacking: The Meta-Learning Approach</h2>
<p>Stacking uses a meta-model to combine predictions from base models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple stacking example with manual blending</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create base models</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">200</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">tree_depth =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec) <span class="sc">%&gt;%</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec) <span class="sc">%&gt;%</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_spec) <span class="sc">%&gt;%</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>lm_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>rf_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>xgb_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(xgb_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple average ensemble</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>avg_pred <span class="ot">&lt;-</span> (lm_pred <span class="sc">+</span> rf_pred <span class="sc">+</span> xgb_pred) <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Weighted average (weights could be tuned)</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>weighted_pred <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="sc">*</span> lm_pred <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> rf_pred <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> xgb_pred</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE for each approach</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>rmse_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Linear"</span>, <span class="st">"Random Forest"</span>, <span class="st">"XGBoost"</span>, <span class="st">"Simple Average"</span>, <span class="st">"Weighted Average"</span>),</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> lm_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> rf_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> xgb_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> avg_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> weighted_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(rmse_results, <span class="at">digits =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Linear</td>
<td style="text-align: right;">28724</td>
</tr>
<tr class="even">
<td style="text-align: left;">Random Forest</td>
<td style="text-align: right;">27934</td>
</tr>
<tr class="odd">
<td style="text-align: left;">XGBoost</td>
<td style="text-align: right;">24228</td>
</tr>
<tr class="even">
<td style="text-align: left;">Simple Average</td>
<td style="text-align: right;">24186</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Weighted Average</td>
<td style="text-align: right;">24076</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize ensemble effect</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rmse_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Model, RMSE), <span class="at">y =</span> RMSE, <span class="at">fill =</span> Model)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Stacking Performance"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Ensemble methods typically outperform individual models"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="voting-ensembles" class="level2">
<h2 class="anchored" data-anchor-id="voting-ensembles">Voting Ensembles</h2>
<p>For classification, voting combines predictions through majority vote or averaging:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create classification problem</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create diverse classifiers</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>logistic_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>tree_spec <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>rf_class_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple recipe for classification</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Year_Built, </span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> class_train) <span class="sc">%&gt;%</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit individual models</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">logistic =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(logistic_spec) <span class="sc">%&gt;%</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train),</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(tree_spec) <span class="sc">%&gt;%</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train),</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(rf_class_spec) <span class="sc">%&gt;%</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(models, <span class="cf">function</span>(model) {</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(model, class_test, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste0</span>(<span class="fu">names</span>(models), <span class="st">"_prob_yes"</span>))</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Hard voting (majority vote)</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>hard_vote <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">vote_yes =</span> <span class="fu">rowSums</span>(. <span class="sc">&gt;</span> <span class="fl">0.5</span>),</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(vote_yes <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Soft voting (average probabilities)</span></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>soft_vote <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_prob =</span> <span class="fu">rowMeans</span>(.),</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(avg_prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate voting methods</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>voting_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"Hard Voting"</span>, <span class="st">"Soft Voting"</span>),</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">accuracy =</span> <span class="fu">c</span>(</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(hard_vote<span class="sc">$</span>prediction <span class="sc">==</span> class_test<span class="sc">$</span>expensive),</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(soft_vote<span class="sc">$</span>prediction <span class="sc">==</span> class_test<span class="sc">$</span>expensive)</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Add individual model accuracies</span></span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>individual_acc <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="cf">function</span>(model) {</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, class_test)</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(pred<span class="sc">$</span>.pred_class <span class="sc">==</span> class_test<span class="sc">$</span>expensive)</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">method =</span> <span class="fu">names</span>(individual_acc), <span class="at">accuracy =</span> individual_acc),</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>  voting_results</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(method, accuracy), <span class="at">y =</span> accuracy)) <span class="sc">+</span></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"steelblue"</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"coral"</span>, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(accuracy, <span class="dv">3</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Voting Ensemble Performance"</span>,</span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Voting often outperforms individual models"</span>,</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Method"</span>,</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Accuracy"</span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="diversity-in-ensembles" class="level2">
<h2 class="anchored" data-anchor-id="diversity-in-ensembles">Diversity in Ensembles</h2>
<p>Ensemble success depends on model diversity:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure diversity through correlation</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from base models</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>base_predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(models, <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(models))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlation matrix</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(base_predictions)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot</span>(cor_matrix, <span class="at">method =</span> <span class="st">"circle"</span>, <span class="at">type =</span> <span class="st">"upper"</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">title =</span> <span class="st">"Model Prediction Correlations"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversity metrics</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>diversity_metrics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">"Average Pairwise Correlation"</span>, <span class="st">"Disagreement Rate"</span>),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(cor_matrix[<span class="fu">upper.tri</span>(cor_matrix)]),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">apply</span>(base_predictions <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">length</span>(<span class="fu">unique</span>(x))) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(diversity_metrics, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">metric</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Average Pairwise Correlation</td>
<td style="text-align: right;">0.909</td>
</tr>
<tr class="even">
<td style="text-align: left;">Disagreement Rate</td>
<td style="text-align: right;">0.133</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show how diversity affects ensemble performance</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create models with varying diversity</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>diverse_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Similar models (low diversity)</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf1 =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">mtry =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf2 =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">mtry =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Different model types (high diversity)</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear =</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"glm"</span>),</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>diverse_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(diverse_models, <span class="cf">function</span>(model) {</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare ensemble of similar vs diverse models</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>similar_ensemble <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(diverse_fits[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowMeans</span>()</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>diverse_ensemble <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(diverse_fits[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>], </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowMeans</span>()</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>ensemble_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">ensemble_type =</span> <span class="fu">c</span>(<span class="st">"Similar Models"</span>, <span class="st">"Diverse Models"</span>),</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">accuracy =</span> <span class="fu">c</span>(</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((similar_ensemble <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">==</span> (class_test<span class="sc">$</span>expensive <span class="sc">==</span> <span class="st">"yes"</span>)),</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((diverse_ensemble <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">==</span> (class_test<span class="sc">$</span>expensive <span class="sc">==</span> <span class="st">"yes"</span>))</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ensemble_comparison, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">ensemble_type</th>
<th style="text-align: right;">accuracy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Similar Models</td>
<td style="text-align: right;">0.876</td>
</tr>
<tr class="even">
<td style="text-align: left;">Diverse Models</td>
<td style="text-align: right;">0.858</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="advanced-ensemble-techniques" class="level2">
<h2 class="anchored" data-anchor-id="advanced-ensemble-techniques">Advanced Ensemble Techniques</h2>
<section id="dynamic-ensemble-selection" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-ensemble-selection">Dynamic Ensemble Selection</h3>
<p>Choose different models for different regions of the feature space:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate region-based ensemble</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2D problem for visualization</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>region_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">region =</span> <span class="fu">case_when</span>(</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"B"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"C"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"D"</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> x1 <span class="sc">+</span> x2,        <span class="co"># Linear in region A</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">~</span> x1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> x2,          <span class="co"># Quadratic in region B</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"C"</span> <span class="sc">~</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> x1) <span class="sc">+</span> x2,   <span class="co"># Sinusoidal in region C</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">exp</span>(<span class="fl">0.5</span> <span class="sc">*</span> x1) <span class="sc">+</span> x2           <span class="co"># Exponential in region D</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="at">sd =</span> <span class="fl">0.3</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize regions</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(region_data, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">color =</span> y)) <span class="sc">+</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Different Patterns in Different Regions"</span>,</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dynamic selection can use best model for each region"</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cascade-ensembles" class="level3">
<h3 class="anchored" data-anchor-id="cascade-ensembles">Cascade Ensembles</h3>
<p>Use simple models for easy cases, complex models for hard cases:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate cascade concept</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># First tier: Simple, fast model</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>simple_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions and residuals</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>simple_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(simple_fit, ames_train)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>train_with_residuals <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple_pred =</span> simple_pred<span class="sc">$</span>.pred,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> simple_pred,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_difficult =</span> <span class="fu">abs</span>(residual) <span class="sc">&gt;</span> <span class="fu">quantile</span>(<span class="fu">abs</span>(residual), <span class="fl">0.75</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Second tier: Complex model for difficult cases</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>complex_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">200</span>, <span class="at">tree_depth =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Train on difficult cases</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>difficult_cases <span class="ot">&lt;-</span> train_with_residuals <span class="sc">%&gt;%</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_difficult)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>complex_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(residual <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> difficult_cases)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>complex_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(complex_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(complex_model) <span class="sc">%&gt;%</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(difficult_cases)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cascade ensemble:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cascade ensemble:</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Simple model handles"</span>, <span class="fu">sum</span>(<span class="sc">!</span>train_with_residuals<span class="sc">$</span>is_difficult), <span class="st">"cases</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Simple model handles 1648 cases</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Complex model handles"</span>, <span class="fu">sum</span>(train_with_residuals<span class="sc">$</span>is_difficult), <span class="st">"difficult cases</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Complex model handles 549 difficult cases</code></pre>
</div>
</div>
</section>
</section>
<section id="best-practices-for-ensembles" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-for-ensembles">Best Practices for Ensembles</h2>
<section id="ensure-model-diversity" class="level3">
<h3 class="anchored" data-anchor-id="ensure-model-diversity">1. Ensure Model Diversity</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategies for diversity</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>diversity_strategies <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Strategy =</span> <span class="fu">c</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different algorithms"</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different hyperparameters"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different features"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different training samples"</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different target transformations"</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Example =</span> <span class="fu">c</span>(</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Linear + Tree + Neural Network"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Shallow trees + Deep trees"</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Subset 1 features + Subset 2 features"</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bootstrap + Stratified + Random"</span>,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Log(y) + sqrt(y) + y"</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Benefit =</span> <span class="fu">c</span>(</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Captures different patterns"</span>,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Varies complexity"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different perspectives"</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reduces correlation"</span>,</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different error distributions"</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(diversity_strategies)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 32%">
<col style="width: 37%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Strategy</th>
<th style="text-align: left;">Example</th>
<th style="text-align: left;">Benefit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Different algorithms</td>
<td style="text-align: left;">Linear + Tree + Neural Network</td>
<td style="text-align: left;">Captures different patterns</td>
</tr>
<tr class="even">
<td style="text-align: left;">Different hyperparameters</td>
<td style="text-align: left;">Shallow trees + Deep trees</td>
<td style="text-align: left;">Varies complexity</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Different features</td>
<td style="text-align: left;">Subset 1 features + Subset 2 features</td>
<td style="text-align: left;">Different perspectives</td>
</tr>
<tr class="even">
<td style="text-align: left;">Different training samples</td>
<td style="text-align: left;">Bootstrap + Stratified + Random</td>
<td style="text-align: left;">Reduces correlation</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Different target transformations</td>
<td style="text-align: left;">Log(y) + sqrt(y) + y</td>
<td style="text-align: left;">Different error distributions</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="choose-appropriate-ensemble-method" class="level3">
<h3 class="anchored" data-anchor-id="choose-appropriate-ensemble-method">2. Choose Appropriate Ensemble Method</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision guide</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>ensemble_guide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario =</span> <span class="fu">c</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High-variance base models"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Need interpretability"</span>,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Limited computational budget"</span>,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Maximizing performance"</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imbalanced classes"</span>,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different expertise regions"</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Recommended Method</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bagging or Random Forest"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple voting or linear stacking"</span>,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Voting ensemble"</span>,</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gradient boosting or stacking"</span>,</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Balanced bagging or cost-sensitive boosting"</span>,</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dynamic selection"</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ensemble_guide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 39%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Scenario</th>
<th style="text-align: left;">Recommended Method</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">High-variance base models</td>
<td style="text-align: left;">Bagging or Random Forest</td>
</tr>
<tr class="even">
<td style="text-align: left;">Need interpretability</td>
<td style="text-align: left;">Simple voting or linear stacking</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Limited computational budget</td>
<td style="text-align: left;">Voting ensemble</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maximizing performance</td>
<td style="text-align: left;">Gradient boosting or stacking</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Imbalanced classes</td>
<td style="text-align: left;">Balanced bagging or cost-sensitive boosting</td>
</tr>
<tr class="even">
<td style="text-align: left;">Different expertise regions</td>
<td style="text-align: left;">Dynamic selection</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="exercise-1-build-a-custom-ensemble" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-build-a-custom-ensemble">Exercise 1: Build a Custom Ensemble</h3>
<p>Create your own ensemble combining different approaches:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom ensemble for Ames housing</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>custom_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Street, Utilities, Condition_2, Roof_Matl, Heating, Pool_QC,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>          Misc_Feature, Pool_Area, Longitude, Latitude) <span class="sc">%&gt;%</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Base models</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>base_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Regularized regression</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">elastic =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tree-based</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">200</span>, <span class="at">mtry =</span> <span class="dv">10</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>),</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Boosting</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">xgb =</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">tree_depth =</span> <span class="dv">5</span>, <span class="at">learn_rate =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>),</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Local model</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">knn =</span> <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit all base models</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>base_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(base_models, <span class="cf">function</span>(model) {</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(custom_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(ames_train)</span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Get out-of-sample predictions using cross-validation</span></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="co"># (In practice, use proper validation set)</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>val_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_train, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>val_train <span class="ot">&lt;-</span> <span class="fu">training</span>(val_split)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>val_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(val_split)</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Refit on validation training</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>val_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(base_models, <span class="cf">function</span>(model) {</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(custom_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(val_train)</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Get validation predictions for stacking</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>val_predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(val_fits, <span class="sc">~</span> <span class="fu">predict</span>(., val_test)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Train meta-learner</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>meta_data <span class="ot">&lt;-</span> val_predictions <span class="sc">%&gt;%</span></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">target =</span> val_test<span class="sc">$</span>Sale_Price)</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a>meta_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(target <span class="sc">~</span> ., <span class="at">data =</span> meta_data)</span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to make ensemble predictions</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>ensemble_predict <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get base predictions</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>  base_preds <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(base_fits, <span class="sc">~</span> <span class="fu">predict</span>(., new_data)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply meta-model</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(meta_model, base_preds)</span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate custom ensemble</span></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>ensemble_pred <span class="ot">&lt;-</span> <span class="fu">ensemble_predict</span>(ames_test)</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>ensemble_rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> ensemble_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with individual models</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>individual_rmse <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(base_fits, <span class="cf">function</span>(fit) {</span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">c</span>(individual_rmse, <span class="at">ensemble =</span> ensemble_rmse)</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sort</span>(results)</span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(results, <span class="at">main =</span> <span class="st">"Custom Ensemble Performance"</span>,</span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"RMSE"</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"steelblue"</span>, <span class="fu">length</span>(results)<span class="sc">-</span><span class="dv">1</span>), <span class="st">"coral"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-2-optimize-ensemble-weights" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-optimize-ensemble-weights">Exercise 2: Optimize Ensemble Weights</h3>
<p>Find optimal weights for combining models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>test_preds <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(base_fits, <span class="sc">~</span> <span class="fu">predict</span>(., ames_test)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimization function</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>optimize_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(weights, predictions, target) {</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize weights</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> weights <span class="sc">/</span> <span class="fu">sum</span>(weights)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weighted average</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  ensemble_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(predictions) <span class="sc">%*%</span> weights</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return RMSE</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((target <span class="sc">-</span> ensemble_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial equal weights</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>n_models <span class="ot">&lt;-</span> <span class="fu">length</span>(base_models)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>initial_weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_models, n_models)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>opt_result <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> initial_weights,</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> optimize_weights,</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> test_preds,</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> ames_test<span class="sc">$</span>Sale_Price,</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n_models),</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_models)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimal weights</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>optimal_weights <span class="ot">&lt;-</span> opt_result<span class="sc">$</span>par <span class="sc">/</span> <span class="fu">sum</span>(opt_result<span class="sc">$</span>par)</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(optimal_weights) <span class="ot">&lt;-</span> <span class="fu">names</span>(base_models)</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare equal vs optimal weights</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>equal_pred <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(test_preds)</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>optimal_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_preds) <span class="sc">%*%</span> optimal_weights</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>weight_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Equal Weights"</span>, <span class="st">"Optimal Weights"</span>),</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> equal_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> optimal_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(weight_comparison, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Method</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Equal Weights</td>
<td style="text-align: right;">26566.04</td>
</tr>
<tr class="even">
<td style="text-align: left;">Optimal Weights</td>
<td style="text-align: right;">23026.81</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show optimal weights</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(optimal_weights, <span class="at">main =</span> <span class="st">"Optimal Ensemble Weights"</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Weight"</span>, <span class="at">col =</span> <span class="st">"steelblue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-implement-boosting-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-implement-boosting-from-scratch">Exercise 3: Implement Boosting from Scratch</h3>
<p>Understand boosting by implementing a simple version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple boosting implementation</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>simple_boosting <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, <span class="at">n_iterations =</span> <span class="dv">10</span>, <span class="at">learning_rate =</span> <span class="fl">0.1</span>) {</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize with mean</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">mean</span>(y), n)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_iterations) {</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">&lt;-</span> y <span class="sc">-</span> predictions</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit a simple model to residuals (using a decision stump)</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For simplicity, we'll use a linear model here</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    model_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">residual =</span> residuals)</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    weak_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(residual <span class="sc">~</span> x, <span class="at">data =</span> model_data)</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store model</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    models[[i]] <span class="ot">&lt;-</span> weak_model</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update predictions</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    update <span class="ot">&lt;-</span> <span class="fu">predict</span>(weak_model, model_data)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">+</span> learning_rate <span class="sc">*</span> update</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate current error</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    current_rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((y <span class="sc">-</span> predictions)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Iteration"</span>, i, <span class="st">"- RMSE:"</span>, current_rmse, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">models =</span> models, <span class="at">final_predictions =</span> predictions,</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>              <span class="at">learning_rate =</span> learning_rate))</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on simple data</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">&lt;-</span> ames_train<span class="sc">$</span>Gr_Liv_Area[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>test_y <span class="ot">&lt;-</span> ames_train<span class="sc">$</span>Sale_Price[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>boost_result <span class="ot">&lt;-</span> <span class="fu">simple_boosting</span>(test_x, test_y, <span class="at">n_iterations =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Iteration 1 - RMSE: 22607.51 
Iteration 2 - RMSE: 22598.13 
Iteration 3 - RMSE: 22590.53 
Iteration 4 - RMSE: 22584.37 
Iteration 5 - RMSE: 22579.38 
Iteration 6 - RMSE: 22575.34 
Iteration 7 - RMSE: 22572.07 
Iteration 8 - RMSE: 22569.41 
Iteration 9 - RMSE: 22567.27 
Iteration 10 - RMSE: 22565.52 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize boosting progress</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(test_x, test_y, <span class="at">main =</span> <span class="st">"Simple Boosting Results"</span>,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Gr_Liv_Area"</span>, <span class="at">ylab =</span> <span class="st">"Sale_Price"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(test_x, boost_result<span class="sc">$</span>final_predictions, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Actual"</span>, <span class="st">"Predicted"</span>), </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>), <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">16</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="16-ensemble-methods_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this comprehensive chapter, you’ve mastered:</p>
<p>✅ <strong>Ensemble fundamentals</strong> - Why ensembles work mathematically - Bias-variance decomposition - The importance of diversity</p>
<p>✅ <strong>Bagging methods</strong> - Bootstrap aggregating - Random forests - Out-of-bag error</p>
<p>✅ <strong>Boosting algorithms</strong> - Sequential learning - AdaBoost and gradient boosting - XGBoost implementation</p>
<p>✅ <strong>Stacking and blending</strong> - Meta-learning approaches - Cross-validation for stacking - Optimal weight finding</p>
<p>✅ <strong>Advanced techniques</strong> - Dynamic selection - Cascade ensembles - Custom ensemble design</p>
<p>Key takeaways: - Ensembles almost always outperform single models - Diversity is crucial for ensemble success - Different methods suit different problems - Boosting for accuracy, bagging for stability - Stacking combines strengths of different approaches - Computational cost vs performance trade-off</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>In <a href="./17-unsupervised-learning.html">Chapter 17</a>, we’ll explore unsupervised learning techniques for discovering patterns without labels.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="https://www.statlearning.com/">Introduction to Statistical Learning - Chapter 8</a></li>
<li><a href="https://hastie.su.domains/ElemStatLearn/">Elements of Statistical Learning - Chapters 10, 15, 16</a></li>
<li><a href="https://xgboost.readthedocs.io/">XGBoost Documentation</a></li>
<li><a href="https://www.stat.berkeley.edu/~breiman/randomforest2001.pdf">Random Forests Original Paper</a></li>
<li><a href="https://www.amazon.com/Ensemble-Methods-Foundations-Algorithms-Learning/dp/1439830037">Ensemble Methods: Foundations and Algorithms</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all elements with class 'quarto-title-meta-heading' that contain "Author"
    const authorHeadings = document.querySelectorAll('.quarto-title-meta-heading');
    
    authorHeadings.forEach(function(heading) {
        if (heading.textContent.trim() === 'Author') {
            heading.textContent = 'Authors';
        }
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb52" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 16: Ensemble Methods - The Power of Many"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "David Sarrat González, Juan R González"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will master:</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The theory behind ensemble methods</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Bagging and random forests</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Boosting algorithms (AdaBoost, GBM, XGBoost)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stacking and blending models</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Voting classifiers</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Model diversity and ensemble selection</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Practical implementation with tidymodels</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>When and why ensembles work</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Wisdom of Crowds in Machine Learning</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>Imagine you're trying to guess the number of jellybeans in a jar. One person might overestimate, another might underestimate, but the average of many guesses often comes remarkably close to the truth. This is the fundamental principle behind ensemble methods: combining multiple models can produce predictions that are more accurate than any individual model.</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>The mathematics behind this are elegant. If we have multiple independent models with uncorrelated errors, combining them reduces the overall error. This is why ensemble methods consistently win machine learning competitions.</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stacks)</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(baguette)</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rules)</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare data</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare a simpler dataset for visualization</span></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>ames_simple <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Sale_Price, Gr_Liv_Area, Overall_Cond, Year_Built, Neighborhood) <span class="sc">%&gt;%</span></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">500</span>)</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Ensembles Work: The Mathematical Foundation</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>Let's understand why combining models reduces error:</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate the power of ensembles</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>n_models <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>n_points <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="co"># True function</span></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">length.out =</span> n_points)</span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a>y_true <span class="ot">&lt;-</span> <span class="fu">sin</span>(x) <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> x</span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a>y_observed <span class="ot">&lt;-</span> y_true <span class="sc">+</span> <span class="fu">rnorm</span>(n_points, <span class="at">sd =</span> <span class="fl">0.5</span>)</span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple "weak" models (with random variations)</span></span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a>weak_predictions <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models, <span class="cf">function</span>(i) {</span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each model sees slightly different data (bootstrap)</span></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a>  sample_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n_points, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simple polynomial model with random degree</span></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a>  degree <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_observed[sample_idx] <span class="sc">~</span> <span class="fu">poly</span>(x[sample_idx], degree))</span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on all points</span></span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(model, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x))</span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine predictions</span></span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a>ensemble_pred <span class="ot">&lt;-</span> <span class="fu">reduce</span>(weak_predictions, <span class="st">`</span><span class="at">+</span><span class="st">`</span>) <span class="sc">/</span> n_models</span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate errors</span></span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a>individual_errors <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(weak_predictions, <span class="sc">~</span> <span class="fu">mean</span>((. <span class="sc">-</span> y_true)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a>ensemble_error <span class="ot">&lt;-</span> <span class="fu">mean</span>((ensemble_pred <span class="sc">-</span> y_true)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_true =</span> y_true,</span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_observed =</span> y_observed,</span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a>  <span class="at">ensemble =</span> ensemble_pred</span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(</span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(weak_predictions, <span class="at">.name_repair =</span> <span class="st">"minimal"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_names</span>(<span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models))</span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot individual models vs ensemble</span></span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_observed), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_2), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> model_3), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Individual Weak Models"</span>,</span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Each model overfits in different ways"</span>,</span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results_df, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_observed), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_true), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ensemble), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Ensemble Prediction"</span>,</span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Ensemble MSE:"</span>, <span class="fu">round</span>(ensemble_error, <span class="dv">3</span>), </span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"vs Avg Individual:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(individual_errors), <span class="dv">3</span>)),</span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb52-135"><a href="#cb52-135" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-136"><a href="#cb52-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-137"><a href="#cb52-137" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span>
<span id="cb52-138"><a href="#cb52-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-139"><a href="#cb52-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Error reduction</span></span>
<span id="cb52-140"><a href="#cb52-140" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average individual model MSE:"</span>, <span class="fu">mean</span>(individual_errors), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-141"><a href="#cb52-141" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Ensemble MSE:"</span>, ensemble_error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-142"><a href="#cb52-142" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Error reduction:"</span>, <span class="fu">round</span>((<span class="dv">1</span> <span class="sc">-</span> ensemble_error<span class="sc">/</span><span class="fu">mean</span>(individual_errors)) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-143"><a href="#cb52-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-144"><a href="#cb52-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-145"><a href="#cb52-145" aria-hidden="true" tabindex="-1"></a>The key insight: errors cancel out when models make different mistakes!</span>
<span id="cb52-146"><a href="#cb52-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-147"><a href="#cb52-147" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bagging: Bootstrap Aggregating</span></span>
<span id="cb52-148"><a href="#cb52-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-149"><a href="#cb52-149" aria-hidden="true" tabindex="-1"></a>Bagging creates diverse models by training on different bootstrap samples:</span>
<span id="cb52-150"><a href="#cb52-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-153"><a href="#cb52-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-154"><a href="#cb52-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement bagging for decision trees</span></span>
<span id="cb52-155"><a href="#cb52-155" aria-hidden="true" tabindex="-1"></a>bagging_spec <span class="ot">&lt;-</span> <span class="fu">bag_tree</span>(</span>
<span id="cb52-156"><a href="#cb52-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost_complexity =</span> <span class="dv">0</span>,</span>
<span id="cb52-157"><a href="#cb52-157" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">10</span>,</span>
<span id="cb52-158"><a href="#cb52-158" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">2</span></span>
<span id="cb52-159"><a href="#cb52-159" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-160"><a href="#cb52-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>, <span class="at">times =</span> <span class="dv">25</span>) <span class="sc">%&gt;%</span>  <span class="co"># 25 bootstrap samples</span></span>
<span id="cb52-161"><a href="#cb52-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-162"><a href="#cb52-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-163"><a href="#cb52-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple recipe</span></span>
<span id="cb52-164"><a href="#cb52-164" aria-hidden="true" tabindex="-1"></a>simple_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb52-165"><a href="#cb52-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Street, Utilities, Condition_2, Roof_Matl, Heating, Pool_QC,</span>
<span id="cb52-166"><a href="#cb52-166" aria-hidden="true" tabindex="-1"></a>          Misc_Feature, Pool_Area, Longitude, Latitude) <span class="sc">%&gt;%</span></span>
<span id="cb52-167"><a href="#cb52-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb52-168"><a href="#cb52-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb52-169"><a href="#cb52-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb52-170"><a href="#cb52-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-171"><a href="#cb52-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow</span></span>
<span id="cb52-172"><a href="#cb52-172" aria-hidden="true" tabindex="-1"></a>bagging_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-173"><a href="#cb52-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-174"><a href="#cb52-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(bagging_spec)</span>
<span id="cb52-175"><a href="#cb52-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-176"><a href="#cb52-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb52-177"><a href="#cb52-177" aria-hidden="true" tabindex="-1"></a>bagging_fit <span class="ot">&lt;-</span> bagging_workflow <span class="sc">%&gt;%</span></span>
<span id="cb52-178"><a href="#cb52-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-179"><a href="#cb52-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-180"><a href="#cb52-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with single tree</span></span>
<span id="cb52-181"><a href="#cb52-181" aria-hidden="true" tabindex="-1"></a>single_tree_spec <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(</span>
<span id="cb52-182"><a href="#cb52-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">cost_complexity =</span> <span class="dv">0</span>,</span>
<span id="cb52-183"><a href="#cb52-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">10</span>,</span>
<span id="cb52-184"><a href="#cb52-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">2</span></span>
<span id="cb52-185"><a href="#cb52-185" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-186"><a href="#cb52-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-187"><a href="#cb52-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-188"><a href="#cb52-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-189"><a href="#cb52-189" aria-hidden="true" tabindex="-1"></a>single_tree_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-190"><a href="#cb52-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-191"><a href="#cb52-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(single_tree_spec)</span>
<span id="cb52-192"><a href="#cb52-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-193"><a href="#cb52-193" aria-hidden="true" tabindex="-1"></a>single_tree_fit <span class="ot">&lt;-</span> single_tree_workflow <span class="sc">%&gt;%</span></span>
<span id="cb52-194"><a href="#cb52-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-195"><a href="#cb52-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-196"><a href="#cb52-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate both</span></span>
<span id="cb52-197"><a href="#cb52-197" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-198"><a href="#cb52-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">actual =</span> ames_test<span class="sc">$</span>Sale_Price,</span>
<span id="cb52-199"><a href="#cb52-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">single_tree =</span> <span class="fu">predict</span>(single_tree_fit, ames_test)<span class="sc">$</span>.pred,</span>
<span id="cb52-200"><a href="#cb52-200" aria-hidden="true" tabindex="-1"></a>  <span class="at">bagging =</span> <span class="fu">predict</span>(bagging_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb52-201"><a href="#cb52-201" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-202"><a href="#cb52-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-203"><a href="#cb52-203" aria-hidden="true" tabindex="-1"></a>comparison_metrics <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-204"><a href="#cb52-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb52-205"><a href="#cb52-205" aria-hidden="true" tabindex="-1"></a>    <span class="at">single_tree_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> single_tree)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-206"><a href="#cb52-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">bagging_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> bagging)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-207"><a href="#cb52-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">improvement =</span> (single_tree_rmse <span class="sc">-</span> bagging_rmse) <span class="sc">/</span> single_tree_rmse <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb52-208"><a href="#cb52-208" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-209"><a href="#cb52-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-210"><a href="#cb52-210" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(comparison_metrics, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb52-211"><a href="#cb52-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-212"><a href="#cb52-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions</span></span>
<span id="cb52-213"><a href="#cb52-213" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-214"><a href="#cb52-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(single_tree, bagging), </span>
<span id="cb52-215"><a href="#cb52-215" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model"</span>, <span class="at">values_to =</span> <span class="st">"prediction"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-216"><a href="#cb52-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> prediction)) <span class="sc">+</span></span>
<span id="cb52-217"><a href="#cb52-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-218"><a href="#cb52-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb52-219"><a href="#cb52-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb52-220"><a href="#cb52-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-221"><a href="#cb52-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Single Tree vs Bagged Trees"</span>,</span>
<span id="cb52-222"><a href="#cb52-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Bagging reduces overfitting and improves predictions"</span>,</span>
<span id="cb52-223"><a href="#cb52-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb52-224"><a href="#cb52-224" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb52-225"><a href="#cb52-225" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-226"><a href="#cb52-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb52-227"><a href="#cb52-227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-228"><a href="#cb52-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-229"><a href="#cb52-229" aria-hidden="true" tabindex="-1"></a>Bagging characteristics:</span>
<span id="cb52-230"><a href="#cb52-230" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reduces variance** without increasing bias</span>
<span id="cb52-231"><a href="#cb52-231" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Works best** with high-variance, low-bias models (like deep trees)</span>
<span id="cb52-232"><a href="#cb52-232" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Parallel training** possible (each bootstrap independent)</span>
<span id="cb52-233"><a href="#cb52-233" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Out-of-bag (OOB)** error provides free validation</span>
<span id="cb52-234"><a href="#cb52-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-235"><a href="#cb52-235" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forests: Bagging with a Twist</span></span>
<span id="cb52-236"><a href="#cb52-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-237"><a href="#cb52-237" aria-hidden="true" tabindex="-1"></a>Random forests add feature randomness to bagging:</span>
<span id="cb52-238"><a href="#cb52-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-241"><a href="#cb52-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-242"><a href="#cb52-242" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare different mtry values</span></span>
<span id="cb52-243"><a href="#cb52-243" aria-hidden="true" tabindex="-1"></a>rf_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-244"><a href="#cb52-244" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry_prop =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.33</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1.0</span>),</span>
<span id="cb52-245"><a href="#cb52-245" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry_desc =</span> <span class="fu">c</span>(<span class="st">"10% features"</span>, <span class="st">"33% features (sqrt)"</span>, <span class="st">"50% features"</span>, </span>
<span id="cb52-246"><a href="#cb52-246" aria-hidden="true" tabindex="-1"></a>                <span class="st">"75% features"</span>, <span class="st">"100% features (bagging)"</span>)</span>
<span id="cb52-247"><a href="#cb52-247" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-248"><a href="#cb52-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-249"><a href="#cb52-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">map</span>(mtry_prop, <span class="cf">function</span>(prop) {</span>
<span id="cb52-250"><a href="#cb52-250" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rand_forest</span>(</span>
<span id="cb52-251"><a href="#cb52-251" aria-hidden="true" tabindex="-1"></a>        <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb52-252"><a href="#cb52-252" aria-hidden="true" tabindex="-1"></a>        <span class="at">mtry =</span> <span class="fu">floor</span>(prop <span class="sc">*</span> (<span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb52-253"><a href="#cb52-253" aria-hidden="true" tabindex="-1"></a>        <span class="at">min_n =</span> <span class="dv">5</span></span>
<span id="cb52-254"><a href="#cb52-254" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb52-255"><a href="#cb52-255" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-256"><a href="#cb52-256" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-257"><a href="#cb52-257" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-258"><a href="#cb52-258" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-259"><a href="#cb52-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-260"><a href="#cb52-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit all models</span></span>
<span id="cb52-261"><a href="#cb52-261" aria-hidden="true" tabindex="-1"></a>rf_workflows <span class="ot">&lt;-</span> rf_comparison <span class="sc">%&gt;%</span></span>
<span id="cb52-262"><a href="#cb52-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-263"><a href="#cb52-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">workflow =</span> <span class="fu">map</span>(model, <span class="cf">function</span>(m) {</span>
<span id="cb52-264"><a href="#cb52-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-265"><a href="#cb52-265" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-266"><a href="#cb52-266" aria-hidden="true" tabindex="-1"></a>        <span class="fu">add_model</span>(m)</span>
<span id="cb52-267"><a href="#cb52-267" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb52-268"><a href="#cb52-268" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-269"><a href="#cb52-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-270"><a href="#cb52-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with cross-validation (simplified for speed)</span></span>
<span id="cb52-271"><a href="#cb52-271" aria-hidden="true" tabindex="-1"></a>rf_results <span class="ot">&lt;-</span> rf_workflows <span class="sc">%&gt;%</span></span>
<span id="cb52-272"><a href="#cb52-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-273"><a href="#cb52-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_results =</span> <span class="fu">map</span>(workflow, <span class="sc">~</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb52-274"><a href="#cb52-274" aria-hidden="true" tabindex="-1"></a>      .,</span>
<span id="cb52-275"><a href="#cb52-275" aria-hidden="true" tabindex="-1"></a>      <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">3</span>),  <span class="co"># Reduced folds for speed</span></span>
<span id="cb52-276"><a href="#cb52-276" aria-hidden="true" tabindex="-1"></a>      <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb52-277"><a href="#cb52-277" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb52-278"><a href="#cb52-278" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-279"><a href="#cb52-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-280"><a href="#cb52-280" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract metrics</span></span>
<span id="cb52-281"><a href="#cb52-281" aria-hidden="true" tabindex="-1"></a>rf_metrics <span class="ot">&lt;-</span> rf_results <span class="sc">%&gt;%</span></span>
<span id="cb52-282"><a href="#cb52-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-283"><a href="#cb52-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">map</span>(cv_results, collect_metrics)</span>
<span id="cb52-284"><a href="#cb52-284" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-285"><a href="#cb52-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(metrics) <span class="sc">%&gt;%</span></span>
<span id="cb52-286"><a href="#cb52-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mtry_desc, .metric, mean, std_err)</span>
<span id="cb52-287"><a href="#cb52-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-288"><a href="#cb52-288" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize mtry effect</span></span>
<span id="cb52-289"><a href="#cb52-289" aria-hidden="true" tabindex="-1"></a>rf_metrics <span class="sc">%&gt;%</span></span>
<span id="cb52-290"><a href="#cb52-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-291"><a href="#cb52-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> mtry_desc, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb52-292"><a href="#cb52-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb52-293"><a href="#cb52-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb52-294"><a href="#cb52-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-295"><a href="#cb52-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Effect of Feature Randomness (mtry)"</span>,</span>
<span id="cb52-296"><a href="#cb52-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Moderate mtry often performs best"</span>,</span>
<span id="cb52-297"><a href="#cb52-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Features Considered per Split"</span>,</span>
<span id="cb52-298"><a href="#cb52-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"RMSE"</span></span>
<span id="cb52-299"><a href="#cb52-299" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-300"><a href="#cb52-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb52-301"><a href="#cb52-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-302"><a href="#cb52-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature importance from best model</span></span>
<span id="cb52-303"><a href="#cb52-303" aria-hidden="true" tabindex="-1"></a>best_rf <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb52-304"><a href="#cb52-304" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">500</span>,</span>
<span id="cb52-305"><a href="#cb52-305" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(ames_train) <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb52-306"><a href="#cb52-306" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">5</span></span>
<span id="cb52-307"><a href="#cb52-307" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-308"><a href="#cb52-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"permutation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-309"><a href="#cb52-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-310"><a href="#cb52-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-311"><a href="#cb52-311" aria-hidden="true" tabindex="-1"></a>best_rf_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-312"><a href="#cb52-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-313"><a href="#cb52-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(best_rf) <span class="sc">%&gt;%</span></span>
<span id="cb52-314"><a href="#cb52-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-315"><a href="#cb52-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-316"><a href="#cb52-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract and plot importance</span></span>
<span id="cb52-317"><a href="#cb52-317" aria-hidden="true" tabindex="-1"></a>best_rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb52-318"><a href="#cb52-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-319"><a href="#cb52-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">15</span>) <span class="sc">+</span></span>
<span id="cb52-320"><a href="#cb52-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Random Forest Feature Importance"</span>)</span>
<span id="cb52-321"><a href="#cb52-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-322"><a href="#cb52-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-323"><a href="#cb52-323" aria-hidden="true" tabindex="-1"></a>Random forest advantages:</span>
<span id="cb52-324"><a href="#cb52-324" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Further reduces overfitting** compared to bagging</span>
<span id="cb52-325"><a href="#cb52-325" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Decorrelates trees** through feature sampling</span>
<span id="cb52-326"><a href="#cb52-326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Provides feature importance** naturally</span>
<span id="cb52-327"><a href="#cb52-327" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Robust to hyperparameters** (often works well out-of-box)</span>
<span id="cb52-328"><a href="#cb52-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-329"><a href="#cb52-329" aria-hidden="true" tabindex="-1"></a><span class="fu">## Boosting: Learning from Mistakes</span></span>
<span id="cb52-330"><a href="#cb52-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-331"><a href="#cb52-331" aria-hidden="true" tabindex="-1"></a>Boosting sequentially builds models, each learning from previous errors:</span>
<span id="cb52-332"><a href="#cb52-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-333"><a href="#cb52-333" aria-hidden="true" tabindex="-1"></a><span class="fu">### AdaBoost: The Original Boosting Algorithm</span></span>
<span id="cb52-334"><a href="#cb52-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-337"><a href="#cb52-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-338"><a href="#cb52-338" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate boosting concept with simple example</span></span>
<span id="cb52-339"><a href="#cb52-339" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a difficult classification dataset</span></span>
<span id="cb52-340"><a href="#cb52-340" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb52-341"><a href="#cb52-341" aria-hidden="true" tabindex="-1"></a>spiral_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-342"><a href="#cb52-342" aria-hidden="true" tabindex="-1"></a>  <span class="at">angle =</span> <span class="fu">runif</span>(<span class="dv">300</span>, <span class="dv">0</span>, <span class="dv">4</span> <span class="sc">*</span> pi),</span>
<span id="cb52-343"><a href="#cb52-343" aria-hidden="true" tabindex="-1"></a>  <span class="at">radius =</span> <span class="fu">runif</span>(<span class="dv">300</span>, <span class="fl">0.5</span>, <span class="dv">2</span>)</span>
<span id="cb52-344"><a href="#cb52-344" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-345"><a href="#cb52-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-346"><a href="#cb52-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> radius <span class="sc">*</span> <span class="fu">cos</span>(angle) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb52-347"><a href="#cb52-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> radius <span class="sc">*</span> <span class="fu">sin</span>(angle) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">300</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb52-348"><a href="#cb52-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(angle <span class="sc">%%</span> (<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">&lt;</span> pi, <span class="st">"A"</span>, <span class="st">"B"</span>))</span>
<span id="cb52-349"><a href="#cb52-349" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-350"><a href="#cb52-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-351"><a href="#cb52-351" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the problem</span></span>
<span id="cb52-352"><a href="#cb52-352" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(spiral_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> class)) <span class="sc">+</span></span>
<span id="cb52-353"><a href="#cb52-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-354"><a href="#cb52-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-355"><a href="#cb52-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Spiral Classification Problem"</span>,</span>
<span id="cb52-356"><a href="#cb52-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Difficult for single linear boundary"</span></span>
<span id="cb52-357"><a href="#cb52-357" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-358"><a href="#cb52-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb52-359"><a href="#cb52-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-360"><a href="#cb52-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Boosting builds sequential models</span></span>
<span id="cb52-361"><a href="#cb52-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Each focuses on misclassified points from previous models</span></span>
<span id="cb52-362"><a href="#cb52-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-363"><a href="#cb52-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-364"><a href="#cb52-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gradient Boosting Machines (GBM)</span></span>
<span id="cb52-365"><a href="#cb52-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-368"><a href="#cb52-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-369"><a href="#cb52-369" aria-hidden="true" tabindex="-1"></a><span class="co"># XGBoost - state-of-the-art gradient boosting</span></span>
<span id="cb52-370"><a href="#cb52-370" aria-hidden="true" tabindex="-1"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb52-371"><a href="#cb52-371" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb52-372"><a href="#cb52-372" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb52-373"><a href="#cb52-373" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">10</span>,</span>
<span id="cb52-374"><a href="#cb52-374" aria-hidden="true" tabindex="-1"></a>  <span class="at">loss_reduction =</span> <span class="fl">0.01</span>,</span>
<span id="cb52-375"><a href="#cb52-375" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_size =</span> <span class="fl">0.8</span>,</span>
<span id="cb52-376"><a href="#cb52-376" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_rate =</span> <span class="fl">0.1</span></span>
<span id="cb52-377"><a href="#cb52-377" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-378"><a href="#cb52-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-379"><a href="#cb52-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-380"><a href="#cb52-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-381"><a href="#cb52-381" aria-hidden="true" tabindex="-1"></a>xgb_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-382"><a href="#cb52-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-383"><a href="#cb52-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_spec)</span>
<span id="cb52-384"><a href="#cb52-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-385"><a href="#cb52-385" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb52-386"><a href="#cb52-386" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> xgb_workflow <span class="sc">%&gt;%</span></span>
<span id="cb52-387"><a href="#cb52-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-388"><a href="#cb52-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-389"><a href="#cb52-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare learning rates</span></span>
<span id="cb52-390"><a href="#cb52-390" aria-hidden="true" tabindex="-1"></a>learning_rates <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>)</span>
<span id="cb52-391"><a href="#cb52-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-392"><a href="#cb52-392" aria-hidden="true" tabindex="-1"></a>lr_comparison <span class="ot">&lt;-</span> <span class="fu">map_df</span>(learning_rates, <span class="cf">function</span>(lr) {</span>
<span id="cb52-393"><a href="#cb52-393" aria-hidden="true" tabindex="-1"></a>  spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(</span>
<span id="cb52-394"><a href="#cb52-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">trees =</span> <span class="dv">100</span>,</span>
<span id="cb52-395"><a href="#cb52-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_depth =</span> <span class="dv">4</span>,</span>
<span id="cb52-396"><a href="#cb52-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> lr</span>
<span id="cb52-397"><a href="#cb52-397" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-398"><a href="#cb52-398" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-399"><a href="#cb52-399" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-400"><a href="#cb52-400" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-401"><a href="#cb52-401" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-402"><a href="#cb52-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-403"><a href="#cb52-403" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(spec)</span>
<span id="cb52-404"><a href="#cb52-404" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-405"><a href="#cb52-405" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb52-406"><a href="#cb52-406" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> wf <span class="sc">%&gt;%</span> <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-407"><a href="#cb52-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-408"><a href="#cb52-408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get training history (if available)</span></span>
<span id="cb52-409"><a href="#cb52-409" aria-hidden="true" tabindex="-1"></a>  train_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_train)</span>
<span id="cb52-410"><a href="#cb52-410" aria-hidden="true" tabindex="-1"></a>  test_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_test)</span>
<span id="cb52-411"><a href="#cb52-411" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-412"><a href="#cb52-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb52-413"><a href="#cb52-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">learn_rate =</span> lr,</span>
<span id="cb52-414"><a href="#cb52-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">train_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_train<span class="sc">$</span>Sale_Price <span class="sc">-</span> train_pred<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-415"><a href="#cb52-415" aria-hidden="true" tabindex="-1"></a>    <span class="at">test_rmse =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> test_pred<span class="sc">$</span>.pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-416"><a href="#cb52-416" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-417"><a href="#cb52-417" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-418"><a href="#cb52-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-419"><a href="#cb52-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize learning rate effect</span></span>
<span id="cb52-420"><a href="#cb52-420" aria-hidden="true" tabindex="-1"></a>lr_comparison <span class="sc">%&gt;%</span></span>
<span id="cb52-421"><a href="#cb52-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(train_rmse, test_rmse), </span>
<span id="cb52-422"><a href="#cb52-422" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"set"</span>, <span class="at">values_to =</span> <span class="st">"rmse"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-423"><a href="#cb52-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(learn_rate), <span class="at">y =</span> rmse, <span class="at">fill =</span> set)) <span class="sc">+</span></span>
<span id="cb52-424"><a href="#cb52-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb52-425"><a href="#cb52-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-426"><a href="#cb52-426" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Learning Rate Effect in Gradient Boosting"</span>,</span>
<span id="cb52-427"><a href="#cb52-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Lower rates often generalize better but need more trees"</span>,</span>
<span id="cb52-428"><a href="#cb52-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Learning Rate"</span>,</span>
<span id="cb52-429"><a href="#cb52-429" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"RMSE"</span></span>
<span id="cb52-430"><a href="#cb52-430" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-431"><a href="#cb52-431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-432"><a href="#cb52-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-433"><a href="#cb52-433" aria-hidden="true" tabindex="-1"></a>Boosting characteristics:</span>
<span id="cb52-434"><a href="#cb52-434" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sequential training** (can't parallelize easily)</span>
<span id="cb52-435"><a href="#cb52-435" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Focuses on difficult cases** progressively</span>
<span id="cb52-436"><a href="#cb52-436" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Can overfit** if not regularized properly</span>
<span id="cb52-437"><a href="#cb52-437" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Often achieves** best single-model performance</span>
<span id="cb52-438"><a href="#cb52-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-439"><a href="#cb52-439" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Stacking: The Meta-Learning Approach</span></span>
<span id="cb52-440"><a href="#cb52-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-441"><a href="#cb52-441" aria-hidden="true" tabindex="-1"></a>Stacking uses a meta-model to combine predictions from base models:</span>
<span id="cb52-442"><a href="#cb52-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-445"><a href="#cb52-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-446"><a href="#cb52-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple stacking example with manual blending</span></span>
<span id="cb52-447"><a href="#cb52-447" aria-hidden="true" tabindex="-1"></a><span class="co"># Create base models</span></span>
<span id="cb52-448"><a href="#cb52-448" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-449"><a href="#cb52-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-450"><a href="#cb52-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-451"><a href="#cb52-451" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">200</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-452"><a href="#cb52-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-453"><a href="#cb52-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-454"><a href="#cb52-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-455"><a href="#cb52-455" aria-hidden="true" tabindex="-1"></a>xgb_spec <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">tree_depth =</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-456"><a href="#cb52-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-457"><a href="#cb52-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-458"><a href="#cb52-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-459"><a href="#cb52-459" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models</span></span>
<span id="cb52-460"><a href="#cb52-460" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-461"><a href="#cb52-461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-462"><a href="#cb52-462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-463"><a href="#cb52-463" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-464"><a href="#cb52-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-465"><a href="#cb52-465" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-466"><a href="#cb52-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-467"><a href="#cb52-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-468"><a href="#cb52-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-469"><a href="#cb52-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-470"><a href="#cb52-470" aria-hidden="true" tabindex="-1"></a>xgb_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-471"><a href="#cb52-471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-472"><a href="#cb52-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(xgb_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-473"><a href="#cb52-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-474"><a href="#cb52-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-475"><a href="#cb52-475" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb52-476"><a href="#cb52-476" aria-hidden="true" tabindex="-1"></a>lm_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb52-477"><a href="#cb52-477" aria-hidden="true" tabindex="-1"></a>rf_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb52-478"><a href="#cb52-478" aria-hidden="true" tabindex="-1"></a>xgb_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(xgb_fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb52-479"><a href="#cb52-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-480"><a href="#cb52-480" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple average ensemble</span></span>
<span id="cb52-481"><a href="#cb52-481" aria-hidden="true" tabindex="-1"></a>avg_pred <span class="ot">&lt;-</span> (lm_pred <span class="sc">+</span> rf_pred <span class="sc">+</span> xgb_pred) <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb52-482"><a href="#cb52-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-483"><a href="#cb52-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Weighted average (weights could be tuned)</span></span>
<span id="cb52-484"><a href="#cb52-484" aria-hidden="true" tabindex="-1"></a>weighted_pred <span class="ot">&lt;-</span> <span class="fl">0.2</span> <span class="sc">*</span> lm_pred <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> rf_pred <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> xgb_pred</span>
<span id="cb52-485"><a href="#cb52-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-486"><a href="#cb52-486" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE for each approach</span></span>
<span id="cb52-487"><a href="#cb52-487" aria-hidden="true" tabindex="-1"></a>rmse_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-488"><a href="#cb52-488" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Linear"</span>, <span class="st">"Random Forest"</span>, <span class="st">"XGBoost"</span>, <span class="st">"Simple Average"</span>, <span class="st">"Weighted Average"</span>),</span>
<span id="cb52-489"><a href="#cb52-489" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb52-490"><a href="#cb52-490" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> lm_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-491"><a href="#cb52-491" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> rf_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-492"><a href="#cb52-492" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> xgb_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-493"><a href="#cb52-493" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> avg_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-494"><a href="#cb52-494" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> weighted_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-495"><a href="#cb52-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-496"><a href="#cb52-496" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-497"><a href="#cb52-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-498"><a href="#cb52-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="cb52-499"><a href="#cb52-499" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(rmse_results, <span class="at">digits =</span> <span class="dv">0</span>)</span>
<span id="cb52-500"><a href="#cb52-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-501"><a href="#cb52-501" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize ensemble effect</span></span>
<span id="cb52-502"><a href="#cb52-502" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rmse_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Model, RMSE), <span class="at">y =</span> RMSE, <span class="at">fill =</span> Model)) <span class="sc">+</span></span>
<span id="cb52-503"><a href="#cb52-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb52-504"><a href="#cb52-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb52-505"><a href="#cb52-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-506"><a href="#cb52-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Stacking Performance"</span>,</span>
<span id="cb52-507"><a href="#cb52-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Ensemble methods typically outperform individual models"</span>,</span>
<span id="cb52-508"><a href="#cb52-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span></span>
<span id="cb52-509"><a href="#cb52-509" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-510"><a href="#cb52-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb52-511"><a href="#cb52-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-512"><a href="#cb52-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-513"><a href="#cb52-513" aria-hidden="true" tabindex="-1"></a><span class="fu">## Voting Ensembles</span></span>
<span id="cb52-514"><a href="#cb52-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-515"><a href="#cb52-515" aria-hidden="true" tabindex="-1"></a>For classification, voting combines predictions through majority vote or averaging:</span>
<span id="cb52-516"><a href="#cb52-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-519"><a href="#cb52-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-520"><a href="#cb52-520" aria-hidden="true" tabindex="-1"></a><span class="co"># Create classification problem</span></span>
<span id="cb52-521"><a href="#cb52-521" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb52-522"><a href="#cb52-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb52-523"><a href="#cb52-523" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb52-524"><a href="#cb52-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb52-525"><a href="#cb52-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-526"><a href="#cb52-526" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb52-527"><a href="#cb52-527" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb52-528"><a href="#cb52-528" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb52-529"><a href="#cb52-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-530"><a href="#cb52-530" aria-hidden="true" tabindex="-1"></a><span class="co"># Create diverse classifiers</span></span>
<span id="cb52-531"><a href="#cb52-531" aria-hidden="true" tabindex="-1"></a>logistic_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-532"><a href="#cb52-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb52-533"><a href="#cb52-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-534"><a href="#cb52-534" aria-hidden="true" tabindex="-1"></a>tree_spec <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-535"><a href="#cb52-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-536"><a href="#cb52-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb52-537"><a href="#cb52-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-538"><a href="#cb52-538" aria-hidden="true" tabindex="-1"></a>rf_class_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-539"><a href="#cb52-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-540"><a href="#cb52-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb52-541"><a href="#cb52-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-542"><a href="#cb52-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple recipe for classification</span></span>
<span id="cb52-543"><a href="#cb52-543" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Year_Built, </span>
<span id="cb52-544"><a href="#cb52-544" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> class_train) <span class="sc">%&gt;%</span></span>
<span id="cb52-545"><a href="#cb52-545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb52-546"><a href="#cb52-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-547"><a href="#cb52-547" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit individual models</span></span>
<span id="cb52-548"><a href="#cb52-548" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-549"><a href="#cb52-549" aria-hidden="true" tabindex="-1"></a>  <span class="at">logistic =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-550"><a href="#cb52-550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-551"><a href="#cb52-551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(logistic_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-552"><a href="#cb52-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train),</span>
<span id="cb52-553"><a href="#cb52-553" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-554"><a href="#cb52-554" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-555"><a href="#cb52-555" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-556"><a href="#cb52-556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(tree_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-557"><a href="#cb52-557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train),</span>
<span id="cb52-558"><a href="#cb52-558" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-559"><a href="#cb52-559" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf =</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-560"><a href="#cb52-560" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-561"><a href="#cb52-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(rf_class_spec) <span class="sc">%&gt;%</span></span>
<span id="cb52-562"><a href="#cb52-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train)</span>
<span id="cb52-563"><a href="#cb52-563" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-564"><a href="#cb52-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-565"><a href="#cb52-565" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb52-566"><a href="#cb52-566" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(models, <span class="cf">function</span>(model) {</span>
<span id="cb52-567"><a href="#cb52-567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(model, class_test, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-568"><a href="#cb52-568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb52-569"><a href="#cb52-569" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb52-570"><a href="#cb52-570" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span></span>
<span id="cb52-571"><a href="#cb52-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste0</span>(<span class="fu">names</span>(models), <span class="st">"_prob_yes"</span>))</span>
<span id="cb52-572"><a href="#cb52-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-573"><a href="#cb52-573" aria-hidden="true" tabindex="-1"></a><span class="co"># Hard voting (majority vote)</span></span>
<span id="cb52-574"><a href="#cb52-574" aria-hidden="true" tabindex="-1"></a>hard_vote <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-575"><a href="#cb52-575" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-576"><a href="#cb52-576" aria-hidden="true" tabindex="-1"></a>    <span class="at">vote_yes =</span> <span class="fu">rowSums</span>(. <span class="sc">&gt;</span> <span class="fl">0.5</span>),</span>
<span id="cb52-577"><a href="#cb52-577" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(vote_yes <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb52-578"><a href="#cb52-578" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-579"><a href="#cb52-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-580"><a href="#cb52-580" aria-hidden="true" tabindex="-1"></a><span class="co"># Soft voting (average probabilities)</span></span>
<span id="cb52-581"><a href="#cb52-581" aria-hidden="true" tabindex="-1"></a>soft_vote <span class="ot">&lt;-</span> predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-582"><a href="#cb52-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-583"><a href="#cb52-583" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_prob =</span> <span class="fu">rowMeans</span>(.),</span>
<span id="cb52-584"><a href="#cb52-584" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(avg_prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb52-585"><a href="#cb52-585" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-586"><a href="#cb52-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-587"><a href="#cb52-587" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate voting methods</span></span>
<span id="cb52-588"><a href="#cb52-588" aria-hidden="true" tabindex="-1"></a>voting_results <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-589"><a href="#cb52-589" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"Hard Voting"</span>, <span class="st">"Soft Voting"</span>),</span>
<span id="cb52-590"><a href="#cb52-590" aria-hidden="true" tabindex="-1"></a>  <span class="at">accuracy =</span> <span class="fu">c</span>(</span>
<span id="cb52-591"><a href="#cb52-591" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(hard_vote<span class="sc">$</span>prediction <span class="sc">==</span> class_test<span class="sc">$</span>expensive),</span>
<span id="cb52-592"><a href="#cb52-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(soft_vote<span class="sc">$</span>prediction <span class="sc">==</span> class_test<span class="sc">$</span>expensive)</span>
<span id="cb52-593"><a href="#cb52-593" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-594"><a href="#cb52-594" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-595"><a href="#cb52-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-596"><a href="#cb52-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Add individual model accuracies</span></span>
<span id="cb52-597"><a href="#cb52-597" aria-hidden="true" tabindex="-1"></a>individual_acc <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(models, <span class="cf">function</span>(model) {</span>
<span id="cb52-598"><a href="#cb52-598" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, class_test)</span>
<span id="cb52-599"><a href="#cb52-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(pred<span class="sc">$</span>.pred_class <span class="sc">==</span> class_test<span class="sc">$</span>expensive)</span>
<span id="cb52-600"><a href="#cb52-600" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-601"><a href="#cb52-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-602"><a href="#cb52-602" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb52-603"><a href="#cb52-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">method =</span> <span class="fu">names</span>(individual_acc), <span class="at">accuracy =</span> individual_acc),</span>
<span id="cb52-604"><a href="#cb52-604" aria-hidden="true" tabindex="-1"></a>  voting_results</span>
<span id="cb52-605"><a href="#cb52-605" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-606"><a href="#cb52-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-607"><a href="#cb52-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb52-608"><a href="#cb52-608" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(all_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(method, accuracy), <span class="at">y =</span> accuracy)) <span class="sc">+</span></span>
<span id="cb52-609"><a href="#cb52-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"steelblue"</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"coral"</span>, <span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb52-610"><a href="#cb52-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(accuracy, <span class="dv">3</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb52-611"><a href="#cb52-611" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-612"><a href="#cb52-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Voting Ensemble Performance"</span>,</span>
<span id="cb52-613"><a href="#cb52-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Voting often outperforms individual models"</span>,</span>
<span id="cb52-614"><a href="#cb52-614" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Method"</span>,</span>
<span id="cb52-615"><a href="#cb52-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Accuracy"</span></span>
<span id="cb52-616"><a href="#cb52-616" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-617"><a href="#cb52-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb52-618"><a href="#cb52-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-619"><a href="#cb52-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-620"><a href="#cb52-620" aria-hidden="true" tabindex="-1"></a><span class="fu">## Diversity in Ensembles</span></span>
<span id="cb52-621"><a href="#cb52-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-622"><a href="#cb52-622" aria-hidden="true" tabindex="-1"></a>Ensemble success depends on model diversity:</span>
<span id="cb52-623"><a href="#cb52-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-626"><a href="#cb52-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-627"><a href="#cb52-627" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure diversity through correlation</span></span>
<span id="cb52-628"><a href="#cb52-628" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from base models</span></span>
<span id="cb52-629"><a href="#cb52-629" aria-hidden="true" tabindex="-1"></a>base_predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(models, <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb52-630"><a href="#cb52-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(models))</span>
<span id="cb52-631"><a href="#cb52-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-632"><a href="#cb52-632" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlation matrix</span></span>
<span id="cb52-633"><a href="#cb52-633" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(base_predictions)</span>
<span id="cb52-634"><a href="#cb52-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-635"><a href="#cb52-635" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb52-636"><a href="#cb52-636" aria-hidden="true" tabindex="-1"></a>corrplot<span class="sc">::</span><span class="fu">corrplot</span>(cor_matrix, <span class="at">method =</span> <span class="st">"circle"</span>, <span class="at">type =</span> <span class="st">"upper"</span>,</span>
<span id="cb52-637"><a href="#cb52-637" aria-hidden="true" tabindex="-1"></a>                   <span class="at">title =</span> <span class="st">"Model Prediction Correlations"</span>)</span>
<span id="cb52-638"><a href="#cb52-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-639"><a href="#cb52-639" aria-hidden="true" tabindex="-1"></a><span class="co"># Diversity metrics</span></span>
<span id="cb52-640"><a href="#cb52-640" aria-hidden="true" tabindex="-1"></a>diversity_metrics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-641"><a href="#cb52-641" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">"Average Pairwise Correlation"</span>, <span class="st">"Disagreement Rate"</span>),</span>
<span id="cb52-642"><a href="#cb52-642" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(</span>
<span id="cb52-643"><a href="#cb52-643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(cor_matrix[<span class="fu">upper.tri</span>(cor_matrix)]),</span>
<span id="cb52-644"><a href="#cb52-644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">apply</span>(base_predictions <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">length</span>(<span class="fu">unique</span>(x))) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb52-645"><a href="#cb52-645" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-646"><a href="#cb52-646" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-647"><a href="#cb52-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-648"><a href="#cb52-648" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(diversity_metrics, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb52-649"><a href="#cb52-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-650"><a href="#cb52-650" aria-hidden="true" tabindex="-1"></a><span class="co"># Show how diversity affects ensemble performance</span></span>
<span id="cb52-651"><a href="#cb52-651" aria-hidden="true" tabindex="-1"></a><span class="co"># Create models with varying diversity</span></span>
<span id="cb52-652"><a href="#cb52-652" aria-hidden="true" tabindex="-1"></a>diverse_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-653"><a href="#cb52-653" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Similar models (low diversity)</span></span>
<span id="cb52-654"><a href="#cb52-654" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf1 =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">mtry =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-655"><a href="#cb52-655" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-656"><a href="#cb52-656" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>),</span>
<span id="cb52-657"><a href="#cb52-657" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-658"><a href="#cb52-658" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf2 =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">mtry =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-659"><a href="#cb52-659" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-660"><a href="#cb52-660" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>),</span>
<span id="cb52-661"><a href="#cb52-661" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-662"><a href="#cb52-662" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Different model types (high diversity)</span></span>
<span id="cb52-663"><a href="#cb52-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">linear =</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-664"><a href="#cb52-664" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"glm"</span>),</span>
<span id="cb52-665"><a href="#cb52-665" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-666"><a href="#cb52-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-667"><a href="#cb52-667" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-668"><a href="#cb52-668" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb52-669"><a href="#cb52-669" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-670"><a href="#cb52-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-671"><a href="#cb52-671" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and evaluate</span></span>
<span id="cb52-672"><a href="#cb52-672" aria-hidden="true" tabindex="-1"></a>diverse_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(diverse_models, <span class="cf">function</span>(model) {</span>
<span id="cb52-673"><a href="#cb52-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-674"><a href="#cb52-674" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-675"><a href="#cb52-675" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb52-676"><a href="#cb52-676" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(class_train)</span>
<span id="cb52-677"><a href="#cb52-677" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-678"><a href="#cb52-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-679"><a href="#cb52-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare ensemble of similar vs diverse models</span></span>
<span id="cb52-680"><a href="#cb52-680" aria-hidden="true" tabindex="-1"></a>similar_ensemble <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(diverse_fits[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], </span>
<span id="cb52-681"><a href="#cb52-681" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb52-682"><a href="#cb52-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowMeans</span>()</span>
<span id="cb52-683"><a href="#cb52-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-684"><a href="#cb52-684" aria-hidden="true" tabindex="-1"></a>diverse_ensemble <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(diverse_fits[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>], </span>
<span id="cb52-685"><a href="#cb52-685" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">~</span> <span class="fu">predict</span>(., class_test, <span class="at">type =</span> <span class="st">"prob"</span>)<span class="sc">$</span>.pred_yes) <span class="sc">%&gt;%</span></span>
<span id="cb52-686"><a href="#cb52-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowMeans</span>()</span>
<span id="cb52-687"><a href="#cb52-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-688"><a href="#cb52-688" aria-hidden="true" tabindex="-1"></a>ensemble_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-689"><a href="#cb52-689" aria-hidden="true" tabindex="-1"></a>  <span class="at">ensemble_type =</span> <span class="fu">c</span>(<span class="st">"Similar Models"</span>, <span class="st">"Diverse Models"</span>),</span>
<span id="cb52-690"><a href="#cb52-690" aria-hidden="true" tabindex="-1"></a>  <span class="at">accuracy =</span> <span class="fu">c</span>(</span>
<span id="cb52-691"><a href="#cb52-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((similar_ensemble <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">==</span> (class_test<span class="sc">$</span>expensive <span class="sc">==</span> <span class="st">"yes"</span>)),</span>
<span id="cb52-692"><a href="#cb52-692" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>((diverse_ensemble <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">==</span> (class_test<span class="sc">$</span>expensive <span class="sc">==</span> <span class="st">"yes"</span>))</span>
<span id="cb52-693"><a href="#cb52-693" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-694"><a href="#cb52-694" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-695"><a href="#cb52-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-696"><a href="#cb52-696" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ensemble_comparison, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb52-697"><a href="#cb52-697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-698"><a href="#cb52-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-699"><a href="#cb52-699" aria-hidden="true" tabindex="-1"></a><span class="fu">## Advanced Ensemble Techniques</span></span>
<span id="cb52-700"><a href="#cb52-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-701"><a href="#cb52-701" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dynamic Ensemble Selection</span></span>
<span id="cb52-702"><a href="#cb52-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-703"><a href="#cb52-703" aria-hidden="true" tabindex="-1"></a>Choose different models for different regions of the feature space:</span>
<span id="cb52-704"><a href="#cb52-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-707"><a href="#cb52-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-708"><a href="#cb52-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate region-based ensemble</span></span>
<span id="cb52-709"><a href="#cb52-709" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 2D problem for visualization</span></span>
<span id="cb52-710"><a href="#cb52-710" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb52-711"><a href="#cb52-711" aria-hidden="true" tabindex="-1"></a>region_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-712"><a href="#cb52-712" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>),</span>
<span id="cb52-713"><a href="#cb52-713" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2 =</span> <span class="fu">runif</span>(<span class="dv">500</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb52-714"><a href="#cb52-714" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb52-715"><a href="#cb52-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-716"><a href="#cb52-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">region =</span> <span class="fu">case_when</span>(</span>
<span id="cb52-717"><a href="#cb52-717" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"A"</span>,</span>
<span id="cb52-718"><a href="#cb52-718" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"B"</span>,</span>
<span id="cb52-719"><a href="#cb52-719" aria-hidden="true" tabindex="-1"></a>      x1 <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> x2 <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"C"</span>,</span>
<span id="cb52-720"><a href="#cb52-720" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"D"</span></span>
<span id="cb52-721"><a href="#cb52-721" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb52-722"><a href="#cb52-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb52-723"><a href="#cb52-723" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"A"</span> <span class="sc">~</span> <span class="dv">2</span> <span class="sc">*</span> x1 <span class="sc">+</span> x2,        <span class="co"># Linear in region A</span></span>
<span id="cb52-724"><a href="#cb52-724" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"B"</span> <span class="sc">~</span> x1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> x2,          <span class="co"># Quadratic in region B</span></span>
<span id="cb52-725"><a href="#cb52-725" aria-hidden="true" tabindex="-1"></a>      region <span class="sc">==</span> <span class="st">"C"</span> <span class="sc">~</span> <span class="fu">sin</span>(<span class="dv">2</span> <span class="sc">*</span> x1) <span class="sc">+</span> x2,   <span class="co"># Sinusoidal in region C</span></span>
<span id="cb52-726"><a href="#cb52-726" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">exp</span>(<span class="fl">0.5</span> <span class="sc">*</span> x1) <span class="sc">+</span> x2           <span class="co"># Exponential in region D</span></span>
<span id="cb52-727"><a href="#cb52-727" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">500</span>, <span class="at">sd =</span> <span class="fl">0.3</span>)</span>
<span id="cb52-728"><a href="#cb52-728" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-729"><a href="#cb52-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-730"><a href="#cb52-730" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize regions</span></span>
<span id="cb52-731"><a href="#cb52-731" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(region_data, <span class="fu">aes</span>(<span class="at">x =</span> x1, <span class="at">y =</span> x2, <span class="at">color =</span> y)) <span class="sc">+</span></span>
<span id="cb52-732"><a href="#cb52-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-733"><a href="#cb52-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb52-734"><a href="#cb52-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb52-735"><a href="#cb52-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb52-736"><a href="#cb52-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb52-737"><a href="#cb52-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Different Patterns in Different Regions"</span>,</span>
<span id="cb52-738"><a href="#cb52-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dynamic selection can use best model for each region"</span></span>
<span id="cb52-739"><a href="#cb52-739" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb52-740"><a href="#cb52-740" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb52-741"><a href="#cb52-741" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-742"><a href="#cb52-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-743"><a href="#cb52-743" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cascade Ensembles</span></span>
<span id="cb52-744"><a href="#cb52-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-745"><a href="#cb52-745" aria-hidden="true" tabindex="-1"></a>Use simple models for easy cases, complex models for hard cases:</span>
<span id="cb52-746"><a href="#cb52-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-749"><a href="#cb52-749" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-750"><a href="#cb52-750" aria-hidden="true" tabindex="-1"></a><span class="co"># Demonstrate cascade concept</span></span>
<span id="cb52-751"><a href="#cb52-751" aria-hidden="true" tabindex="-1"></a><span class="co"># First tier: Simple, fast model</span></span>
<span id="cb52-752"><a href="#cb52-752" aria-hidden="true" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-753"><a href="#cb52-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb52-754"><a href="#cb52-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-755"><a href="#cb52-755" aria-hidden="true" tabindex="-1"></a>simple_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-756"><a href="#cb52-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(simple_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-757"><a href="#cb52-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(simple_model) <span class="sc">%&gt;%</span></span>
<span id="cb52-758"><a href="#cb52-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-759"><a href="#cb52-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-760"><a href="#cb52-760" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions and residuals</span></span>
<span id="cb52-761"><a href="#cb52-761" aria-hidden="true" tabindex="-1"></a>simple_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(simple_fit, ames_train)</span>
<span id="cb52-762"><a href="#cb52-762" aria-hidden="true" tabindex="-1"></a>train_with_residuals <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb52-763"><a href="#cb52-763" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-764"><a href="#cb52-764" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple_pred =</span> simple_pred<span class="sc">$</span>.pred,</span>
<span id="cb52-765"><a href="#cb52-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> simple_pred,</span>
<span id="cb52-766"><a href="#cb52-766" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_difficult =</span> <span class="fu">abs</span>(residual) <span class="sc">&gt;</span> <span class="fu">quantile</span>(<span class="fu">abs</span>(residual), <span class="fl">0.75</span>)</span>
<span id="cb52-767"><a href="#cb52-767" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-768"><a href="#cb52-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-769"><a href="#cb52-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Second tier: Complex model for difficult cases</span></span>
<span id="cb52-770"><a href="#cb52-770" aria-hidden="true" tabindex="-1"></a>complex_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">200</span>, <span class="at">tree_depth =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-771"><a href="#cb52-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-772"><a href="#cb52-772" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-773"><a href="#cb52-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-774"><a href="#cb52-774" aria-hidden="true" tabindex="-1"></a><span class="co"># Train on difficult cases</span></span>
<span id="cb52-775"><a href="#cb52-775" aria-hidden="true" tabindex="-1"></a>difficult_cases <span class="ot">&lt;-</span> train_with_residuals <span class="sc">%&gt;%</span></span>
<span id="cb52-776"><a href="#cb52-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(is_difficult)</span>
<span id="cb52-777"><a href="#cb52-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-778"><a href="#cb52-778" aria-hidden="true" tabindex="-1"></a>complex_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(residual <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb52-779"><a href="#cb52-779" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> difficult_cases)</span>
<span id="cb52-780"><a href="#cb52-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-781"><a href="#cb52-781" aria-hidden="true" tabindex="-1"></a>complex_fit <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-782"><a href="#cb52-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(complex_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-783"><a href="#cb52-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(complex_model) <span class="sc">%&gt;%</span></span>
<span id="cb52-784"><a href="#cb52-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(difficult_cases)</span>
<span id="cb52-785"><a href="#cb52-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-786"><a href="#cb52-786" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cascade ensemble:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-787"><a href="#cb52-787" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Simple model handles"</span>, <span class="fu">sum</span>(<span class="sc">!</span>train_with_residuals<span class="sc">$</span>is_difficult), <span class="st">"cases</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-788"><a href="#cb52-788" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"- Complex model handles"</span>, <span class="fu">sum</span>(train_with_residuals<span class="sc">$</span>is_difficult), <span class="st">"difficult cases</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-789"><a href="#cb52-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-790"><a href="#cb52-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-791"><a href="#cb52-791" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Practices for Ensembles</span></span>
<span id="cb52-792"><a href="#cb52-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-793"><a href="#cb52-793" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Ensure Model Diversity</span></span>
<span id="cb52-794"><a href="#cb52-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-797"><a href="#cb52-797" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-798"><a href="#cb52-798" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategies for diversity</span></span>
<span id="cb52-799"><a href="#cb52-799" aria-hidden="true" tabindex="-1"></a>diversity_strategies <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-800"><a href="#cb52-800" aria-hidden="true" tabindex="-1"></a>  <span class="at">Strategy =</span> <span class="fu">c</span>(</span>
<span id="cb52-801"><a href="#cb52-801" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different algorithms"</span>,</span>
<span id="cb52-802"><a href="#cb52-802" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different hyperparameters"</span>,</span>
<span id="cb52-803"><a href="#cb52-803" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different features"</span>,</span>
<span id="cb52-804"><a href="#cb52-804" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different training samples"</span>,</span>
<span id="cb52-805"><a href="#cb52-805" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different target transformations"</span></span>
<span id="cb52-806"><a href="#cb52-806" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-807"><a href="#cb52-807" aria-hidden="true" tabindex="-1"></a>  <span class="at">Example =</span> <span class="fu">c</span>(</span>
<span id="cb52-808"><a href="#cb52-808" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Linear + Tree + Neural Network"</span>,</span>
<span id="cb52-809"><a href="#cb52-809" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Shallow trees + Deep trees"</span>,</span>
<span id="cb52-810"><a href="#cb52-810" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Subset 1 features + Subset 2 features"</span>,</span>
<span id="cb52-811"><a href="#cb52-811" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bootstrap + Stratified + Random"</span>,</span>
<span id="cb52-812"><a href="#cb52-812" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Log(y) + sqrt(y) + y"</span></span>
<span id="cb52-813"><a href="#cb52-813" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-814"><a href="#cb52-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">Benefit =</span> <span class="fu">c</span>(</span>
<span id="cb52-815"><a href="#cb52-815" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Captures different patterns"</span>,</span>
<span id="cb52-816"><a href="#cb52-816" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Varies complexity"</span>,</span>
<span id="cb52-817"><a href="#cb52-817" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different perspectives"</span>,</span>
<span id="cb52-818"><a href="#cb52-818" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reduces correlation"</span>,</span>
<span id="cb52-819"><a href="#cb52-819" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different error distributions"</span></span>
<span id="cb52-820"><a href="#cb52-820" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-821"><a href="#cb52-821" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-822"><a href="#cb52-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-823"><a href="#cb52-823" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(diversity_strategies)</span>
<span id="cb52-824"><a href="#cb52-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-825"><a href="#cb52-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-826"><a href="#cb52-826" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Choose Appropriate Ensemble Method</span></span>
<span id="cb52-827"><a href="#cb52-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-830"><a href="#cb52-830" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-831"><a href="#cb52-831" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision guide</span></span>
<span id="cb52-832"><a href="#cb52-832" aria-hidden="true" tabindex="-1"></a>ensemble_guide <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-833"><a href="#cb52-833" aria-hidden="true" tabindex="-1"></a>  <span class="at">Scenario =</span> <span class="fu">c</span>(</span>
<span id="cb52-834"><a href="#cb52-834" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High-variance base models"</span>,</span>
<span id="cb52-835"><a href="#cb52-835" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Need interpretability"</span>,</span>
<span id="cb52-836"><a href="#cb52-836" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Limited computational budget"</span>,</span>
<span id="cb52-837"><a href="#cb52-837" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Maximizing performance"</span>,</span>
<span id="cb52-838"><a href="#cb52-838" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imbalanced classes"</span>,</span>
<span id="cb52-839"><a href="#cb52-839" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Different expertise regions"</span></span>
<span id="cb52-840"><a href="#cb52-840" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb52-841"><a href="#cb52-841" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Recommended Method</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb52-842"><a href="#cb52-842" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bagging or Random Forest"</span>,</span>
<span id="cb52-843"><a href="#cb52-843" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple voting or linear stacking"</span>,</span>
<span id="cb52-844"><a href="#cb52-844" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Voting ensemble"</span>,</span>
<span id="cb52-845"><a href="#cb52-845" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gradient boosting or stacking"</span>,</span>
<span id="cb52-846"><a href="#cb52-846" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Balanced bagging or cost-sensitive boosting"</span>,</span>
<span id="cb52-847"><a href="#cb52-847" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dynamic selection"</span></span>
<span id="cb52-848"><a href="#cb52-848" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-849"><a href="#cb52-849" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-850"><a href="#cb52-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-851"><a href="#cb52-851" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ensemble_guide)</span>
<span id="cb52-852"><a href="#cb52-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-853"><a href="#cb52-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-854"><a href="#cb52-854" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb52-855"><a href="#cb52-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-856"><a href="#cb52-856" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Build a Custom Ensemble</span></span>
<span id="cb52-857"><a href="#cb52-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-858"><a href="#cb52-858" aria-hidden="true" tabindex="-1"></a>Create your own ensemble combining different approaches:</span>
<span id="cb52-859"><a href="#cb52-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-862"><a href="#cb52-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-863"><a href="#cb52-863" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-864"><a href="#cb52-864" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom ensemble for Ames housing</span></span>
<span id="cb52-865"><a href="#cb52-865" aria-hidden="true" tabindex="-1"></a>custom_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb52-866"><a href="#cb52-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(Street, Utilities, Condition_2, Roof_Matl, Heating, Pool_QC,</span>
<span id="cb52-867"><a href="#cb52-867" aria-hidden="true" tabindex="-1"></a>          Misc_Feature, Pool_Area, Longitude, Latitude) <span class="sc">%&gt;%</span></span>
<span id="cb52-868"><a href="#cb52-868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb52-869"><a href="#cb52-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb52-870"><a href="#cb52-870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb52-871"><a href="#cb52-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-872"><a href="#cb52-872" aria-hidden="true" tabindex="-1"></a><span class="co"># Base models</span></span>
<span id="cb52-873"><a href="#cb52-873" aria-hidden="true" tabindex="-1"></a>base_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-874"><a href="#cb52-874" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Regularized regression</span></span>
<span id="cb52-875"><a href="#cb52-875" aria-hidden="true" tabindex="-1"></a>  <span class="at">elastic =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-876"><a href="#cb52-876" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb52-877"><a href="#cb52-877" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-878"><a href="#cb52-878" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Tree-based</span></span>
<span id="cb52-879"><a href="#cb52-879" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf =</span> <span class="fu">rand_forest</span>(<span class="at">trees =</span> <span class="dv">200</span>, <span class="at">mtry =</span> <span class="dv">10</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-880"><a href="#cb52-880" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-881"><a href="#cb52-881" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>),</span>
<span id="cb52-882"><a href="#cb52-882" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-883"><a href="#cb52-883" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Boosting</span></span>
<span id="cb52-884"><a href="#cb52-884" aria-hidden="true" tabindex="-1"></a>  <span class="at">xgb =</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">100</span>, <span class="at">tree_depth =</span> <span class="dv">5</span>, <span class="at">learn_rate =</span> <span class="fl">0.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-885"><a href="#cb52-885" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-886"><a href="#cb52-886" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>),</span>
<span id="cb52-887"><a href="#cb52-887" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-888"><a href="#cb52-888" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Local model</span></span>
<span id="cb52-889"><a href="#cb52-889" aria-hidden="true" tabindex="-1"></a>  <span class="at">knn =</span> <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-890"><a href="#cb52-890" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-891"><a href="#cb52-891" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb52-892"><a href="#cb52-892" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-893"><a href="#cb52-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-894"><a href="#cb52-894" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit all base models</span></span>
<span id="cb52-895"><a href="#cb52-895" aria-hidden="true" tabindex="-1"></a>base_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(base_models, <span class="cf">function</span>(model) {</span>
<span id="cb52-896"><a href="#cb52-896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-897"><a href="#cb52-897" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(custom_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-898"><a href="#cb52-898" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb52-899"><a href="#cb52-899" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(ames_train)</span>
<span id="cb52-900"><a href="#cb52-900" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-901"><a href="#cb52-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-902"><a href="#cb52-902" aria-hidden="true" tabindex="-1"></a><span class="co"># Get out-of-sample predictions using cross-validation</span></span>
<span id="cb52-903"><a href="#cb52-903" aria-hidden="true" tabindex="-1"></a><span class="co"># (In practice, use proper validation set)</span></span>
<span id="cb52-904"><a href="#cb52-904" aria-hidden="true" tabindex="-1"></a>val_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_train, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb52-905"><a href="#cb52-905" aria-hidden="true" tabindex="-1"></a>val_train <span class="ot">&lt;-</span> <span class="fu">training</span>(val_split)</span>
<span id="cb52-906"><a href="#cb52-906" aria-hidden="true" tabindex="-1"></a>val_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(val_split)</span>
<span id="cb52-907"><a href="#cb52-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-908"><a href="#cb52-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Refit on validation training</span></span>
<span id="cb52-909"><a href="#cb52-909" aria-hidden="true" tabindex="-1"></a>val_fits <span class="ot">&lt;-</span> <span class="fu">map</span>(base_models, <span class="cf">function</span>(model) {</span>
<span id="cb52-910"><a href="#cb52-910" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb52-911"><a href="#cb52-911" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(custom_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb52-912"><a href="#cb52-912" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb52-913"><a href="#cb52-913" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fit</span>(val_train)</span>
<span id="cb52-914"><a href="#cb52-914" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-915"><a href="#cb52-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-916"><a href="#cb52-916" aria-hidden="true" tabindex="-1"></a><span class="co"># Get validation predictions for stacking</span></span>
<span id="cb52-917"><a href="#cb52-917" aria-hidden="true" tabindex="-1"></a>val_predictions <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(val_fits, <span class="sc">~</span> <span class="fu">predict</span>(., val_test)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb52-918"><a href="#cb52-918" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb52-919"><a href="#cb52-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-920"><a href="#cb52-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Train meta-learner</span></span>
<span id="cb52-921"><a href="#cb52-921" aria-hidden="true" tabindex="-1"></a>meta_data <span class="ot">&lt;-</span> val_predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-922"><a href="#cb52-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">target =</span> val_test<span class="sc">$</span>Sale_Price)</span>
<span id="cb52-923"><a href="#cb52-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-924"><a href="#cb52-924" aria-hidden="true" tabindex="-1"></a>meta_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(target <span class="sc">~</span> ., <span class="at">data =</span> meta_data)</span>
<span id="cb52-925"><a href="#cb52-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-926"><a href="#cb52-926" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to make ensemble predictions</span></span>
<span id="cb52-927"><a href="#cb52-927" aria-hidden="true" tabindex="-1"></a>ensemble_predict <span class="ot">&lt;-</span> <span class="cf">function</span>(new_data) {</span>
<span id="cb52-928"><a href="#cb52-928" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get base predictions</span></span>
<span id="cb52-929"><a href="#cb52-929" aria-hidden="true" tabindex="-1"></a>  base_preds <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(base_fits, <span class="sc">~</span> <span class="fu">predict</span>(., new_data)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb52-930"><a href="#cb52-930" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb52-931"><a href="#cb52-931" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-932"><a href="#cb52-932" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply meta-model</span></span>
<span id="cb52-933"><a href="#cb52-933" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(meta_model, base_preds)</span>
<span id="cb52-934"><a href="#cb52-934" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-935"><a href="#cb52-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-936"><a href="#cb52-936" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate custom ensemble</span></span>
<span id="cb52-937"><a href="#cb52-937" aria-hidden="true" tabindex="-1"></a>ensemble_pred <span class="ot">&lt;-</span> <span class="fu">ensemble_predict</span>(ames_test)</span>
<span id="cb52-938"><a href="#cb52-938" aria-hidden="true" tabindex="-1"></a>ensemble_rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> ensemble_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-939"><a href="#cb52-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-940"><a href="#cb52-940" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare with individual models</span></span>
<span id="cb52-941"><a href="#cb52-941" aria-hidden="true" tabindex="-1"></a>individual_rmse <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(base_fits, <span class="cf">function</span>(fit) {</span>
<span id="cb52-942"><a href="#cb52-942" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, ames_test)<span class="sc">$</span>.pred</span>
<span id="cb52-943"><a href="#cb52-943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-944"><a href="#cb52-944" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb52-945"><a href="#cb52-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-946"><a href="#cb52-946" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">c</span>(individual_rmse, <span class="at">ensemble =</span> ensemble_rmse)</span>
<span id="cb52-947"><a href="#cb52-947" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">sort</span>(results)</span>
<span id="cb52-948"><a href="#cb52-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-949"><a href="#cb52-949" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(results, <span class="at">main =</span> <span class="st">"Custom Ensemble Performance"</span>,</span>
<span id="cb52-950"><a href="#cb52-950" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"RMSE"</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"steelblue"</span>, <span class="fu">length</span>(results)<span class="sc">-</span><span class="dv">1</span>), <span class="st">"coral"</span>))</span>
<span id="cb52-951"><a href="#cb52-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-952"><a href="#cb52-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-953"><a href="#cb52-953" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Optimize Ensemble Weights</span></span>
<span id="cb52-954"><a href="#cb52-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-955"><a href="#cb52-955" aria-hidden="true" tabindex="-1"></a>Find optimal weights for combining models:</span>
<span id="cb52-956"><a href="#cb52-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-959"><a href="#cb52-959" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-960"><a href="#cb52-960" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-961"><a href="#cb52-961" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions from each model</span></span>
<span id="cb52-962"><a href="#cb52-962" aria-hidden="true" tabindex="-1"></a>test_preds <span class="ot">&lt;-</span> <span class="fu">map_dfc</span>(base_fits, <span class="sc">~</span> <span class="fu">predict</span>(., ames_test)<span class="sc">$</span>.pred) <span class="sc">%&gt;%</span></span>
<span id="cb52-963"><a href="#cb52-963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">names</span>(base_models))</span>
<span id="cb52-964"><a href="#cb52-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-965"><a href="#cb52-965" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimization function</span></span>
<span id="cb52-966"><a href="#cb52-966" aria-hidden="true" tabindex="-1"></a>optimize_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(weights, predictions, target) {</span>
<span id="cb52-967"><a href="#cb52-967" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize weights</span></span>
<span id="cb52-968"><a href="#cb52-968" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> weights <span class="sc">/</span> <span class="fu">sum</span>(weights)</span>
<span id="cb52-969"><a href="#cb52-969" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-970"><a href="#cb52-970" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Weighted average</span></span>
<span id="cb52-971"><a href="#cb52-971" aria-hidden="true" tabindex="-1"></a>  ensemble_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(predictions) <span class="sc">%*%</span> weights</span>
<span id="cb52-972"><a href="#cb52-972" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-973"><a href="#cb52-973" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return RMSE</span></span>
<span id="cb52-974"><a href="#cb52-974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((target <span class="sc">-</span> ensemble_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-975"><a href="#cb52-975" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-976"><a href="#cb52-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-977"><a href="#cb52-977" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial equal weights</span></span>
<span id="cb52-978"><a href="#cb52-978" aria-hidden="true" tabindex="-1"></a>n_models <span class="ot">&lt;-</span> <span class="fu">length</span>(base_models)</span>
<span id="cb52-979"><a href="#cb52-979" aria-hidden="true" tabindex="-1"></a>initial_weights <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">/</span>n_models, n_models)</span>
<span id="cb52-980"><a href="#cb52-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-981"><a href="#cb52-981" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb52-982"><a href="#cb52-982" aria-hidden="true" tabindex="-1"></a>opt_result <span class="ot">&lt;-</span> <span class="fu">optim</span>(</span>
<span id="cb52-983"><a href="#cb52-983" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> initial_weights,</span>
<span id="cb52-984"><a href="#cb52-984" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> optimize_weights,</span>
<span id="cb52-985"><a href="#cb52-985" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictions =</span> test_preds,</span>
<span id="cb52-986"><a href="#cb52-986" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> ames_test<span class="sc">$</span>Sale_Price,</span>
<span id="cb52-987"><a href="#cb52-987" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"L-BFGS-B"</span>,</span>
<span id="cb52-988"><a href="#cb52-988" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n_models),</span>
<span id="cb52-989"><a href="#cb52-989" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n_models)</span>
<span id="cb52-990"><a href="#cb52-990" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-991"><a href="#cb52-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-992"><a href="#cb52-992" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimal weights</span></span>
<span id="cb52-993"><a href="#cb52-993" aria-hidden="true" tabindex="-1"></a>optimal_weights <span class="ot">&lt;-</span> opt_result<span class="sc">$</span>par <span class="sc">/</span> <span class="fu">sum</span>(opt_result<span class="sc">$</span>par)</span>
<span id="cb52-994"><a href="#cb52-994" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(optimal_weights) <span class="ot">&lt;-</span> <span class="fu">names</span>(base_models)</span>
<span id="cb52-995"><a href="#cb52-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-996"><a href="#cb52-996" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare equal vs optimal weights</span></span>
<span id="cb52-997"><a href="#cb52-997" aria-hidden="true" tabindex="-1"></a>equal_pred <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(test_preds)</span>
<span id="cb52-998"><a href="#cb52-998" aria-hidden="true" tabindex="-1"></a>optimal_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_preds) <span class="sc">%*%</span> optimal_weights</span>
<span id="cb52-999"><a href="#cb52-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1000"><a href="#cb52-1000" aria-hidden="true" tabindex="-1"></a>weight_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb52-1001"><a href="#cb52-1001" aria-hidden="true" tabindex="-1"></a>  <span class="at">Method =</span> <span class="fu">c</span>(<span class="st">"Equal Weights"</span>, <span class="st">"Optimal Weights"</span>),</span>
<span id="cb52-1002"><a href="#cb52-1002" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(</span>
<span id="cb52-1003"><a href="#cb52-1003" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> equal_pred)<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb52-1004"><a href="#cb52-1004" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((ames_test<span class="sc">$</span>Sale_Price <span class="sc">-</span> optimal_pred)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-1005"><a href="#cb52-1005" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-1006"><a href="#cb52-1006" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-1007"><a href="#cb52-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1008"><a href="#cb52-1008" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(weight_comparison, <span class="at">digits =</span> <span class="dv">3</span>)</span>
<span id="cb52-1009"><a href="#cb52-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1010"><a href="#cb52-1010" aria-hidden="true" tabindex="-1"></a><span class="co"># Show optimal weights</span></span>
<span id="cb52-1011"><a href="#cb52-1011" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(optimal_weights, <span class="at">main =</span> <span class="st">"Optimal Ensemble Weights"</span>,</span>
<span id="cb52-1012"><a href="#cb52-1012" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Weight"</span>, <span class="at">col =</span> <span class="st">"steelblue"</span>)</span>
<span id="cb52-1013"><a href="#cb52-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1014"><a href="#cb52-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1015"><a href="#cb52-1015" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Implement Boosting from Scratch</span></span>
<span id="cb52-1016"><a href="#cb52-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1017"><a href="#cb52-1017" aria-hidden="true" tabindex="-1"></a>Understand boosting by implementing a simple version:</span>
<span id="cb52-1018"><a href="#cb52-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1021"><a href="#cb52-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-1022"><a href="#cb52-1022" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb52-1023"><a href="#cb52-1023" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple boosting implementation</span></span>
<span id="cb52-1024"><a href="#cb52-1024" aria-hidden="true" tabindex="-1"></a>simple_boosting <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, <span class="at">n_iterations =</span> <span class="dv">10</span>, <span class="at">learning_rate =</span> <span class="fl">0.1</span>) {</span>
<span id="cb52-1025"><a href="#cb52-1025" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb52-1026"><a href="#cb52-1026" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-1027"><a href="#cb52-1027" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize with mean</span></span>
<span id="cb52-1028"><a href="#cb52-1028" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">mean</span>(y), n)</span>
<span id="cb52-1029"><a href="#cb52-1029" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb52-1030"><a href="#cb52-1030" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-1031"><a href="#cb52-1031" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_iterations) {</span>
<span id="cb52-1032"><a href="#cb52-1032" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals</span></span>
<span id="cb52-1033"><a href="#cb52-1033" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">&lt;-</span> y <span class="sc">-</span> predictions</span>
<span id="cb52-1034"><a href="#cb52-1034" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1035"><a href="#cb52-1035" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit a simple model to residuals (using a decision stump)</span></span>
<span id="cb52-1036"><a href="#cb52-1036" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For simplicity, we'll use a linear model here</span></span>
<span id="cb52-1037"><a href="#cb52-1037" aria-hidden="true" tabindex="-1"></a>    model_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x, <span class="at">residual =</span> residuals)</span>
<span id="cb52-1038"><a href="#cb52-1038" aria-hidden="true" tabindex="-1"></a>    weak_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(residual <span class="sc">~</span> x, <span class="at">data =</span> model_data)</span>
<span id="cb52-1039"><a href="#cb52-1039" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1040"><a href="#cb52-1040" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store model</span></span>
<span id="cb52-1041"><a href="#cb52-1041" aria-hidden="true" tabindex="-1"></a>    models[[i]] <span class="ot">&lt;-</span> weak_model</span>
<span id="cb52-1042"><a href="#cb52-1042" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1043"><a href="#cb52-1043" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update predictions</span></span>
<span id="cb52-1044"><a href="#cb52-1044" aria-hidden="true" tabindex="-1"></a>    update <span class="ot">&lt;-</span> <span class="fu">predict</span>(weak_model, model_data)</span>
<span id="cb52-1045"><a href="#cb52-1045" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> predictions <span class="sc">+</span> learning_rate <span class="sc">*</span> update</span>
<span id="cb52-1046"><a href="#cb52-1046" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1047"><a href="#cb52-1047" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate current error</span></span>
<span id="cb52-1048"><a href="#cb52-1048" aria-hidden="true" tabindex="-1"></a>    current_rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((y <span class="sc">-</span> predictions)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb52-1049"><a href="#cb52-1049" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb52-1050"><a href="#cb52-1050" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Iteration"</span>, i, <span class="st">"- RMSE:"</span>, current_rmse, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-1051"><a href="#cb52-1051" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-1052"><a href="#cb52-1052" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-1053"><a href="#cb52-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">models =</span> models, <span class="at">final_predictions =</span> predictions,</span>
<span id="cb52-1054"><a href="#cb52-1054" aria-hidden="true" tabindex="-1"></a>              <span class="at">learning_rate =</span> learning_rate))</span>
<span id="cb52-1055"><a href="#cb52-1055" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-1056"><a href="#cb52-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1057"><a href="#cb52-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># Test on simple data</span></span>
<span id="cb52-1058"><a href="#cb52-1058" aria-hidden="true" tabindex="-1"></a>test_x <span class="ot">&lt;-</span> ames_train<span class="sc">$</span>Gr_Liv_Area[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb52-1059"><a href="#cb52-1059" aria-hidden="true" tabindex="-1"></a>test_y <span class="ot">&lt;-</span> ames_train<span class="sc">$</span>Sale_Price[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>]</span>
<span id="cb52-1060"><a href="#cb52-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1061"><a href="#cb52-1061" aria-hidden="true" tabindex="-1"></a>boost_result <span class="ot">&lt;-</span> <span class="fu">simple_boosting</span>(test_x, test_y, <span class="at">n_iterations =</span> <span class="dv">10</span>)</span>
<span id="cb52-1062"><a href="#cb52-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1063"><a href="#cb52-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize boosting progress</span></span>
<span id="cb52-1064"><a href="#cb52-1064" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(test_x, test_y, <span class="at">main =</span> <span class="st">"Simple Boosting Results"</span>,</span>
<span id="cb52-1065"><a href="#cb52-1065" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Gr_Liv_Area"</span>, <span class="at">ylab =</span> <span class="st">"Sale_Price"</span>)</span>
<span id="cb52-1066"><a href="#cb52-1066" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(test_x, boost_result<span class="sc">$</span>final_predictions, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">16</span>)</span>
<span id="cb52-1067"><a href="#cb52-1067" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Actual"</span>, <span class="st">"Predicted"</span>), </span>
<span id="cb52-1068"><a href="#cb52-1068" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>), <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">16</span>))</span>
<span id="cb52-1069"><a href="#cb52-1069" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-1070"><a href="#cb52-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1071"><a href="#cb52-1071" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb52-1072"><a href="#cb52-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1073"><a href="#cb52-1073" aria-hidden="true" tabindex="-1"></a>In this comprehensive chapter, you've mastered:</span>
<span id="cb52-1074"><a href="#cb52-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1075"><a href="#cb52-1075" aria-hidden="true" tabindex="-1"></a>✅ **Ensemble fundamentals**</span>
<span id="cb52-1076"><a href="#cb52-1076" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Why ensembles work mathematically</span>
<span id="cb52-1077"><a href="#cb52-1077" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Bias-variance decomposition</span>
<span id="cb52-1078"><a href="#cb52-1078" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>The importance of diversity</span>
<span id="cb52-1079"><a href="#cb52-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1080"><a href="#cb52-1080" aria-hidden="true" tabindex="-1"></a>✅ **Bagging methods**</span>
<span id="cb52-1081"><a href="#cb52-1081" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Bootstrap aggregating</span>
<span id="cb52-1082"><a href="#cb52-1082" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Random forests</span>
<span id="cb52-1083"><a href="#cb52-1083" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Out-of-bag error</span>
<span id="cb52-1084"><a href="#cb52-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1085"><a href="#cb52-1085" aria-hidden="true" tabindex="-1"></a>✅ **Boosting algorithms**</span>
<span id="cb52-1086"><a href="#cb52-1086" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Sequential learning</span>
<span id="cb52-1087"><a href="#cb52-1087" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>AdaBoost and gradient boosting</span>
<span id="cb52-1088"><a href="#cb52-1088" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>XGBoost implementation</span>
<span id="cb52-1089"><a href="#cb52-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1090"><a href="#cb52-1090" aria-hidden="true" tabindex="-1"></a>✅ **Stacking and blending**</span>
<span id="cb52-1091"><a href="#cb52-1091" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Meta-learning approaches</span>
<span id="cb52-1092"><a href="#cb52-1092" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Cross-validation for stacking</span>
<span id="cb52-1093"><a href="#cb52-1093" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Optimal weight finding</span>
<span id="cb52-1094"><a href="#cb52-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1095"><a href="#cb52-1095" aria-hidden="true" tabindex="-1"></a>✅ **Advanced techniques**</span>
<span id="cb52-1096"><a href="#cb52-1096" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Dynamic selection</span>
<span id="cb52-1097"><a href="#cb52-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Cascade ensembles</span>
<span id="cb52-1098"><a href="#cb52-1098" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Custom ensemble design</span>
<span id="cb52-1099"><a href="#cb52-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1100"><a href="#cb52-1100" aria-hidden="true" tabindex="-1"></a>Key takeaways:</span>
<span id="cb52-1101"><a href="#cb52-1101" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Ensembles almost always outperform single models</span>
<span id="cb52-1102"><a href="#cb52-1102" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Diversity is crucial for ensemble success</span>
<span id="cb52-1103"><a href="#cb52-1103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Different methods suit different problems</span>
<span id="cb52-1104"><a href="#cb52-1104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Boosting for accuracy, bagging for stability</span>
<span id="cb52-1105"><a href="#cb52-1105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stacking combines strengths of different approaches</span>
<span id="cb52-1106"><a href="#cb52-1106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Computational cost vs performance trade-off</span>
<span id="cb52-1107"><a href="#cb52-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1108"><a href="#cb52-1108" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Next?</span></span>
<span id="cb52-1109"><a href="#cb52-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1110"><a href="#cb52-1110" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">Chapter 17</span><span class="co">](17-unsupervised-learning.Rmd)</span>, we'll explore unsupervised learning techniques for discovering patterns without labels.</span>
<span id="cb52-1111"><a href="#cb52-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1112"><a href="#cb52-1112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Resources</span></span>
<span id="cb52-1113"><a href="#cb52-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-1114"><a href="#cb52-1114" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Introduction to Statistical Learning - Chapter 8</span><span class="co">](https://www.statlearning.com/)</span></span>
<span id="cb52-1115"><a href="#cb52-1115" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Elements of Statistical Learning - Chapters 10, 15, 16</span><span class="co">](https://hastie.su.domains/ElemStatLearn/)</span></span>
<span id="cb52-1116"><a href="#cb52-1116" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">XGBoost Documentation</span><span class="co">](https://xgboost.readthedocs.io/)</span></span>
<span id="cb52-1117"><a href="#cb52-1117" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Random Forests Original Paper</span><span class="co">](https://www.stat.berkeley.edu/~breiman/randomforest2001.pdf)</span></span>
<span id="cb52-1118"><a href="#cb52-1118" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Ensemble Methods: Foundations and Algorithms</span><span class="co">](https://www.amazon.com/Ensemble-Methods-Foundations-Algorithms-Learning/dp/1439830037)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>