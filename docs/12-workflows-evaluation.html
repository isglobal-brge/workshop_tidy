<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Sarrat González, Juan R González">
<meta name="dcterms.date" content="2025-10-06">

<title>Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines – Tidyverse &amp; Machine Learning Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-90ee96a17764a76d4fcf3f331faa145e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidyverse &amp; Machine Learning Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-1-tidyverse" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 1: Tidyverse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-1-tidyverse">    
        <li>
    <a class="dropdown-item" href="./01-introduction.html">
 <span class="dropdown-text">Ch 1: Introduction to Tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-data-import.html">
 <span class="dropdown-text">Ch 2: Data Import with readr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-data-wrangling.html">
 <span class="dropdown-text">Ch 3: Data Wrangling with dplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-data-tidying.html">
 <span class="dropdown-text">Ch 4: Data Tidying with tidyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-visualization.html">
 <span class="dropdown-text">Ch 5: Visualization with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-functional-programming.html">
 <span class="dropdown-text">Ch 6: Functional Programming with purrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-strings-dates.html">
 <span class="dropdown-text">Ch 7: Strings and Dates</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-1.html">
 <span class="dropdown-text">Block 1 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-2-tidymodels" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 2: Tidymodels</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-2-tidymodels">    
        <li>
    <a class="dropdown-item" href="./08-tidymodels-intro.html">
 <span class="dropdown-text">Ch 8: Introduction to Tidymodels</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-data-splitting.html">
 <span class="dropdown-text">Ch 9: Data Splitting &amp; Resampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-feature-engineering.html">
 <span class="dropdown-text">Ch 10: Feature Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-model-specification.html">
 <span class="dropdown-text">Ch 11: Model Specification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-workflows-evaluation.html">
 <span class="dropdown-text">Ch 12: Workflows &amp; Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-hyperparameter-tuning.html">
 <span class="dropdown-text">Ch 13: Hyperparameter Tuning</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-2.html">
 <span class="dropdown-text">Block 2 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-3-machine-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 3: Machine Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-3-machine-learning">    
        <li>
    <a class="dropdown-item" href="./14-classification.html">
 <span class="dropdown-text">Ch 14: Classification Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-regression.html">
 <span class="dropdown-text">Ch 15: Regression Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-ensemble-methods.html">
 <span class="dropdown-text">Ch 16: Ensemble Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./17-unsupervised-learning.html">
 <span class="dropdown-text">Ch 17: Unsupervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./18-model-deployment.html">
 <span class="dropdown-text">Ch 18: Model Deployment</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-3.html">
 <span class="dropdown-text">Block 3 Assessment</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#why-workflows-matter" id="toc-why-workflows-matter" class="nav-link" data-scroll-target="#why-workflows-matter">Why Workflows Matter</a></li>
  <li><a href="#building-your-first-workflow" id="toc-building-your-first-workflow" class="nav-link" data-scroll-target="#building-your-first-workflow">Building Your First Workflow</a></li>
  <li><a href="#workflow-components" id="toc-workflow-components" class="nav-link" data-scroll-target="#workflow-components">Workflow Components</a>
  <ul class="collapse">
  <li><a href="#adding-and-modifying-components" id="toc-adding-and-modifying-components" class="nav-link" data-scroll-target="#adding-and-modifying-components">Adding and Modifying Components</a></li>
  <li><a href="#formula-vs-recipe-interface" id="toc-formula-vs-recipe-interface" class="nav-link" data-scroll-target="#formula-vs-recipe-interface">Formula vs Recipe Interface</a></li>
  </ul></li>
  <li><a href="#fitting-and-predicting-with-workflows" id="toc-fitting-and-predicting-with-workflows" class="nav-link" data-scroll-target="#fitting-and-predicting-with-workflows">Fitting and Predicting with Workflows</a></li>
  <li><a href="#workflow-sets-comparing-multiple-approaches" id="toc-workflow-sets-comparing-multiple-approaches" class="nav-link" data-scroll-target="#workflow-sets-comparing-multiple-approaches">Workflow Sets: Comparing Multiple Approaches</a>
  <ul class="collapse">
  <li><a href="#evaluating-workflow-sets" id="toc-evaluating-workflow-sets" class="nav-link" data-scroll-target="#evaluating-workflow-sets">Evaluating Workflow Sets</a></li>
  </ul></li>
  <li><a href="#model-evaluation-with-yardstick" id="toc-model-evaluation-with-yardstick" class="nav-link" data-scroll-target="#model-evaluation-with-yardstick">Model Evaluation with yardstick</a>
  <ul class="collapse">
  <li><a href="#regression-metrics" id="toc-regression-metrics" class="nav-link" data-scroll-target="#regression-metrics">Regression Metrics</a></li>
  <li><a href="#classification-metrics" id="toc-classification-metrics" class="nav-link" data-scroll-target="#classification-metrics">Classification Metrics</a></li>
  </ul></li>
  <li><a href="#custom-metrics-and-evaluation" id="toc-custom-metrics-and-evaluation" class="nav-link" data-scroll-target="#custom-metrics-and-evaluation">Custom Metrics and Evaluation</a></li>
  <li><a href="#advanced-workflow-techniques" id="toc-advanced-workflow-techniques" class="nav-link" data-scroll-target="#advanced-workflow-techniques">Advanced Workflow Techniques</a>
  <ul class="collapse">
  <li><a href="#extracting-and-modifying-fitted-workflows" id="toc-extracting-and-modifying-fitted-workflows" class="nav-link" data-scroll-target="#extracting-and-modifying-fitted-workflows">Extracting and Modifying Fitted Workflows</a></li>
  <li><a href="#workflow-finalization" id="toc-workflow-finalization" class="nav-link" data-scroll-target="#workflow-finalization">Workflow Finalization</a></li>
  </ul></li>
  <li><a href="#evaluating-model-assumptions" id="toc-evaluating-model-assumptions" class="nav-link" data-scroll-target="#evaluating-model-assumptions">Evaluating Model Assumptions</a></li>
  <li><a href="#probability-calibration" id="toc-probability-calibration" class="nav-link" data-scroll-target="#probability-calibration">Probability Calibration</a></li>
  <li><a href="#performance-visualization" id="toc-performance-visualization" class="nav-link" data-scroll-target="#performance-visualization">Performance Visualization</a></li>
  <li><a href="#best-practices-for-workflows" id="toc-best-practices-for-workflows" class="nav-link" data-scroll-target="#best-practices-for-workflows">Best Practices for Workflows</a>
  <ul class="collapse">
  <li><a href="#always-use-workflows-for-production" id="toc-always-use-workflows-for-production" class="nav-link" data-scroll-target="#always-use-workflows-for-production">1. Always Use Workflows for Production</a></li>
  <li><a href="#version-control-your-workflows" id="toc-version-control-your-workflows" class="nav-link" data-scroll-target="#version-control-your-workflows">2. Version Control Your Workflows</a></li>
  <li><a href="#document-your-choices" id="toc-document-your-choices" class="nav-link" data-scroll-target="#document-your-choices">3. Document Your Choices</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-build-a-complete-evaluation-pipeline" id="toc-exercise-1-build-a-complete-evaluation-pipeline" class="nav-link" data-scroll-target="#exercise-1-build-a-complete-evaluation-pipeline">Exercise 1: Build a Complete Evaluation Pipeline</a></li>
  <li><a href="#exercise-2-compare-preprocessing-strategies" id="toc-exercise-2-compare-preprocessing-strategies" class="nav-link" data-scroll-target="#exercise-2-compare-preprocessing-strategies">Exercise 2: Compare Preprocessing Strategies</a></li>
  <li><a href="#exercise-3-custom-metrics-for-business-goals" id="toc-exercise-3-custom-metrics-for-business-goals" class="nav-link" data-scroll-target="#exercise-3-custom-metrics-for-business-goals">Exercise 3: Custom Metrics for Business Goals</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next?</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Sarrat González, Juan R González </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 6, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this chapter, you will master:</p>
<ul>
<li>The workflow concept and its importance</li>
<li>Combining preprocessing and modeling</li>
<li>Workflow sets for comparing multiple approaches</li>
<li>Comprehensive model evaluation with yardstick</li>
<li>Custom metrics and metric sets</li>
<li>Visualizing model performance</li>
<li>Workflow extraction and modification</li>
<li>Best practices for reproducible ML pipelines</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Download R Script
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can download the complete R code for this chapter: <a href="R_scripts/12-workflows-evaluation.R" class="btn btn-primary" download="12-workflows-evaluation.R">📥 Download 12-workflows-evaluation.R</a></p>
</div>
</div>
</section>
<section id="why-workflows-matter" class="level2">
<h2 class="anchored" data-anchor-id="why-workflows-matter">Why Workflows Matter</h2>
<p>Imagine you’re baking a complex cake. You wouldn’t just throw ingredients together randomly - you’d follow a recipe that specifies the exact order of operations: mix dry ingredients, cream butter and sugar, combine wet and dry, bake at specific temperature. Machine learning is similar: the order and combination of steps matters immensely.</p>
<p>A workflow in tidymodels bundles together: 1. <strong>Preprocessing</strong> (recipes) 2. <strong>Model specification</strong> (parsnip) 3. <strong>Post-processing</strong> (if needed)</p>
<p>This bundling ensures: - <strong>Reproducibility</strong>: The exact same steps are applied to new data - <strong>Prevention of data leakage</strong>: Preprocessing parameters are learned only from training data - <strong>Simplicity</strong>: One object contains your entire modeling pipeline - <strong>Flexibility</strong>: Easy to swap components and compare approaches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example data</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="building-your-first-workflow" class="level2">
<h2 class="anchored" data-anchor-id="building-your-first-workflow">Building Your First Workflow</h2>
<p>Let’s start by understanding the problem with not using workflows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The WRONG way - manual preprocessing</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This approach is error-prone and can lead to data leakage</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual preprocessing on training data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ames_train_processed <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log transform - uses training data statistics</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scaling - WRONG! Uses all training data including validation folds</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we need to remember these transformations for test data</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># And apply them consistently... but what were the scaling parameters?</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The RIGHT way - using workflows</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a recipe</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>ames_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                      Neighborhood, </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create a model specification</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine into a workflow</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>lm_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
<p>The workflow object now contains everything needed to go from raw data to predictions. This is incredibly powerful for maintaining consistency across training, validation, and deployment.</p>
</section>
<section id="workflow-components" class="level2">
<h2 class="anchored" data-anchor-id="workflow-components">Workflow Components</h2>
<section id="adding-and-modifying-components" class="level3">
<h3 class="anchored" data-anchor-id="adding-and-modifying-components">Adding and Modifying Components</h3>
<p>Workflows are modular - you can add, remove, or update components:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with an empty workflow</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add components step by step</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding recipe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After adding recipe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: None

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After adding model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also update components</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>updated_workflow <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After updating model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After updating model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(updated_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.01

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Or remove components</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>recipe_only <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_model</span>()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After removing model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After removing model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(recipe_only)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: None

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()</code></pre>
</div>
</div>
<p>This modularity is essential for: - <strong>Experimentation</strong>: Quickly try different models with same preprocessing - <strong>Model comparison</strong>: Keep preprocessing constant while varying models - <strong>Debugging</strong>: Test components independently</p>
</section>
<section id="formula-vs-recipe-interface" class="level3">
<h3 class="anchored" data-anchor-id="formula-vs-recipe-interface">Formula vs Recipe Interface</h3>
<p>Workflows support two interfaces for specifying predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: Formula interface (simple, no preprocessing)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>formula_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2: Recipe interface (complex preprocessing)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>recipe_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 3: Variables interface (programmatic)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>vars_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_variables</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcomes =</span> Sale_Price,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> <span class="fu">c</span>(Gr_Liv_Area, Overall_Cond, Neighborhood)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the approaches</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Formula approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Formula approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>formula_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Formula
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
Sale_Price ~ Gr_Liv_Area + Overall_Cond

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recipe approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\nRecipe approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>recipe_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variables approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\nVariables approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>vars_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Variables
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
Outcomes: Sale_Price
Predictors: c(Gr_Liv_Area, Overall_Cond, Neighborhood)

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
<p>Choose based on your needs: - <strong>Formula</strong>: Quick prototyping, simple models - <strong>Recipe</strong>: Complex preprocessing, feature engineering - <strong>Variables</strong>: Programmatic variable selection</p>
</section>
</section>
<section id="fitting-and-predicting-with-workflows" class="level2">
<h2 class="anchored" data-anchor-id="fitting-and-predicting-with-workflows">Fitting and Predicting with Workflows</h2>
<p>The workflow handles all the complexity of applying transformations consistently:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the workflow</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> ames_train)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The fitted workflow contains:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. The prepared recipe (with learned parameters)</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The fitted model</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────

Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
                                         (Intercept)  
                                              164586  
                                         Gr_Liv_Area  
                                               33020  
                                          Year_Built  
                                               16040  
                                       Total_Bsmt_SF  
                                               15285  
                          Neighborhood_College_Creek  
                                               18650  
                               Neighborhood_Old_Town  
                                               -1959  
                                Neighborhood_Edwards  
                                              -10541  
                               Neighborhood_Somerset  
                                               37339  
                     Neighborhood_Northridge_Heights  
                                               89923  
                                Neighborhood_Gilbert  
                                                9375  
                                 Neighborhood_Sawyer  
                                                2027  
                         Neighborhood_Northwest_Ames  
                                                3646  
                            Neighborhood_Sawyer_West  
                                                4397  
                               Neighborhood_Mitchell  
                                                1085  
                              Neighborhood_Brookside  
                                                6919  
                               Neighborhood_Crawford  
                                               44017  
                 Neighborhood_Iowa_DOT_and_Rail_Road  
                                               -9375  
                             Neighborhood_Timberland  
                                               44374  
                             Neighborhood_Northridge  
                                               74323  
                            Neighborhood_Stone_Brook  
                                              101480  
Neighborhood_South_and_West_of_Iowa_State_University  
                                               -8260  
                            Neighborhood_Clear_Creek  
                                               15883  
                         Neighborhood_Meadow_Village  

...
and 20 more lines.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions - automatically applies all preprocessing!</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
    .pred
    &lt;dbl&gt;
1 114373.
2 155891.
3 191539.
4 190392.
5 270562.
6 206107.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get multiple types of predictions</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test),           <span class="co"># Point predictions</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test, <span class="at">type =</span> <span class="st">"conf_int"</span>)  <span class="co"># Confidence intervals for lm</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  Sale_Price   .pred .pred_lower .pred_upper
       &lt;int&gt;   &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1     105000 114373.     110063.     118683.
2     172000 155891.     151593.     160189.
3     189900 191539.     184896.     198181.
4     195500 190392.     183751.     197033.
5     191500 270562.     258711.     282414.
6     189000 206107.     199435.     212779.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The workflow ensures consistency</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># These transformations are automatically applied:</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Log transform of Sale_Price (inverse transformed for predictions)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Normalization of numeric predictors</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Dummy encoding of Neighborhood</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="workflow-sets-comparing-multiple-approaches" class="level2">
<h2 class="anchored" data-anchor-id="workflow-sets-comparing-multiple-approaches">Workflow Sets: Comparing Multiple Approaches</h2>
<p>One of the most powerful features is comparing multiple workflows systematically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple preprocessing recipes</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>recipe_simple <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>recipe_normalized <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>recipe_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars <span class="sc">+</span> </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                         First_Flr_SF <span class="sc">+</span> Full_Bath, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple model specifications</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">lm =</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>),</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">ridge =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">lasso =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow set</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>workflow_set <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple =</span> recipe_simple,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized =</span> recipe_normalized</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> models</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A workflow set/tibble: 8 × 4
  wflow_id         info             option    result    
  &lt;chr&gt;            &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
1 simple_lm        &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
2 simple_ridge     &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
3 simple_lasso     &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
4 simple_tree      &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
5 normalized_lm    &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
6 normalized_ridge &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
7 normalized_lasso &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
8 normalized_tree  &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates 8 workflows (2 recipes × 4 models)!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="evaluating-workflow-sets" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-workflow-sets">Evaluating Workflow Sets</h3>
<p>Now we can evaluate all workflows systematically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate workflows individually to avoid errors</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll evaluate just a subset for demonstration</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>simple_lm <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>))</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> ames_folds,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Show metrics</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(simple_lm_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric .estimator      mean     n   std_err .config        
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;          
1 mae     standard   31681.        5  727.     pre0_mod0_post0
2 rmse    standard   46911.        5 2520.     pre0_mod0_post0
3 rsq     standard       0.655     5    0.0192 pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize performance</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Model Performance with Cross-Validation"</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Simple linear model with 5-fold CV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This systematic comparison helps identify: - Which preprocessing steps add value - Which models work best with your data - Interaction effects between preprocessing and models</p>
</section>
</section>
<section id="model-evaluation-with-yardstick" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-with-yardstick">Model Evaluation with yardstick</h2>
<p>The yardstick package provides comprehensive metrics for model evaluation:</p>
<section id="regression-metrics" class="level3">
<h3 class="anchored" data-anchor-id="regression-metrics">Regression Metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit our simple workflow</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>best_fit <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get test predictions</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> best_fit <span class="sc">%&gt;%</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate multiple metrics</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>regression_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  rmse,      <span class="co"># Root Mean Squared Error</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  mae,       <span class="co"># Mean Absolute Error</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  mape,      <span class="co"># Mean Absolute Percentage Error</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  rsq,       <span class="co"># R-squared</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  ccc        <span class="co"># Concordance Correlation Coefficient</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>test_performance <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">regression_metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(test_performance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard   45366.   
2 mae     standard   31162.   
3 mape    standard      17.6  
4 rsq     standard       0.690
5 ccc     standard       0.804</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions vs actual</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs Actual Sale Prices"</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(test_performance<span class="sc">$</span>.estimate[<span class="dv">1</span>], <span class="dv">2</span>)),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="classification-metrics" class="level3">
<h3 class="anchored" data-anchor-id="classification-metrics">Classification Metrics</h3>
<p>Let’s also explore classification metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification problem</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple classification workflow</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built, </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_class) <span class="sc">%&gt;%</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>class_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>class_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(class_spec)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and predict</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>class_fit <span class="ot">&lt;-</span> class_workflow <span class="sc">%&gt;%</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(class_train)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>class_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  class_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(expensive),</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test),</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification metrics</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>  accuracy,</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  precision,</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>  recall,</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  f_meas,</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>  roc_auc,</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>  pr_auc</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>class_performance <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(class_performance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  .metric   .estimator .estimate
  &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
1 accuracy  binary        0.885 
2 precision binary        0.902 
3 recall    binary        0.865 
4 f_meas    binary        0.883 
5 roc_auc   binary        0.0380
6 pr_auc    binary        0.310 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(conf_matrix, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Confusion Matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC curve</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>roc_curve_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> expensive, .pred_yes)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(roc_curve_data) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve"</span>) <span class="sc">+</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC:"</span>, <span class="fu">round</span>(class_performance<span class="sc">$</span>.estimate[<span class="dv">5</span>], <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="custom-metrics-and-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="custom-metrics-and-evaluation">Custom Metrics and Evaluation</h2>
<p>Sometimes you need custom metrics for your specific problem:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom metric - Mean Absolute Percentage Error with threshold</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>mape_vec_threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">threshold =</span> <span class="fl">0.2</span>, <span class="at">na_rm =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> <span class="fu">abs</span>((truth <span class="sc">-</span> estimate) <span class="sc">/</span> truth)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  errors[errors <span class="sc">&gt;</span> threshold] <span class="ot">&lt;-</span> threshold  <span class="co"># Cap errors at threshold</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(errors, <span class="at">na.rm =</span> na_rm)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the custom metric directly</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>custom_mape <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_mape =</span> <span class="fu">mape_vec_threshold</span>(Sale_Price, .pred),</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>((Sale_Price <span class="sc">-</span> .pred) <span class="sc">/</span> Sale_Price))</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(custom_mape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  custom_mape regular_mape
        &lt;dbl&gt;        &lt;dbl&gt;
1       0.127        0.176</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a business-specific metric</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For example: penalize underestimation more than overestimation</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>asymmetric_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">under_weight =</span> <span class="dv">2</span>) {</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> truth <span class="sc">-</span> estimate</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(errors <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                   under_weight <span class="sc">*</span> errors<span class="sc">^</span><span class="dv">2</span>,  <span class="co"># Underestimation penalty</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                   errors<span class="sc">^</span><span class="dv">2</span>)                  <span class="co"># Overestimation penalty</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>(result))</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply custom metric</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">asymmetric_loss</span>(Sale_Price, .pred)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_rmse =</span> <span class="fu">rmse_vec</span>(Sale_Price, .pred),</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">mean</span>(asymmetric_rmse)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  regular_rmse asymmetric_rmse
         &lt;dbl&gt;           &lt;dbl&gt;
1       45366.          59141.</code></pre>
</div>
</div>
</section>
<section id="advanced-workflow-techniques" class="level2">
<h2 class="anchored" data-anchor-id="advanced-workflow-techniques">Advanced Workflow Techniques</h2>
<section id="extracting-and-modifying-fitted-workflows" class="level3">
<h3 class="anchored" data-anchor-id="extracting-and-modifying-fitted-workflows">Extracting and Modifying Fitted Workflows</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components from fitted workflow</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>extracted_recipe <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>()</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>extracted_model <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get preprocessing results</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>() <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> ames_test)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(preprocessed_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 32
  Gr_Liv_Area Year_Built Total_Bsmt_SF Sale_Price Neighborhood_College_Creek
        &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;      &lt;int&gt;                      &lt;dbl&gt;
1      -1.18      -0.353        -0.364     105000                          0
2      -0.337     -0.452         0.634     172000                          0
3       0.247      0.836        -0.262     189900                          0
4       0.198      0.869        -0.266     195500                          0
5      -0.433      0.671         0.525     191500                          0
6       0.588      0.902        -0.114     189000                          0
# ℹ 27 more variables: Neighborhood_Old_Town &lt;dbl&gt;, Neighborhood_Edwards &lt;dbl&gt;,
#   Neighborhood_Somerset &lt;dbl&gt;, Neighborhood_Northridge_Heights &lt;dbl&gt;,
#   Neighborhood_Gilbert &lt;dbl&gt;, Neighborhood_Sawyer &lt;dbl&gt;,
#   Neighborhood_Northwest_Ames &lt;dbl&gt;, Neighborhood_Sawyer_West &lt;dbl&gt;,
#   Neighborhood_Mitchell &lt;dbl&gt;, Neighborhood_Brookside &lt;dbl&gt;,
#   Neighborhood_Crawford &lt;dbl&gt;, Neighborhood_Iowa_DOT_and_Rail_Road &lt;dbl&gt;,
#   Neighborhood_Timberland &lt;dbl&gt;, Neighborhood_Northridge &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract model coefficients</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  term                       estimate std.error statistic   p.value
  &lt;chr&gt;                         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)                 164586.     2214.    74.3   0        
2 Gr_Liv_Area                  33020.     1003.    32.9   4.40e-193
3 Year_Built                   16040.     1732.     9.26  4.64e- 20
4 Total_Bsmt_SF                15285.     1029.    14.9   1.28e- 47
5 Neighborhood_College_Creek   18650.     3982.     4.68  2.99e-  6
6 Neighborhood_Old_Town        -1959.     4085.    -0.480 6.32e-  1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable importance (if applicable)</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For models that support it</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span> <span class="fu">set_mode</span>(<span class="st">"regression"</span>))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>rf_importance <span class="ot">&lt;-</span> rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>()</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="workflow-finalization" class="level3">
<h3 class="anchored" data-anchor-id="workflow-finalization">Workflow Finalization</h3>
<p>After tuning (covered in next chapter), you finalize workflows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Finalize a workflow with best parameters</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This would typically come from tuning</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fl">0.01</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fl">0.5</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunable workflow</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>tunable_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fu">tune</span>(),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fu">tune</span>()</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>tunable_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_normalized) <span class="sc">%&gt;%</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tunable_spec)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize with best parameters</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> tunable_workflow <span class="sc">%&gt;%</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_params)</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
1 Recipe Step

• step_normalize()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.01
  mixture = 0.5

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final model on all training data</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Last fit - train on all data, evaluate on test</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>last_fit_results <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(<span class="at">split =</span> ames_split, <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq))</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final metrics</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>final_metrics <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config        
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;          
1 rmse    standard   40233.    pre0_mod0_post0
2 rsq     standard       0.760 pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final model</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluating-model-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-model-assumptions">Evaluating Model Assumptions</h2>
<p>Workflows make it easy to check model assumptions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual analysis for regression</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>residual_analysis <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> .pred,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_residual =</span> residual <span class="sc">/</span> <span class="fu">sd</span>(residual),</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_residual =</span> <span class="fu">abs</span>(residual)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual plots</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Fitted"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">sample =</span> std_residual)) <span class="sc">+</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q Plot"</span>, <span class="at">x =</span> <span class="st">"Theoretical Quantiles"</span>, <span class="at">y =</span> <span class="st">"Standardized Residuals"</span>)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> <span class="fu">sqrt</span>(abs_residual))) <span class="sc">+</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scale-Location"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"√|Residuals|"</span>)</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> residual)) <span class="sc">+</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(count)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Distribution"</span>, <span class="at">x =</span> <span class="st">"Residuals"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4) <span class="sc">+</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Regression Diagnostics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="probability-calibration" class="level2">
<h2 class="anchored" data-anchor-id="probability-calibration">Probability Calibration</h2>
<p>For classification, we often need well-calibrated probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration analysis</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>calibration_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_bin =</span> <span class="fu">cut</span>(.pred_yes, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prob_bin) <span class="sc">%&gt;%</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_predicted =</span> <span class="fu">mean</span>(.pred_yes),</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction_positive =</span> <span class="fu">mean</span>(expensive <span class="sc">==</span> <span class="st">"yes"</span>),</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">5</span>)  <span class="co"># Remove bins with few observations</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration plot</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Probability Calibration Plot"</span>,</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Well-calibrated models follow the diagonal"</span>,</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probably package for calibration</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple calibration visualization</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll just show the calibration plot without the probably package functions</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># that are causing issues</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple comparison</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Calibration Assessment"</span>,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points should follow the red diagonal for perfect calibration"</span>,</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="performance-visualization" class="level2">
<h2 class="anchored" data-anchor-id="performance-visualization">Performance Visualization</h2>
<p>Create comprehensive performance visualizations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For regression: actual vs predicted with confidence bands</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Accuracy"</span>,</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"R² ="</span>, <span class="fu">round</span>(<span class="fu">rsq_vec</span>(test_predictions<span class="sc">$</span>Sale_Price, </span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>                                          test_predictions<span class="sc">$</span>.pred), <span class="dv">3</span>)),</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Price"</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Price"</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Error distribution</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>error_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> .pred <span class="sc">-</span> Sale_Price,</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_error =</span> error <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error)) <span class="sc">+</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Error Distribution"</span>,</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage error"</span>,</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Error (%)"</span>,</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="sc">+</span> error_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="best-practices-for-workflows" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-for-workflows">Best Practices for Workflows</h2>
<section id="always-use-workflows-for-production" class="level3">
<h3 class="anchored" data-anchor-id="always-use-workflows-for-production">1. Always Use Workflows for Production</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Good practice: Complete workflow</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>production_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures all preprocessing is contained and reproducible</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="version-control-your-workflows" class="level3">
<h3 class="anchored" data-anchor-id="version-control-your-workflows">2. Version Control Your Workflows</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save workflow for reproducibility</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_fit, <span class="st">"models/final_workflow_v1.rds"</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and use later</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># loaded_workflow &lt;- readRDS("models/final_workflow_v1.rds")</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># new_predictions &lt;- predict(loaded_workflow, new_data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="document-your-choices" class="level3">
<h3 class="anchored" data-anchor-id="document-your-choices">3. Document Your Choices</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow with documentation</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>documented_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle missing values before other steps</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Normalize for model stability</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create dummies for linear model</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression to handle multicollinearity</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="exercise-1-build-a-complete-evaluation-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-build-a-complete-evaluation-pipeline">Exercise 1: Build a Complete Evaluation Pipeline</h3>
<p>Create a workflow and comprehensive evaluation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a complete evaluation pipeline</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>eval_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>                      Neighborhood <span class="sc">+</span> Total_Bsmt_SF, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price, <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="co"># Skip for prediction</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>eval_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>eval_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(eval_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(eval_spec)</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit with cross-validation</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>eval_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>eval_results <span class="ot">&lt;-</span> eval_workflow <span class="sc">%&gt;%</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> eval_folds,</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>mape),</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize performance</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(eval_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  .metric .estimator       mean     n      std_err .config        
  &lt;chr&gt;   &lt;chr&gt;           &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt; &lt;chr&gt;          
1 mae     standard   180453.       10  696.        pre0_mod0_post0
2 mape    standard      100.0      10    0.0000425 pre0_mod0_post0
3 rmse    standard   197162.       10 1400.        pre0_mod0_post0
4 rsq     standard        0.764    10    0.0157    pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions for visualization</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>eval_predictions <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(eval_results)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize CV performance</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eval_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>id, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions Across CV Folds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-2-compare-preprocessing-strategies" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-compare-preprocessing-strategies">Exercise 2: Compare Preprocessing Strategies</h3>
<p>Evaluate different preprocessing approaches:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different preprocessing strategies</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>preproc_minimal <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> ames_train)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>preproc_standard <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>preproc_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Year_Built)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflows</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">minimal =</span> preproc_minimal,</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">standard =</span> preproc_standard,</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> preproc_complex</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model for all</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and evaluate workflows</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>strategy_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(strategy_name) {</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    wf,</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare strategies</span></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(strategy_results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Preprocessing Strategy Comparison"</span>) <span class="sc">+</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-custom-metrics-for-business-goals" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-custom-metrics-for-business-goals">Exercise 3: Custom Metrics for Business Goals</h3>
<p>Create business-specific metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Business scenario: Real estate company</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - Overestimating is bad (disappointed customers)</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &lt;5% is acceptable</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &gt;5% is very bad (lost opportunity)</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>business_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate) {</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  pct_error <span class="ot">&lt;-</span> (estimate <span class="sc">-</span> truth) <span class="sc">/</span> truth <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  penalties <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">2</span>,        <span class="co"># Overestimate penalty</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="fl">0.5</span>,     <span class="co"># Small underestimate</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">3</span>                  <span class="co"># Large underestimate penalty</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(penalties)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test predictions</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">business_score =</span> <span class="fu">business_metric</span>(Sale_Price, .pred),</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">standard_mape =</span> <span class="fu">mape_vec</span>(Sale_Price, .pred)</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_business_score =</span> <span class="fu">mean</span>(business_score),</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_standard_mape =</span> <span class="fu">mean</span>(standard_mape)</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  mean_business_score mean_standard_mape
                &lt;dbl&gt;              &lt;dbl&gt;
1                42.4               17.6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize business metric</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_error =</span> (.pred <span class="sc">-</span> Sale_Price) <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">error_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Overestimate"</span>,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"Small Underestimate"</span>,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Large Underestimate"</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error, <span class="at">fill =</span> error_category)) <span class="sc">+</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Overestimate"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small Underestimate"</span> <span class="ot">=</span> <span class="st">"yellow"</span>,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large Underestimate"</span> <span class="ot">=</span> <span class="st">"darkred"</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Business Impact of Prediction Errors"</span>,</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Error"</span>,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Error Category"</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this comprehensive chapter, you’ve mastered:</p>
<p>✅ <strong>Workflow fundamentals</strong> - Combining preprocessing and models - Preventing data leakage - Ensuring reproducibility</p>
<p>✅ <strong>Workflow components</strong> - Adding and updating recipes/models - Formula vs recipe interfaces - Modular design</p>
<p>✅ <strong>Workflow sets</strong> - Comparing multiple approaches - Systematic evaluation - Ranking and selection</p>
<p>✅ <strong>Model evaluation</strong> - Comprehensive metrics with yardstick - Custom metrics for business needs - Visualization techniques</p>
<p>✅ <strong>Advanced techniques</strong> - Extracting workflow components - Probability calibration - Model diagnostics</p>
<p>Key takeaways: - Always use workflows for production models - Workflows prevent data leakage automatically - Workflow sets enable systematic comparison - Custom metrics align models with business goals - Proper evaluation is crucial for model trust</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>In <a href="./13-hyperparameter-tuning.html">Chapter 13</a>, we’ll explore hyperparameter tuning to optimize model performance.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="https://workflows.tidymodels.org/">workflows Documentation</a></li>
<li><a href="https://workflowsets.tidymodels.org/">workflowsets Documentation</a></li>
<li><a href="https://yardstick.tidymodels.org/">yardstick Documentation</a></li>
<li><a href="https://www.tmwr.org/workflows.html">Tidy Modeling with R - Workflows Chapter</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all elements with class 'quarto-title-meta-heading' that contain "Author"
    const authorHeadings = document.querySelectorAll('.quarto-title-meta-heading');
    
    authorHeadings.forEach(function(heading) {
        if (heading.textContent.trim() === 'Author') {
            heading.textContent = 'Authors';
        }
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb80" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines"</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "David Sarrat González, Juan R González"</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will master:</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The workflow concept and its importance</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Combining preprocessing and modeling</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow sets for comparing multiple approaches</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Comprehensive model evaluation with yardstick</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Custom metrics and metric sets</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Visualizing model performance</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow extraction and modification</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Best practices for reproducible ML pipelines</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Download R Script</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>You can download the complete R code for this chapter:</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">📥 Download 12-workflows-evaluation.R</span><span class="co">](R_scripts/12-workflows-evaluation.R)</span>{.btn .btn-primary download="12-workflows-evaluation.R"}</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Workflows Matter</span></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>Imagine you're baking a complex cake. You wouldn't just throw ingredients together randomly - you'd follow a recipe that specifies the exact order of operations: mix dry ingredients, cream butter and sugar, combine wet and dry, bake at specific temperature. Machine learning is similar: the order and combination of steps matters immensely.</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>A workflow in tidymodels bundles together:</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Preprocessing** (recipes)</span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Model specification** (parsnip)</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Post-processing** (if needed)</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>This bundling ensures:</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reproducibility**: The exact same steps are applied to new data</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prevention of data leakage**: Preprocessing parameters are learned only from training data</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Simplicity**: One object contains your entire modeling pipeline</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Flexibility**: Easy to swap components and compare approaches</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example data</span></span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building Your First Workflow</span></span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>Let's start by understanding the problem with not using workflows:</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a><span class="co"># The WRONG way - manual preprocessing</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a><span class="co"># This approach is error-prone and can lead to data leakage</span></span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual preprocessing on training data</span></span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>ames_train_processed <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log transform - uses training data statistics</span></span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price),</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scaling - WRONG! Uses all training data including validation folds</span></span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we need to remember these transformations for test data</span></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a><span class="co"># And apply them consistently... but what were the scaling parameters?</span></span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a><span class="co"># The RIGHT way - using workflows</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a recipe</span></span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>ames_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> </span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>                      Neighborhood, </span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create a model specification</span></span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine into a workflow</span></span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>lm_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_workflow)</span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>The workflow object now contains everything needed to go from raw data to predictions. This is incredibly powerful for maintaining consistency across training, validation, and deployment.</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Workflow Components</span></span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding and Modifying Components</span></span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>Workflows are modular - you can add, remove, or update components:</span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with an empty workflow</span></span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Add components step by step</span></span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe)</span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding recipe:"</span>)</span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-131"><a href="#cb80-131" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-132"><a href="#cb80-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb80-133"><a href="#cb80-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-134"><a href="#cb80-134" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding model:"</span>)</span>
<span id="cb80-135"><a href="#cb80-135" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span>
<span id="cb80-136"><a href="#cb80-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-137"><a href="#cb80-137" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also update components</span></span>
<span id="cb80-138"><a href="#cb80-138" aria-hidden="true" tabindex="-1"></a>updated_workflow <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-139"><a href="#cb80-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(</span>
<span id="cb80-140"><a href="#cb80-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-141"><a href="#cb80-141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb80-142"><a href="#cb80-142" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-143"><a href="#cb80-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-144"><a href="#cb80-144" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After updating model:"</span>)</span>
<span id="cb80-145"><a href="#cb80-145" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(updated_workflow)</span>
<span id="cb80-146"><a href="#cb80-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-147"><a href="#cb80-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Or remove components</span></span>
<span id="cb80-148"><a href="#cb80-148" aria-hidden="true" tabindex="-1"></a>recipe_only <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-149"><a href="#cb80-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_model</span>()</span>
<span id="cb80-150"><a href="#cb80-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-151"><a href="#cb80-151" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After removing model:"</span>)</span>
<span id="cb80-152"><a href="#cb80-152" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(recipe_only)</span>
<span id="cb80-153"><a href="#cb80-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-154"><a href="#cb80-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-155"><a href="#cb80-155" aria-hidden="true" tabindex="-1"></a>This modularity is essential for:</span>
<span id="cb80-156"><a href="#cb80-156" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Experimentation**: Quickly try different models with same preprocessing</span>
<span id="cb80-157"><a href="#cb80-157" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model comparison**: Keep preprocessing constant while varying models</span>
<span id="cb80-158"><a href="#cb80-158" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Debugging**: Test components independently</span>
<span id="cb80-159"><a href="#cb80-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-160"><a href="#cb80-160" aria-hidden="true" tabindex="-1"></a><span class="fu">### Formula vs Recipe Interface</span></span>
<span id="cb80-161"><a href="#cb80-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-162"><a href="#cb80-162" aria-hidden="true" tabindex="-1"></a>Workflows support two interfaces for specifying predictors:</span>
<span id="cb80-163"><a href="#cb80-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-166"><a href="#cb80-166" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-167"><a href="#cb80-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: Formula interface (simple, no preprocessing)</span></span>
<span id="cb80-168"><a href="#cb80-168" aria-hidden="true" tabindex="-1"></a>formula_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-169"><a href="#cb80-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb80-170"><a href="#cb80-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb80-171"><a href="#cb80-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-172"><a href="#cb80-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2: Recipe interface (complex preprocessing)</span></span>
<span id="cb80-173"><a href="#cb80-173" aria-hidden="true" tabindex="-1"></a>recipe_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-174"><a href="#cb80-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb80-175"><a href="#cb80-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb80-176"><a href="#cb80-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-177"><a href="#cb80-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 3: Variables interface (programmatic)</span></span>
<span id="cb80-178"><a href="#cb80-178" aria-hidden="true" tabindex="-1"></a>vars_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-179"><a href="#cb80-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_variables</span>(</span>
<span id="cb80-180"><a href="#cb80-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcomes =</span> Sale_Price,</span>
<span id="cb80-181"><a href="#cb80-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> <span class="fu">c</span>(Gr_Liv_Area, Overall_Cond, Neighborhood)</span>
<span id="cb80-182"><a href="#cb80-182" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-183"><a href="#cb80-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb80-184"><a href="#cb80-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-185"><a href="#cb80-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the approaches</span></span>
<span id="cb80-186"><a href="#cb80-186" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Formula approach:"</span>)</span>
<span id="cb80-187"><a href="#cb80-187" aria-hidden="true" tabindex="-1"></a>formula_workflow</span>
<span id="cb80-188"><a href="#cb80-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-189"><a href="#cb80-189" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recipe approach:"</span>)</span>
<span id="cb80-190"><a href="#cb80-190" aria-hidden="true" tabindex="-1"></a>recipe_workflow</span>
<span id="cb80-191"><a href="#cb80-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-192"><a href="#cb80-192" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variables approach:"</span>)</span>
<span id="cb80-193"><a href="#cb80-193" aria-hidden="true" tabindex="-1"></a>vars_workflow</span>
<span id="cb80-194"><a href="#cb80-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-195"><a href="#cb80-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-196"><a href="#cb80-196" aria-hidden="true" tabindex="-1"></a>Choose based on your needs:</span>
<span id="cb80-197"><a href="#cb80-197" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Formula**: Quick prototyping, simple models</span>
<span id="cb80-198"><a href="#cb80-198" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Recipe**: Complex preprocessing, feature engineering</span>
<span id="cb80-199"><a href="#cb80-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Variables**: Programmatic variable selection</span>
<span id="cb80-200"><a href="#cb80-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-201"><a href="#cb80-201" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting and Predicting with Workflows</span></span>
<span id="cb80-202"><a href="#cb80-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-203"><a href="#cb80-203" aria-hidden="true" tabindex="-1"></a>The workflow handles all the complexity of applying transformations consistently:</span>
<span id="cb80-204"><a href="#cb80-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-207"><a href="#cb80-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-208"><a href="#cb80-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the workflow</span></span>
<span id="cb80-209"><a href="#cb80-209" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-210"><a href="#cb80-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> ames_train)</span>
<span id="cb80-211"><a href="#cb80-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-212"><a href="#cb80-212" aria-hidden="true" tabindex="-1"></a><span class="co"># The fitted workflow contains:</span></span>
<span id="cb80-213"><a href="#cb80-213" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. The prepared recipe (with learned parameters)</span></span>
<span id="cb80-214"><a href="#cb80-214" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The fitted model</span></span>
<span id="cb80-215"><a href="#cb80-215" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_fit)</span>
<span id="cb80-216"><a href="#cb80-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-217"><a href="#cb80-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions - automatically applies all preprocessing!</span></span>
<span id="cb80-218"><a href="#cb80-218" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-219"><a href="#cb80-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test)</span>
<span id="cb80-220"><a href="#cb80-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-221"><a href="#cb80-221" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predictions)</span>
<span id="cb80-222"><a href="#cb80-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-223"><a href="#cb80-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Get multiple types of predictions</span></span>
<span id="cb80-224"><a href="#cb80-224" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb80-225"><a href="#cb80-225" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price),</span>
<span id="cb80-226"><a href="#cb80-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test),           <span class="co"># Point predictions</span></span>
<span id="cb80-227"><a href="#cb80-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test, <span class="at">type =</span> <span class="st">"conf_int"</span>)  <span class="co"># Confidence intervals for lm</span></span>
<span id="cb80-228"><a href="#cb80-228" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-229"><a href="#cb80-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-230"><a href="#cb80-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_predictions)</span>
<span id="cb80-231"><a href="#cb80-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-232"><a href="#cb80-232" aria-hidden="true" tabindex="-1"></a><span class="co"># The workflow ensures consistency</span></span>
<span id="cb80-233"><a href="#cb80-233" aria-hidden="true" tabindex="-1"></a><span class="co"># These transformations are automatically applied:</span></span>
<span id="cb80-234"><a href="#cb80-234" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Log transform of Sale_Price (inverse transformed for predictions)</span></span>
<span id="cb80-235"><a href="#cb80-235" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Normalization of numeric predictors</span></span>
<span id="cb80-236"><a href="#cb80-236" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Dummy encoding of Neighborhood</span></span>
<span id="cb80-237"><a href="#cb80-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-238"><a href="#cb80-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-239"><a href="#cb80-239" aria-hidden="true" tabindex="-1"></a><span class="fu">## Workflow Sets: Comparing Multiple Approaches</span></span>
<span id="cb80-240"><a href="#cb80-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-241"><a href="#cb80-241" aria-hidden="true" tabindex="-1"></a>One of the most powerful features is comparing multiple workflows systematically:</span>
<span id="cb80-242"><a href="#cb80-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-245"><a href="#cb80-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-246"><a href="#cb80-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple preprocessing recipes</span></span>
<span id="cb80-247"><a href="#cb80-247" aria-hidden="true" tabindex="-1"></a>recipe_simple <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb80-248"><a href="#cb80-248" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb80-249"><a href="#cb80-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-250"><a href="#cb80-250" aria-hidden="true" tabindex="-1"></a>recipe_normalized <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb80-251"><a href="#cb80-251" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-252"><a href="#cb80-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb80-253"><a href="#cb80-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-254"><a href="#cb80-254" aria-hidden="true" tabindex="-1"></a>recipe_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb80-255"><a href="#cb80-255" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars <span class="sc">+</span> </span>
<span id="cb80-256"><a href="#cb80-256" aria-hidden="true" tabindex="-1"></a>                         First_Flr_SF <span class="sc">+</span> Full_Bath, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-257"><a href="#cb80-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-258"><a href="#cb80-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-259"><a href="#cb80-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb80-260"><a href="#cb80-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-261"><a href="#cb80-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple model specifications</span></span>
<span id="cb80-262"><a href="#cb80-262" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb80-263"><a href="#cb80-263" aria-hidden="true" tabindex="-1"></a>  <span class="at">lm =</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>),</span>
<span id="cb80-264"><a href="#cb80-264" aria-hidden="true" tabindex="-1"></a>  <span class="at">ridge =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb80-265"><a href="#cb80-265" aria-hidden="true" tabindex="-1"></a>  <span class="at">lasso =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb80-266"><a href="#cb80-266" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb80-267"><a href="#cb80-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb80-268"><a href="#cb80-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb80-269"><a href="#cb80-269" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-270"><a href="#cb80-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-271"><a href="#cb80-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow set</span></span>
<span id="cb80-272"><a href="#cb80-272" aria-hidden="true" tabindex="-1"></a>workflow_set <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb80-273"><a href="#cb80-273" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(</span>
<span id="cb80-274"><a href="#cb80-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple =</span> recipe_simple,</span>
<span id="cb80-275"><a href="#cb80-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized =</span> recipe_normalized</span>
<span id="cb80-276"><a href="#cb80-276" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb80-277"><a href="#cb80-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> models</span>
<span id="cb80-278"><a href="#cb80-278" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-279"><a href="#cb80-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-280"><a href="#cb80-280" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_set)</span>
<span id="cb80-281"><a href="#cb80-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-282"><a href="#cb80-282" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates 8 workflows (2 recipes × 4 models)!</span></span>
<span id="cb80-283"><a href="#cb80-283" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-284"><a href="#cb80-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-285"><a href="#cb80-285" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluating Workflow Sets</span></span>
<span id="cb80-286"><a href="#cb80-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-287"><a href="#cb80-287" aria-hidden="true" tabindex="-1"></a>Now we can evaluate all workflows systematically:</span>
<span id="cb80-288"><a href="#cb80-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-291"><a href="#cb80-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-292"><a href="#cb80-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb80-293"><a href="#cb80-293" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb80-294"><a href="#cb80-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-295"><a href="#cb80-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate workflows individually to avoid errors</span></span>
<span id="cb80-296"><a href="#cb80-296" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll evaluate just a subset for demonstration</span></span>
<span id="cb80-297"><a href="#cb80-297" aria-hidden="true" tabindex="-1"></a>simple_lm <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-298"><a href="#cb80-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb80-299"><a href="#cb80-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>))</span>
<span id="cb80-300"><a href="#cb80-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-301"><a href="#cb80-301" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb80-302"><a href="#cb80-302" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb80-303"><a href="#cb80-303" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> ames_folds,</span>
<span id="cb80-304"><a href="#cb80-304" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae)</span>
<span id="cb80-305"><a href="#cb80-305" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-306"><a href="#cb80-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-307"><a href="#cb80-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Show metrics</span></span>
<span id="cb80-308"><a href="#cb80-308" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(simple_lm_results)</span>
<span id="cb80-309"><a href="#cb80-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-310"><a href="#cb80-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize performance</span></span>
<span id="cb80-311"><a href="#cb80-311" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="sc">%&gt;%</span></span>
<span id="cb80-312"><a href="#cb80-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-313"><a href="#cb80-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb80-314"><a href="#cb80-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb80-315"><a href="#cb80-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb80-316"><a href="#cb80-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb80-317"><a href="#cb80-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Model Performance with Cross-Validation"</span>,</span>
<span id="cb80-318"><a href="#cb80-318" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Simple linear model with 5-fold CV"</span>)</span>
<span id="cb80-319"><a href="#cb80-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-320"><a href="#cb80-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-321"><a href="#cb80-321" aria-hidden="true" tabindex="-1"></a>This systematic comparison helps identify:</span>
<span id="cb80-322"><a href="#cb80-322" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which preprocessing steps add value</span>
<span id="cb80-323"><a href="#cb80-323" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which models work best with your data</span>
<span id="cb80-324"><a href="#cb80-324" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interaction effects between preprocessing and models</span>
<span id="cb80-325"><a href="#cb80-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-326"><a href="#cb80-326" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Evaluation with yardstick</span></span>
<span id="cb80-327"><a href="#cb80-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-328"><a href="#cb80-328" aria-hidden="true" tabindex="-1"></a>The yardstick package provides comprehensive metrics for model evaluation:</span>
<span id="cb80-329"><a href="#cb80-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-330"><a href="#cb80-330" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression Metrics</span></span>
<span id="cb80-331"><a href="#cb80-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-334"><a href="#cb80-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-335"><a href="#cb80-335" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit our simple workflow</span></span>
<span id="cb80-336"><a href="#cb80-336" aria-hidden="true" tabindex="-1"></a>best_fit <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb80-337"><a href="#cb80-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb80-338"><a href="#cb80-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-339"><a href="#cb80-339" aria-hidden="true" tabindex="-1"></a><span class="co"># Get test predictions</span></span>
<span id="cb80-340"><a href="#cb80-340" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> best_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-341"><a href="#cb80-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb80-342"><a href="#cb80-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price))</span>
<span id="cb80-343"><a href="#cb80-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-344"><a href="#cb80-344" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate multiple metrics</span></span>
<span id="cb80-345"><a href="#cb80-345" aria-hidden="true" tabindex="-1"></a>regression_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb80-346"><a href="#cb80-346" aria-hidden="true" tabindex="-1"></a>  rmse,      <span class="co"># Root Mean Squared Error</span></span>
<span id="cb80-347"><a href="#cb80-347" aria-hidden="true" tabindex="-1"></a>  mae,       <span class="co"># Mean Absolute Error</span></span>
<span id="cb80-348"><a href="#cb80-348" aria-hidden="true" tabindex="-1"></a>  mape,      <span class="co"># Mean Absolute Percentage Error</span></span>
<span id="cb80-349"><a href="#cb80-349" aria-hidden="true" tabindex="-1"></a>  rsq,       <span class="co"># R-squared</span></span>
<span id="cb80-350"><a href="#cb80-350" aria-hidden="true" tabindex="-1"></a>  ccc        <span class="co"># Concordance Correlation Coefficient</span></span>
<span id="cb80-351"><a href="#cb80-351" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-352"><a href="#cb80-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-353"><a href="#cb80-353" aria-hidden="true" tabindex="-1"></a>test_performance <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-354"><a href="#cb80-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">regression_metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb80-355"><a href="#cb80-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-356"><a href="#cb80-356" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(test_performance)</span>
<span id="cb80-357"><a href="#cb80-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-358"><a href="#cb80-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions vs actual</span></span>
<span id="cb80-359"><a href="#cb80-359" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb80-360"><a href="#cb80-360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb80-361"><a href="#cb80-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb80-362"><a href="#cb80-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-363"><a href="#cb80-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-364"><a href="#cb80-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs Actual Sale Prices"</span>,</span>
<span id="cb80-365"><a href="#cb80-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(test_performance<span class="sc">$</span>.estimate[<span class="dv">1</span>], <span class="dv">2</span>)),</span>
<span id="cb80-366"><a href="#cb80-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb80-367"><a href="#cb80-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb80-368"><a href="#cb80-368" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-369"><a href="#cb80-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb80-370"><a href="#cb80-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-371"><a href="#cb80-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-372"><a href="#cb80-372" aria-hidden="true" tabindex="-1"></a><span class="fu">### Classification Metrics</span></span>
<span id="cb80-373"><a href="#cb80-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-374"><a href="#cb80-374" aria-hidden="true" tabindex="-1"></a>Let's also explore classification metrics:</span>
<span id="cb80-375"><a href="#cb80-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-378"><a href="#cb80-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-379"><a href="#cb80-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification problem</span></span>
<span id="cb80-380"><a href="#cb80-380" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb80-381"><a href="#cb80-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb80-382"><a href="#cb80-382" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb80-383"><a href="#cb80-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb80-384"><a href="#cb80-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-385"><a href="#cb80-385" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple classification workflow</span></span>
<span id="cb80-386"><a href="#cb80-386" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built, </span>
<span id="cb80-387"><a href="#cb80-387" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_class) <span class="sc">%&gt;%</span></span>
<span id="cb80-388"><a href="#cb80-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb80-389"><a href="#cb80-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-390"><a href="#cb80-390" aria-hidden="true" tabindex="-1"></a>class_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-391"><a href="#cb80-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb80-392"><a href="#cb80-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-393"><a href="#cb80-393" aria-hidden="true" tabindex="-1"></a>class_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-394"><a href="#cb80-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb80-395"><a href="#cb80-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(class_spec)</span>
<span id="cb80-396"><a href="#cb80-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-397"><a href="#cb80-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and predict</span></span>
<span id="cb80-398"><a href="#cb80-398" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb80-399"><a href="#cb80-399" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb80-400"><a href="#cb80-400" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb80-401"><a href="#cb80-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-402"><a href="#cb80-402" aria-hidden="true" tabindex="-1"></a>class_fit <span class="ot">&lt;-</span> class_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-403"><a href="#cb80-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(class_train)</span>
<span id="cb80-404"><a href="#cb80-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-405"><a href="#cb80-405" aria-hidden="true" tabindex="-1"></a>class_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb80-406"><a href="#cb80-406" aria-hidden="true" tabindex="-1"></a>  class_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(expensive),</span>
<span id="cb80-407"><a href="#cb80-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test),</span>
<span id="cb80-408"><a href="#cb80-408" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb80-409"><a href="#cb80-409" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-410"><a href="#cb80-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-411"><a href="#cb80-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification metrics</span></span>
<span id="cb80-412"><a href="#cb80-412" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb80-413"><a href="#cb80-413" aria-hidden="true" tabindex="-1"></a>  accuracy,</span>
<span id="cb80-414"><a href="#cb80-414" aria-hidden="true" tabindex="-1"></a>  precision,</span>
<span id="cb80-415"><a href="#cb80-415" aria-hidden="true" tabindex="-1"></a>  recall,</span>
<span id="cb80-416"><a href="#cb80-416" aria-hidden="true" tabindex="-1"></a>  f_meas,</span>
<span id="cb80-417"><a href="#cb80-417" aria-hidden="true" tabindex="-1"></a>  roc_auc,</span>
<span id="cb80-418"><a href="#cb80-418" aria-hidden="true" tabindex="-1"></a>  pr_auc</span>
<span id="cb80-419"><a href="#cb80-419" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-420"><a href="#cb80-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-421"><a href="#cb80-421" aria-hidden="true" tabindex="-1"></a>class_performance <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-422"><a href="#cb80-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb80-423"><a href="#cb80-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-424"><a href="#cb80-424" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(class_performance)</span>
<span id="cb80-425"><a href="#cb80-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-426"><a href="#cb80-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb80-427"><a href="#cb80-427" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-428"><a href="#cb80-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb80-429"><a href="#cb80-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-430"><a href="#cb80-430" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(conf_matrix, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb80-431"><a href="#cb80-431" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Confusion Matrix"</span>)</span>
<span id="cb80-432"><a href="#cb80-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-433"><a href="#cb80-433" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC curve</span></span>
<span id="cb80-434"><a href="#cb80-434" aria-hidden="true" tabindex="-1"></a>roc_curve_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-435"><a href="#cb80-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> expensive, .pred_yes)</span>
<span id="cb80-436"><a href="#cb80-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-437"><a href="#cb80-437" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(roc_curve_data) <span class="sc">+</span></span>
<span id="cb80-438"><a href="#cb80-438" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve"</span>) <span class="sc">+</span></span>
<span id="cb80-439"><a href="#cb80-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, </span>
<span id="cb80-440"><a href="#cb80-440" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC:"</span>, <span class="fu">round</span>(class_performance<span class="sc">$</span>.estimate[<span class="dv">5</span>], <span class="dv">3</span>)))</span>
<span id="cb80-441"><a href="#cb80-441" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-442"><a href="#cb80-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-443"><a href="#cb80-443" aria-hidden="true" tabindex="-1"></a><span class="fu">## Custom Metrics and Evaluation</span></span>
<span id="cb80-444"><a href="#cb80-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-445"><a href="#cb80-445" aria-hidden="true" tabindex="-1"></a>Sometimes you need custom metrics for your specific problem:</span>
<span id="cb80-446"><a href="#cb80-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-449"><a href="#cb80-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-450"><a href="#cb80-450" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom metric - Mean Absolute Percentage Error with threshold</span></span>
<span id="cb80-451"><a href="#cb80-451" aria-hidden="true" tabindex="-1"></a>mape_vec_threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">threshold =</span> <span class="fl">0.2</span>, <span class="at">na_rm =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb80-452"><a href="#cb80-452" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> <span class="fu">abs</span>((truth <span class="sc">-</span> estimate) <span class="sc">/</span> truth)</span>
<span id="cb80-453"><a href="#cb80-453" aria-hidden="true" tabindex="-1"></a>  errors[errors <span class="sc">&gt;</span> threshold] <span class="ot">&lt;-</span> threshold  <span class="co"># Cap errors at threshold</span></span>
<span id="cb80-454"><a href="#cb80-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(errors, <span class="at">na.rm =</span> na_rm)</span>
<span id="cb80-455"><a href="#cb80-455" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-456"><a href="#cb80-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-457"><a href="#cb80-457" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the custom metric directly</span></span>
<span id="cb80-458"><a href="#cb80-458" aria-hidden="true" tabindex="-1"></a>custom_mape <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-459"><a href="#cb80-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb80-460"><a href="#cb80-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_mape =</span> <span class="fu">mape_vec_threshold</span>(Sale_Price, .pred),</span>
<span id="cb80-461"><a href="#cb80-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>((Sale_Price <span class="sc">-</span> .pred) <span class="sc">/</span> Sale_Price))</span>
<span id="cb80-462"><a href="#cb80-462" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-463"><a href="#cb80-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-464"><a href="#cb80-464" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(custom_mape)</span>
<span id="cb80-465"><a href="#cb80-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-466"><a href="#cb80-466" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a business-specific metric</span></span>
<span id="cb80-467"><a href="#cb80-467" aria-hidden="true" tabindex="-1"></a><span class="co"># For example: penalize underestimation more than overestimation</span></span>
<span id="cb80-468"><a href="#cb80-468" aria-hidden="true" tabindex="-1"></a>asymmetric_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">under_weight =</span> <span class="dv">2</span>) {</span>
<span id="cb80-469"><a href="#cb80-469" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> truth <span class="sc">-</span> estimate</span>
<span id="cb80-470"><a href="#cb80-470" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(errors <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb80-471"><a href="#cb80-471" aria-hidden="true" tabindex="-1"></a>                   under_weight <span class="sc">*</span> errors<span class="sc">^</span><span class="dv">2</span>,  <span class="co"># Underestimation penalty</span></span>
<span id="cb80-472"><a href="#cb80-472" aria-hidden="true" tabindex="-1"></a>                   errors<span class="sc">^</span><span class="dv">2</span>)                  <span class="co"># Overestimation penalty</span></span>
<span id="cb80-473"><a href="#cb80-473" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>(result))</span>
<span id="cb80-474"><a href="#cb80-474" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-475"><a href="#cb80-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-476"><a href="#cb80-476" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply custom metric</span></span>
<span id="cb80-477"><a href="#cb80-477" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-478"><a href="#cb80-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-479"><a href="#cb80-479" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">asymmetric_loss</span>(Sale_Price, .pred)</span>
<span id="cb80-480"><a href="#cb80-480" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-481"><a href="#cb80-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb80-482"><a href="#cb80-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_rmse =</span> <span class="fu">rmse_vec</span>(Sale_Price, .pred),</span>
<span id="cb80-483"><a href="#cb80-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">mean</span>(asymmetric_rmse)</span>
<span id="cb80-484"><a href="#cb80-484" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-485"><a href="#cb80-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-486"><a href="#cb80-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-487"><a href="#cb80-487" aria-hidden="true" tabindex="-1"></a><span class="fu">## Advanced Workflow Techniques</span></span>
<span id="cb80-488"><a href="#cb80-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-489"><a href="#cb80-489" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting and Modifying Fitted Workflows</span></span>
<span id="cb80-490"><a href="#cb80-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-493"><a href="#cb80-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-494"><a href="#cb80-494" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components from fitted workflow</span></span>
<span id="cb80-495"><a href="#cb80-495" aria-hidden="true" tabindex="-1"></a>extracted_recipe <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-496"><a href="#cb80-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>()</span>
<span id="cb80-497"><a href="#cb80-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-498"><a href="#cb80-498" aria-hidden="true" tabindex="-1"></a>extracted_model <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-499"><a href="#cb80-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb80-500"><a href="#cb80-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-501"><a href="#cb80-501" aria-hidden="true" tabindex="-1"></a><span class="co"># Get preprocessing results</span></span>
<span id="cb80-502"><a href="#cb80-502" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-503"><a href="#cb80-503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-504"><a href="#cb80-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> ames_test)</span>
<span id="cb80-505"><a href="#cb80-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-506"><a href="#cb80-506" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(preprocessed_data)</span>
<span id="cb80-507"><a href="#cb80-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-508"><a href="#cb80-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract model coefficients</span></span>
<span id="cb80-509"><a href="#cb80-509" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-510"><a href="#cb80-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-511"><a href="#cb80-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb80-512"><a href="#cb80-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-513"><a href="#cb80-513" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coefficients)</span>
<span id="cb80-514"><a href="#cb80-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-515"><a href="#cb80-515" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable importance (if applicable)</span></span>
<span id="cb80-516"><a href="#cb80-516" aria-hidden="true" tabindex="-1"></a><span class="co"># For models that support it</span></span>
<span id="cb80-517"><a href="#cb80-517" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-518"><a href="#cb80-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb80-519"><a href="#cb80-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span> <span class="fu">set_mode</span>(<span class="st">"regression"</span>))</span>
<span id="cb80-520"><a href="#cb80-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-521"><a href="#cb80-521" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-522"><a href="#cb80-522" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb80-523"><a href="#cb80-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-524"><a href="#cb80-524" aria-hidden="true" tabindex="-1"></a>rf_importance <span class="ot">&lt;-</span> rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb80-525"><a href="#cb80-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-526"><a href="#cb80-526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>()</span>
<span id="cb80-527"><a href="#cb80-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-528"><a href="#cb80-528" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf_importance)</span>
<span id="cb80-529"><a href="#cb80-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-530"><a href="#cb80-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-531"><a href="#cb80-531" aria-hidden="true" tabindex="-1"></a><span class="fu">### Workflow Finalization</span></span>
<span id="cb80-532"><a href="#cb80-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-533"><a href="#cb80-533" aria-hidden="true" tabindex="-1"></a>After tuning (covered in next chapter), you finalize workflows:</span>
<span id="cb80-534"><a href="#cb80-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-537"><a href="#cb80-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-538"><a href="#cb80-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Finalize a workflow with best parameters</span></span>
<span id="cb80-539"><a href="#cb80-539" aria-hidden="true" tabindex="-1"></a><span class="co"># This would typically come from tuning</span></span>
<span id="cb80-540"><a href="#cb80-540" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb80-541"><a href="#cb80-541" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fl">0.01</span>,</span>
<span id="cb80-542"><a href="#cb80-542" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fl">0.5</span></span>
<span id="cb80-543"><a href="#cb80-543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-544"><a href="#cb80-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-545"><a href="#cb80-545" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunable workflow</span></span>
<span id="cb80-546"><a href="#cb80-546" aria-hidden="true" tabindex="-1"></a>tunable_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(</span>
<span id="cb80-547"><a href="#cb80-547" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fu">tune</span>(),</span>
<span id="cb80-548"><a href="#cb80-548" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fu">tune</span>()</span>
<span id="cb80-549"><a href="#cb80-549" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb80-550"><a href="#cb80-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb80-551"><a href="#cb80-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-552"><a href="#cb80-552" aria-hidden="true" tabindex="-1"></a>tunable_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-553"><a href="#cb80-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_normalized) <span class="sc">%&gt;%</span></span>
<span id="cb80-554"><a href="#cb80-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tunable_spec)</span>
<span id="cb80-555"><a href="#cb80-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-556"><a href="#cb80-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize with best parameters</span></span>
<span id="cb80-557"><a href="#cb80-557" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> tunable_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-558"><a href="#cb80-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_params)</span>
<span id="cb80-559"><a href="#cb80-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-560"><a href="#cb80-560" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_workflow)</span>
<span id="cb80-561"><a href="#cb80-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-562"><a href="#cb80-562" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final model on all training data</span></span>
<span id="cb80-563"><a href="#cb80-563" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-564"><a href="#cb80-564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb80-565"><a href="#cb80-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-566"><a href="#cb80-566" aria-hidden="true" tabindex="-1"></a><span class="co"># Last fit - train on all data, evaluate on test</span></span>
<span id="cb80-567"><a href="#cb80-567" aria-hidden="true" tabindex="-1"></a>last_fit_results <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-568"><a href="#cb80-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(<span class="at">split =</span> ames_split, <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq))</span>
<span id="cb80-569"><a href="#cb80-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-570"><a href="#cb80-570" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final metrics</span></span>
<span id="cb80-571"><a href="#cb80-571" aria-hidden="true" tabindex="-1"></a>final_metrics <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb80-572"><a href="#cb80-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb80-573"><a href="#cb80-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-574"><a href="#cb80-574" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_metrics)</span>
<span id="cb80-575"><a href="#cb80-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-576"><a href="#cb80-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final model</span></span>
<span id="cb80-577"><a href="#cb80-577" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb80-578"><a href="#cb80-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>()</span>
<span id="cb80-579"><a href="#cb80-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-580"><a href="#cb80-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-581"><a href="#cb80-581" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluating Model Assumptions</span></span>
<span id="cb80-582"><a href="#cb80-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-583"><a href="#cb80-583" aria-hidden="true" tabindex="-1"></a>Workflows make it easy to check model assumptions:</span>
<span id="cb80-584"><a href="#cb80-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-587"><a href="#cb80-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-588"><a href="#cb80-588" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual analysis for regression</span></span>
<span id="cb80-589"><a href="#cb80-589" aria-hidden="true" tabindex="-1"></a>residual_analysis <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-590"><a href="#cb80-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-591"><a href="#cb80-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> .pred,</span>
<span id="cb80-592"><a href="#cb80-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_residual =</span> residual <span class="sc">/</span> <span class="fu">sd</span>(residual),</span>
<span id="cb80-593"><a href="#cb80-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_residual =</span> <span class="fu">abs</span>(residual)</span>
<span id="cb80-594"><a href="#cb80-594" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-595"><a href="#cb80-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-596"><a href="#cb80-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual plots</span></span>
<span id="cb80-597"><a href="#cb80-597" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb80-598"><a href="#cb80-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb80-599"><a href="#cb80-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb80-600"><a href="#cb80-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-601"><a href="#cb80-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Fitted"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb80-602"><a href="#cb80-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-603"><a href="#cb80-603" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">sample =</span> std_residual)) <span class="sc">+</span></span>
<span id="cb80-604"><a href="#cb80-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb80-605"><a href="#cb80-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb80-606"><a href="#cb80-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q Plot"</span>, <span class="at">x =</span> <span class="st">"Theoretical Quantiles"</span>, <span class="at">y =</span> <span class="st">"Standardized Residuals"</span>)</span>
<span id="cb80-607"><a href="#cb80-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-608"><a href="#cb80-608" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> <span class="fu">sqrt</span>(abs_residual))) <span class="sc">+</span></span>
<span id="cb80-609"><a href="#cb80-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb80-610"><a href="#cb80-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-611"><a href="#cb80-611" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scale-Location"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"√|Residuals|"</span>)</span>
<span id="cb80-612"><a href="#cb80-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-613"><a href="#cb80-613" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> residual)) <span class="sc">+</span></span>
<span id="cb80-614"><a href="#cb80-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb80-615"><a href="#cb80-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(count)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-616"><a href="#cb80-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Distribution"</span>, <span class="at">x =</span> <span class="st">"Residuals"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb80-617"><a href="#cb80-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-618"><a href="#cb80-618" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb80-619"><a href="#cb80-619" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4) <span class="sc">+</span></span>
<span id="cb80-620"><a href="#cb80-620" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Regression Diagnostics"</span>)</span>
<span id="cb80-621"><a href="#cb80-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-622"><a href="#cb80-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-623"><a href="#cb80-623" aria-hidden="true" tabindex="-1"></a><span class="fu">## Probability Calibration</span></span>
<span id="cb80-624"><a href="#cb80-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-625"><a href="#cb80-625" aria-hidden="true" tabindex="-1"></a>For classification, we often need well-calibrated probabilities:</span>
<span id="cb80-626"><a href="#cb80-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-629"><a href="#cb80-629" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-630"><a href="#cb80-630" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration analysis</span></span>
<span id="cb80-631"><a href="#cb80-631" aria-hidden="true" tabindex="-1"></a>calibration_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-632"><a href="#cb80-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-633"><a href="#cb80-633" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_bin =</span> <span class="fu">cut</span>(.pred_yes, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-634"><a href="#cb80-634" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-635"><a href="#cb80-635" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prob_bin) <span class="sc">%&gt;%</span></span>
<span id="cb80-636"><a href="#cb80-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb80-637"><a href="#cb80-637" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_predicted =</span> <span class="fu">mean</span>(.pred_yes),</span>
<span id="cb80-638"><a href="#cb80-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction_positive =</span> <span class="fu">mean</span>(expensive <span class="sc">==</span> <span class="st">"yes"</span>),</span>
<span id="cb80-639"><a href="#cb80-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb80-640"><a href="#cb80-640" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb80-641"><a href="#cb80-641" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-642"><a href="#cb80-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">5</span>)  <span class="co"># Remove bins with few observations</span></span>
<span id="cb80-643"><a href="#cb80-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-644"><a href="#cb80-644" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration plot</span></span>
<span id="cb80-645"><a href="#cb80-645" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb80-646"><a href="#cb80-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb80-647"><a href="#cb80-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb80-648"><a href="#cb80-648" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb80-649"><a href="#cb80-649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb80-650"><a href="#cb80-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-651"><a href="#cb80-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Probability Calibration Plot"</span>,</span>
<span id="cb80-652"><a href="#cb80-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Well-calibrated models follow the diagonal"</span>,</span>
<span id="cb80-653"><a href="#cb80-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb80-654"><a href="#cb80-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb80-655"><a href="#cb80-655" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb80-656"><a href="#cb80-656" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-657"><a href="#cb80-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb80-658"><a href="#cb80-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb80-659"><a href="#cb80-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-660"><a href="#cb80-660" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probably package for calibration</span></span>
<span id="cb80-661"><a href="#cb80-661" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb80-662"><a href="#cb80-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-663"><a href="#cb80-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple calibration visualization</span></span>
<span id="cb80-664"><a href="#cb80-664" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll just show the calibration plot without the probably package functions</span></span>
<span id="cb80-665"><a href="#cb80-665" aria-hidden="true" tabindex="-1"></a><span class="co"># that are causing issues</span></span>
<span id="cb80-666"><a href="#cb80-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-667"><a href="#cb80-667" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple comparison</span></span>
<span id="cb80-668"><a href="#cb80-668" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb80-669"><a href="#cb80-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-670"><a href="#cb80-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb80-671"><a href="#cb80-671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-672"><a href="#cb80-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb80-673"><a href="#cb80-673" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-674"><a href="#cb80-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Calibration Assessment"</span>,</span>
<span id="cb80-675"><a href="#cb80-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points should follow the red diagonal for perfect calibration"</span>,</span>
<span id="cb80-676"><a href="#cb80-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb80-677"><a href="#cb80-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb80-678"><a href="#cb80-678" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb80-679"><a href="#cb80-679" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-680"><a href="#cb80-680" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb80-681"><a href="#cb80-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-682"><a href="#cb80-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb80-683"><a href="#cb80-683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-684"><a href="#cb80-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-685"><a href="#cb80-685" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Visualization</span></span>
<span id="cb80-686"><a href="#cb80-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-687"><a href="#cb80-687" aria-hidden="true" tabindex="-1"></a>Create comprehensive performance visualizations:</span>
<span id="cb80-688"><a href="#cb80-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-691"><a href="#cb80-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-692"><a href="#cb80-692" aria-hidden="true" tabindex="-1"></a><span class="co"># For regression: actual vs predicted with confidence bands</span></span>
<span id="cb80-693"><a href="#cb80-693" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-694"><a href="#cb80-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb80-695"><a href="#cb80-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb80-696"><a href="#cb80-696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-697"><a href="#cb80-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-698"><a href="#cb80-698" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb80-699"><a href="#cb80-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-700"><a href="#cb80-700" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Accuracy"</span>,</span>
<span id="cb80-701"><a href="#cb80-701" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"R² ="</span>, <span class="fu">round</span>(<span class="fu">rsq_vec</span>(test_predictions<span class="sc">$</span>Sale_Price, </span>
<span id="cb80-702"><a href="#cb80-702" aria-hidden="true" tabindex="-1"></a>                                          test_predictions<span class="sc">$</span>.pred), <span class="dv">3</span>)),</span>
<span id="cb80-703"><a href="#cb80-703" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Price"</span>,</span>
<span id="cb80-704"><a href="#cb80-704" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Price"</span></span>
<span id="cb80-705"><a href="#cb80-705" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-706"><a href="#cb80-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb80-707"><a href="#cb80-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-708"><a href="#cb80-708" aria-hidden="true" tabindex="-1"></a><span class="co"># Error distribution</span></span>
<span id="cb80-709"><a href="#cb80-709" aria-hidden="true" tabindex="-1"></a>error_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-710"><a href="#cb80-710" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> .pred <span class="sc">-</span> Sale_Price,</span>
<span id="cb80-711"><a href="#cb80-711" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_error =</span> error <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-712"><a href="#cb80-712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error)) <span class="sc">+</span></span>
<span id="cb80-713"><a href="#cb80-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb80-714"><a href="#cb80-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb80-715"><a href="#cb80-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-716"><a href="#cb80-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Error Distribution"</span>,</span>
<span id="cb80-717"><a href="#cb80-717" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage error"</span>,</span>
<span id="cb80-718"><a href="#cb80-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Error (%)"</span>,</span>
<span id="cb80-719"><a href="#cb80-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb80-720"><a href="#cb80-720" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-721"><a href="#cb80-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-722"><a href="#cb80-722" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="sc">+</span> error_plot</span>
<span id="cb80-723"><a href="#cb80-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-724"><a href="#cb80-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-725"><a href="#cb80-725" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Practices for Workflows</span></span>
<span id="cb80-726"><a href="#cb80-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-727"><a href="#cb80-727" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Always Use Workflows for Production</span></span>
<span id="cb80-728"><a href="#cb80-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-731"><a href="#cb80-731" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-732"><a href="#cb80-732" aria-hidden="true" tabindex="-1"></a><span class="co"># Good practice: Complete workflow</span></span>
<span id="cb80-733"><a href="#cb80-733" aria-hidden="true" tabindex="-1"></a>production_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-734"><a href="#cb80-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb80-735"><a href="#cb80-735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-736"><a href="#cb80-736" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-737"><a href="#cb80-737" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-738"><a href="#cb80-738" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-739"><a href="#cb80-739" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb80-740"><a href="#cb80-740" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-741"><a href="#cb80-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb80-742"><a href="#cb80-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb80-743"><a href="#cb80-743" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-744"><a href="#cb80-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-745"><a href="#cb80-745" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures all preprocessing is contained and reproducible</span></span>
<span id="cb80-746"><a href="#cb80-746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-747"><a href="#cb80-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-748"><a href="#cb80-748" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Version Control Your Workflows</span></span>
<span id="cb80-749"><a href="#cb80-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-752"><a href="#cb80-752" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-753"><a href="#cb80-753" aria-hidden="true" tabindex="-1"></a><span class="co"># Save workflow for reproducibility</span></span>
<span id="cb80-754"><a href="#cb80-754" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_fit, <span class="st">"models/final_workflow_v1.rds"</span>)</span>
<span id="cb80-755"><a href="#cb80-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-756"><a href="#cb80-756" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and use later</span></span>
<span id="cb80-757"><a href="#cb80-757" aria-hidden="true" tabindex="-1"></a><span class="co"># loaded_workflow &lt;- readRDS("models/final_workflow_v1.rds")</span></span>
<span id="cb80-758"><a href="#cb80-758" aria-hidden="true" tabindex="-1"></a><span class="co"># new_predictions &lt;- predict(loaded_workflow, new_data)</span></span>
<span id="cb80-759"><a href="#cb80-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-760"><a href="#cb80-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-761"><a href="#cb80-761" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Document Your Choices</span></span>
<span id="cb80-762"><a href="#cb80-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-765"><a href="#cb80-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-766"><a href="#cb80-766" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow with documentation</span></span>
<span id="cb80-767"><a href="#cb80-767" aria-hidden="true" tabindex="-1"></a>documented_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-768"><a href="#cb80-768" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb80-769"><a href="#cb80-769" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-770"><a href="#cb80-770" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle missing values before other steps</span></span>
<span id="cb80-771"><a href="#cb80-771" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-772"><a href="#cb80-772" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Normalize for model stability</span></span>
<span id="cb80-773"><a href="#cb80-773" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-774"><a href="#cb80-774" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create dummies for linear model</span></span>
<span id="cb80-775"><a href="#cb80-775" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb80-776"><a href="#cb80-776" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-777"><a href="#cb80-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb80-778"><a href="#cb80-778" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression to handle multicollinearity</span></span>
<span id="cb80-779"><a href="#cb80-779" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-780"><a href="#cb80-780" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb80-781"><a href="#cb80-781" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-782"><a href="#cb80-782" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-783"><a href="#cb80-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-784"><a href="#cb80-784" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb80-785"><a href="#cb80-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-786"><a href="#cb80-786" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Build a Complete Evaluation Pipeline</span></span>
<span id="cb80-787"><a href="#cb80-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-788"><a href="#cb80-788" aria-hidden="true" tabindex="-1"></a>Create a workflow and comprehensive evaluation:</span>
<span id="cb80-789"><a href="#cb80-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-792"><a href="#cb80-792" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-793"><a href="#cb80-793" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb80-794"><a href="#cb80-794" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a complete evaluation pipeline</span></span>
<span id="cb80-795"><a href="#cb80-795" aria-hidden="true" tabindex="-1"></a>eval_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb80-796"><a href="#cb80-796" aria-hidden="true" tabindex="-1"></a>                      Neighborhood <span class="sc">+</span> Total_Bsmt_SF, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-797"><a href="#cb80-797" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price, <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="co"># Skip for prediction</span></span>
<span id="cb80-798"><a href="#cb80-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-799"><a href="#cb80-799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-800"><a href="#cb80-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb80-801"><a href="#cb80-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-802"><a href="#cb80-802" aria-hidden="true" tabindex="-1"></a>eval_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-803"><a href="#cb80-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb80-804"><a href="#cb80-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-805"><a href="#cb80-805" aria-hidden="true" tabindex="-1"></a>eval_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-806"><a href="#cb80-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(eval_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb80-807"><a href="#cb80-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(eval_spec)</span>
<span id="cb80-808"><a href="#cb80-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-809"><a href="#cb80-809" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit with cross-validation</span></span>
<span id="cb80-810"><a href="#cb80-810" aria-hidden="true" tabindex="-1"></a>eval_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb80-811"><a href="#cb80-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-812"><a href="#cb80-812" aria-hidden="true" tabindex="-1"></a>eval_results <span class="ot">&lt;-</span> eval_workflow <span class="sc">%&gt;%</span></span>
<span id="cb80-813"><a href="#cb80-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb80-814"><a href="#cb80-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> eval_folds,</span>
<span id="cb80-815"><a href="#cb80-815" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>mape),</span>
<span id="cb80-816"><a href="#cb80-816" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-817"><a href="#cb80-817" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-818"><a href="#cb80-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-819"><a href="#cb80-819" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize performance</span></span>
<span id="cb80-820"><a href="#cb80-820" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(eval_results)</span>
<span id="cb80-821"><a href="#cb80-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-822"><a href="#cb80-822" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions for visualization</span></span>
<span id="cb80-823"><a href="#cb80-823" aria-hidden="true" tabindex="-1"></a>eval_predictions <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(eval_results)</span>
<span id="cb80-824"><a href="#cb80-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-825"><a href="#cb80-825" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize CV performance</span></span>
<span id="cb80-826"><a href="#cb80-826" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eval_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb80-827"><a href="#cb80-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb80-828"><a href="#cb80-828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb80-829"><a href="#cb80-829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>id, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb80-830"><a href="#cb80-830" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions Across CV Folds"</span>)</span>
<span id="cb80-831"><a href="#cb80-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-832"><a href="#cb80-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-833"><a href="#cb80-833" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Compare Preprocessing Strategies</span></span>
<span id="cb80-834"><a href="#cb80-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-835"><a href="#cb80-835" aria-hidden="true" tabindex="-1"></a>Evaluate different preprocessing approaches:</span>
<span id="cb80-836"><a href="#cb80-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-839"><a href="#cb80-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-840"><a href="#cb80-840" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb80-841"><a href="#cb80-841" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different preprocessing strategies</span></span>
<span id="cb80-842"><a href="#cb80-842" aria-hidden="true" tabindex="-1"></a>preproc_minimal <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb80-843"><a href="#cb80-843" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> ames_train)</span>
<span id="cb80-844"><a href="#cb80-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-845"><a href="#cb80-845" aria-hidden="true" tabindex="-1"></a>preproc_standard <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb80-846"><a href="#cb80-846" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-847"><a href="#cb80-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb80-848"><a href="#cb80-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-849"><a href="#cb80-849" aria-hidden="true" tabindex="-1"></a>preproc_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb80-850"><a href="#cb80-850" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb80-851"><a href="#cb80-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-852"><a href="#cb80-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb80-853"><a href="#cb80-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Year_Built)</span>
<span id="cb80-854"><a href="#cb80-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-855"><a href="#cb80-855" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflows</span></span>
<span id="cb80-856"><a href="#cb80-856" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb80-857"><a href="#cb80-857" aria-hidden="true" tabindex="-1"></a>  <span class="at">minimal =</span> preproc_minimal,</span>
<span id="cb80-858"><a href="#cb80-858" aria-hidden="true" tabindex="-1"></a>  <span class="at">standard =</span> preproc_standard,</span>
<span id="cb80-859"><a href="#cb80-859" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> preproc_complex</span>
<span id="cb80-860"><a href="#cb80-860" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb80-861"><a href="#cb80-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-862"><a href="#cb80-862" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model for all</span></span>
<span id="cb80-863"><a href="#cb80-863" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb80-864"><a href="#cb80-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-865"><a href="#cb80-865" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and evaluate workflows</span></span>
<span id="cb80-866"><a href="#cb80-866" aria-hidden="true" tabindex="-1"></a>strategy_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(strategy_name) {</span>
<span id="cb80-867"><a href="#cb80-867" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-868"><a href="#cb80-868" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb80-869"><a href="#cb80-869" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb80-870"><a href="#cb80-870" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-871"><a href="#cb80-871" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb80-872"><a href="#cb80-872" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb80-873"><a href="#cb80-873" aria-hidden="true" tabindex="-1"></a>    wf,</span>
<span id="cb80-874"><a href="#cb80-874" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb80-875"><a href="#cb80-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb80-876"><a href="#cb80-876" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-877"><a href="#cb80-877" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb80-878"><a href="#cb80-878" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb80-879"><a href="#cb80-879" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb80-880"><a href="#cb80-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-881"><a href="#cb80-881" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare strategies</span></span>
<span id="cb80-882"><a href="#cb80-882" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(strategy_results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb80-883"><a href="#cb80-883" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb80-884"><a href="#cb80-884" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb80-885"><a href="#cb80-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb80-886"><a href="#cb80-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Preprocessing Strategy Comparison"</span>) <span class="sc">+</span></span>
<span id="cb80-887"><a href="#cb80-887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb80-888"><a href="#cb80-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-889"><a href="#cb80-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-890"><a href="#cb80-890" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Custom Metrics for Business Goals</span></span>
<span id="cb80-891"><a href="#cb80-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-892"><a href="#cb80-892" aria-hidden="true" tabindex="-1"></a>Create business-specific metrics:</span>
<span id="cb80-893"><a href="#cb80-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-896"><a href="#cb80-896" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb80-897"><a href="#cb80-897" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb80-898"><a href="#cb80-898" aria-hidden="true" tabindex="-1"></a><span class="co"># Business scenario: Real estate company</span></span>
<span id="cb80-899"><a href="#cb80-899" aria-hidden="true" tabindex="-1"></a><span class="co"># - Overestimating is bad (disappointed customers)</span></span>
<span id="cb80-900"><a href="#cb80-900" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &lt;5% is acceptable</span></span>
<span id="cb80-901"><a href="#cb80-901" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &gt;5% is very bad (lost opportunity)</span></span>
<span id="cb80-902"><a href="#cb80-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-903"><a href="#cb80-903" aria-hidden="true" tabindex="-1"></a>business_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate) {</span>
<span id="cb80-904"><a href="#cb80-904" aria-hidden="true" tabindex="-1"></a>  pct_error <span class="ot">&lt;-</span> (estimate <span class="sc">-</span> truth) <span class="sc">/</span> truth <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb80-905"><a href="#cb80-905" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-906"><a href="#cb80-906" aria-hidden="true" tabindex="-1"></a>  penalties <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb80-907"><a href="#cb80-907" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">2</span>,        <span class="co"># Overestimate penalty</span></span>
<span id="cb80-908"><a href="#cb80-908" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="fl">0.5</span>,     <span class="co"># Small underestimate</span></span>
<span id="cb80-909"><a href="#cb80-909" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">3</span>                  <span class="co"># Large underestimate penalty</span></span>
<span id="cb80-910"><a href="#cb80-910" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-911"><a href="#cb80-911" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb80-912"><a href="#cb80-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(penalties)</span>
<span id="cb80-913"><a href="#cb80-913" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-914"><a href="#cb80-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-915"><a href="#cb80-915" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test predictions</span></span>
<span id="cb80-916"><a href="#cb80-916" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-917"><a href="#cb80-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-918"><a href="#cb80-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">business_score =</span> <span class="fu">business_metric</span>(Sale_Price, .pred),</span>
<span id="cb80-919"><a href="#cb80-919" aria-hidden="true" tabindex="-1"></a>    <span class="at">standard_mape =</span> <span class="fu">mape_vec</span>(Sale_Price, .pred)</span>
<span id="cb80-920"><a href="#cb80-920" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-921"><a href="#cb80-921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb80-922"><a href="#cb80-922" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_business_score =</span> <span class="fu">mean</span>(business_score),</span>
<span id="cb80-923"><a href="#cb80-923" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_standard_mape =</span> <span class="fu">mean</span>(standard_mape)</span>
<span id="cb80-924"><a href="#cb80-924" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-925"><a href="#cb80-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-926"><a href="#cb80-926" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize business metric</span></span>
<span id="cb80-927"><a href="#cb80-927" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-928"><a href="#cb80-928" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb80-929"><a href="#cb80-929" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_error =</span> (.pred <span class="sc">-</span> Sale_Price) <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb80-930"><a href="#cb80-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">error_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb80-931"><a href="#cb80-931" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Overestimate"</span>,</span>
<span id="cb80-932"><a href="#cb80-932" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"Small Underestimate"</span>,</span>
<span id="cb80-933"><a href="#cb80-933" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Large Underestimate"</span></span>
<span id="cb80-934"><a href="#cb80-934" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb80-935"><a href="#cb80-935" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb80-936"><a href="#cb80-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error, <span class="at">fill =</span> error_category)) <span class="sc">+</span></span>
<span id="cb80-937"><a href="#cb80-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb80-938"><a href="#cb80-938" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb80-939"><a href="#cb80-939" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Overestimate"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb80-940"><a href="#cb80-940" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small Underestimate"</span> <span class="ot">=</span> <span class="st">"yellow"</span>,</span>
<span id="cb80-941"><a href="#cb80-941" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large Underestimate"</span> <span class="ot">=</span> <span class="st">"darkred"</span></span>
<span id="cb80-942"><a href="#cb80-942" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb80-943"><a href="#cb80-943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-944"><a href="#cb80-944" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Business Impact of Prediction Errors"</span>,</span>
<span id="cb80-945"><a href="#cb80-945" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Error"</span>,</span>
<span id="cb80-946"><a href="#cb80-946" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb80-947"><a href="#cb80-947" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Error Category"</span></span>
<span id="cb80-948"><a href="#cb80-948" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-949"><a href="#cb80-949" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb80-950"><a href="#cb80-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-951"><a href="#cb80-951" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb80-952"><a href="#cb80-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-953"><a href="#cb80-953" aria-hidden="true" tabindex="-1"></a>In this comprehensive chapter, you've mastered:</span>
<span id="cb80-954"><a href="#cb80-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-955"><a href="#cb80-955" aria-hidden="true" tabindex="-1"></a>✅ **Workflow fundamentals**</span>
<span id="cb80-956"><a href="#cb80-956" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Combining preprocessing and models</span>
<span id="cb80-957"><a href="#cb80-957" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Preventing data leakage</span>
<span id="cb80-958"><a href="#cb80-958" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Ensuring reproducibility</span>
<span id="cb80-959"><a href="#cb80-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-960"><a href="#cb80-960" aria-hidden="true" tabindex="-1"></a>✅ **Workflow components**</span>
<span id="cb80-961"><a href="#cb80-961" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Adding and updating recipes/models</span>
<span id="cb80-962"><a href="#cb80-962" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Formula vs recipe interfaces</span>
<span id="cb80-963"><a href="#cb80-963" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Modular design</span>
<span id="cb80-964"><a href="#cb80-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-965"><a href="#cb80-965" aria-hidden="true" tabindex="-1"></a>✅ **Workflow sets**</span>
<span id="cb80-966"><a href="#cb80-966" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Comparing multiple approaches</span>
<span id="cb80-967"><a href="#cb80-967" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Systematic evaluation</span>
<span id="cb80-968"><a href="#cb80-968" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Ranking and selection</span>
<span id="cb80-969"><a href="#cb80-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-970"><a href="#cb80-970" aria-hidden="true" tabindex="-1"></a>✅ **Model evaluation**</span>
<span id="cb80-971"><a href="#cb80-971" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Comprehensive metrics with yardstick</span>
<span id="cb80-972"><a href="#cb80-972" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Custom metrics for business needs</span>
<span id="cb80-973"><a href="#cb80-973" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Visualization techniques</span>
<span id="cb80-974"><a href="#cb80-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-975"><a href="#cb80-975" aria-hidden="true" tabindex="-1"></a>✅ **Advanced techniques**</span>
<span id="cb80-976"><a href="#cb80-976" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extracting workflow components</span>
<span id="cb80-977"><a href="#cb80-977" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Probability calibration</span>
<span id="cb80-978"><a href="#cb80-978" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Model diagnostics</span>
<span id="cb80-979"><a href="#cb80-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-980"><a href="#cb80-980" aria-hidden="true" tabindex="-1"></a>Key takeaways:</span>
<span id="cb80-981"><a href="#cb80-981" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Always use workflows for production models</span>
<span id="cb80-982"><a href="#cb80-982" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflows prevent data leakage automatically</span>
<span id="cb80-983"><a href="#cb80-983" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow sets enable systematic comparison</span>
<span id="cb80-984"><a href="#cb80-984" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Custom metrics align models with business goals</span>
<span id="cb80-985"><a href="#cb80-985" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Proper evaluation is crucial for model trust</span>
<span id="cb80-986"><a href="#cb80-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-987"><a href="#cb80-987" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Next?</span></span>
<span id="cb80-988"><a href="#cb80-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-989"><a href="#cb80-989" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">Chapter 13</span><span class="co">](13-hyperparameter-tuning.Rmd)</span>, we'll explore hyperparameter tuning to optimize model performance.</span>
<span id="cb80-990"><a href="#cb80-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-991"><a href="#cb80-991" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Resources</span></span>
<span id="cb80-992"><a href="#cb80-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-993"><a href="#cb80-993" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">workflows Documentation</span><span class="co">](https://workflows.tidymodels.org/)</span></span>
<span id="cb80-994"><a href="#cb80-994" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">workflowsets Documentation</span><span class="co">](https://workflowsets.tidymodels.org/)</span></span>
<span id="cb80-995"><a href="#cb80-995" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">yardstick Documentation</span><span class="co">](https://yardstick.tidymodels.org/)</span></span>
<span id="cb80-996"><a href="#cb80-996" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Tidy Modeling with R - Workflows Chapter</span><span class="co">](https://www.tmwr.org/workflows.html)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>