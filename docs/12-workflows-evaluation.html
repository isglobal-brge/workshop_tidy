<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David Sarrat González, Juan R González">
<meta name="dcterms.date" content="2025-10-06">

<title>Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines – Tidyverse &amp; Machine Learning Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-90ee96a17764a76d4fcf3f331faa145e.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Tidyverse &amp; Machine Learning Workshop</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-1-tidyverse" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 1: Tidyverse</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-1-tidyverse">    
        <li>
    <a class="dropdown-item" href="./01-introduction.html">
 <span class="dropdown-text">Ch 1: Introduction to Tidyverse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02-data-import.html">
 <span class="dropdown-text">Ch 2: Data Import with readr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03-data-wrangling.html">
 <span class="dropdown-text">Ch 3: Data Wrangling with dplyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04-data-tidying.html">
 <span class="dropdown-text">Ch 4: Data Tidying with tidyr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05-visualization.html">
 <span class="dropdown-text">Ch 5: Visualization with ggplot2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06-functional-programming.html">
 <span class="dropdown-text">Ch 6: Functional Programming with purrr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07-strings-dates.html">
 <span class="dropdown-text">Ch 7: Strings and Dates</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-1.html">
 <span class="dropdown-text">Block 1 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-2-tidymodels" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 2: Tidymodels</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-2-tidymodels">    
        <li>
    <a class="dropdown-item" href="./08-tidymodels-intro.html">
 <span class="dropdown-text">Ch 8: Introduction to Tidymodels</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09-data-splitting.html">
 <span class="dropdown-text">Ch 9: Data Splitting &amp; Resampling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10-feature-engineering.html">
 <span class="dropdown-text">Ch 10: Feature Engineering</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11-model-specification.html">
 <span class="dropdown-text">Ch 11: Model Specification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12-workflows-evaluation.html">
 <span class="dropdown-text">Ch 12: Workflows &amp; Evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13-hyperparameter-tuning.html">
 <span class="dropdown-text">Ch 13: Hyperparameter Tuning</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-2.html">
 <span class="dropdown-text">Block 2 Assessment</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-part-3-machine-learning" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Part 3: Machine Learning</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-part-3-machine-learning">    
        <li>
    <a class="dropdown-item" href="./14-classification.html">
 <span class="dropdown-text">Ch 14: Classification Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./15-regression.html">
 <span class="dropdown-text">Ch 15: Regression Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./16-ensemble-methods.html">
 <span class="dropdown-text">Ch 16: Ensemble Methods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./17-unsupervised-learning.html">
 <span class="dropdown-text">Ch 17: Unsupervised Learning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./18-model-deployment.html">
 <span class="dropdown-text">Ch 18: Model Deployment</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="./quiz-block-3.html">
 <span class="dropdown-text">Block 3 Assessment</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a></li>
  <li><a href="#why-workflows-matter" id="toc-why-workflows-matter" class="nav-link" data-scroll-target="#why-workflows-matter">Why Workflows Matter</a></li>
  <li><a href="#building-your-first-workflow" id="toc-building-your-first-workflow" class="nav-link" data-scroll-target="#building-your-first-workflow">Building Your First Workflow</a></li>
  <li><a href="#workflow-components" id="toc-workflow-components" class="nav-link" data-scroll-target="#workflow-components">Workflow Components</a>
  <ul class="collapse">
  <li><a href="#adding-and-modifying-components" id="toc-adding-and-modifying-components" class="nav-link" data-scroll-target="#adding-and-modifying-components">Adding and Modifying Components</a></li>
  <li><a href="#formula-vs-recipe-interface" id="toc-formula-vs-recipe-interface" class="nav-link" data-scroll-target="#formula-vs-recipe-interface">Formula vs Recipe Interface</a></li>
  </ul></li>
  <li><a href="#fitting-and-predicting-with-workflows" id="toc-fitting-and-predicting-with-workflows" class="nav-link" data-scroll-target="#fitting-and-predicting-with-workflows">Fitting and Predicting with Workflows</a></li>
  <li><a href="#workflow-sets-comparing-multiple-approaches" id="toc-workflow-sets-comparing-multiple-approaches" class="nav-link" data-scroll-target="#workflow-sets-comparing-multiple-approaches">Workflow Sets: Comparing Multiple Approaches</a>
  <ul class="collapse">
  <li><a href="#evaluating-workflow-sets" id="toc-evaluating-workflow-sets" class="nav-link" data-scroll-target="#evaluating-workflow-sets">Evaluating Workflow Sets</a></li>
  </ul></li>
  <li><a href="#model-evaluation-with-yardstick" id="toc-model-evaluation-with-yardstick" class="nav-link" data-scroll-target="#model-evaluation-with-yardstick">Model Evaluation with yardstick</a>
  <ul class="collapse">
  <li><a href="#regression-metrics" id="toc-regression-metrics" class="nav-link" data-scroll-target="#regression-metrics">Regression Metrics</a></li>
  <li><a href="#classification-metrics" id="toc-classification-metrics" class="nav-link" data-scroll-target="#classification-metrics">Classification Metrics</a></li>
  </ul></li>
  <li><a href="#custom-metrics-and-evaluation" id="toc-custom-metrics-and-evaluation" class="nav-link" data-scroll-target="#custom-metrics-and-evaluation">Custom Metrics and Evaluation</a></li>
  <li><a href="#advanced-workflow-techniques" id="toc-advanced-workflow-techniques" class="nav-link" data-scroll-target="#advanced-workflow-techniques">Advanced Workflow Techniques</a>
  <ul class="collapse">
  <li><a href="#extracting-and-modifying-fitted-workflows" id="toc-extracting-and-modifying-fitted-workflows" class="nav-link" data-scroll-target="#extracting-and-modifying-fitted-workflows">Extracting and Modifying Fitted Workflows</a></li>
  <li><a href="#workflow-finalization" id="toc-workflow-finalization" class="nav-link" data-scroll-target="#workflow-finalization">Workflow Finalization</a></li>
  </ul></li>
  <li><a href="#evaluating-model-assumptions" id="toc-evaluating-model-assumptions" class="nav-link" data-scroll-target="#evaluating-model-assumptions">Evaluating Model Assumptions</a></li>
  <li><a href="#probability-calibration" id="toc-probability-calibration" class="nav-link" data-scroll-target="#probability-calibration">Probability Calibration</a></li>
  <li><a href="#performance-visualization" id="toc-performance-visualization" class="nav-link" data-scroll-target="#performance-visualization">Performance Visualization</a></li>
  <li><a href="#best-practices-for-workflows" id="toc-best-practices-for-workflows" class="nav-link" data-scroll-target="#best-practices-for-workflows">Best Practices for Workflows</a>
  <ul class="collapse">
  <li><a href="#always-use-workflows-for-production" id="toc-always-use-workflows-for-production" class="nav-link" data-scroll-target="#always-use-workflows-for-production">1. Always Use Workflows for Production</a></li>
  <li><a href="#version-control-your-workflows" id="toc-version-control-your-workflows" class="nav-link" data-scroll-target="#version-control-your-workflows">2. Version Control Your Workflows</a></li>
  <li><a href="#document-your-choices" id="toc-document-your-choices" class="nav-link" data-scroll-target="#document-your-choices">3. Document Your Choices</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-build-a-complete-evaluation-pipeline" id="toc-exercise-1-build-a-complete-evaluation-pipeline" class="nav-link" data-scroll-target="#exercise-1-build-a-complete-evaluation-pipeline">Exercise 1: Build a Complete Evaluation Pipeline</a></li>
  <li><a href="#exercise-2-compare-preprocessing-strategies" id="toc-exercise-2-compare-preprocessing-strategies" class="nav-link" data-scroll-target="#exercise-2-compare-preprocessing-strategies">Exercise 2: Compare Preprocessing Strategies</a></li>
  <li><a href="#exercise-3-custom-metrics-for-business-goals" id="toc-exercise-3-custom-metrics-for-business-goals" class="nav-link" data-scroll-target="#exercise-3-custom-metrics-for-business-goals">Exercise 3: Custom Metrics for Business Goals</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#whats-next" id="toc-whats-next" class="nav-link" data-scroll-target="#whats-next">What’s Next?</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>David Sarrat González, Juan R González </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 6, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this chapter, you will master:</p>
<ul>
<li>The workflow concept and its importance</li>
<li>Combining preprocessing and modeling</li>
<li>Workflow sets for comparing multiple approaches</li>
<li>Comprehensive model evaluation with yardstick</li>
<li>Custom metrics and metric sets</li>
<li>Visualizing model performance</li>
<li>Workflow extraction and modification</li>
<li>Best practices for reproducible ML pipelines</li>
</ul>
</section>
<section id="why-workflows-matter" class="level2">
<h2 class="anchored" data-anchor-id="why-workflows-matter">Why Workflows Matter</h2>
<p>Imagine you’re baking a complex cake. You wouldn’t just throw ingredients together randomly - you’d follow a recipe that specifies the exact order of operations: mix dry ingredients, cream butter and sugar, combine wet and dry, bake at specific temperature. Machine learning is similar: the order and combination of steps matters immensely.</p>
<p>A workflow in tidymodels bundles together: 1. <strong>Preprocessing</strong> (recipes) 2. <strong>Model specification</strong> (parsnip) 3. <strong>Post-processing</strong> (if needed)</p>
<p>This bundling ensures: - <strong>Reproducibility</strong>: The exact same steps are applied to new data - <strong>Prevention of data leakage</strong>: Preprocessing parameters are learned only from training data - <strong>Simplicity</strong>: One object contains your entire modeling pipeline - <strong>Flexibility</strong>: Easy to swap components and compare approaches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching packages -------------------------------------- tidymodels 1.4.1 --</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>v broom        1.0.10     v recipes      1.3.1 
v dials        1.4.2      v rsample      1.3.1 
v dplyr        1.1.4      v tailor       0.1.0 
v ggplot2      4.0.0      v tidyr        1.3.1 
v infer        1.0.9      v tune         2.0.0 
v modeldata    1.5.1      v workflows    1.3.0 
v parsnip      1.3.3      v workflowsets 1.1.1 
v purrr        1.1.0      v yardstick    1.3.2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ----------------------------------------- tidymodels_conflicts() --
x purrr::discard() masks scales::discard()
x dplyr::filter()  masks stats::filter()
x dplyr::lag()     masks stats::lag()
x recipes::step()  masks stats::step()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching core tidyverse packages ------------------------ tidyverse 2.0.0 --
v forcats   1.0.0     v stringr   1.5.2
v lubridate 1.9.4     v tibble    3.3.0
v readr     2.1.5     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x readr::col_factor() masks scales::col_factor()
x purrr::discard()    masks scales::discard()
x dplyr::filter()     masks stats::filter()
x stringr::fixed()    masks recipes::fixed()
x dplyr::lag()        masks stats::lag()
x readr::spec()       masks yardstick::spec()
i Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'vip'

The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Adjuntando el paquete: 'probably'

The following objects are masked from 'package:base':

    as.factor, as.ordered</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example data</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="building-your-first-workflow" class="level2">
<h2 class="anchored" data-anchor-id="building-your-first-workflow">Building Your First Workflow</h2>
<p>Let’s start by understanding the problem with not using workflows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The WRONG way - manual preprocessing</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This approach is error-prone and can lead to data leakage</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual preprocessing on training data</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ames_train_processed <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log transform - uses training data statistics</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scaling - WRONG! Uses all training data including validation folds</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we need to remember these transformations for test data</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># And apply them consistently... but what were the scaling parameters?</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The RIGHT way - using workflows</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a recipe</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>ames_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                      Neighborhood, </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create a model specification</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine into a workflow</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>lm_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
<p>The workflow object now contains everything needed to go from raw data to predictions. This is incredibly powerful for maintaining consistency across training, validation, and deployment.</p>
</section>
<section id="workflow-components" class="level2">
<h2 class="anchored" data-anchor-id="workflow-components">Workflow Components</h2>
<section id="adding-and-modifying-components" class="level3">
<h3 class="anchored" data-anchor-id="adding-and-modifying-components">Adding and Modifying Components</h3>
<p>Workflows are modular - you can add, remove, or update components:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with an empty workflow</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add components step by step</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding recipe:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After adding recipe:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: None

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After adding model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also update components</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>updated_workflow <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After updating model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After updating model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(updated_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.01

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Or remove components</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>recipe_only <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_model</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After removing model:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "After removing model:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(recipe_only)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: None

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()</code></pre>
</div>
</div>
<p>This modularity is essential for: - <strong>Experimentation</strong>: Quickly try different models with same preprocessing - <strong>Model comparison</strong>: Keep preprocessing constant while varying models - <strong>Debugging</strong>: Test components independently</p>
</section>
<section id="formula-vs-recipe-interface" class="level3">
<h3 class="anchored" data-anchor-id="formula-vs-recipe-interface">Formula vs Recipe Interface</h3>
<p>Workflows support two interfaces for specifying predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: Formula interface (simple, no preprocessing)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>formula_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2: Recipe interface (complex preprocessing)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>recipe_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 3: Variables interface (programmatic)</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>vars_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_variables</span>(</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcomes =</span> Sale_Price,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> <span class="fu">c</span>(Gr_Liv_Area, Overall_Cond, Neighborhood)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the approaches</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Formula approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Formula approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>formula_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Formula
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
Sale_Price ~ Gr_Liv_Area + Overall_Cond

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recipe approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\nRecipe approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>recipe_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variables approach:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\nVariables approach:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>vars_workflow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Variables
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
Outcomes: Sale_Price
Predictors: c(Gr_Liv_Area, Overall_Cond, Neighborhood)

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
<p>Choose based on your needs: - <strong>Formula</strong>: Quick prototyping, simple models - <strong>Recipe</strong>: Complex preprocessing, feature engineering - <strong>Variables</strong>: Programmatic variable selection</p>
</section>
</section>
<section id="fitting-and-predicting-with-workflows" class="level2">
<h2 class="anchored" data-anchor-id="fitting-and-predicting-with-workflows">Fitting and Predicting with Workflows</h2>
<p>The workflow handles all the complexity of applying transformations consistently:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the workflow</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> ames_train)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The fitted workflow contains:</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. The prepared recipe (with learned parameters)</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The fitted model</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow [trained] ==========================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_normalize()
* step_dummy()

-- Model -----------------------------------------------------------------------

Call:
stats::lm(formula = ..y ~ ., data = data)

Coefficients:
                                         (Intercept)  
                                              164586  
                                         Gr_Liv_Area  
                                               33020  
                                          Year_Built  
                                               16040  
                                       Total_Bsmt_SF  
                                               15285  
                          Neighborhood_College_Creek  
                                               18650  
                               Neighborhood_Old_Town  
                                               -1959  
                                Neighborhood_Edwards  
                                              -10541  
                               Neighborhood_Somerset  
                                               37339  
                     Neighborhood_Northridge_Heights  
                                               89923  
                                Neighborhood_Gilbert  
                                                9375  
                                 Neighborhood_Sawyer  
                                                2027  
                         Neighborhood_Northwest_Ames  
                                                3646  
                            Neighborhood_Sawyer_West  
                                                4397  
                               Neighborhood_Mitchell  
                                                1085  
                              Neighborhood_Brookside  
                                                6919  
                               Neighborhood_Crawford  
                                               44017  
                 Neighborhood_Iowa_DOT_and_Rail_Road  
                                               -9375  
                             Neighborhood_Timberland  
                                               44374  
                             Neighborhood_Northridge  
                                               74323  
                            Neighborhood_Stone_Brook  
                                              101480  
Neighborhood_South_and_West_of_Iowa_State_University  
                                               -8260  
                            Neighborhood_Clear_Creek  
                                               15883  
                         Neighborhood_Meadow_Village  

...
and 20 more lines.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions - automatically applies all preprocessing!</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 1
    .pred
    &lt;dbl&gt;
1 114373.
2 155891.
3 191539.
4 190392.
5 270562.
6 206107.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get multiple types of predictions</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test),           <span class="co"># Point predictions</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test, <span class="at">type =</span> <span class="st">"conf_int"</span>)  <span class="co"># Confidence intervals for lm</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_predictions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 4
  Sale_Price   .pred .pred_lower .pred_upper
       &lt;int&gt;   &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1     105000 114373.     110063.     118683.
2     172000 155891.     151593.     160189.
3     189900 191539.     184896.     198181.
4     195500 190392.     183751.     197033.
5     191500 270562.     258711.     282414.
6     189000 206107.     199435.     212779.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The workflow ensures consistency</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># These transformations are automatically applied:</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Log transform of Sale_Price (inverse transformed for predictions)</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Normalization of numeric predictors</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Dummy encoding of Neighborhood</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="workflow-sets-comparing-multiple-approaches" class="level2">
<h2 class="anchored" data-anchor-id="workflow-sets-comparing-multiple-approaches">Workflow Sets: Comparing Multiple Approaches</h2>
<p>One of the most powerful features is comparing multiple workflows systematically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple preprocessing recipes</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>recipe_simple <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>recipe_normalized <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>recipe_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars <span class="sc">+</span> </span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>                         First_Flr_SF <span class="sc">+</span> Full_Bath, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple model specifications</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">lm =</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>),</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">ridge =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">lasso =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow set</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>workflow_set <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple =</span> recipe_simple,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized =</span> recipe_normalized</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> models</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A workflow set/tibble: 8 x 4
  wflow_id         info             option    result    
  &lt;chr&gt;            &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
1 simple_lm        &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
2 simple_ridge     &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
3 simple_lasso     &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
4 simple_tree      &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
5 normalized_lm    &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
6 normalized_ridge &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
7 normalized_lasso &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
8 normalized_tree  &lt;tibble [1 x 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates 8 workflows (2 recipes × 4 models)!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="evaluating-workflow-sets" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-workflow-sets">Evaluating Workflow Sets</h3>
<p>Now we can evaluate all workflows systematically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate workflows individually to avoid errors</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll evaluate just a subset for demonstration</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>simple_lm <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> ames_folds,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Show metrics</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(simple_lm_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 x 6
  .metric .estimator      mean     n   std_err .config        
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;          
1 mae     standard   31681.        5  727.     pre0_mod0_post0
2 rmse    standard   46911.        5 2520.     pre0_mod0_post0
3 rsq     standard       0.655     5    0.0192 pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize performance</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Model Performance with Cross-Validation"</span>,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Simple linear model with 5-fold CV"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This systematic comparison helps identify: - Which preprocessing steps add value - Which models work best with your data - Interaction effects between preprocessing and models</p>
</section>
</section>
<section id="model-evaluation-with-yardstick" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-with-yardstick">Model Evaluation with yardstick</h2>
<p>The yardstick package provides comprehensive metrics for model evaluation:</p>
<section id="regression-metrics" class="level3">
<h3 class="anchored" data-anchor-id="regression-metrics">Regression Metrics</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit our simple workflow</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>best_fit <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get test predictions</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> best_fit <span class="sc">%&gt;%</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price))</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate multiple metrics</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>regression_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  rmse,      <span class="co"># Root Mean Squared Error</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>  mae,       <span class="co"># Mean Absolute Error</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>  mape,      <span class="co"># Mean Absolute Percentage Error</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  rsq,       <span class="co"># R-squared</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  ccc        <span class="co"># Concordance Correlation Coefficient</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>test_performance <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">regression_metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(test_performance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard   45366.   
2 mae     standard   31162.   
3 mape    standard      17.6  
4 rsq     standard       0.690
5 ccc     standard       0.804</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions vs actual</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs Actual Sale Prices"</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(test_performance<span class="sc">$</span>.estimate[<span class="dv">1</span>], <span class="dv">2</span>)),</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="classification-metrics" class="level3">
<h3 class="anchored" data-anchor-id="classification-metrics">Classification Metrics</h3>
<p>Let’s also explore classification metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification problem</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple classification workflow</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built, </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_class) <span class="sc">%&gt;%</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>class_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>class_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(class_spec)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and predict</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>class_fit <span class="ot">&lt;-</span> class_workflow <span class="sc">%&gt;%</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(class_train)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>class_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  class_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(expensive),</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test),</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification metrics</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>  accuracy,</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>  precision,</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>  recall,</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>  f_meas,</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>  roc_auc,</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>  pr_auc</span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>class_performance <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(class_performance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 3
  .metric   .estimator .estimate
  &lt;chr&gt;     &lt;chr&gt;          &lt;dbl&gt;
1 accuracy  binary        0.885 
2 precision binary        0.902 
3 recall    binary        0.865 
4 f_meas    binary        0.883 
5 roc_auc   binary        0.0380
6 pr_auc    binary        0.310 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(conf_matrix, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Confusion Matrix"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC curve</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>roc_curve_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> expensive, .pred_yes)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(roc_curve_data) <span class="sc">+</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve"</span>) <span class="sc">+</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC:"</span>, <span class="fu">round</span>(class_performance<span class="sc">$</span>.estimate[<span class="dv">5</span>], <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="custom-metrics-and-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="custom-metrics-and-evaluation">Custom Metrics and Evaluation</h2>
<p>Sometimes you need custom metrics for your specific problem:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom metric - Mean Absolute Percentage Error with threshold</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>mape_vec_threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">threshold =</span> <span class="fl">0.2</span>, <span class="at">na_rm =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> <span class="fu">abs</span>((truth <span class="sc">-</span> estimate) <span class="sc">/</span> truth)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  errors[errors <span class="sc">&gt;</span> threshold] <span class="ot">&lt;-</span> threshold  <span class="co"># Cap errors at threshold</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(errors, <span class="at">na.rm =</span> na_rm)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the custom metric directly</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>custom_mape <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_mape =</span> <span class="fu">mape_vec_threshold</span>(Sale_Price, .pred),</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>((Sale_Price <span class="sc">-</span> .pred) <span class="sc">/</span> Sale_Price))</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(custom_mape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 2
  custom_mape regular_mape
        &lt;dbl&gt;        &lt;dbl&gt;
1       0.127        0.176</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a business-specific metric</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For example: penalize underestimation more than overestimation</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>asymmetric_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">under_weight =</span> <span class="dv">2</span>) {</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> truth <span class="sc">-</span> estimate</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(errors <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>                   under_weight <span class="sc">*</span> errors<span class="sc">^</span><span class="dv">2</span>,  <span class="co"># Underestimation penalty</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                   errors<span class="sc">^</span><span class="dv">2</span>)                  <span class="co"># Overestimation penalty</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>(result))</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply custom metric</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">asymmetric_loss</span>(Sale_Price, .pred)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_rmse =</span> <span class="fu">rmse_vec</span>(Sale_Price, .pred),</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">mean</span>(asymmetric_rmse)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 2
  regular_rmse asymmetric_rmse
         &lt;dbl&gt;           &lt;dbl&gt;
1       45366.          59141.</code></pre>
</div>
</div>
</section>
<section id="advanced-workflow-techniques" class="level2">
<h2 class="anchored" data-anchor-id="advanced-workflow-techniques">Advanced Workflow Techniques</h2>
<section id="extracting-and-modifying-fitted-workflows" class="level3">
<h3 class="anchored" data-anchor-id="extracting-and-modifying-fitted-workflows">Extracting and Modifying Fitted Workflows</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components from fitted workflow</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>extracted_recipe <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>()</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>extracted_model <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Get preprocessing results</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>() <span class="sc">%&gt;%</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> ames_test)</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(preprocessed_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 32
  Gr_Liv_Area Year_Built Total_Bsmt_SF Sale_Price Neighborhood_College_Creek
        &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;      &lt;int&gt;                      &lt;dbl&gt;
1      -1.18      -0.353        -0.364     105000                          0
2      -0.337     -0.452         0.634     172000                          0
3       0.247      0.836        -0.262     189900                          0
4       0.198      0.869        -0.266     195500                          0
5      -0.433      0.671         0.525     191500                          0
6       0.588      0.902        -0.114     189000                          0
# i 27 more variables: Neighborhood_Old_Town &lt;dbl&gt;, Neighborhood_Edwards &lt;dbl&gt;,
#   Neighborhood_Somerset &lt;dbl&gt;, Neighborhood_Northridge_Heights &lt;dbl&gt;,
#   Neighborhood_Gilbert &lt;dbl&gt;, Neighborhood_Sawyer &lt;dbl&gt;,
#   Neighborhood_Northwest_Ames &lt;dbl&gt;, Neighborhood_Sawyer_West &lt;dbl&gt;,
#   Neighborhood_Mitchell &lt;dbl&gt;, Neighborhood_Brookside &lt;dbl&gt;,
#   Neighborhood_Crawford &lt;dbl&gt;, Neighborhood_Iowa_DOT_and_Rail_Road &lt;dbl&gt;,
#   Neighborhood_Timberland &lt;dbl&gt;, Neighborhood_Northridge &lt;dbl&gt;, ...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract model coefficients</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 5
  term                       estimate std.error statistic   p.value
  &lt;chr&gt;                         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)                 164586.     2214.    74.3   0        
2 Gr_Liv_Area                  33020.     1003.    32.9   4.40e-193
3 Year_Built                   16040.     1732.     9.26  4.64e- 20
4 Total_Bsmt_SF                15285.     1029.    14.9   1.28e- 47
5 Neighborhood_College_Creek   18650.     3982.     4.68  2.99e-  6
6 Neighborhood_Old_Town        -1959.     4085.    -0.480 6.32e-  1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable importance (if applicable)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For models that support it</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span> <span class="fu">set_mode</span>(<span class="st">"regression"</span>))</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>rf_importance <span class="ot">&lt;-</span> rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>()</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf_importance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="workflow-finalization" class="level3">
<h3 class="anchored" data-anchor-id="workflow-finalization">Workflow Finalization</h3>
<p>After tuning (covered in next chapter), you finalize workflows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Finalize a workflow with best parameters</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This would typically come from tuning</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fl">0.01</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fl">0.5</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunable workflow</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>tunable_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fu">tune</span>(),</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fu">tune</span>()</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>tunable_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_normalized) <span class="sc">%&gt;%</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tunable_spec)</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize with best parameters</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> tunable_workflow <span class="sc">%&gt;%</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_params)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_workflow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
1 Recipe Step

* step_normalize()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.01
  mixture = 0.5

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final model on all training data</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Last fit - train on all data, evaluate on test</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>last_fit_results <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(<span class="at">split =</span> ames_split, <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq))</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final metrics</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>final_metrics <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 x 4
  .metric .estimator .estimate .config        
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;          
1 rmse    standard   40233.    pre0_mod0_post0
2 rsq     standard       0.760 pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final model</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluating-model-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-model-assumptions">Evaluating Model Assumptions</h2>
<p>Workflows make it easy to check model assumptions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual analysis for regression</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>residual_analysis <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> .pred,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_residual =</span> residual <span class="sc">/</span> <span class="fu">sd</span>(residual),</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_residual =</span> <span class="fu">abs</span>(residual)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual plots</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Fitted"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">sample =</span> std_residual)) <span class="sc">+</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q Plot"</span>, <span class="at">x =</span> <span class="st">"Theoretical Quantiles"</span>, <span class="at">y =</span> <span class="st">"Standardized Residuals"</span>)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> <span class="fu">sqrt</span>(abs_residual))) <span class="sc">+</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scale-Location"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"√|Residuals|"</span>)</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> residual)) <span class="sc">+</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(count)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Distribution"</span>, <span class="at">x =</span> <span class="st">"Residuals"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4) <span class="sc">+</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Regression Diagnostics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="probability-calibration" class="level2">
<h2 class="anchored" data-anchor-id="probability-calibration">Probability Calibration</h2>
<p>For classification, we often need well-calibrated probabilities:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration analysis</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>calibration_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_bin =</span> <span class="fu">cut</span>(.pred_yes, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prob_bin) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_predicted =</span> <span class="fu">mean</span>(.pred_yes),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction_positive =</span> <span class="fu">mean</span>(expensive <span class="sc">==</span> <span class="st">"yes"</span>),</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">5</span>)  <span class="co"># Remove bins with few observations</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration plot</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Probability Calibration Plot"</span>,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Well-calibrated models follow the diagonal"</span>,</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probably package for calibration</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple calibration visualization</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll just show the calibration plot without the probably package functions</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># that are causing issues</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple comparison</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Calibration Assessment"</span>,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points should follow the red diagonal for perfect calibration"</span>,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="performance-visualization" class="level2">
<h2 class="anchored" data-anchor-id="performance-visualization">Performance Visualization</h2>
<p>Create comprehensive performance visualizations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For regression: actual vs predicted with confidence bands</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Accuracy"</span>,</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"R² ="</span>, <span class="fu">round</span>(<span class="fu">rsq_vec</span>(test_predictions<span class="sc">$</span>Sale_Price, </span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>                                          test_predictions<span class="sc">$</span>.pred), <span class="dv">3</span>)),</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Price"</span>,</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Price"</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Error distribution</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>error_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> .pred <span class="sc">-</span> Sale_Price,</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_error =</span> error <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error)) <span class="sc">+</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Error Distribution"</span>,</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage error"</span>,</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Error (%)"</span>,</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="sc">+</span> error_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="best-practices-for-workflows" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-for-workflows">Best Practices for Workflows</h2>
<section id="always-use-workflows-for-production" class="level3">
<h3 class="anchored" data-anchor-id="always-use-workflows-for-production">1. Always Use Workflows for Production</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Good practice: Complete workflow</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>production_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures all preprocessing is contained and reproducible</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="version-control-your-workflows" class="level3">
<h3 class="anchored" data-anchor-id="version-control-your-workflows">2. Version Control Your Workflows</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save workflow for reproducibility</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_fit, <span class="st">"models/final_workflow_v1.rds"</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and use later</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># loaded_workflow &lt;- readRDS("models/final_workflow_v1.rds")</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># new_predictions &lt;- predict(loaded_workflow, new_data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="document-your-choices" class="level3">
<h3 class="anchored" data-anchor-id="document-your-choices">3. Document Your Choices</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow with documentation</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>documented_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle missing values before other steps</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Normalize for model stability</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create dummies for linear model</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression to handle multicollinearity</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<section id="exercise-1-build-a-complete-evaluation-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-build-a-complete-evaluation-pipeline">Exercise 1: Build a Complete Evaluation Pipeline</h3>
<p>Create a workflow and comprehensive evaluation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a complete evaluation pipeline</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>eval_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                      Neighborhood <span class="sc">+</span> Total_Bsmt_SF, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price, <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="co"># Skip for prediction</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>eval_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>eval_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(eval_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(eval_spec)</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit with cross-validation</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>eval_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>eval_results <span class="ot">&lt;-</span> eval_workflow <span class="sc">%&gt;%</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> eval_folds,</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>mape),</span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize performance</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(eval_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 x 6
  .metric .estimator       mean     n      std_err .config        
  &lt;chr&gt;   &lt;chr&gt;           &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt; &lt;chr&gt;          
1 mae     standard   180453.       10  696.        pre0_mod0_post0
2 mape    standard      100.0      10    0.0000425 pre0_mod0_post0
3 rmse    standard   197162.       10 1400.        pre0_mod0_post0
4 rsq     standard        0.764    10    0.0157    pre0_mod0_post0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions for visualization</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>eval_predictions <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(eval_results)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize CV performance</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eval_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>id, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions Across CV Folds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-2-compare-preprocessing-strategies" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2-compare-preprocessing-strategies">Exercise 2: Compare Preprocessing Strategies</h3>
<p>Evaluate different preprocessing approaches:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different preprocessing strategies</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>preproc_minimal <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> ames_train)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>preproc_standard <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>preproc_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Year_Built)</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflows</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">minimal =</span> preproc_minimal,</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">standard =</span> preproc_standard,</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> preproc_complex</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model for all</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and evaluate workflows</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>strategy_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(strategy_name) {</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>    wf,</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare strategies</span></span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(strategy_results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Preprocessing Strategy Comparison"</span>) <span class="sc">+</span></span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-custom-metrics-for-business-goals" class="level3">
<h3 class="anchored" data-anchor-id="exercise-3-custom-metrics-for-business-goals">Exercise 3: Custom Metrics for Business Goals</h3>
<p>Create business-specific metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Business scenario: Real estate company</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - Overestimating is bad (disappointed customers)</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &lt;5% is acceptable</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &gt;5% is very bad (lost opportunity)</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>business_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate) {</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  pct_error <span class="ot">&lt;-</span> (estimate <span class="sc">-</span> truth) <span class="sc">/</span> truth <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  penalties <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">2</span>,        <span class="co"># Overestimate penalty</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="fl">0.5</span>,     <span class="co"># Small underestimate</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">3</span>                  <span class="co"># Large underestimate penalty</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(penalties)</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test predictions</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">business_score =</span> <span class="fu">business_metric</span>(Sale_Price, .pred),</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">standard_mape =</span> <span class="fu">mape_vec</span>(Sale_Price, .pred)</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_business_score =</span> <span class="fu">mean</span>(business_score),</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_standard_mape =</span> <span class="fu">mean</span>(standard_mape)</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 x 2
  mean_business_score mean_standard_mape
                &lt;dbl&gt;              &lt;dbl&gt;
1                42.4               17.6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize business metric</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_error =</span> (.pred <span class="sc">-</span> Sale_Price) <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">error_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Overestimate"</span>,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"Small Underestimate"</span>,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Large Underestimate"</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error, <span class="at">fill =</span> error_category)) <span class="sc">+</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Overestimate"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small Underestimate"</span> <span class="ot">=</span> <span class="st">"yellow"</span>,</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large Underestimate"</span> <span class="ot">=</span> <span class="st">"darkred"</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Business Impact of Prediction Errors"</span>,</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Error"</span>,</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Error Category"</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="12-workflows-evaluation_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this comprehensive chapter, you’ve mastered:</p>
<p>✅ <strong>Workflow fundamentals</strong> - Combining preprocessing and models - Preventing data leakage - Ensuring reproducibility</p>
<p>✅ <strong>Workflow components</strong> - Adding and updating recipes/models - Formula vs recipe interfaces - Modular design</p>
<p>✅ <strong>Workflow sets</strong> - Comparing multiple approaches - Systematic evaluation - Ranking and selection</p>
<p>✅ <strong>Model evaluation</strong> - Comprehensive metrics with yardstick - Custom metrics for business needs - Visualization techniques</p>
<p>✅ <strong>Advanced techniques</strong> - Extracting workflow components - Probability calibration - Model diagnostics</p>
<p>Key takeaways: - Always use workflows for production models - Workflows prevent data leakage automatically - Workflow sets enable systematic comparison - Custom metrics align models with business goals - Proper evaluation is crucial for model trust</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>In <a href="./13-hyperparameter-tuning.html">Chapter 13</a>, we’ll explore hyperparameter tuning to optimize model performance.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="https://workflows.tidymodels.org/">workflows Documentation</a></li>
<li><a href="https://workflowsets.tidymodels.org/">workflowsets Documentation</a></li>
<li><a href="https://yardstick.tidymodels.org/">yardstick Documentation</a></li>
<li><a href="https://www.tmwr.org/workflows.html">Tidy Modeling with R - Workflows Chapter</a></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all elements with class 'quarto-title-meta-heading' that contain "Author"
    const authorHeadings = document.querySelectorAll('.quarto-title-meta-heading');
    
    authorHeadings.forEach(function(heading) {
        if (heading.textContent.trim() === 'Author') {
            heading.textContent = 'Authors';
        }
    });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb91" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Chapter 12: Workflows and Model Evaluation - Building Reproducible ML Pipelines"</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "David Sarrat González, Juan R González"</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Objectives</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>By the end of this chapter, you will master:</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The workflow concept and its importance</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Combining preprocessing and modeling</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow sets for comparing multiple approaches</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Comprehensive model evaluation with yardstick</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Custom metrics and metric sets</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Visualizing model performance</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow extraction and modification</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Best practices for reproducible ML pipelines</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Workflows Matter</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>Imagine you're baking a complex cake. You wouldn't just throw ingredients together randomly - you'd follow a recipe that specifies the exact order of operations: mix dry ingredients, cream butter and sugar, combine wet and dry, bake at specific temperature. Machine learning is similar: the order and combination of steps matters immensely.</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>A workflow in tidymodels bundles together:</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Preprocessing** (recipes)</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Model specification** (parsnip)</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Post-processing** (if needed)</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>This bundling ensures:</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reproducibility**: The exact same steps are applied to new data</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prevention of data leakage**: Preprocessing parameters are learned only from training data</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Simplicity**: One object contains your entire modeling pipeline</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Flexibility**: Easy to swap components and compare approaches</span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Set theme and seed</span></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Load example data</span></span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(ames)</span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building Your First Workflow</span></span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a>Let's start by understanding the problem with not using workflows:</span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a><span class="co"># The WRONG way - manual preprocessing</span></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a><span class="co"># This approach is error-prone and can lead to data leakage</span></span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual preprocessing on training data</span></span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>ames_train_processed <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log transform - uses training data statistics</span></span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">Sale_Price_log =</span> <span class="fu">log</span>(Sale_Price),</span>
<span id="cb91-77"><a href="#cb91-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scaling - WRONG! Uses all training data including validation folds</span></span>
<span id="cb91-78"><a href="#cb91-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gr_Liv_Area_scaled =</span> <span class="fu">scale</span>(Gr_Liv_Area)[,<span class="dv">1</span>]</span>
<span id="cb91-79"><a href="#cb91-79" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-80"><a href="#cb91-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-81"><a href="#cb91-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we need to remember these transformations for test data</span></span>
<span id="cb91-82"><a href="#cb91-82" aria-hidden="true" tabindex="-1"></a><span class="co"># And apply them consistently... but what were the scaling parameters?</span></span>
<span id="cb91-83"><a href="#cb91-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-84"><a href="#cb91-84" aria-hidden="true" tabindex="-1"></a><span class="co"># The RIGHT way - using workflows</span></span>
<span id="cb91-85"><a href="#cb91-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Create a recipe</span></span>
<span id="cb91-86"><a href="#cb91-86" aria-hidden="true" tabindex="-1"></a>ames_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> </span>
<span id="cb91-87"><a href="#cb91-87" aria-hidden="true" tabindex="-1"></a>                      Neighborhood, </span>
<span id="cb91-88"><a href="#cb91-88" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-89"><a href="#cb91-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-90"><a href="#cb91-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb91-91"><a href="#cb91-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-92"><a href="#cb91-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Create a model specification</span></span>
<span id="cb91-93"><a href="#cb91-93" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-94"><a href="#cb91-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb91-95"><a href="#cb91-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-96"><a href="#cb91-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Combine into a workflow</span></span>
<span id="cb91-97"><a href="#cb91-97" aria-hidden="true" tabindex="-1"></a>lm_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-98"><a href="#cb91-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb91-99"><a href="#cb91-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb91-100"><a href="#cb91-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-101"><a href="#cb91-101" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_workflow)</span>
<span id="cb91-102"><a href="#cb91-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-103"><a href="#cb91-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-104"><a href="#cb91-104" aria-hidden="true" tabindex="-1"></a>The workflow object now contains everything needed to go from raw data to predictions. This is incredibly powerful for maintaining consistency across training, validation, and deployment.</span>
<span id="cb91-105"><a href="#cb91-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-106"><a href="#cb91-106" aria-hidden="true" tabindex="-1"></a><span class="fu">## Workflow Components</span></span>
<span id="cb91-107"><a href="#cb91-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-108"><a href="#cb91-108" aria-hidden="true" tabindex="-1"></a><span class="fu">### Adding and Modifying Components</span></span>
<span id="cb91-109"><a href="#cb91-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-110"><a href="#cb91-110" aria-hidden="true" tabindex="-1"></a>Workflows are modular - you can add, remove, or update components:</span>
<span id="cb91-111"><a href="#cb91-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-114"><a href="#cb91-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-115"><a href="#cb91-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with an empty workflow</span></span>
<span id="cb91-116"><a href="#cb91-116" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb91-117"><a href="#cb91-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-118"><a href="#cb91-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Add components step by step</span></span>
<span id="cb91-119"><a href="#cb91-119" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-120"><a href="#cb91-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe)</span>
<span id="cb91-121"><a href="#cb91-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-122"><a href="#cb91-122" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding recipe:"</span>)</span>
<span id="cb91-123"><a href="#cb91-123" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span>
<span id="cb91-124"><a href="#cb91-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-125"><a href="#cb91-125" aria-hidden="true" tabindex="-1"></a>base_workflow <span class="ot">&lt;-</span> base_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-126"><a href="#cb91-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb91-127"><a href="#cb91-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-128"><a href="#cb91-128" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After adding model:"</span>)</span>
<span id="cb91-129"><a href="#cb91-129" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(base_workflow)</span>
<span id="cb91-130"><a href="#cb91-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-131"><a href="#cb91-131" aria-hidden="true" tabindex="-1"></a><span class="co"># You can also update components</span></span>
<span id="cb91-132"><a href="#cb91-132" aria-hidden="true" tabindex="-1"></a>updated_workflow <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-133"><a href="#cb91-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_model</span>(</span>
<span id="cb91-134"><a href="#cb91-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-135"><a href="#cb91-135" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb91-136"><a href="#cb91-136" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-137"><a href="#cb91-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-138"><a href="#cb91-138" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After updating model:"</span>)</span>
<span id="cb91-139"><a href="#cb91-139" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(updated_workflow)</span>
<span id="cb91-140"><a href="#cb91-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-141"><a href="#cb91-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Or remove components</span></span>
<span id="cb91-142"><a href="#cb91-142" aria-hidden="true" tabindex="-1"></a>recipe_only <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-143"><a href="#cb91-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_model</span>()</span>
<span id="cb91-144"><a href="#cb91-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-145"><a href="#cb91-145" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"After removing model:"</span>)</span>
<span id="cb91-146"><a href="#cb91-146" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(recipe_only)</span>
<span id="cb91-147"><a href="#cb91-147" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-148"><a href="#cb91-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-149"><a href="#cb91-149" aria-hidden="true" tabindex="-1"></a>This modularity is essential for:</span>
<span id="cb91-150"><a href="#cb91-150" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Experimentation**: Quickly try different models with same preprocessing</span>
<span id="cb91-151"><a href="#cb91-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model comparison**: Keep preprocessing constant while varying models</span>
<span id="cb91-152"><a href="#cb91-152" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Debugging**: Test components independently</span>
<span id="cb91-153"><a href="#cb91-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-154"><a href="#cb91-154" aria-hidden="true" tabindex="-1"></a><span class="fu">### Formula vs Recipe Interface</span></span>
<span id="cb91-155"><a href="#cb91-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-156"><a href="#cb91-156" aria-hidden="true" tabindex="-1"></a>Workflows support two interfaces for specifying predictors:</span>
<span id="cb91-157"><a href="#cb91-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-160"><a href="#cb91-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-161"><a href="#cb91-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1: Formula interface (simple, no preprocessing)</span></span>
<span id="cb91-162"><a href="#cb91-162" aria-hidden="true" tabindex="-1"></a>formula_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-163"><a href="#cb91-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond) <span class="sc">%&gt;%</span></span>
<span id="cb91-164"><a href="#cb91-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb91-165"><a href="#cb91-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-166"><a href="#cb91-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2: Recipe interface (complex preprocessing)</span></span>
<span id="cb91-167"><a href="#cb91-167" aria-hidden="true" tabindex="-1"></a>recipe_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-168"><a href="#cb91-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb91-169"><a href="#cb91-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb91-170"><a href="#cb91-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-171"><a href="#cb91-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 3: Variables interface (programmatic)</span></span>
<span id="cb91-172"><a href="#cb91-172" aria-hidden="true" tabindex="-1"></a>vars_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-173"><a href="#cb91-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_variables</span>(</span>
<span id="cb91-174"><a href="#cb91-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcomes =</span> Sale_Price,</span>
<span id="cb91-175"><a href="#cb91-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> <span class="fu">c</span>(Gr_Liv_Area, Overall_Cond, Neighborhood)</span>
<span id="cb91-176"><a href="#cb91-176" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-177"><a href="#cb91-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lm_spec)</span>
<span id="cb91-178"><a href="#cb91-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-179"><a href="#cb91-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare the approaches</span></span>
<span id="cb91-180"><a href="#cb91-180" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Formula approach:"</span>)</span>
<span id="cb91-181"><a href="#cb91-181" aria-hidden="true" tabindex="-1"></a>formula_workflow</span>
<span id="cb91-182"><a href="#cb91-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-183"><a href="#cb91-183" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recipe approach:"</span>)</span>
<span id="cb91-184"><a href="#cb91-184" aria-hidden="true" tabindex="-1"></a>recipe_workflow</span>
<span id="cb91-185"><a href="#cb91-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-186"><a href="#cb91-186" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variables approach:"</span>)</span>
<span id="cb91-187"><a href="#cb91-187" aria-hidden="true" tabindex="-1"></a>vars_workflow</span>
<span id="cb91-188"><a href="#cb91-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-189"><a href="#cb91-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-190"><a href="#cb91-190" aria-hidden="true" tabindex="-1"></a>Choose based on your needs:</span>
<span id="cb91-191"><a href="#cb91-191" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Formula**: Quick prototyping, simple models</span>
<span id="cb91-192"><a href="#cb91-192" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Recipe**: Complex preprocessing, feature engineering</span>
<span id="cb91-193"><a href="#cb91-193" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Variables**: Programmatic variable selection</span>
<span id="cb91-194"><a href="#cb91-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-195"><a href="#cb91-195" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting and Predicting with Workflows</span></span>
<span id="cb91-196"><a href="#cb91-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-197"><a href="#cb91-197" aria-hidden="true" tabindex="-1"></a>The workflow handles all the complexity of applying transformations consistently:</span>
<span id="cb91-198"><a href="#cb91-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-201"><a href="#cb91-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-202"><a href="#cb91-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the workflow</span></span>
<span id="cb91-203"><a href="#cb91-203" aria-hidden="true" tabindex="-1"></a>lm_fit <span class="ot">&lt;-</span> lm_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-204"><a href="#cb91-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> ames_train)</span>
<span id="cb91-205"><a href="#cb91-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-206"><a href="#cb91-206" aria-hidden="true" tabindex="-1"></a><span class="co"># The fitted workflow contains:</span></span>
<span id="cb91-207"><a href="#cb91-207" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. The prepared recipe (with learned parameters)</span></span>
<span id="cb91-208"><a href="#cb91-208" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. The fitted model</span></span>
<span id="cb91-209"><a href="#cb91-209" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lm_fit)</span>
<span id="cb91-210"><a href="#cb91-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-211"><a href="#cb91-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions - automatically applies all preprocessing!</span></span>
<span id="cb91-212"><a href="#cb91-212" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-213"><a href="#cb91-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test)</span>
<span id="cb91-214"><a href="#cb91-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-215"><a href="#cb91-215" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predictions)</span>
<span id="cb91-216"><a href="#cb91-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-217"><a href="#cb91-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Get multiple types of predictions</span></span>
<span id="cb91-218"><a href="#cb91-218" aria-hidden="true" tabindex="-1"></a>all_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb91-219"><a href="#cb91-219" aria-hidden="true" tabindex="-1"></a>  ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price),</span>
<span id="cb91-220"><a href="#cb91-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test),           <span class="co"># Point predictions</span></span>
<span id="cb91-221"><a href="#cb91-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(lm_fit, ames_test, <span class="at">type =</span> <span class="st">"conf_int"</span>)  <span class="co"># Confidence intervals for lm</span></span>
<span id="cb91-222"><a href="#cb91-222" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-223"><a href="#cb91-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-224"><a href="#cb91-224" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_predictions)</span>
<span id="cb91-225"><a href="#cb91-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-226"><a href="#cb91-226" aria-hidden="true" tabindex="-1"></a><span class="co"># The workflow ensures consistency</span></span>
<span id="cb91-227"><a href="#cb91-227" aria-hidden="true" tabindex="-1"></a><span class="co"># These transformations are automatically applied:</span></span>
<span id="cb91-228"><a href="#cb91-228" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Log transform of Sale_Price (inverse transformed for predictions)</span></span>
<span id="cb91-229"><a href="#cb91-229" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Normalization of numeric predictors</span></span>
<span id="cb91-230"><a href="#cb91-230" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Dummy encoding of Neighborhood</span></span>
<span id="cb91-231"><a href="#cb91-231" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-232"><a href="#cb91-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-233"><a href="#cb91-233" aria-hidden="true" tabindex="-1"></a><span class="fu">## Workflow Sets: Comparing Multiple Approaches</span></span>
<span id="cb91-234"><a href="#cb91-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-235"><a href="#cb91-235" aria-hidden="true" tabindex="-1"></a>One of the most powerful features is comparing multiple workflows systematically:</span>
<span id="cb91-236"><a href="#cb91-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-239"><a href="#cb91-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-240"><a href="#cb91-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple preprocessing recipes</span></span>
<span id="cb91-241"><a href="#cb91-241" aria-hidden="true" tabindex="-1"></a>recipe_simple <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb91-242"><a href="#cb91-242" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> ames_train)</span>
<span id="cb91-243"><a href="#cb91-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-244"><a href="#cb91-244" aria-hidden="true" tabindex="-1"></a>recipe_normalized <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb91-245"><a href="#cb91-245" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-246"><a href="#cb91-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb91-247"><a href="#cb91-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-248"><a href="#cb91-248" aria-hidden="true" tabindex="-1"></a>recipe_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb91-249"><a href="#cb91-249" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars <span class="sc">+</span> </span>
<span id="cb91-250"><a href="#cb91-250" aria-hidden="true" tabindex="-1"></a>                         First_Flr_SF <span class="sc">+</span> Full_Bath, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-251"><a href="#cb91-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-252"><a href="#cb91-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-253"><a href="#cb91-253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb91-254"><a href="#cb91-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-255"><a href="#cb91-255" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple model specifications</span></span>
<span id="cb91-256"><a href="#cb91-256" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb91-257"><a href="#cb91-257" aria-hidden="true" tabindex="-1"></a>  <span class="at">lm =</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>),</span>
<span id="cb91-258"><a href="#cb91-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">ridge =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb91-259"><a href="#cb91-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">lasso =</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.1</span>, <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>),</span>
<span id="cb91-260"><a href="#cb91-260" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree =</span> <span class="fu">decision_tree</span>(<span class="at">tree_depth =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-261"><a href="#cb91-261" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb91-262"><a href="#cb91-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb91-263"><a href="#cb91-263" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-264"><a href="#cb91-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-265"><a href="#cb91-265" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow set</span></span>
<span id="cb91-266"><a href="#cb91-266" aria-hidden="true" tabindex="-1"></a>workflow_set <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb91-267"><a href="#cb91-267" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(</span>
<span id="cb91-268"><a href="#cb91-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">simple =</span> recipe_simple,</span>
<span id="cb91-269"><a href="#cb91-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized =</span> recipe_normalized</span>
<span id="cb91-270"><a href="#cb91-270" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb91-271"><a href="#cb91-271" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> models</span>
<span id="cb91-272"><a href="#cb91-272" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-273"><a href="#cb91-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-274"><a href="#cb91-274" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_set)</span>
<span id="cb91-275"><a href="#cb91-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-276"><a href="#cb91-276" aria-hidden="true" tabindex="-1"></a><span class="co"># This creates 8 workflows (2 recipes × 4 models)!</span></span>
<span id="cb91-277"><a href="#cb91-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-278"><a href="#cb91-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-279"><a href="#cb91-279" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluating Workflow Sets</span></span>
<span id="cb91-280"><a href="#cb91-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-281"><a href="#cb91-281" aria-hidden="true" tabindex="-1"></a>Now we can evaluate all workflows systematically:</span>
<span id="cb91-282"><a href="#cb91-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-285"><a href="#cb91-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-286"><a href="#cb91-286" aria-hidden="true" tabindex="-1"></a><span class="co"># Create resamples for evaluation</span></span>
<span id="cb91-287"><a href="#cb91-287" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb91-288"><a href="#cb91-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-289"><a href="#cb91-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate workflows individually to avoid errors</span></span>
<span id="cb91-290"><a href="#cb91-290" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll evaluate just a subset for demonstration</span></span>
<span id="cb91-291"><a href="#cb91-291" aria-hidden="true" tabindex="-1"></a>simple_lm <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-292"><a href="#cb91-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb91-293"><a href="#cb91-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>))</span>
<span id="cb91-294"><a href="#cb91-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-295"><a href="#cb91-295" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb91-296"><a href="#cb91-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb91-297"><a href="#cb91-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> ames_folds,</span>
<span id="cb91-298"><a href="#cb91-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae)</span>
<span id="cb91-299"><a href="#cb91-299" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-300"><a href="#cb91-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-301"><a href="#cb91-301" aria-hidden="true" tabindex="-1"></a><span class="co"># Show metrics</span></span>
<span id="cb91-302"><a href="#cb91-302" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(simple_lm_results)</span>
<span id="cb91-303"><a href="#cb91-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-304"><a href="#cb91-304" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize performance</span></span>
<span id="cb91-305"><a href="#cb91-305" aria-hidden="true" tabindex="-1"></a>simple_lm_results <span class="sc">%&gt;%</span></span>
<span id="cb91-306"><a href="#cb91-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-307"><a href="#cb91-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb91-308"><a href="#cb91-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb91-309"><a href="#cb91-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb91-310"><a href="#cb91-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb91-311"><a href="#cb91-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Model Performance with Cross-Validation"</span>,</span>
<span id="cb91-312"><a href="#cb91-312" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Simple linear model with 5-fold CV"</span>)</span>
<span id="cb91-313"><a href="#cb91-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-314"><a href="#cb91-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-315"><a href="#cb91-315" aria-hidden="true" tabindex="-1"></a>This systematic comparison helps identify:</span>
<span id="cb91-316"><a href="#cb91-316" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which preprocessing steps add value</span>
<span id="cb91-317"><a href="#cb91-317" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which models work best with your data</span>
<span id="cb91-318"><a href="#cb91-318" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interaction effects between preprocessing and models</span>
<span id="cb91-319"><a href="#cb91-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-320"><a href="#cb91-320" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Evaluation with yardstick</span></span>
<span id="cb91-321"><a href="#cb91-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-322"><a href="#cb91-322" aria-hidden="true" tabindex="-1"></a>The yardstick package provides comprehensive metrics for model evaluation:</span>
<span id="cb91-323"><a href="#cb91-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-324"><a href="#cb91-324" aria-hidden="true" tabindex="-1"></a><span class="fu">### Regression Metrics</span></span>
<span id="cb91-325"><a href="#cb91-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-328"><a href="#cb91-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-329"><a href="#cb91-329" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit our simple workflow</span></span>
<span id="cb91-330"><a href="#cb91-330" aria-hidden="true" tabindex="-1"></a>best_fit <span class="ot">&lt;-</span> simple_lm <span class="sc">%&gt;%</span></span>
<span id="cb91-331"><a href="#cb91-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb91-332"><a href="#cb91-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-333"><a href="#cb91-333" aria-hidden="true" tabindex="-1"></a><span class="co"># Get test predictions</span></span>
<span id="cb91-334"><a href="#cb91-334" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> best_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-335"><a href="#cb91-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb91-336"><a href="#cb91-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(Sale_Price))</span>
<span id="cb91-337"><a href="#cb91-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-338"><a href="#cb91-338" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate multiple metrics</span></span>
<span id="cb91-339"><a href="#cb91-339" aria-hidden="true" tabindex="-1"></a>regression_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb91-340"><a href="#cb91-340" aria-hidden="true" tabindex="-1"></a>  rmse,      <span class="co"># Root Mean Squared Error</span></span>
<span id="cb91-341"><a href="#cb91-341" aria-hidden="true" tabindex="-1"></a>  mae,       <span class="co"># Mean Absolute Error</span></span>
<span id="cb91-342"><a href="#cb91-342" aria-hidden="true" tabindex="-1"></a>  mape,      <span class="co"># Mean Absolute Percentage Error</span></span>
<span id="cb91-343"><a href="#cb91-343" aria-hidden="true" tabindex="-1"></a>  rsq,       <span class="co"># R-squared</span></span>
<span id="cb91-344"><a href="#cb91-344" aria-hidden="true" tabindex="-1"></a>  ccc        <span class="co"># Concordance Correlation Coefficient</span></span>
<span id="cb91-345"><a href="#cb91-345" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-346"><a href="#cb91-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-347"><a href="#cb91-347" aria-hidden="true" tabindex="-1"></a>test_performance <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-348"><a href="#cb91-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">regression_metrics</span>(<span class="at">truth =</span> Sale_Price, <span class="at">estimate =</span> .pred)</span>
<span id="cb91-349"><a href="#cb91-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-350"><a href="#cb91-350" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(test_performance)</span>
<span id="cb91-351"><a href="#cb91-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-352"><a href="#cb91-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize predictions vs actual</span></span>
<span id="cb91-353"><a href="#cb91-353" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb91-354"><a href="#cb91-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-355"><a href="#cb91-355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb91-356"><a href="#cb91-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-357"><a href="#cb91-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-358"><a href="#cb91-358" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs Actual Sale Prices"</span>,</span>
<span id="cb91-359"><a href="#cb91-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(test_performance<span class="sc">$</span>.estimate[<span class="dv">1</span>], <span class="dv">2</span>)),</span>
<span id="cb91-360"><a href="#cb91-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Sale Price"</span>,</span>
<span id="cb91-361"><a href="#cb91-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Sale Price"</span></span>
<span id="cb91-362"><a href="#cb91-362" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-363"><a href="#cb91-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb91-364"><a href="#cb91-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-365"><a href="#cb91-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-366"><a href="#cb91-366" aria-hidden="true" tabindex="-1"></a><span class="fu">### Classification Metrics</span></span>
<span id="cb91-367"><a href="#cb91-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-368"><a href="#cb91-368" aria-hidden="true" tabindex="-1"></a>Let's also explore classification metrics:</span>
<span id="cb91-369"><a href="#cb91-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-372"><a href="#cb91-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-373"><a href="#cb91-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a classification problem</span></span>
<span id="cb91-374"><a href="#cb91-374" aria-hidden="true" tabindex="-1"></a>ames_class <span class="ot">&lt;-</span> ames_train <span class="sc">%&gt;%</span></span>
<span id="cb91-375"><a href="#cb91-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">expensive =</span> <span class="fu">factor</span>(<span class="fu">if_else</span>(Sale_Price <span class="sc">&gt;</span> <span class="fu">median</span>(Sale_Price), </span>
<span id="cb91-376"><a href="#cb91-376" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"yes"</span>, <span class="st">"no"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb91-377"><a href="#cb91-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Sale_Price)</span>
<span id="cb91-378"><a href="#cb91-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-379"><a href="#cb91-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple classification workflow</span></span>
<span id="cb91-380"><a href="#cb91-380" aria-hidden="true" tabindex="-1"></a>class_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(expensive <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Overall_Cond <span class="sc">+</span> Year_Built, </span>
<span id="cb91-381"><a href="#cb91-381" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ames_class) <span class="sc">%&gt;%</span></span>
<span id="cb91-382"><a href="#cb91-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb91-383"><a href="#cb91-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-384"><a href="#cb91-384" aria-hidden="true" tabindex="-1"></a>class_spec <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-385"><a href="#cb91-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb91-386"><a href="#cb91-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-387"><a href="#cb91-387" aria-hidden="true" tabindex="-1"></a>class_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-388"><a href="#cb91-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(class_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb91-389"><a href="#cb91-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(class_spec)</span>
<span id="cb91-390"><a href="#cb91-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-391"><a href="#cb91-391" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and predict</span></span>
<span id="cb91-392"><a href="#cb91-392" aria-hidden="true" tabindex="-1"></a>class_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(ames_class, <span class="at">strata =</span> expensive)</span>
<span id="cb91-393"><a href="#cb91-393" aria-hidden="true" tabindex="-1"></a>class_train <span class="ot">&lt;-</span> <span class="fu">training</span>(class_split)</span>
<span id="cb91-394"><a href="#cb91-394" aria-hidden="true" tabindex="-1"></a>class_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(class_split)</span>
<span id="cb91-395"><a href="#cb91-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-396"><a href="#cb91-396" aria-hidden="true" tabindex="-1"></a>class_fit <span class="ot">&lt;-</span> class_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-397"><a href="#cb91-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(class_train)</span>
<span id="cb91-398"><a href="#cb91-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-399"><a href="#cb91-399" aria-hidden="true" tabindex="-1"></a>class_predictions <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb91-400"><a href="#cb91-400" aria-hidden="true" tabindex="-1"></a>  class_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(expensive),</span>
<span id="cb91-401"><a href="#cb91-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test),</span>
<span id="cb91-402"><a href="#cb91-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(class_fit, class_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb91-403"><a href="#cb91-403" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-404"><a href="#cb91-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-405"><a href="#cb91-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification metrics</span></span>
<span id="cb91-406"><a href="#cb91-406" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(</span>
<span id="cb91-407"><a href="#cb91-407" aria-hidden="true" tabindex="-1"></a>  accuracy,</span>
<span id="cb91-408"><a href="#cb91-408" aria-hidden="true" tabindex="-1"></a>  precision,</span>
<span id="cb91-409"><a href="#cb91-409" aria-hidden="true" tabindex="-1"></a>  recall,</span>
<span id="cb91-410"><a href="#cb91-410" aria-hidden="true" tabindex="-1"></a>  f_meas,</span>
<span id="cb91-411"><a href="#cb91-411" aria-hidden="true" tabindex="-1"></a>  roc_auc,</span>
<span id="cb91-412"><a href="#cb91-412" aria-hidden="true" tabindex="-1"></a>  pr_auc</span>
<span id="cb91-413"><a href="#cb91-413" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-414"><a href="#cb91-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-415"><a href="#cb91-415" aria-hidden="true" tabindex="-1"></a>class_performance <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-416"><a href="#cb91-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb91-417"><a href="#cb91-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-418"><a href="#cb91-418" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(class_performance)</span>
<span id="cb91-419"><a href="#cb91-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-420"><a href="#cb91-420" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb91-421"><a href="#cb91-421" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-422"><a href="#cb91-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> expensive, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb91-423"><a href="#cb91-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-424"><a href="#cb91-424" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(conf_matrix, <span class="at">type =</span> <span class="st">"heatmap"</span>) <span class="sc">+</span></span>
<span id="cb91-425"><a href="#cb91-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Confusion Matrix"</span>)</span>
<span id="cb91-426"><a href="#cb91-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-427"><a href="#cb91-427" aria-hidden="true" tabindex="-1"></a><span class="co"># ROC curve</span></span>
<span id="cb91-428"><a href="#cb91-428" aria-hidden="true" tabindex="-1"></a>roc_curve_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-429"><a href="#cb91-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> expensive, .pred_yes)</span>
<span id="cb91-430"><a href="#cb91-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-431"><a href="#cb91-431" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(roc_curve_data) <span class="sc">+</span></span>
<span id="cb91-432"><a href="#cb91-432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"ROC Curve"</span>) <span class="sc">+</span></span>
<span id="cb91-433"><a href="#cb91-433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, </span>
<span id="cb91-434"><a href="#cb91-434" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"AUC:"</span>, <span class="fu">round</span>(class_performance<span class="sc">$</span>.estimate[<span class="dv">5</span>], <span class="dv">3</span>)))</span>
<span id="cb91-435"><a href="#cb91-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-436"><a href="#cb91-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-437"><a href="#cb91-437" aria-hidden="true" tabindex="-1"></a><span class="fu">## Custom Metrics and Evaluation</span></span>
<span id="cb91-438"><a href="#cb91-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-439"><a href="#cb91-439" aria-hidden="true" tabindex="-1"></a>Sometimes you need custom metrics for your specific problem:</span>
<span id="cb91-440"><a href="#cb91-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-443"><a href="#cb91-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-444"><a href="#cb91-444" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a custom metric - Mean Absolute Percentage Error with threshold</span></span>
<span id="cb91-445"><a href="#cb91-445" aria-hidden="true" tabindex="-1"></a>mape_vec_threshold <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">threshold =</span> <span class="fl">0.2</span>, <span class="at">na_rm =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb91-446"><a href="#cb91-446" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> <span class="fu">abs</span>((truth <span class="sc">-</span> estimate) <span class="sc">/</span> truth)</span>
<span id="cb91-447"><a href="#cb91-447" aria-hidden="true" tabindex="-1"></a>  errors[errors <span class="sc">&gt;</span> threshold] <span class="ot">&lt;-</span> threshold  <span class="co"># Cap errors at threshold</span></span>
<span id="cb91-448"><a href="#cb91-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(errors, <span class="at">na.rm =</span> na_rm)</span>
<span id="cb91-449"><a href="#cb91-449" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-450"><a href="#cb91-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-451"><a href="#cb91-451" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the custom metric directly</span></span>
<span id="cb91-452"><a href="#cb91-452" aria-hidden="true" tabindex="-1"></a>custom_mape <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-453"><a href="#cb91-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-454"><a href="#cb91-454" aria-hidden="true" tabindex="-1"></a>    <span class="at">custom_mape =</span> <span class="fu">mape_vec_threshold</span>(Sale_Price, .pred),</span>
<span id="cb91-455"><a href="#cb91-455" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>((Sale_Price <span class="sc">-</span> .pred) <span class="sc">/</span> Sale_Price))</span>
<span id="cb91-456"><a href="#cb91-456" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-457"><a href="#cb91-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-458"><a href="#cb91-458" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(custom_mape)</span>
<span id="cb91-459"><a href="#cb91-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-460"><a href="#cb91-460" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a business-specific metric</span></span>
<span id="cb91-461"><a href="#cb91-461" aria-hidden="true" tabindex="-1"></a><span class="co"># For example: penalize underestimation more than overestimation</span></span>
<span id="cb91-462"><a href="#cb91-462" aria-hidden="true" tabindex="-1"></a>asymmetric_loss <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate, <span class="at">under_weight =</span> <span class="dv">2</span>) {</span>
<span id="cb91-463"><a href="#cb91-463" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> truth <span class="sc">-</span> estimate</span>
<span id="cb91-464"><a href="#cb91-464" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(errors <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb91-465"><a href="#cb91-465" aria-hidden="true" tabindex="-1"></a>                   under_weight <span class="sc">*</span> errors<span class="sc">^</span><span class="dv">2</span>,  <span class="co"># Underestimation penalty</span></span>
<span id="cb91-466"><a href="#cb91-466" aria-hidden="true" tabindex="-1"></a>                   errors<span class="sc">^</span><span class="dv">2</span>)                  <span class="co"># Overestimation penalty</span></span>
<span id="cb91-467"><a href="#cb91-467" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>(result))</span>
<span id="cb91-468"><a href="#cb91-468" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-469"><a href="#cb91-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-470"><a href="#cb91-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply custom metric</span></span>
<span id="cb91-471"><a href="#cb91-471" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-472"><a href="#cb91-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-473"><a href="#cb91-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">asymmetric_loss</span>(Sale_Price, .pred)</span>
<span id="cb91-474"><a href="#cb91-474" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-475"><a href="#cb91-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-476"><a href="#cb91-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">regular_rmse =</span> <span class="fu">rmse_vec</span>(Sale_Price, .pred),</span>
<span id="cb91-477"><a href="#cb91-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">asymmetric_rmse =</span> <span class="fu">mean</span>(asymmetric_rmse)</span>
<span id="cb91-478"><a href="#cb91-478" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-479"><a href="#cb91-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-480"><a href="#cb91-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-481"><a href="#cb91-481" aria-hidden="true" tabindex="-1"></a><span class="fu">## Advanced Workflow Techniques</span></span>
<span id="cb91-482"><a href="#cb91-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-483"><a href="#cb91-483" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting and Modifying Fitted Workflows</span></span>
<span id="cb91-484"><a href="#cb91-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-487"><a href="#cb91-487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-488"><a href="#cb91-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components from fitted workflow</span></span>
<span id="cb91-489"><a href="#cb91-489" aria-hidden="true" tabindex="-1"></a>extracted_recipe <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-490"><a href="#cb91-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>()</span>
<span id="cb91-491"><a href="#cb91-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-492"><a href="#cb91-492" aria-hidden="true" tabindex="-1"></a>extracted_model <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-493"><a href="#cb91-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span>
<span id="cb91-494"><a href="#cb91-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-495"><a href="#cb91-495" aria-hidden="true" tabindex="-1"></a><span class="co"># Get preprocessing results</span></span>
<span id="cb91-496"><a href="#cb91-496" aria-hidden="true" tabindex="-1"></a>preprocessed_data <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-497"><a href="#cb91-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_recipe</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-498"><a href="#cb91-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> ames_test)</span>
<span id="cb91-499"><a href="#cb91-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-500"><a href="#cb91-500" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(preprocessed_data)</span>
<span id="cb91-501"><a href="#cb91-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-502"><a href="#cb91-502" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract model coefficients</span></span>
<span id="cb91-503"><a href="#cb91-503" aria-hidden="true" tabindex="-1"></a>coefficients <span class="ot">&lt;-</span> lm_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-504"><a href="#cb91-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-505"><a href="#cb91-505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>()</span>
<span id="cb91-506"><a href="#cb91-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-507"><a href="#cb91-507" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(coefficients)</span>
<span id="cb91-508"><a href="#cb91-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-509"><a href="#cb91-509" aria-hidden="true" tabindex="-1"></a><span class="co"># Variable importance (if applicable)</span></span>
<span id="cb91-510"><a href="#cb91-510" aria-hidden="true" tabindex="-1"></a><span class="co"># For models that support it</span></span>
<span id="cb91-511"><a href="#cb91-511" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-512"><a href="#cb91-512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_simple) <span class="sc">%&gt;%</span></span>
<span id="cb91-513"><a href="#cb91-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(<span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span> <span class="fu">set_mode</span>(<span class="st">"regression"</span>))</span>
<span id="cb91-514"><a href="#cb91-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-515"><a href="#cb91-515" aria-hidden="true" tabindex="-1"></a>rf_fit <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-516"><a href="#cb91-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb91-517"><a href="#cb91-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-518"><a href="#cb91-518" aria-hidden="true" tabindex="-1"></a>rf_importance <span class="ot">&lt;-</span> rf_fit <span class="sc">%&gt;%</span></span>
<span id="cb91-519"><a href="#cb91-519" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-520"><a href="#cb91-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>()</span>
<span id="cb91-521"><a href="#cb91-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-522"><a href="#cb91-522" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(rf_importance)</span>
<span id="cb91-523"><a href="#cb91-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-524"><a href="#cb91-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-525"><a href="#cb91-525" aria-hidden="true" tabindex="-1"></a><span class="fu">### Workflow Finalization</span></span>
<span id="cb91-526"><a href="#cb91-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-527"><a href="#cb91-527" aria-hidden="true" tabindex="-1"></a>After tuning (covered in next chapter), you finalize workflows:</span>
<span id="cb91-528"><a href="#cb91-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-531"><a href="#cb91-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-532"><a href="#cb91-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Finalize a workflow with best parameters</span></span>
<span id="cb91-533"><a href="#cb91-533" aria-hidden="true" tabindex="-1"></a><span class="co"># This would typically come from tuning</span></span>
<span id="cb91-534"><a href="#cb91-534" aria-hidden="true" tabindex="-1"></a>best_params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb91-535"><a href="#cb91-535" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fl">0.01</span>,</span>
<span id="cb91-536"><a href="#cb91-536" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fl">0.5</span></span>
<span id="cb91-537"><a href="#cb91-537" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-538"><a href="#cb91-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-539"><a href="#cb91-539" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunable workflow</span></span>
<span id="cb91-540"><a href="#cb91-540" aria-hidden="true" tabindex="-1"></a>tunable_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(</span>
<span id="cb91-541"><a href="#cb91-541" aria-hidden="true" tabindex="-1"></a>  <span class="at">penalty =</span> <span class="fu">tune</span>(),</span>
<span id="cb91-542"><a href="#cb91-542" aria-hidden="true" tabindex="-1"></a>  <span class="at">mixture =</span> <span class="fu">tune</span>()</span>
<span id="cb91-543"><a href="#cb91-543" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb91-544"><a href="#cb91-544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb91-545"><a href="#cb91-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-546"><a href="#cb91-546" aria-hidden="true" tabindex="-1"></a>tunable_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-547"><a href="#cb91-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_normalized) <span class="sc">%&gt;%</span></span>
<span id="cb91-548"><a href="#cb91-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tunable_spec)</span>
<span id="cb91-549"><a href="#cb91-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-550"><a href="#cb91-550" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize with best parameters</span></span>
<span id="cb91-551"><a href="#cb91-551" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> tunable_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-552"><a href="#cb91-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_params)</span>
<span id="cb91-553"><a href="#cb91-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-554"><a href="#cb91-554" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_workflow)</span>
<span id="cb91-555"><a href="#cb91-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-556"><a href="#cb91-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit final model on all training data</span></span>
<span id="cb91-557"><a href="#cb91-557" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-558"><a href="#cb91-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span>
<span id="cb91-559"><a href="#cb91-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-560"><a href="#cb91-560" aria-hidden="true" tabindex="-1"></a><span class="co"># Last fit - train on all data, evaluate on test</span></span>
<span id="cb91-561"><a href="#cb91-561" aria-hidden="true" tabindex="-1"></a>last_fit_results <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-562"><a href="#cb91-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(<span class="at">split =</span> ames_split, <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq))</span>
<span id="cb91-563"><a href="#cb91-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-564"><a href="#cb91-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final metrics</span></span>
<span id="cb91-565"><a href="#cb91-565" aria-hidden="true" tabindex="-1"></a>final_metrics <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb91-566"><a href="#cb91-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span>
<span id="cb91-567"><a href="#cb91-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-568"><a href="#cb91-568" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_metrics)</span>
<span id="cb91-569"><a href="#cb91-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-570"><a href="#cb91-570" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract final model</span></span>
<span id="cb91-571"><a href="#cb91-571" aria-hidden="true" tabindex="-1"></a>final_model <span class="ot">&lt;-</span> last_fit_results <span class="sc">%&gt;%</span></span>
<span id="cb91-572"><a href="#cb91-572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>()</span>
<span id="cb91-573"><a href="#cb91-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-574"><a href="#cb91-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-575"><a href="#cb91-575" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluating Model Assumptions</span></span>
<span id="cb91-576"><a href="#cb91-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-577"><a href="#cb91-577" aria-hidden="true" tabindex="-1"></a>Workflows make it easy to check model assumptions:</span>
<span id="cb91-578"><a href="#cb91-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-581"><a href="#cb91-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-582"><a href="#cb91-582" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual analysis for regression</span></span>
<span id="cb91-583"><a href="#cb91-583" aria-hidden="true" tabindex="-1"></a>residual_analysis <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-584"><a href="#cb91-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-585"><a href="#cb91-585" aria-hidden="true" tabindex="-1"></a>    <span class="at">residual =</span> Sale_Price <span class="sc">-</span> .pred,</span>
<span id="cb91-586"><a href="#cb91-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">std_residual =</span> residual <span class="sc">/</span> <span class="fu">sd</span>(residual),</span>
<span id="cb91-587"><a href="#cb91-587" aria-hidden="true" tabindex="-1"></a>    <span class="at">abs_residual =</span> <span class="fu">abs</span>(residual)</span>
<span id="cb91-588"><a href="#cb91-588" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-589"><a href="#cb91-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-590"><a href="#cb91-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual plots</span></span>
<span id="cb91-591"><a href="#cb91-591" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> residual)) <span class="sc">+</span></span>
<span id="cb91-592"><a href="#cb91-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-593"><a href="#cb91-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb91-594"><a href="#cb91-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-595"><a href="#cb91-595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Fitted"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb91-596"><a href="#cb91-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-597"><a href="#cb91-597" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">sample =</span> std_residual)) <span class="sc">+</span></span>
<span id="cb91-598"><a href="#cb91-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb91-599"><a href="#cb91-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_qq_line</span>(<span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb91-600"><a href="#cb91-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q Plot"</span>, <span class="at">x =</span> <span class="st">"Theoretical Quantiles"</span>, <span class="at">y =</span> <span class="st">"Standardized Residuals"</span>)</span>
<span id="cb91-601"><a href="#cb91-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-602"><a href="#cb91-602" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> <span class="fu">sqrt</span>(abs_residual))) <span class="sc">+</span></span>
<span id="cb91-603"><a href="#cb91-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-604"><a href="#cb91-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-605"><a href="#cb91-605" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scale-Location"</span>, <span class="at">x =</span> <span class="st">"Fitted Values"</span>, <span class="at">y =</span> <span class="st">"√|Residuals|"</span>)</span>
<span id="cb91-606"><a href="#cb91-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-607"><a href="#cb91-607" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_analysis, <span class="fu">aes</span>(<span class="at">x =</span> residual)) <span class="sc">+</span></span>
<span id="cb91-608"><a href="#cb91-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-609"><a href="#cb91-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(count)), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-610"><a href="#cb91-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Distribution"</span>, <span class="at">x =</span> <span class="st">"Residuals"</span>, <span class="at">y =</span> <span class="st">"Count"</span>)</span>
<span id="cb91-611"><a href="#cb91-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-612"><a href="#cb91-612" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb91-613"><a href="#cb91-613" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">+</span> p2) <span class="sc">/</span> (p3 <span class="sc">+</span> p4) <span class="sc">+</span></span>
<span id="cb91-614"><a href="#cb91-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Regression Diagnostics"</span>)</span>
<span id="cb91-615"><a href="#cb91-615" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-616"><a href="#cb91-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-617"><a href="#cb91-617" aria-hidden="true" tabindex="-1"></a><span class="fu">## Probability Calibration</span></span>
<span id="cb91-618"><a href="#cb91-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-619"><a href="#cb91-619" aria-hidden="true" tabindex="-1"></a>For classification, we often need well-calibrated probabilities:</span>
<span id="cb91-620"><a href="#cb91-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-623"><a href="#cb91-623" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-624"><a href="#cb91-624" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration analysis</span></span>
<span id="cb91-625"><a href="#cb91-625" aria-hidden="true" tabindex="-1"></a>calibration_data <span class="ot">&lt;-</span> class_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-626"><a href="#cb91-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-627"><a href="#cb91-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob_bin =</span> <span class="fu">cut</span>(.pred_yes, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>), <span class="at">include.lowest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-628"><a href="#cb91-628" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-629"><a href="#cb91-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prob_bin) <span class="sc">%&gt;%</span></span>
<span id="cb91-630"><a href="#cb91-630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-631"><a href="#cb91-631" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_predicted =</span> <span class="fu">mean</span>(.pred_yes),</span>
<span id="cb91-632"><a href="#cb91-632" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction_positive =</span> <span class="fu">mean</span>(expensive <span class="sc">==</span> <span class="st">"yes"</span>),</span>
<span id="cb91-633"><a href="#cb91-633" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb91-634"><a href="#cb91-634" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb91-635"><a href="#cb91-635" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-636"><a href="#cb91-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">5</span>)  <span class="co"># Remove bins with few observations</span></span>
<span id="cb91-637"><a href="#cb91-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-638"><a href="#cb91-638" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration plot</span></span>
<span id="cb91-639"><a href="#cb91-639" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb91-640"><a href="#cb91-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb91-641"><a href="#cb91-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb91-642"><a href="#cb91-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb91-643"><a href="#cb91-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb91-644"><a href="#cb91-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-645"><a href="#cb91-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Probability Calibration Plot"</span>,</span>
<span id="cb91-646"><a href="#cb91-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Well-calibrated models follow the diagonal"</span>,</span>
<span id="cb91-647"><a href="#cb91-647" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb91-648"><a href="#cb91-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb91-649"><a href="#cb91-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb91-650"><a href="#cb91-650" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-651"><a href="#cb91-651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb91-652"><a href="#cb91-652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb91-653"><a href="#cb91-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-654"><a href="#cb91-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Use probably package for calibration</span></span>
<span id="cb91-655"><a href="#cb91-655" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(probably)</span>
<span id="cb91-656"><a href="#cb91-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-657"><a href="#cb91-657" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple calibration visualization</span></span>
<span id="cb91-658"><a href="#cb91-658" aria-hidden="true" tabindex="-1"></a><span class="co"># We'll just show the calibration plot without the probably package functions</span></span>
<span id="cb91-659"><a href="#cb91-659" aria-hidden="true" tabindex="-1"></a><span class="co"># that are causing issues</span></span>
<span id="cb91-660"><a href="#cb91-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-661"><a href="#cb91-661" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a simple comparison</span></span>
<span id="cb91-662"><a href="#cb91-662" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(calibration_data, <span class="fu">aes</span>(<span class="at">x =</span> mean_predicted, <span class="at">y =</span> fraction_positive)) <span class="sc">+</span></span>
<span id="cb91-663"><a href="#cb91-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-664"><a href="#cb91-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-665"><a href="#cb91-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-666"><a href="#cb91-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb91-667"><a href="#cb91-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-668"><a href="#cb91-668" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Calibration Assessment"</span>,</span>
<span id="cb91-669"><a href="#cb91-669" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points should follow the red diagonal for perfect calibration"</span>,</span>
<span id="cb91-670"><a href="#cb91-670" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mean Predicted Probability"</span>,</span>
<span id="cb91-671"><a href="#cb91-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Observed Frequency"</span>,</span>
<span id="cb91-672"><a href="#cb91-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"Count"</span></span>
<span id="cb91-673"><a href="#cb91-673" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-674"><a href="#cb91-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb91-675"><a href="#cb91-675" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-676"><a href="#cb91-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb91-677"><a href="#cb91-677" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-678"><a href="#cb91-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-679"><a href="#cb91-679" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Visualization</span></span>
<span id="cb91-680"><a href="#cb91-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-681"><a href="#cb91-681" aria-hidden="true" tabindex="-1"></a>Create comprehensive performance visualizations:</span>
<span id="cb91-682"><a href="#cb91-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-685"><a href="#cb91-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-686"><a href="#cb91-686" aria-hidden="true" tabindex="-1"></a><span class="co"># For regression: actual vs predicted with confidence bands</span></span>
<span id="cb91-687"><a href="#cb91-687" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-688"><a href="#cb91-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb91-689"><a href="#cb91-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb91-690"><a href="#cb91-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb91-691"><a href="#cb91-691" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-692"><a href="#cb91-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb91-693"><a href="#cb91-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-694"><a href="#cb91-694" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Accuracy"</span>,</span>
<span id="cb91-695"><a href="#cb91-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"R² ="</span>, <span class="fu">round</span>(<span class="fu">rsq_vec</span>(test_predictions<span class="sc">$</span>Sale_Price, </span>
<span id="cb91-696"><a href="#cb91-696" aria-hidden="true" tabindex="-1"></a>                                          test_predictions<span class="sc">$</span>.pred), <span class="dv">3</span>)),</span>
<span id="cb91-697"><a href="#cb91-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Price"</span>,</span>
<span id="cb91-698"><a href="#cb91-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Price"</span></span>
<span id="cb91-699"><a href="#cb91-699" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb91-700"><a href="#cb91-700" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>()</span>
<span id="cb91-701"><a href="#cb91-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-702"><a href="#cb91-702" aria-hidden="true" tabindex="-1"></a><span class="co"># Error distribution</span></span>
<span id="cb91-703"><a href="#cb91-703" aria-hidden="true" tabindex="-1"></a>error_plot <span class="ot">&lt;-</span> test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-704"><a href="#cb91-704" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">error =</span> .pred <span class="sc">-</span> Sale_Price,</span>
<span id="cb91-705"><a href="#cb91-705" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_error =</span> error <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-706"><a href="#cb91-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error)) <span class="sc">+</span></span>
<span id="cb91-707"><a href="#cb91-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-708"><a href="#cb91-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb91-709"><a href="#cb91-709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-710"><a href="#cb91-710" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Prediction Error Distribution"</span>,</span>
<span id="cb91-711"><a href="#cb91-711" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage error"</span>,</span>
<span id="cb91-712"><a href="#cb91-712" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Error (%)"</span>,</span>
<span id="cb91-713"><a href="#cb91-713" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb91-714"><a href="#cb91-714" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-715"><a href="#cb91-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-716"><a href="#cb91-716" aria-hidden="true" tabindex="-1"></a>prediction_plot <span class="sc">+</span> error_plot</span>
<span id="cb91-717"><a href="#cb91-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-718"><a href="#cb91-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-719"><a href="#cb91-719" aria-hidden="true" tabindex="-1"></a><span class="fu">## Best Practices for Workflows</span></span>
<span id="cb91-720"><a href="#cb91-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-721"><a href="#cb91-721" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Always Use Workflows for Production</span></span>
<span id="cb91-722"><a href="#cb91-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-725"><a href="#cb91-725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-726"><a href="#cb91-726" aria-hidden="true" tabindex="-1"></a><span class="co"># Good practice: Complete workflow</span></span>
<span id="cb91-727"><a href="#cb91-727" aria-hidden="true" tabindex="-1"></a>production_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-728"><a href="#cb91-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb91-729"><a href="#cb91-729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-730"><a href="#cb91-730" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-731"><a href="#cb91-731" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_mode</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-732"><a href="#cb91-732" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-733"><a href="#cb91-733" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb91-734"><a href="#cb91-734" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-735"><a href="#cb91-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb91-736"><a href="#cb91-736" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb91-737"><a href="#cb91-737" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-738"><a href="#cb91-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-739"><a href="#cb91-739" aria-hidden="true" tabindex="-1"></a><span class="co"># This ensures all preprocessing is contained and reproducible</span></span>
<span id="cb91-740"><a href="#cb91-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-741"><a href="#cb91-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-742"><a href="#cb91-742" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Version Control Your Workflows</span></span>
<span id="cb91-743"><a href="#cb91-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-746"><a href="#cb91-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-747"><a href="#cb91-747" aria-hidden="true" tabindex="-1"></a><span class="co"># Save workflow for reproducibility</span></span>
<span id="cb91-748"><a href="#cb91-748" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_fit, <span class="st">"models/final_workflow_v1.rds"</span>)</span>
<span id="cb91-749"><a href="#cb91-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-750"><a href="#cb91-750" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and use later</span></span>
<span id="cb91-751"><a href="#cb91-751" aria-hidden="true" tabindex="-1"></a><span class="co"># loaded_workflow &lt;- readRDS("models/final_workflow_v1.rds")</span></span>
<span id="cb91-752"><a href="#cb91-752" aria-hidden="true" tabindex="-1"></a><span class="co"># new_predictions &lt;- predict(loaded_workflow, new_data)</span></span>
<span id="cb91-753"><a href="#cb91-753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-754"><a href="#cb91-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-755"><a href="#cb91-755" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Document Your Choices</span></span>
<span id="cb91-756"><a href="#cb91-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-759"><a href="#cb91-759" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-760"><a href="#cb91-760" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflow with documentation</span></span>
<span id="cb91-761"><a href="#cb91-761" aria-hidden="true" tabindex="-1"></a>documented_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-762"><a href="#cb91-762" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(</span>
<span id="cb91-763"><a href="#cb91-763" aria-hidden="true" tabindex="-1"></a>    <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-764"><a href="#cb91-764" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Handle missing values before other steps</span></span>
<span id="cb91-765"><a href="#cb91-765" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-766"><a href="#cb91-766" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Normalize for model stability</span></span>
<span id="cb91-767"><a href="#cb91-767" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-768"><a href="#cb91-768" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create dummies for linear model</span></span>
<span id="cb91-769"><a href="#cb91-769" aria-hidden="true" tabindex="-1"></a>      <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb91-770"><a href="#cb91-770" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-771"><a href="#cb91-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(</span>
<span id="cb91-772"><a href="#cb91-772" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression to handle multicollinearity</span></span>
<span id="cb91-773"><a href="#cb91-773" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-774"><a href="#cb91-774" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb91-775"><a href="#cb91-775" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-776"><a href="#cb91-776" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-777"><a href="#cb91-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-778"><a href="#cb91-778" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb91-779"><a href="#cb91-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-780"><a href="#cb91-780" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 1: Build a Complete Evaluation Pipeline</span></span>
<span id="cb91-781"><a href="#cb91-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-782"><a href="#cb91-782" aria-hidden="true" tabindex="-1"></a>Create a workflow and comprehensive evaluation:</span>
<span id="cb91-783"><a href="#cb91-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-786"><a href="#cb91-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-787"><a href="#cb91-787" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb91-788"><a href="#cb91-788" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a complete evaluation pipeline</span></span>
<span id="cb91-789"><a href="#cb91-789" aria-hidden="true" tabindex="-1"></a>eval_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Overall_Cond <span class="sc">+</span> </span>
<span id="cb91-790"><a href="#cb91-790" aria-hidden="true" tabindex="-1"></a>                      Neighborhood <span class="sc">+</span> Total_Bsmt_SF, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-791"><a href="#cb91-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(Sale_Price, <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span>  <span class="co"># Skip for prediction</span></span>
<span id="cb91-792"><a href="#cb91-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-793"><a href="#cb91-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-794"><a href="#cb91-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span>
<span id="cb91-795"><a href="#cb91-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-796"><a href="#cb91-796" aria-hidden="true" tabindex="-1"></a>eval_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fl">0.01</span>, <span class="at">mixture =</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb91-797"><a href="#cb91-797" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb91-798"><a href="#cb91-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-799"><a href="#cb91-799" aria-hidden="true" tabindex="-1"></a>eval_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-800"><a href="#cb91-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(eval_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb91-801"><a href="#cb91-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(eval_spec)</span>
<span id="cb91-802"><a href="#cb91-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-803"><a href="#cb91-803" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit with cross-validation</span></span>
<span id="cb91-804"><a href="#cb91-804" aria-hidden="true" tabindex="-1"></a>eval_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">10</span>, <span class="at">strata =</span> Sale_Price)</span>
<span id="cb91-805"><a href="#cb91-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-806"><a href="#cb91-806" aria-hidden="true" tabindex="-1"></a>eval_results <span class="ot">&lt;-</span> eval_workflow <span class="sc">%&gt;%</span></span>
<span id="cb91-807"><a href="#cb91-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb91-808"><a href="#cb91-808" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> eval_folds,</span>
<span id="cb91-809"><a href="#cb91-809" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>mape),</span>
<span id="cb91-810"><a href="#cb91-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-811"><a href="#cb91-811" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-812"><a href="#cb91-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-813"><a href="#cb91-813" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize performance</span></span>
<span id="cb91-814"><a href="#cb91-814" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(eval_results)</span>
<span id="cb91-815"><a href="#cb91-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-816"><a href="#cb91-816" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions for visualization</span></span>
<span id="cb91-817"><a href="#cb91-817" aria-hidden="true" tabindex="-1"></a>eval_predictions <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(eval_results)</span>
<span id="cb91-818"><a href="#cb91-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-819"><a href="#cb91-819" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize CV performance</span></span>
<span id="cb91-820"><a href="#cb91-820" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(eval_predictions, <span class="fu">aes</span>(<span class="at">x =</span> Sale_Price, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb91-821"><a href="#cb91-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb91-822"><a href="#cb91-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb91-823"><a href="#cb91-823" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>id, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb91-824"><a href="#cb91-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions Across CV Folds"</span>)</span>
<span id="cb91-825"><a href="#cb91-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-826"><a href="#cb91-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-827"><a href="#cb91-827" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 2: Compare Preprocessing Strategies</span></span>
<span id="cb91-828"><a href="#cb91-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-829"><a href="#cb91-829" aria-hidden="true" tabindex="-1"></a>Evaluate different preprocessing approaches:</span>
<span id="cb91-830"><a href="#cb91-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-833"><a href="#cb91-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-834"><a href="#cb91-834" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb91-835"><a href="#cb91-835" aria-hidden="true" tabindex="-1"></a><span class="co"># Define different preprocessing strategies</span></span>
<span id="cb91-836"><a href="#cb91-836" aria-hidden="true" tabindex="-1"></a>preproc_minimal <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built, </span>
<span id="cb91-837"><a href="#cb91-837" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> ames_train)</span>
<span id="cb91-838"><a href="#cb91-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-839"><a href="#cb91-839" aria-hidden="true" tabindex="-1"></a>preproc_standard <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> Total_Bsmt_SF, </span>
<span id="cb91-840"><a href="#cb91-840" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-841"><a href="#cb91-841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb91-842"><a href="#cb91-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-843"><a href="#cb91-843" aria-hidden="true" tabindex="-1"></a>preproc_complex <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Sale_Price <span class="sc">~</span> Gr_Liv_Area <span class="sc">+</span> Year_Built <span class="sc">+</span> </span>
<span id="cb91-844"><a href="#cb91-844" aria-hidden="true" tabindex="-1"></a>                         Neighborhood <span class="sc">+</span> Total_Bsmt_SF <span class="sc">+</span> Garage_Cars, <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span></span>
<span id="cb91-845"><a href="#cb91-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-846"><a href="#cb91-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb91-847"><a href="#cb91-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span> Gr_Liv_Area<span class="sc">:</span>Year_Built)</span>
<span id="cb91-848"><a href="#cb91-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-849"><a href="#cb91-849" aria-hidden="true" tabindex="-1"></a><span class="co"># Create workflows</span></span>
<span id="cb91-850"><a href="#cb91-850" aria-hidden="true" tabindex="-1"></a>strategies <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb91-851"><a href="#cb91-851" aria-hidden="true" tabindex="-1"></a>  <span class="at">minimal =</span> preproc_minimal,</span>
<span id="cb91-852"><a href="#cb91-852" aria-hidden="true" tabindex="-1"></a>  <span class="at">standard =</span> preproc_standard,</span>
<span id="cb91-853"><a href="#cb91-853" aria-hidden="true" tabindex="-1"></a>  <span class="at">complex =</span> preproc_complex</span>
<span id="cb91-854"><a href="#cb91-854" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-855"><a href="#cb91-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-856"><a href="#cb91-856" aria-hidden="true" tabindex="-1"></a><span class="co"># Same model for all</span></span>
<span id="cb91-857"><a href="#cb91-857" aria-hidden="true" tabindex="-1"></a>model_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb91-858"><a href="#cb91-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-859"><a href="#cb91-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Create and evaluate workflows</span></span>
<span id="cb91-860"><a href="#cb91-860" aria-hidden="true" tabindex="-1"></a>strategy_results <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="fu">names</span>(strategies), <span class="cf">function</span>(strategy_name) {</span>
<span id="cb91-861"><a href="#cb91-861" aria-hidden="true" tabindex="-1"></a>  wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-862"><a href="#cb91-862" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_recipe</span>(strategies[[strategy_name]]) <span class="sc">%&gt;%</span></span>
<span id="cb91-863"><a href="#cb91-863" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_model</span>(model_spec)</span>
<span id="cb91-864"><a href="#cb91-864" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-865"><a href="#cb91-865" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit and evaluate</span></span>
<span id="cb91-866"><a href="#cb91-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb91-867"><a href="#cb91-867" aria-hidden="true" tabindex="-1"></a>    wf,</span>
<span id="cb91-868"><a href="#cb91-868" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v =</span> <span class="dv">5</span>),</span>
<span id="cb91-869"><a href="#cb91-869" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb91-870"><a href="#cb91-870" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-871"><a href="#cb91-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb91-872"><a href="#cb91-872" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">strategy =</span> strategy_name)</span>
<span id="cb91-873"><a href="#cb91-873" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-874"><a href="#cb91-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-875"><a href="#cb91-875" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare strategies</span></span>
<span id="cb91-876"><a href="#cb91-876" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(strategy_results, <span class="fu">aes</span>(<span class="at">x =</span> strategy, <span class="at">y =</span> mean, <span class="at">fill =</span> strategy)) <span class="sc">+</span></span>
<span id="cb91-877"><a href="#cb91-877" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb91-878"><a href="#cb91-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err, <span class="at">ymax =</span> mean <span class="sc">+</span> std_err), <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb91-879"><a href="#cb91-879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb91-880"><a href="#cb91-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Preprocessing Strategy Comparison"</span>) <span class="sc">+</span></span>
<span id="cb91-881"><a href="#cb91-881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb91-882"><a href="#cb91-882" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-883"><a href="#cb91-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-884"><a href="#cb91-884" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exercise 3: Custom Metrics for Business Goals</span></span>
<span id="cb91-885"><a href="#cb91-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-886"><a href="#cb91-886" aria-hidden="true" tabindex="-1"></a>Create business-specific metrics:</span>
<span id="cb91-887"><a href="#cb91-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-890"><a href="#cb91-890" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb91-891"><a href="#cb91-891" aria-hidden="true" tabindex="-1"></a><span class="co"># Your solution</span></span>
<span id="cb91-892"><a href="#cb91-892" aria-hidden="true" tabindex="-1"></a><span class="co"># Business scenario: Real estate company</span></span>
<span id="cb91-893"><a href="#cb91-893" aria-hidden="true" tabindex="-1"></a><span class="co"># - Overestimating is bad (disappointed customers)</span></span>
<span id="cb91-894"><a href="#cb91-894" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &lt;5% is acceptable</span></span>
<span id="cb91-895"><a href="#cb91-895" aria-hidden="true" tabindex="-1"></a><span class="co"># - Underestimating by &gt;5% is very bad (lost opportunity)</span></span>
<span id="cb91-896"><a href="#cb91-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-897"><a href="#cb91-897" aria-hidden="true" tabindex="-1"></a>business_metric <span class="ot">&lt;-</span> <span class="cf">function</span>(truth, estimate) {</span>
<span id="cb91-898"><a href="#cb91-898" aria-hidden="true" tabindex="-1"></a>  pct_error <span class="ot">&lt;-</span> (estimate <span class="sc">-</span> truth) <span class="sc">/</span> truth <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb91-899"><a href="#cb91-899" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-900"><a href="#cb91-900" aria-hidden="true" tabindex="-1"></a>  penalties <span class="ot">&lt;-</span> <span class="fu">case_when</span>(</span>
<span id="cb91-901"><a href="#cb91-901" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">2</span>,        <span class="co"># Overestimate penalty</span></span>
<span id="cb91-902"><a href="#cb91-902" aria-hidden="true" tabindex="-1"></a>    pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="fl">0.5</span>,     <span class="co"># Small underestimate</span></span>
<span id="cb91-903"><a href="#cb91-903" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">abs</span>(pct_error) <span class="sc">*</span> <span class="dv">3</span>                  <span class="co"># Large underestimate penalty</span></span>
<span id="cb91-904"><a href="#cb91-904" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-905"><a href="#cb91-905" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-906"><a href="#cb91-906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(penalties)</span>
<span id="cb91-907"><a href="#cb91-907" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-908"><a href="#cb91-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-909"><a href="#cb91-909" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to test predictions</span></span>
<span id="cb91-910"><a href="#cb91-910" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-911"><a href="#cb91-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-912"><a href="#cb91-912" aria-hidden="true" tabindex="-1"></a>    <span class="at">business_score =</span> <span class="fu">business_metric</span>(Sale_Price, .pred),</span>
<span id="cb91-913"><a href="#cb91-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">standard_mape =</span> <span class="fu">mape_vec</span>(Sale_Price, .pred)</span>
<span id="cb91-914"><a href="#cb91-914" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-915"><a href="#cb91-915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb91-916"><a href="#cb91-916" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_business_score =</span> <span class="fu">mean</span>(business_score),</span>
<span id="cb91-917"><a href="#cb91-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_standard_mape =</span> <span class="fu">mean</span>(standard_mape)</span>
<span id="cb91-918"><a href="#cb91-918" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-919"><a href="#cb91-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-920"><a href="#cb91-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize business metric</span></span>
<span id="cb91-921"><a href="#cb91-921" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="sc">%&gt;%</span></span>
<span id="cb91-922"><a href="#cb91-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb91-923"><a href="#cb91-923" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_error =</span> (.pred <span class="sc">-</span> Sale_Price) <span class="sc">/</span> Sale_Price <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb91-924"><a href="#cb91-924" aria-hidden="true" tabindex="-1"></a>    <span class="at">error_category =</span> <span class="fu">case_when</span>(</span>
<span id="cb91-925"><a href="#cb91-925" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"Overestimate"</span>,</span>
<span id="cb91-926"><a href="#cb91-926" aria-hidden="true" tabindex="-1"></a>      pct_error <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"Small Underestimate"</span>,</span>
<span id="cb91-927"><a href="#cb91-927" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Large Underestimate"</span></span>
<span id="cb91-928"><a href="#cb91-928" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb91-929"><a href="#cb91-929" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb91-930"><a href="#cb91-930" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pct_error, <span class="at">fill =</span> error_category)) <span class="sc">+</span></span>
<span id="cb91-931"><a href="#cb91-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb91-932"><a href="#cb91-932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb91-933"><a href="#cb91-933" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Overestimate"</span> <span class="ot">=</span> <span class="st">"red"</span>,</span>
<span id="cb91-934"><a href="#cb91-934" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Small Underestimate"</span> <span class="ot">=</span> <span class="st">"yellow"</span>,</span>
<span id="cb91-935"><a href="#cb91-935" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Large Underestimate"</span> <span class="ot">=</span> <span class="st">"darkred"</span></span>
<span id="cb91-936"><a href="#cb91-936" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb91-937"><a href="#cb91-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb91-938"><a href="#cb91-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Business Impact of Prediction Errors"</span>,</span>
<span id="cb91-939"><a href="#cb91-939" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Error"</span>,</span>
<span id="cb91-940"><a href="#cb91-940" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb91-941"><a href="#cb91-941" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Error Category"</span></span>
<span id="cb91-942"><a href="#cb91-942" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb91-943"><a href="#cb91-943" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb91-944"><a href="#cb91-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-945"><a href="#cb91-945" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb91-946"><a href="#cb91-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-947"><a href="#cb91-947" aria-hidden="true" tabindex="-1"></a>In this comprehensive chapter, you've mastered:</span>
<span id="cb91-948"><a href="#cb91-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-949"><a href="#cb91-949" aria-hidden="true" tabindex="-1"></a>✅ **Workflow fundamentals**</span>
<span id="cb91-950"><a href="#cb91-950" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Combining preprocessing and models</span>
<span id="cb91-951"><a href="#cb91-951" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Preventing data leakage</span>
<span id="cb91-952"><a href="#cb91-952" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Ensuring reproducibility</span>
<span id="cb91-953"><a href="#cb91-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-954"><a href="#cb91-954" aria-hidden="true" tabindex="-1"></a>✅ **Workflow components**</span>
<span id="cb91-955"><a href="#cb91-955" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Adding and updating recipes/models</span>
<span id="cb91-956"><a href="#cb91-956" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Formula vs recipe interfaces</span>
<span id="cb91-957"><a href="#cb91-957" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Modular design</span>
<span id="cb91-958"><a href="#cb91-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-959"><a href="#cb91-959" aria-hidden="true" tabindex="-1"></a>✅ **Workflow sets**</span>
<span id="cb91-960"><a href="#cb91-960" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Comparing multiple approaches</span>
<span id="cb91-961"><a href="#cb91-961" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Systematic evaluation</span>
<span id="cb91-962"><a href="#cb91-962" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Ranking and selection</span>
<span id="cb91-963"><a href="#cb91-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-964"><a href="#cb91-964" aria-hidden="true" tabindex="-1"></a>✅ **Model evaluation**</span>
<span id="cb91-965"><a href="#cb91-965" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Comprehensive metrics with yardstick</span>
<span id="cb91-966"><a href="#cb91-966" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Custom metrics for business needs</span>
<span id="cb91-967"><a href="#cb91-967" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Visualization techniques</span>
<span id="cb91-968"><a href="#cb91-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-969"><a href="#cb91-969" aria-hidden="true" tabindex="-1"></a>✅ **Advanced techniques**</span>
<span id="cb91-970"><a href="#cb91-970" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Extracting workflow components</span>
<span id="cb91-971"><a href="#cb91-971" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Probability calibration</span>
<span id="cb91-972"><a href="#cb91-972" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Model diagnostics</span>
<span id="cb91-973"><a href="#cb91-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-974"><a href="#cb91-974" aria-hidden="true" tabindex="-1"></a>Key takeaways:</span>
<span id="cb91-975"><a href="#cb91-975" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Always use workflows for production models</span>
<span id="cb91-976"><a href="#cb91-976" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflows prevent data leakage automatically</span>
<span id="cb91-977"><a href="#cb91-977" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Workflow sets enable systematic comparison</span>
<span id="cb91-978"><a href="#cb91-978" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Custom metrics align models with business goals</span>
<span id="cb91-979"><a href="#cb91-979" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Proper evaluation is crucial for model trust</span>
<span id="cb91-980"><a href="#cb91-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-981"><a href="#cb91-981" aria-hidden="true" tabindex="-1"></a><span class="fu">## What's Next?</span></span>
<span id="cb91-982"><a href="#cb91-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-983"><a href="#cb91-983" aria-hidden="true" tabindex="-1"></a>In <span class="co">[</span><span class="ot">Chapter 13</span><span class="co">](13-hyperparameter-tuning.Rmd)</span>, we'll explore hyperparameter tuning to optimize model performance.</span>
<span id="cb91-984"><a href="#cb91-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-985"><a href="#cb91-985" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Resources</span></span>
<span id="cb91-986"><a href="#cb91-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-987"><a href="#cb91-987" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">workflows Documentation</span><span class="co">](https://workflows.tidymodels.org/)</span></span>
<span id="cb91-988"><a href="#cb91-988" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">workflowsets Documentation</span><span class="co">](https://workflowsets.tidymodels.org/)</span></span>
<span id="cb91-989"><a href="#cb91-989" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">yardstick Documentation</span><span class="co">](https://yardstick.tidymodels.org/)</span></span>
<span id="cb91-990"><a href="#cb91-990" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Tidy Modeling with R - Workflows Chapter</span><span class="co">](https://www.tmwr.org/workflows.html)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>